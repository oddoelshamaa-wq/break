<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELSHAMAA | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø© ÙˆØ§Ù„Ø´ÙŠÙØ§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-deep: #020617;
            --primary: #6366f1;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255,255,255,0.08);
            --text-light: #f1f5f9;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%); 
            margin: 0; padding: 20px; min-height: 100vh; color: var(--text-light);
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .main-card {
            background: var(--glass);
            backdrop-filter: blur(30px);
            border-radius: 30px;
            border:1px solid var(--glass-border);
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        h2 { margin-top: 0; text-align: center; color: var(--accent); margin-bottom: 20px; }
        
        input, select {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-family: 'Cairo';
            margin-bottom: 10px;
            box-sizing: border-box;
            outline: none;
        }
        input:focus, select:focus { border-color: var(--primary); }
        
        input:disabled {
            background: rgba(255,255,255,0.05);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn {
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: 0.3s;
            font-family: 'Cairo';
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: default; transform: none !important; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-accent { background: var(--accent); color: #0f172a; font-weight: 900; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ØµÙ…Ø© */
        .fingerprint-section {
            text-align: center; padding: 40px;
            background: rgba(255,255,255,0.02); border-radius: 20px;
            border: 1px dashed var(--accent); margin-bottom: 30px;
        }

        .actions-container {
            display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;
        }

        .finger-btn {
            width: 130px; height: 130px; border-radius: 50%; background: var(--bg-deep);
            border: 4px solid var(--accent); color: var(--accent); font-size: 3rem;
            cursor: pointer; transition: 0.3s; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
        }
        .finger-btn span { font-size: 0.9rem; margin-top: 5px; font-weight: bold; }
        .finger-btn:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(6, 182, 212, 0.5); }
        
        .finger-btn:active, .finger-btn.scanning {
            background: var(--accent); color: var(--bg-deep);
            animation: pulse 1s infinite;
        }
        
        .absent-btn {
            width: 130px; height: 130px; border-radius: 50%; background: var(--bg-deep);
            border: 4px solid var(--danger); color: var(--danger); font-size: 3rem;
            cursor: pointer; transition: 0.3s; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }
        .absent-btn span { font-size: 0.9rem; margin-top: 5px; font-weight: bold; }
        .absent-btn:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(239, 68, 68, 0.5); }
        .absent-btn:active { background: var(--danger); color: white; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(6, 182, 212, 0); } 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); } }

        .scan-status { margin-top: 20px; font-size: 1.2rem; font-weight: bold; min-height: 40px; }
        .current-status-badge {
            background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 50px;
            border: 1px solid var(--glass-border); display: inline-block; margin-bottom: 10px;
            font-weight: bold;
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; overflow-x: auto; }
        .tab-btn { background: transparent; border: 1px solid var(--glass-border); color: #94a3b8; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: 'Cairo'; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-container {
            overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 20px;
            padding: 15px; border: 1px solid var(--glass-border); margin-top: 20px;
            margin-bottom: 40px;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 800px; }
        th { background: rgba(99, 102, 241, 0.15); color: var(--accent); padding: 15px; text-align: center; font-weight: bold; border-radius: 8px; white-space: nowrap; }
        tbody tr { background: rgba(255,255,255,0.02); transition: 0.2s; }
        tbody tr:hover { background: rgba(255,255,255,0.05); }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        td:first-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; text-align: right; padding-right: 20px; font-weight: bold;}
        td:last-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }

        /* Ø§Ù„Ø´Ø§Ø±Ø§Øª */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; display: inline-block;}
        .bg-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .bg-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .bg-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .bg-info { background: rgba(6, 182, 212, 0.2); color: var(--accent); border: 1px solid var(--accent); }
        .bg-off { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid #94a3b8; }

        /* Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        #toast-container { position: fixed; top: 20px; left: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 320px; }
        .toast { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); border-right: 5px solid var(--accent); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; transform: translateX(-120%); transition: transform 0.4s; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: var(--success); }

        .hidden { display: none !important; }
        .section-title { font-size: 1.3rem; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }

        /* Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù Ù„Ù„Ø´ÙŠÙØ§Øª */
        .admin-controls {
            background: rgba(99, 102, 241, 0.1); /* Ù„ÙˆÙ† Ø¨Ù†ÙØ³Ø¬ÙŠ Ø®ÙÙŠÙ */
            border: 1px solid var(--primary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        }
        .admin-controls.visible { display: block; }
        
        .grid-2-col {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        @media(max-width: 600px) { .grid-2-col { grid-template-columns: 1fr; } }

    </style>
</head>
<body>

    <div class="container">
        <div id="toast-container"></div>

        <div class="main-card">
            <h2>ğŸ”¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø© ÙˆØ§Ù„Ø´ÙŠÙØ§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</h2>

            <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <div id="loginSection" style="max-width: 400px; margin: 50px auto; text-align: center; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 20px;">
                <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn btn-success" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            </div>

            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <div id="dashboardSection" class="hidden">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 id="welcomeMsg">Ø£Ù‡Ù„Ø§Ù‹</h3>
                    <button class="btn btn-danger" onclick="logout()" style="width:auto; font-size:0.9rem;">Ø®Ø±ÙˆØ¬</button>
                </div>

                <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
                <div class="tabs-nav">
                    <button class="tab-btn active" onclick="switchTab('attendance')">ğŸ“Š Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¨ØµÙ…Ø©</button>
                    <button class="tab-btn" onclick="switchTab('shifts')">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙŠÙØ§Øª</button>
                </div>

                <!-- ================= Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 1: Ø§Ù„Ø­Ø¶ÙˆØ± ================= -->
                <div id="tab-attendance" class="tab-content active">
                    
                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ØµÙ…Ø© -->
                    <div class="fingerprint-section">
                        <p style="color: #94a3b8; margin-bottom: 20px;">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ùƒ Ø£Ùˆ Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¨Ø£Ù†Ùƒ ØºØ§Ø¦Ø¨</p>
                        
                        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
                        <div id="myCurrentStatus" class="current-status-badge" style="margin-bottom:20px;">
                            <i class="fa fa-info-circle"></i> <span>Ù„Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</span>
                        </div>

                        <div class="actions-container">
                            <!-- Ø²Ø± Ø§Ù„Ø¨ØµÙ…Ø© -->
                            <div class="finger-btn" onclick="scanFingerprint()">
                                <i class="fa-solid fa-fingerprint"></i>
                                <span>Ø¨ØµÙ…Ø©<br>Fingerprint</span>
                            </div>

                            <!-- Ø²Ø± Ø§Ù„ØºØ§Ø¦Ø¨ -->
                            <div class="absent-btn" onclick="markSelfAbsent()">
                                <i class="fa-solid fa-user-xmark"></i>
                                <span>ØºØ§Ø¦Ø¨<br>Absent</span>
                            </div>
                        </div>

                        <div id="scanStatus" class="scan-status"></div>
                    </div>

                    <!-- ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
                    <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                        <label id="dateLabel" for="attendanceDateView">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¶:</label>
                        <input type="date" id="attendanceDateView" style="width: auto; display:inline-block;" onchange="renderAttendanceTable()">
                    </div>

                    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
                    <div class="table-container">
                        <div class="section-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                    <th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
                                    <th class="admin-only">ØªØ­ÙƒÙ…</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody"></tbody>
                        </table>
                    </div>

                </div>

                <!-- ================= Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 2: Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙŠÙØ§Øª ================= -->
                <div id="tab-shifts" class="tab-content">
                    <div class="table-container">
                        
                        <!-- ØªØ­ÙƒÙ… ÙÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø´ÙŠÙØ§Øª -->
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                            <div>
                                <div class="section-title" id="shiftTableTitle" style="margin-bottom:0; border:none;">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø´ÙŠÙØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <label id="shiftDateLabel" for="shiftDateView">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
                                <input type="date" id="shiftDateView" style="width: auto; display:inline-block;" onchange="renderShiftsTable()">
                            </div>
                        </div>
                        <p style="color:#94a3b8; margin-bottom:15px;" id="shiftTableDesc">ÙŠØ¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</p>

                        <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù Ù„Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙŠÙØ§Øª (Ø¬Ø¯ÙŠØ¯Ø©) -->
                        <div id="adminShiftControls" class="admin-controls">
                            <h4 style="margin-top:0; color:var(--accent); display:flex; align-items:center; gap:8px;">
                                <i class="fa fa-pen-to-square"></i> ØªØ­Ø±ÙŠØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙŠÙØ§Øª (Ù„Ù„Ù…Ø¯ÙŠØ±)
                            </h4>
                            <div class="grid-2-col">
                                <div>
                                    <label style="font-size:0.85rem; color:#cbd5e1;">Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                                    <select id="schedUserSelect"></select>
                                </div>
                                <div>
                                    <label style="font-size:0.85rem; color:#cbd5e1;">Ø§Ù„ÙŠÙˆÙ…:</label>
                                    <select id="schedDaySelect">
                                        <option value="0">Ø§Ù„Ø³Ø¨Øª (Saturday)</option>
                                        <option value="1">Ø§Ù„Ø£Ø­Ø¯ (Sunday)</option>
                                        <option value="2">Ø§Ù„Ø§Ø«Ù†ÙŠÙ† (Monday)</option>
                                        <option value="3">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ (Tuesday)</option>
                                        <option value="4">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ (Wednesday)</option>
                                        <option value="5">Ø§Ù„Ø®Ù…ÙŠØ³ (Thursday)</option>
                                        <option value="6">Ø§Ù„Ø¬Ù…Ø¹Ø© (Friday)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-top:10px;">
                                <label style="font-size:0.85rem; color:#cbd5e1;">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <select id="schedStatusSelect" onchange="toggleSchedInputs()">
                                    <option value="work">â° Ø¯ÙˆØ§Ù… Ø¹Ù…Ù„ (Work)</option>
                                    <option value="Off">ğŸŒ´ Ø¥Ø¬Ø§Ø²Ø© (Off)</option>
                                    <option value="Annual Leave">ğŸ”– Ø¥Ø¬Ø§Ø²Ø© Ø³Ù†ÙˆÙŠØ© (Annual)</option>
                                    <option value="Sick Leave">ğŸ¥ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© (Sick)</option>
                                </select>
                            </div>

                            <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ -->
                            <div id="schedTimeInputs" class="grid-2-col" style="display:none;">
                                <div>
                                    <label style="font-size:0.85rem; color:#cbd5e1;">Ù…Ù†:</label>
                                    <input type="time" id="schedStartTime">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem; color:#cbd5e1;">Ø¥Ù„Ù‰:</label>
                                    <input type="time" id="schedEndTime">
                                </div>
                            </div>

                            <button class="btn btn-accent" style="margin-top:15px;" onclick="saveShiftToDB()">
                                <i class="fa fa-save"></i> Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                            </button>
                        </div>

                        <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
                        <table id="shiftsTable">
                            <thead>
                                <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù‡Ù†Ø§ -->
                            </thead>
                            <tbody id="shiftsTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBojsAZ73wpf-4cD8TviULncyxIIOUO2qY",
            authDomain: "brak-nagaf.firebaseapp.com",
            projectId: "brak-nagaf",
            storageBucket: "brak-nagaf.firebasestorage.app",
            messagingSenderId: "149166416863",
            appId: "1:149166416863:web:e94fe392f868da07bbda6a",
            measurementId: "G-Z82Y7NHNGE",
            databaseURL: "https://brak-nagaf-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let allUsersData = {};
        let allScheduleData = {};
        const MANAGERS = ['mahmoud', 'abutamim', 'ahmed'];
        
        // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;
        document.getElementById('attendanceDateView').value = todayStr;
        document.getElementById('shiftDateView').value = todayStr;

        // ================= Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… =================

        function attemptLogin(savedU = null, savedP = null) {
            const u = savedU || document.getElementById('usernameInput').value.trim().toLowerCase();
            const p = savedP || document.getElementById('passwordInput').value.trim();

            if(allUsersData[u] && allUsersData[u].password === p) {
                currentUser = allUsersData[u];
                currentUser.role = MANAGERS.includes(u) ? 'admin' : 'employee';

                const datePicker = document.getElementById('attendanceDateView');
                const dateLabel = document.getElementById('dateLabel');
                const shiftDatePicker = document.getElementById('shiftDateView');
                const shiftDateLabel = document.getElementById('shiftDateLabel');
                const shiftTitle = document.getElementById('shiftTableTitle');
                const shiftDesc = document.getElementById('shiftTableDesc');
                const adminControls = document.getElementById('adminShiftControls');

                if(currentUser.role === 'employee') {
                    // Ù„Ù„Ù…ÙˆØ¸Ù
                    datePicker.disabled = true;
                    datePicker.value = todayStr;
                    dateLabel.innerText = "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… (Ù…Ù‚ÙÙˆÙ„):";
                    
                    shiftDatePicker.disabled = true;
                    shiftDatePicker.value = todayStr;
                    shiftDateLabel.innerText = "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:";
                    
                    shiftTitle.innerText = "ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø´ÙŠÙØ§ØªÙŠ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹";
                    shiftDesc.innerText = "ØªØ¸Ù‡Ø± Ø´ÙŠÙØ§ØªÙƒ ÙÙ‚Ø·";
                    
                    adminControls.classList.remove('visible'); // Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                } else {
                    // Ù„Ù„Ù…Ø´Ø±Ù
                    datePicker.disabled = false;
                    dateLabel.innerText = "Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ø±Ø¶:";
                    
                    shiftDatePicker.disabled = false;
                    shiftDateLabel.innerText = "Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø¹Ø±Ø¶:";
                    
                    shiftTitle.innerText = "ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø´ÙŠÙØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†";
                    shiftDesc.innerText = "ÙŠØ¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù";

                    adminControls.classList.add('visible'); // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
                    populateUserSelect(); // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                    startAttendanceListener();
                }

                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.realName || currentUser.username}`;

                localStorage.setItem('elshamaa_user', u);
                localStorage.setItem('elshamaa_pass', p);
                
                updateMyStatusDisplay(); 
                renderAttendanceTable();
                renderShiftsTable();
            } else {
                if(!savedU) alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©");
            }
        }

        function logout() {
            localStorage.removeItem('elshamaa_user');
            localStorage.removeItem('elshamaa_pass');
            location.reload();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            if(tabName === 'shifts') renderShiftsTable();
        }

        function getFbDateKey(dateObj) {
            const d = dateObj.getDate().toString().padStart(2, '0');
            const m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const y = dateObj.getFullYear();
            return `${y}-${m}-${d}`;
        }

        // ================= Ø§Ù„Ø¨ØµÙ…Ø© =================

        function scanFingerprint() {
            const btn = document.querySelector('.finger-btn');
            const statusTxt = document.getElementById('scanStatus');
            
            if(btn.classList.contains('scanning')) return;

            btn.classList.add('scanning');
            statusTxt.innerText = "Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ØµÙ…Ø©...";
            statusTxt.style.color = "var(--warning)";

            setTimeout(() => {
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                const dateKeyFb = getFbDateKey(now); 

                const todayAtt = (currentUser.attendance && currentUser.attendance[dateKeyFb]) ? currentUser.attendance[dateKeyFb] : null;
                
                const isCurrentlyAbsent = (todayAtt && todayAtt.status === 'Absent');
                const hasClockIn = (todayAtt && todayAtt.clockIn);
                const hasClockOut = (todayAtt && todayAtt.clockOut);

                const updates = {};

                if (!hasClockIn || isCurrentlyAbsent) {
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/clockIn`] = timeString;
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/status`] = 'Present';
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/date`] = dateKeyFb;
                    
                    if(isCurrentlyAbsent) {
                        statusTxt.innerText = `âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±: ${timeString}`;
                    } else {
                        statusTxt.innerText = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±: ${timeString}`;
                    }
                    statusTxt.style.color = "var(--success)";
                } else if (!hasClockOut) {
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/clockOut`] = timeString;
                    statusTxt.innerText = `ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ${timeString}`;
                    statusTxt.style.color = "var(--accent)";
                } else {
                    statusTxt.innerText = "âš ï¸ Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø¯ÙˆØ§Ù…Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ù„ÙŠÙˆÙ…!";
                    statusTxt.style.color = "var(--text-light)";
                }

                if(Object.keys(updates).length > 0) {
                    db.ref().update(updates).then(() => {
                        setTimeout(() => {
                            btn.classList.remove('scanning');
                            if(!currentUser.attendance) currentUser.attendance = {};
                            currentUser.attendance[dateKeyFb] = { 
                                ...(currentUser.attendance[dateKeyFb] || {}), 
                                ...updates[`users/${currentUser.username}/attendance/${dateKeyFb}`] 
                            };
                            updateMyStatusDisplay();
                            renderAttendanceTable();
                        }, 500);
                    });
                } else {
                    btn.classList.remove('scanning');
                }

            }, 1500);
        }

        function markSelfAbsent() {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³Ùƒ ÙƒØºØ§Ø¦Ø¨ Ø§Ù„ÙŠÙˆÙ…ØŸ")) return;

            const dateKeyFb = getFbDateKey(new Date());
            const updates = {};
            
            updates[`users/${currentUser.username}/attendance/${dateKeyFb}/status`] = 'Absent';
            updates[`users/${currentUser.username}/attendance/${dateKeyFb}/clockIn`] = null;
            updates[`users/${currentUser.username}/attendance/${dateKeyFb}/clockOut`] = null;
            updates[`users/${currentUser.username}/attendance/${dateKeyFb}/date`] = dateKeyFb;

            db.ref().update(updates).then(() => {
                if(!currentUser.attendance) currentUser.attendance = {};
                currentUser.attendance[dateKeyFb] = { status: 'Absent', date: dateKeyFb };
                updateMyStatusDisplay();
                renderAttendanceTable();
                alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨");
            });
        }

        function updateMyStatusDisplay() {
            const display = document.getElementById('myCurrentStatus');
            const dateKeyFb = getFbDateKey(new Date());
            const att = (currentUser.attendance && currentUser.attendance[dateKeyFb]) ? currentUser.attendance[dateKeyFb] : null;

            if(!att) {
                display.innerHTML = '<i class="fa fa-info-circle"></i> <span>Ù„Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</span>';
                display.style.borderColor = "var(--glass-border)";
                display.style.color = "var(--text-light)";
            } else if (att.status === 'Present' || att.status === 'Late') {
                display.innerHTML = `<i class="fa fa-check-circle"></i> <span>Ø£Ù†Øª Ø§Ù„Ø¢Ù†: Ø­Ø§Ø¶Ø± (Ø¯Ø®ÙˆÙ„ ${att.clockIn})</span>`;
                display.style.borderColor = "var(--success)";
                display.style.color = "var(--success)";
            } else if (att.status === 'Absent') {
                display.innerHTML = `<i class="fa fa-xmark-circle"></i> <span>Ø£Ù†Øª Ø§Ù„ÙŠÙˆÙ…: ØºØ§Ø¦Ø¨</span>`;
                display.style.borderColor = "var(--danger)";
                display.style.color = "var(--danger)";
            }
        }

        // ================= Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙŠÙØ§Øª) =================

        function populateUserSelect() {
            const sel = document.getElementById('schedUserSelect');
            sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option>';
            Object.keys(allUsersData).forEach(u => {
                if(!MANAGERS.includes(u)) {
                    const name = allUsersData[u].realName || u;
                    sel.innerHTML += `<option value="${u}">${name}</option>`;
                }
            });
        }

        function toggleSchedInputs() {
            const val = document.getElementById('schedStatusSelect').value;
            const timeGroup = document.getElementById('schedTimeInputs');
            if(val === 'work') {
                timeGroup.style.display = 'grid';
            } else {
                timeGroup.style.display = 'none';
            }
        }

        function saveShiftToDB() {
            const user = document.getElementById('schedUserSelect').value;
            const day = document.getElementById('schedDaySelect').value;
            const status = document.getElementById('schedStatusSelect').value;
            const start = document.getElementById('schedStartTime').value;
            const end = document.getElementById('schedEndTime').value;

            if(!user) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù");

            let valueToSave = "";
            if(status === 'work') {
                if(!start || !end) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©");
                valueToSave = `${start} - ${end}`;
            } else {
                valueToSave = status;
            }

            db.ref(`schedules/${user}/${day}`).set(valueToSave).then(() => {
                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙØ© Ø¨Ù†Ø¬Ø§Ø­");
                // Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‡ÙŠØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù€ Listener
            }).catch(err => {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + err.message);
            });
        }

        // ================= Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ =================

        function renderAttendanceTable() {
            let dateInput;
            if(currentUser.role === 'employee') {
                dateInput = todayStr; 
            } else {
                dateInput = document.getElementById('attendanceDateView').value;
            }

            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            const dateKeyFb = getFbDateKey(new Date(dateInput));
            
            let users = [];
            if(currentUser.role === 'admin') {
                users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));
            } else {
                users = [currentUser];
            }

            users.forEach(u => {
                const att = (u.attendance && u.attendance[dateKeyFb]) ? u.attendance[dateKeyFb] : null;
                let statusBadge = '<span class="badge bg-off">--</span>';
                
                if(att && att.status) {
                    let colorClass = 'bg-success';
                    if(att.status === 'Late') colorClass = 'bg-warning';
                    if(att.status === 'Absent') colorClass = 'bg-danger';
                    if(att.status === 'Off') colorClass = 'bg-off';
                    statusBadge = `<span class="badge ${colorClass}">${att.status}</span>`;
                }

                const clockIn = att ? (att.clockIn || '--:--') : '--:--';
                const clockOut = att ? (att.clockOut || '--:--') : '--:--';

                let actionBtn = '';
                if(currentUser.role === 'admin') {
                    actionBtn = `
                        <button class="btn btn-success" style="width:auto; padding:5px 10px; font-size:0.8rem; display:inline-flex;"
                        onclick="quickSetStatus('${u.username}', '${dateKeyFb}', 'Present')">Ø­Ø¶ÙˆØ±</button>
                        <button class="btn btn-danger" style="width:auto; padding:5px 10px; font-size:0.8rem; display:inline-flex;"
                        onclick="quickSetStatus('${u.username}', '${dateKeyFb}', 'Absent')">ØºÙŠØ§Ø¨</button>
                    `;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${u.realName || u.username}</td>
                        <td>${statusBadge}</td>
                        <td style="font-family:monospace; font-size:1.1rem">${clockIn}</td>
                        <td style="font-family:monospace; font-size:1.1rem">${clockOut}</td>
                        ${currentUser.role === 'admin' ? `<td>${actionBtn}</td>` : ''}
                    </tr>
                `;
            });
        }

        function renderShiftsTable() {
            const thead = document.querySelector('#shiftsTable thead');
            const tbody = document.getElementById('shiftsTableBody');
            tbody.innerHTML = '';

            // Ø­Ø³Ø§Ø¨ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù† Ø§Ù„Ù€ Date Picker
            let inputDateStr = document.getElementById('shiftDateView').value;
            let inputDate = new Date(inputDateStr);
            const jsDay = inputDate.getDay();
            const daysToSaturday = (jsDay + 1) % 7;
            const saturdayDate = new Date(inputDate);
            saturdayDate.setDate(inputDate.getDate() - daysToSaturday);

            const dayNames = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'];
            
            let headerHTML = '<tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th>';
            for(let i=0; i<7; i++) {
                let currentDayDate = new Date(saturdayDate);
                currentDayDate.setDate(saturdayDate.getDate() + i);
                const d = String(currentDayDate.getDate()).padStart(2, '0');
                const m = String(currentDayDate.getMonth() + 1).padStart(2, '0');
                const dateStr = `${d}/${m}`;
                const dayName = dayNames[i];
                headerHTML += `<th>${dayName} <br> <span style="font-size:0.8em">${dateStr}</span></th>`;
            }
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            let users = [];
            if(currentUser.role === 'admin') {
                users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));
                users.sort((a,b) => (a.realName || a.username).localeCompare(b.realName || b.username));
            } else {
                users = [currentUser];
            }

            users.forEach(u => {
                let row = `<tr><td>${u.realName || u.username}</td>`;
                for(let i=0; i<7; i++) {
                    const shift = (allScheduleData[u.username] && allScheduleData[u.username][i]) ? allScheduleData[u.username][i] : null;
                    let cellContent = '<span style="color:#555; font-size:0.8rem">-</span>';

                    if(shift) {
                        if(shift === 'Off') {
                            cellContent = '<span class="badge bg-off">Off</span>';
                        } else if(shift.includes('Leave')) {
                             cellContent = '<span class="badge bg-warning">Ø¥Ø¬Ø§Ø²Ø©</span>';
                        } else {
                            cellContent = `<span class="badge bg-info">${shift}</span>`;
                        }
                    }
                    row += `<td>${cellContent}</td>`;
                }
                row += '</tr>';
                tbody.innerHTML += row;
            });
        }

        function quickSetStatus(username, dateKey, status) {
            if(!confirm(`ØªØ£ÙƒÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ ${status}ØŸ`)) return;
            const updates = {};
            updates[`users/${username}/attendance/${dateKey}/status`] = status;
            if(status === 'Absent') {
                updates[`users/${username}/attendance/${dateKey}/clockIn`] = null;
                updates[`users/${username}/attendance/${dateKey}/clockOut`] = null;
            }
            db.ref().update(updates).then(() => renderAttendanceTable());
        }

        function startAttendanceListener() {
            db.ref('users').on('child_changed', (snapshot) => {
                const updatedUser = snapshot.val();
                const username = snapshot.key;
                if (username === currentUser.username) return;

                const todayKey = getFbDateKey(new Date());
                if (updatedUser.attendance && updatedUser.attendance[todayKey]) {
                    const att = updatedUser.attendance[todayKey];
                    const name = updatedUser.realName || username;
                    if (att.clockIn && att.status !== 'Absent') {
                        showToast(`${name} Ø­Ø¶Ø± Ø§Ù„Ø¢Ù†`, `Ø§Ù„ÙˆÙ‚Øª: ${att.clockIn}`);
                    }
                }
            });
        }

        function showToast(title, msg) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast success';
            t.innerHTML = `<div><h5>${title}</h5><p>${msg}</p></div>`;
            c.appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(),400); }, 5000);
        }

        function init() {
            db.ref('users').on('value', snap => {
                allUsersData = snap.val() || {};
                if(!currentUser) {
                    const savedU = localStorage.getItem('elshamaa_user');
                    const savedP = localStorage.getItem('elshamaa_pass');
                    if(savedU && savedP) attemptLogin(savedU, savedP);
                } else {
                    if(allUsersData[currentUser.username]) currentUser = allUsersData[currentUser.username];
                }
            });

            db.ref('schedules').on('value', snap => {
                allScheduleData = snap.val() || {};
                if(document.getElementById('tab-shifts').classList.contains('active')) {
                    renderShiftsTable();
                }
            });
        }

        init();

    </script>
</body>
</html>
