    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ELSHAMAA | Ø§Ù„Ø´ÙŠÙØ§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

        <style>
            :root {
                --bg-deep: #020617;
                --primary: #6366f1;
                --accent: #06b6d4;
                --success: #10b981;
                --warning: #f59e0b;
                --danger: #ef4444;
                --glass: rgba(15, 23, 42, 0.6);
                --glass-border: rgba(255,255,255,0.08);
                --text-light: #f1f5f9;
                
                /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
                --btn-off-bg: #475569;
                --btn-start-bg: #ec4899; /* ÙˆØ±Ø¯ÙŠ */
                --btn-action-bg: #8b5cf6; /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
            }

            body { 
                font-family: 'Cairo', sans-serif; 
                background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%); 
                margin: 0; padding: 20px; min-height: 100vh; color: var(--text-light);
            }

            .container { max-width: 1400px; margin: 0 auto; }

            .main-card {
                background: var(--glass);
                backdrop-filter: blur(30px);
                border-radius: 30px;
                border:1px solid var(--glass-border);
                padding: 30px;
                box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            }

            h2 { margin-top: 0; text-align: center; color: var(--accent); }
            
            .login-box { max-width: 400px; margin: 50px auto; text-align: center; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 20px; }

            input, select {
                width: 100%;
                padding: 12px;
                background: rgba(0,0,0,0.3);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                color: white;
                font-family: 'Cairo';
                margin-bottom: 10px;
                box-sizing: border-box;
                outline: none;
            }
            input:focus, select:focus { border-color: var(--primary); }

            .btn {
                color: white;
                padding: 12px 20px;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                font-weight: bold;
                width: 100%;
                transition: 0.3s;
                font-family: 'Cairo';
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 8px;
            }
            .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
            
            .btn-off { background: var(--btn-off-bg); }
            .btn-start { background: var(--btn-start-bg); }
            .btn-action { background: var(--btn-action-bg); }
            .btn-danger { background: var(--danger); }
            .btn-success { background: var(--success); }

            /* Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
            .admin-controls-grid {
                display: grid;
                grid-template-columns: 1fr 1fr; 
                gap: 20px;
                margin-bottom: 30px;
            }

            @media (max-width: 900px) { .admin-controls-grid { grid-template-columns: 1fr; } }

            .control-box {
                background: rgba(255,255,255,0.03);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                padding: 20px;
            }

            .control-box h4 { margin-top: 0; color: var(--accent); display: flex; align-items: center; gap: 8px; }

            /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
            .tables-wrapper {
                display: grid;
                grid-template-columns: 1.5fr 1fr; 
                gap: 25px;
            }

            @media (max-width: 1100px) { .tables-wrapper { grid-template-columns: 1fr; } }

            .table-container {
                overflow-x: auto;
                background: rgba(0,0,0,0.2);
                border-radius: 20px;
                padding: 10px;
                border: 1px solid var(--glass-border);
            }

            .section-title {
                font-size: 1.1rem;
                font-weight: bold;
                color: var(--primary);
                margin-bottom: 15px;
                border-bottom: 2px solid var(--glass-border);
                padding-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            table { width: 100%; border-collapse: separate; border-spacing: 0 5px; min-width: 600px; }
            
            th {
                background: rgba(99, 102, 241, 0.2);
                color: var(--accent);
                padding: 12px;
                text-align: center;
                font-weight: bold;
                border-radius: 8px;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            tbody tr { background: rgba(255,255,255,0.02); }
            tbody tr:hover { background: rgba(255,255,255,0.05); }
            td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }

            /* Ø´ÙŠÙØ§Øª */
            .shift-badge {
                background: rgba(6, 182, 212, 0.15);
                color: var(--accent);
                border: 1px solid var(--accent);
                padding: 4px 8px;
                border-radius: 8px;
                font-size: 0.8rem;
            }

            /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´ÙŠÙØ§Øª */
            .sched-status-badge {
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: bold;
                display: inline-block;
            }
            .sched-status-off { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid #94a3b8; }
            .sched-status-annual { background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid #a78bfa; }
            .sched-status-sick { background: rgba(236, 72, 153, 0.2); color: #f472b6; border: 1px solid #f472b6; }
            .sched-status-absent { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }

            /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± */
            .status-badge {
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: bold;
                display: inline-block;
            }
            .status-present { background: rgba(16, 185, 129, 0.2); color: var(--success); }
            .status-late { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
            .status-absent { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
            .status-annual { background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid #a78bfa; }
            .status-sick { background: rgba(236, 72, 153, 0.2); color: #f472b6; border: 1px solid #f472b6; }
            .status-off { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid #94a3b8; }

            .hidden { display: none !important; }
            .logout { background: var(--danger); width: auto; padding: 8px 15px; font-size: 0.9rem; }

            /* ==================== Ù…ÙŠØ²Ø§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ==================== */

            /* 1. Ù‚Ø³Ù… Ø§Ù„ÙÙ„ØªØ±Ø© */
            .date-filter-box {
                background: rgba(30, 41, 59, 0.4);
                border: 1px solid var(--glass-border);
                border-radius: 15px;
                padding: 15px;
                margin-bottom: 15px;
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                align-items: flex-end;
            }
            .date-filter-group { flex: 1; min-width: 200px; }
            .date-filter-group label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #cbd5e1; }
            .filter-btn { background: var(--accent); color: #0f172a; width: auto; padding: 10px 25px; font-weight: 800; }
            .filter-btn:hover { background: #22d3ee; color: #000; }
            .reset-btn { background: transparent; border: 1px solid var(--danger); color: var(--danger); width: auto; padding: 10px 15px; }
            .reset-btn:hover { background: var(--danger); color: white; }

            /* 2. Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
            .quick-actions-flex { display: flex; gap: 10px; margin-top: 15px; }
            
            .action-card-btn {
                flex: 1;
                padding: 15px;
                border-radius: 12px;
                color: white;
                text-align: center;
                cursor: pointer;
                transition: 0.2s;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 5px;
                font-size: 0.9rem;
                box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            }
            .action-card-btn i { font-size: 1.2rem; }
            .action-card-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.3); }

            .card-off { background: var(--btn-off-bg); }
            .card-start { background: var(--btn-start-bg); }
            .card-action { background: var(--btn-action-bg); }

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† */
.attendance-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 20px;
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.05);
    overflow-x: auto; /* Ù„Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
}

.attendance-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    text-align: center;
}

.attendance-table th {
    background: rgba(99, 102, 241, 0.1);
    color: var(--accent);
    padding: 15px;
    font-weight: 900;
    border-radius: 10px;
}

.attendance-table td {
    padding: 15px;
    color: var(--text-main);
    vertical-align: middle;
}

/* Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù */
.emp-name {
    font-weight: bold;
    color: white;
    text-align: right;
    padding-right: 20px;
}

/* Ø´ÙƒÙ„ ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„ÙˆÙ‚Øª (Ø£ÙÙ‚ÙŠ - Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶) */
.time-slot {
    display: inline-flex;
    flex-direction: row; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶Ù‡Ø§ */
    align-items: center;
    justify-content: center;
    gap: 8px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ */
    border: 1px solid var(--accent);
    padding: 6px 12px;
    border-radius: 8px;
    background: rgba(6, 182, 212, 0.05);
    min-width: 130px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ */
}

.time-in {
    color: var(--accent);
    font-weight: bold;
}

/* ÙØ§ØµÙ„ ØµØºÙŠØ± Ø¨ÙŠÙ† Ø§Ù„ÙˆÙ‚ØªÙŠÙ† */
.time-separator {
    color: var(--text-muted);
    opacity: 0.5;
    font-size: 0.8rem;
}

.time-out {
    color: #fff; /* Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ù„ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ù„Ù„ØªÙ…ÙŠÙŠØ² */
    font-weight: bold;
}

/* Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„ÙØ§Ø±ØºØ© */
.empty-slot {
    color: var(--text-muted);
    opacity: 0.5;
}

/* Ø§Ù„ØªØ§Ø±ÙŠØ® ØªØ­Øª Ø§Ù„ÙŠÙˆÙ… */
.date-label {
    display: block;
    font-size: 0.75rem;
    color: var(--primary);
    margin-top: 5px;
}

        </style>
    </head>
    <body>

        <div class="container">
            <div class="main-card">
                <h2>ğŸ”¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´ÙŠÙØ§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒØ§Ù…Ù„</h2>

                <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
                <div id="loginSection" class="login-box">
                    <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <button class="btn" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
                </div>

                <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ -->
                <div id="dashboardSection" class="hidden">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 id="welcomeMsg" style="margin:0;">Ø£Ù‡Ù„Ø§Ù‹</h3>
                        <div style="display:flex; gap:10px;">
                            <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠÙƒ -->
                            <button class="btn" onclick="window.location.href='index.html'" style="background: var(--accent); color: #0f172a; width: auto; padding: 8px 15px; font-size: 0.9rem; font-weight: bold; border-radius: 12px;">
                                â˜• Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠÙƒ
                            </button>
                            <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø£ØµÙ„ÙŠ -->
                            <button class="btn logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>

                    <!-- ========================================================== -->
                    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†) -->
                    <!-- ========================================================== -->
                    <div id="adminPanel" class="admin-controls-grid hidden">

                        <!-- 1. Ø§Ù„Ø´ÙŠÙØ§Øª -->
                        <div class="control-box">
                            <h4>ğŸ“… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø´ÙŠÙØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h4>

                            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø´ÙŠÙØ§Øª -->
                            <div class="date-filter-box" style="margin-bottom: 15px;">
                                <div class="date-filter-group">
                                    <label>Ø§Ù„Ø³Ù†Ø©:</label>
                                    <select id="schedYearSelect" onchange="setSchedWeekStart()"></select>
                                </div>
                                <div class="date-filter-group">
                                    <label>Ø§Ù„Ø´Ù‡Ø±:</label>
                                    <select id="schedMonthSelect" onchange="setSchedWeekStart()">
                                        <option value="0">ÙŠÙ†Ø§ÙŠØ±</option>
                                        <option value="1">ÙØ¨Ø±Ø§ÙŠØ±</option>
                                        <option value="2">Ù…Ø§Ø±Ø³</option>
                                        <option value="3">Ø¥Ø¨Ø±ÙŠÙ„</option>
                                        <option value="4">Ù…Ø§ÙŠÙˆ</option>
                                        <option value="5">ÙŠÙˆÙ†ÙŠÙˆ</option>
                                        <option value="6">ÙŠÙˆÙ„ÙŠÙˆ</option>
                                        <option value="7">Ø£ØºØ³Ø·Ø³</option>
                                        <option value="8">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                                        <option value="9">Ø£ÙƒØªÙˆØ¨Ø±</option>
                                        <option value="10">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                                        <option value="11">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                                    </select>
                                </div>
                                <div class="date-filter-group">
                                    <label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
                                    <select id="schedWeekSelect" onchange="setSchedWeekStart()">
                                        <option value="1">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</option>
                                        <option value="2">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                        <option value="3">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                        <option value="4">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                                        <option value="5">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                                <select id="schedUser"></select>
                                <select id="schedDay">
                                    <option value="0">Ø§Ù„Ø³Ø¨Øª</option><option value="1">Ø§Ù„Ø£Ø­Ø¯</option><option value="2">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="3">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option value="4">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="5">Ø§Ù„Ø®Ù…ÙŠØ³</option><option value="6">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
                                </select>

                                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø© (ÙƒÙ„Ù…Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©) -->
                                <select id="schedStatus" onchange="toggleSchedInputs()" style="grid-column: span 2;">
                                    <option value="work">â° Ø´ÙŠÙØ§Øª (Work)</option>
                                    <option value="Off">ğŸŒ´ Ø¥Ø¬Ø§Ø²Ø© (Off)</option>
                                    <option value="Annual Leave">ğŸ”– Ø¥Ø¬Ø§Ø²Ø© Ø³Ù†ÙˆÙŠØ© (Annual)</option>
                                    <option value="Sick Leave">ğŸ¥ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© (Sick)</option>
                                    <option value="Absent">âŒ ØºÙŠØ§Ø¨ (Absent)</option>
                                </select>

                                <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª -->
                                <div id="timeInputsGroup" style="grid-column: span 2; display: grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                    <input type="time" id="schedStart">
                                    <input type="time" id="schedEnd">
                                </div>

                                <button class="btn" onclick="saveShift()" style="background:var(--accent); grid-column: span 2;">Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙØ©</button>
                            </div>
                        </div>

                        <!-- 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù†Ø´Ø· -->
                        <div class="control-box">
                            <h4>ğŸ“… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù†Ø´Ø· Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>

                            <div class="date-filter-box" style="margin-bottom: 15px;">
                                <div class="date-filter-group">
                                    <label>Ø§Ù„Ø³Ù†Ø©:</label>
                                    <select id="currentYearSelect"></select>
                                </div>
                                <div class="date-filter-group">
                                    <label>Ø§Ù„Ø´Ù‡Ø±:</label>
                                    <select id="currentMonthSelect">
                                        <option value="0">ÙŠÙ†Ø§ÙŠØ±</option>
                                        <option value="1">ÙØ¨Ø±Ø§ÙŠØ±</option>
                                        <option value="2">Ù…Ø§Ø±Ø³</option>
                                        <option value="3">Ø¥Ø¨Ø±ÙŠÙ„</option>
                                        <option value="4">Ù…Ø§ÙŠÙˆ</option>
                                        <option value="5">ÙŠÙˆÙ†ÙŠÙˆ</option>
                                        <option value="6">ÙŠÙˆÙ„ÙŠÙˆ</option>
                                        <option value="7">Ø£ØºØ³Ø·Ø³</option>
                                        <option value="8">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                                        <option value="9">Ø£ÙƒØªÙˆØ¨Ø±</option>
                                        <option value="10">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                                        <option value="11">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                                    </select>
                                </div>
                                <div class="date-filter-group">
                                    <label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
                                    <select id="currentWeekSelect">
                                        <option value="1">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</option>
                                        <option value="2">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                        <option value="3">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                        <option value="4">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                                        <option value="5">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn" onclick="saveCurrentWeek()" style="background:var(--accent);">Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù†Ø´Ø·</button>
                        </div>

                        <!-- 2. Ø§Ù„Ø­Ø¶ÙˆØ± -->
                    
                            
                                <select id="attendUser"></select>
                                

                                                            <

                           
                        

                    </div>

                    <!-- ========================================== -->
                    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ† -->
                    <!-- ========================================== -->
                    <div class="tables-wrapper">

                        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙŠÙØ§Øª -->
                        <div>
                            <div class="section-title">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙŠÙØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (ÙŠØ¸Ù‡Ø± Off ÙˆØ§Ù„Ø­Ø§Ù„Ø§Øª)</div>

                            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ -->
                            <div class="date-filter-box" id="scheduleFilterBox" style="margin-bottom: 15px;">
                                <div class="date-filter-group">
                                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
                                    <select id="yearSelect" onchange="setWeekStart()"></select>
                                </div>
                                <div class="date-filter-group">
                                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
                                    <select id="monthSelect" onchange="setWeekStart()">
                                        <option value="0">ÙŠÙ†Ø§ÙŠØ±</option>
                                        <option value="1">ÙØ¨Ø±Ø§ÙŠØ±</option>
                                        <option value="2">Ù…Ø§Ø±Ø³</option>
                                        <option value="3">Ø¥Ø¨Ø±ÙŠÙ„</option>
                                        <option value="4">Ù…Ø§ÙŠÙˆ</option>
                                        <option value="5">ÙŠÙˆÙ†ÙŠÙˆ</option>
                                        <option value="6">ÙŠÙˆÙ„ÙŠÙˆ</option>
                                        <option value="7">Ø£ØºØ³Ø·Ø³</option>
                                        <option value="8">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                                        <option value="9">Ø£ÙƒØªÙˆØ¨Ø±</option>
                                        <option value="10">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                                        <option value="11">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                                    </select>
                                </div>
                                <div class="date-filter-group">
                                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙÙŠ Ø§Ù„Ø´Ù‡Ø±:</label>
                                    <select id="weekSelect" onchange="setWeekStart()">
                                        <option value="1">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</option>
                                        <option value="2">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                        <option value="3">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                        <option value="4">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                                        <option value="5">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                                    </select>
                                </div>
                                <div class="date-filter-group">
                                    <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
                                    <input type="date" id="weekStartDate" onchange="renderTables()">
                                </div>
                            </div>

                            <div class="attendance-container">
                                <table class="attendance-table">
                                    <thead id="scheduleHead">
                                        <tr>
                                            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                            <th>Ø§Ù„Ø³Ø¨Øª <span class="date-label">31/01</span></th>
                                            <th>Ø§Ù„Ø£Ø­Ø¯ <span class="date-label">01/02</span></th>
                                            <th>Ø§Ù„Ø§Ø«Ù†ÙŠÙ† <span class="date-label">02/02</span></th>
                                            <th>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ <span class="date-label">03/02</span></th>
                                            <th>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ <span class="date-label">04/02</span></th>
                                            <th>Ø§Ù„Ø®Ù…ÙŠØ³ <span class="date-label">05/02</span></th>
                                            <th>Ø§Ù„Ø¬Ù…Ø¹Ø© <span class="date-label">06/02</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody"></tbody>
                                </table>
                            </div>
                        </div>

                       
                                    <tbody id="attendanceBody"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyBojsAZ73wpf-4cD8TviULncyxIIOUO2qY",
                authDomain: "brak-nagaf.firebaseapp.com",
                projectId: "brak-nagaf",
                storageBucket: "brak-nagaf.firebasestorage.app",
                messagingSenderId: "149166416863",
                appId: "1:149166416863:web:e94fe392f868da07bbda6a",
                measurementId: "G-Z82Y7NHNGE",
                databaseURL: "https://brak-nagaf-default-rtdb.firebaseio.com/"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase .database();

            let currentUser = null;
            let allUsersData = {};
            let allScheduleData = {};
            let isFilterMode = false;
            let currentWeek = null;
            
            const MANAGERS = ['mahmoud', 'abutamim', 'ahmed'];
            const DAYS = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'];

            // Helper Functions
            function getServerDateString() {
                const d = new Date();
                return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
            }

            function convertHtmlDateToFbKey(dateStr) {
                if(!dateStr) return "";
                const parts = dateStr.split('-');
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }

            function attemptLogin(savedU = null, savedP = null) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø£Ø®Ø°Ù‡Ø§ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
                const u = savedU || document.getElementById('usernameInput').value.trim().toLowerCase();
                const p = savedP || document.getElementById('passwordInput').value.trim();

                if(allUsersData[u] && allUsersData[u].password === p) {
                    currentUser = allUsersData[u];
                    currentUser.role = MANAGERS.includes(u) ? 'admin' : 'employee';

                    if(currentUser.role === 'employee') {
                        document.getElementById('scheduleFilterBox').style.display = 'none';
                    }
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
                    localStorage.setItem('elshamaa_user', u);
                    localStorage.setItem('elshamaa_pass', p);

                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.realName || currentUser.username}`;

                    if(currentUser.role === 'admin') {
                        document.getElementById('adminPanel').classList.remove('hidden');
                        document.getElementById('adminQuickActions').classList.remove('hidden');
                        populateSelects();
                        const now = new Date();
                        document.getElementById('attendDate').valueAsDate = now;

                        // Set default month to current month
                        document.getElementById('monthSelect').value = now.getMonth();
                        document.getElementById('schedMonthSelect').value = now.getMonth();

                        // Set default week start to current Saturday
                        const dayOfWeek = now.getDay(); // 0 = Sunday
                        const daysToSaturday = (dayOfWeek + 1) % 7; // Days back to Saturday
                        const currentSaturday = new Date(now);
                        currentSaturday.setDate(now.getDate() - daysToSaturday);
                        document.getElementById('weekStartDate').value = currentSaturday.toISOString().split('T')[0];

                        // Set default week for scheduling
                        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                        const daysSinceFirstDay = now.getDate() - 1;
                        const weekNum = Math.floor(daysSinceFirstDay / 7) + 1;
                        document.getElementById('schedWeekSelect').value = Math.min(weekNum, 5);

                        // Set default for current week selects
                        document.getElementById('currentMonthSelect').value = now.getMonth();
                        document.getElementById('currentWeekSelect').value = Math.min(weekNum, 5);

                        // Set default filter to current month
                        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        document.getElementById('filterDateStart').value = startOfMonth.toISOString().split('T')[0];
                        document.getElementById('filterDateEnd').value = endOfMonth.toISOString().split('T')[0];
                        applyFilter();
                    }
                    renderTables();
                } else {
                    if(!savedU) alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); // Ù„Ø§ ØªØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„ÙØ§Ø´Ù„
                }
            }

            function logout() {
                localStorage.removeItem('elshamaa_user');
                localStorage.removeItem('elshamaa_pass');
                location.reload();
            }

            function populateSelects() {
                const schedSel = document.getElementById('schedUser');
                const attendSel = document.getElementById('attendUser');

                // ØªÙØ±ÙŠØº Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù…Ø¹ ÙˆØ¶Ø¹ Ø®ÙŠØ§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ
                schedSel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø´ÙŠÙ --</option>';
                attendSel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù --</option>';

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØµÙÙˆÙ Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹
                const userKeys = Object.keys(allUsersData);

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø£Ùˆ Ø§Ù„ÙŠÙˆØ²Ø±
                userKeys.sort((a, b) => {
                    const nameA = allUsersData[a].realName || a;
                    const nameB = allUsersData[b].realName || b;
                    return nameA.localeCompare(nameB, 'ar');
                });

                userKeys.forEach(username => {
                    // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø­Ù…ÙˆØ¯ØŒ Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…ØŒ Ø£Ø­Ù…Ø¯)
                    if(!MANAGERS.includes(username.toLowerCase())) {
                        const user = allUsersData[username];
                        const displayName = user.realName || username; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„ÙŠÙˆØ²Ø±

                        const option = `<option value="${username}">${displayName}</option>`;
                        schedSel.innerHTML += option;
                        attendSel.innerHTML += option;
                    }
                });

                console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ " + (userKeys.length - MANAGERS.length) + " Ø§Ø³Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

                // Populate year select
                const yearSel = document.getElementById('yearSelect');
                const schedYearSel = document.getElementById('schedYearSelect');
                const currentYearSel = document.getElementById('currentYearSelect');
                const currentYear = new Date().getFullYear();
                yearSel.innerHTML = '';
                schedYearSel.innerHTML = '';
                currentYearSel.innerHTML = '';
                for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                    const option = `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
                    yearSel.innerHTML += option;
                    schedYearSel.innerHTML += option;
                    currentYearSel.innerHTML += option;
                }
            }

            // 1.5 Toggle Inputs for Schedule
            function toggleSchedInputs() {
                const status = document.getElementById('schedStatus').value;
                const timeGroup = document.getElementById('timeInputsGroup');
                
                if (status === 'work') {
                    timeGroup.style.display = 'grid';
                } else {
                    timeGroup.style.display = 'none';
                }
            }

            // 2. Shift Logic
            function saveShift() {
                const u = document.getElementById('schedUser').value;
                const d = document.getElementById('schedDay').value;
                const status = document.getElementById('schedStatus').value;

                if(!u) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù");

                if (status === 'work') {
                    const s = document.getElementById('schedStart').value;
                    const e = document.getElementById('schedEnd').value;
                    if(!s || !e) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ‚Øª");
                    
                    db.ref(`schedules/${u}/${d}`).set(`${s} - ${e}`).then(() => {
                        renderTables();
                        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙØ©");
                    });
                } else {
                    // Save Status String (Off, Annual, Sick) - English words
                    db.ref(`schedules/${u}/${d}`).set(status).then(() => {
                        renderTables();
                        alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…");
                    });
                }
            }

            // 2.1 Save Current Week
            function saveCurrentWeek() {
                const year = parseInt(document.getElementById('currentYearSelect').value);
                const month = parseInt(document.getElementById('currentMonthSelect').value);
                const week = parseInt(document.getElementById('currentWeekSelect').value);

                db.ref('settings/currentWeek').set({year, month, week}).then(() => {
                    currentWeek = {year, month, week};
                    renderTables();
                    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù†Ø´Ø·");
                });
            }

            // 3. Attendance Logic
            function saveAttendance() {
                const u = document.getElementById('attendUser').value;
                const dateInput = document.getElementById('attendDate').value;
                const status = document.getElementById('attendStatus').value;

                if(!u || !dateInput) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®");

                const dateKey = convertHtmlDateToFbKey(dateInput);
                const updates = {};
                // Save Status (Present, Late, Absent) - English words
                updates[`users/${u}/attendance/${dateKey}/status`] = status;

                db.ref().update(updates).then(() => {
                    renderTables();
                    alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±");
                });
            }

            // 3.1 Quick Actions (Admin)
            function quickSave(leaveType) {
                const u = document.getElementById('attendUser').value;
                const dateInput = document.getElementById('attendDate').value;

                if(!u) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹");
                if(!dateInput) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®");

                if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ "${leaveType}" Ù„Ù„Ù…ÙˆØ¸ÙØŸ`)) return;

                const dateKey = convertHtmlDateToFbKey(dateInput);
                const updates = {};
                updates[`users/${u}/attendance/${dateKey}/status`] = leaveType;
                updates[`users/${u}/attendance/${dateKey}/clockIn`] = null;
                updates[`users/${u}/attendance/${dateKey}/clockOut`] = null;
                const dateParts = dateKey.split('-');
                updates[`users/${u}/attendance/${dateKey}/date`] = `${dateParts[0]}/${dateParts[1]}/${dateParts[2]}`;

                db.ref().update(updates).then(() => {
                    alert("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
                    renderTables();
                });
            }

            // 3.2 Employee Quick Actions
            function quickSaveSelf(leaveType) {
                const dateInput = getServerDateString().split('/').reverse().join('-');
                if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³Ùƒ "${leaveType}" Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŸ`)) return;
                
                const dateKey = convertHtmlDateToFbKey(dateInput);
                const updates = {};
                updates[`users/${currentUser.username}/attendance/${dateKey}/status`] = leaveType;
                updates[`users/${currentUser.username}/attendance/${dateKey}/clockIn`] = null;
                updates[`users/${currentUser.username}/attendance/${dateKey}/clockOut`] = null;
                
                db.ref().update(updates).then(() => {
                    alert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ "${leaveType}"`);
                    renderTables();
                });
            }

            function startWorkNow() {
                const dateInput = getServerDateString().split('/').reverse().join('-');
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                
                const dateKey = convertHtmlDateToFbKey(dateInput);
                
                db.ref(`users/${currentUser.username}/attendance/${dateKey}/clockIn`).once('value', snap => {
                    if(snap.exists()) {
                        alert("âš ï¸ Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ù„ÙŠÙˆÙ…!");
                    } else {
                        const updates = {};
                        updates[`users/${currentUser.username}/attendance/${dateKey}/status`] = 'Present'; // English
                        updates[`users/${currentUser.username}/attendance/${dateKey}/clockIn`] = timeString;
                        
                        db.ref().update(updates).then(() => {
                            alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù† " + timeString);
                            renderTables();
                        });
                    }
                });
            }

            function endWorkNow() {
                const dateInput = getServerDateString().split('/').reverse().join('-');
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                
                const dateKey = convertHtmlDateToFbKey(dateInput);

                const updates = {};
                updates[`users/${currentUser.username}/attendance/${dateKey}/clockOut`] = timeString;
                
                db.ref().update(updates).then(() => {
                    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ " + timeString);
                    renderTables();
                });
            }

            // 4. Filtering Logic
            function applyFilter() {
                const start = document.getElementById('filterDateStart').value;
                const end = document.getElementById('filterDateEnd').value;

                if(!start || !end) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©");

                isFilterMode = true;
                const thead = document.getElementById('attendanceHead');
                thead.innerHTML = `
                    <tr>
                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„ÙŠÙˆÙ…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø¯Ø®ÙˆÙ„</th>
                        <th>Ø®Ø±ÙˆØ¬</th>
                    </tr>
                `;
                renderTables(start, end);
            }

            function resetFilter() {
                isFilterMode = false;
                document.getElementById('filterDateStart').value = '';
                document.getElementById('filterDateEnd').value = '';
                const thead = document.getElementById('attendanceHead');
                thead.innerHTML = `
                    <tr>
                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø¯Ø®ÙˆÙ„</th>
                        <th>Ø®Ø±ÙˆØ¬</th>
                    </tr>
                `;
                renderTables();
            }

            // 5. Rendering
            function renderTables(filterStart = null, filterEnd = null) {
                // A. Shift Table
                // Calculate week dates
                let weekStart;
                if (currentUser.role === 'employee' && currentWeek) {
                    const firstDay = new Date(currentWeek.year, currentWeek.month, 1);
                    weekStart = new Date(firstDay);
                    weekStart.setDate(firstDay.getDate() + (currentWeek.week - 1) * 7);
                } else {
                    const weekStartInput = document.getElementById('weekStartDate').value;
                    weekStart = new Date();
                    if (weekStartInput) {
                        weekStart = new Date(weekStartInput);
                    } else {
                        // Default to current week, starting from Saturday
                        const today = new Date();
                        const dayOfWeek = today.getDay(); // 0 = Sunday
                        const daysToSaturday = (dayOfWeek + 1) % 7; // Days back to Saturday
                        weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - daysToSaturday);
                    }
                }

                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    weekDates.push(dateStr);
                }

                // Update header with dates
                const schedHead = document.getElementById('scheduleHead');
                schedHead.innerHTML = `
                    <tr>
                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        ${DAYS.map((day, i) => `<th>${day} <span class="date-label">${weekDates[i]}</span></th>`).join('')}
                    </tr>
                `;

                const schedBody = document.getElementById('scheduleBody');
                schedBody.innerHTML = '';

                let usersToShow = (currentUser.role === 'admin')
                    ? Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username))
                    : [currentUser];

                usersToShow.sort((a,b) => (a.realName || a.username).localeCompare(b.realName || b.username));

                usersToShow.forEach(u => {
                    let row = `<tr><td class="emp-name">${u.realName || u.username}</td>`;
                    for(let i=0; i<7; i++) {
                        let cellContent = '<span class="empty-slot">--</span>';
                        const val = (allScheduleData[u.username] && allScheduleData[u.username][i]) ? allScheduleData[u.username][i] : null;

                        if (val) {
                            if (val === 'Off') {
                                cellContent = `<span class="sched-status-badge sched-status-off">Off</span>`;
                            } else if (val === 'Annual Leave') {
                                cellContent = `<span class="sched-status-badge sched-status-annual">Annual</span>`;
                            } else if (val === 'Sick Leave') {
                                cellContent = `<span class="sched-status-badge sched-status-sick">Sick</span>`;
                            } else if (val === 'Absent') {
                                cellContent = `<span class="sched-status-badge sched-status-absent">Absent</span>`;
                            } else {
                                // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù†Ù‡ ÙˆÙ‚Øª
                                const times = val.split(' - ');
                                if (times.length === 2) {
                                    cellContent = `<div class="time-slot"><span class="time-in">${times[0]}</span><span class="time-separator">-</span><span class="time-out">${times[1]}</span></div>`;
                                } else {
                                    cellContent = `<span class="shift-badge">${val}</span>`;
                                }
                            }
                        }
                        row += `<td>${cellContent}</td>`;
                    }
                    row += `</tr>`;
                    schedBody.innerHTML += row;
                });

                // B. Attendance Table
                const attendBody = document.getElementById('attendanceBody');
                attendBody.innerHTML = '';

                if (!isFilterMode) {
                    const todayKey = getServerDateString().replace(/\//g, '-');
                    
                    usersToShow.forEach(u => {
                        const todayData = (u.attendance && u.attendance[todayKey]) ? u.attendance[todayKey] : null;
                        
                        let statusDisplay = '<span style="color:#aaa;">-</span>';
                        if (todayData && todayData.status) {
                            const s = todayData.status;
                            let badgeClass = 'status-present';
                            if(s === 'Late') badgeClass = 'status-late'; // English Match
                            if(s === 'Absent') badgeClass = 'status-absent'; // English Match
                            if(s === 'Annual Leave') badgeClass = 'status-annual';
                            if(s === 'Sick Leave') badgeClass = 'status-sick';
                            if(s === 'Day Off' || s === 'Off') badgeClass = 'status-off';
                            statusDisplay = `<span class="status-badge ${badgeClass}">${s}</span>`;
                        }

                        const clockIn = todayData ? (todayData.clockIn || '--:--') : '--:--';
                        const clockOut = todayData ? (todayData.clockOut || '--:--') : '--:--';
                        
                        attendBody.innerHTML += `
                            <tr>
                                <td style="font-weight:bold;">${u.realName || u.username}</td>
                                <td>${statusDisplay}</td>
                                <td style="font-family:'Courier New';">${clockIn}</td>
                                <td style="font-family:'Courier New';">${clockOut}</td>
                            </tr>
                        `;
                    });
                } else {
                    const startDate = new Date(filterStart);
                    const endDate = new Date(filterEnd);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateKey = `${d.getDate().toString().padStart(2, '0')}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getFullYear()}`;
                        const dateDisplay = `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
                        const dayName = new Date(d).toLocaleDateString('ar-EG', {weekday: 'long'});

                        usersToShow.forEach(u => {
                            const record = (u.attendance && u.attendance[dateKey]) ? u.attendance[dateKey] : null;

                            if (record) {
                                let statusDisplay = '<span style="color:#aaa;">-</span>';
                                if (record.status) {
                                    const s = record.status;
                                    let badgeClass = 'status-present';
                                    if(s === 'Late') badgeClass = 'status-late';
                                    if(s === 'Absent') badgeClass = 'status-absent';
                                    if(s === 'Annual Leave') badgeClass = 'status-annual';
                                    if(s === 'Sick Leave') badgeClass = 'status-sick';
                                    if(s === 'Day Off' || s === 'Off') badgeClass = 'status-off';
                                    statusDisplay = `<span class="status-badge ${badgeClass}">${s}</span>`;
                                }

                                const clockIn = record.clockIn || '--:--';
                                const clockOut = record.clockOut || '--:--';

                                attendBody.innerHTML += `
                                    <tr>
                                        <td style="font-weight:bold;">${u.realName || u.username}</td>
                                        <td style="font-size:0.85rem; color:#cbd5e1;">${dateDisplay}</td>
                                        <td style="font-size:0.85rem; color:#cbd5e1;">${dayName}</td>
                                        <td>${statusDisplay}</td>
                                        <td style="font-family:'Courier New';">${clockIn}</td>
                                        <td style="font-family:'Courier New';">${clockOut}</td>
                                    </tr>
                                `;
                            }
                        });
                    }
                    
                    if(attendBody.innerHTML === '') {
                        attendBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#64748b;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚</td></tr>';
                    }
                }
            }

            // Quick Range Functions
            function setQuickRange(range) {
                const now = new Date();
                let start, end;

                if (range === 'week') {
                    // This week: from Sunday to Saturday
                    const dayOfWeek = now.getDay(); // 0 = Sunday
                    start = new Date(now);
                    start.setDate(now.getDate() - dayOfWeek);
                    end = new Date(start);
                    end.setDate(start.getDate() + 6);
                } else if (range === 'month') {
                    // This month
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (range === 'lastMonth') {
                    // Last month
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0);
                } else if (range === '30days') {
                    // Last 30 days
                    end = new Date(now);
                    start = new Date(now);
                    start.setDate(now.getDate() - 29); // 30 days including today
                }

                document.getElementById('filterDateStart').value = start.toISOString().split('T')[0];
                document.getElementById('filterDateEnd').value = end.toISOString().split('T')[0];
                applyFilter();
            }

            // Set Week Start based on selected week in month
            function setWeekStart() {
                const weekNum = parseInt(document.getElementById('weekSelect').value);
                const monthNum = parseInt(document.getElementById('monthSelect').value);
                const year = parseInt(document.getElementById('yearSelect').value);

                // First day of the selected month
                const firstDay = new Date(year, monthNum, 1);

                // Week start: firstDay + (weekNum - 1) * 7
                const weekStart = new Date(firstDay);
                weekStart.setDate(firstDay.getDate() + (weekNum - 1) * 7);

                document.getElementById('weekStartDate').value = weekStart.toISOString().split('T')[0];
                renderTables();
            }

            // Set Week Start for scheduling
            function setSchedWeekStart() {
                // This function can be used if needed for scheduling, but currently not required
            }

            function initListeners() {
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª
                db.ref('users').on('value', snap => {
                    allUsersData = snap.val() || {};

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    populateSelects();

                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ù„Ø°ÙŠ Ø£Ø¶ÙÙ†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
                    if (!currentUser) {
                        const savedU = localStorage.getItem('elshamaa_user');
                        const savedP = localStorage.getItem('elshamaa_pass');
                        if (savedU && savedP) {
                            attemptLogin(savedU, savedP);
                        }
                    }

                    if(currentUser && allUsersData[currentUser.username]) {
                        currentUser = allUsersData[currentUser.username];
                        renderTables();
                    }
                });

                db.ref('schedules').on('value', snap => {
                    allScheduleData = snap.val() || {};
                    if(currentUser) renderTables();
                });

                db.ref('settings').on('value', snap => {
                    const settings = snap.val() || {};
                    currentWeek = settings.currentWeek || null;
                    if(currentUser) renderTables();
                });
            }

            initListeners();
        </script>
    </body>
    </html>
