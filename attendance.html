<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø´Ù…Ø¹Ø© | Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© ÙˆØ§Ù„Ø¨ØµÙ…Ø©</title>
    <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø¬Ù…ÙŠÙ„ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-deep: #0f172a;
            --primary: #6366f1;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255,255,255,0.08);
            --text-light: #f1f5f9;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%); 
            margin: 0; padding: 20px; min-height: 100vh; color: var(--text-light);
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Main Card */
        .main-card {
            background: var(--glass);
            backdrop-filter: blur(30px);
            border-radius: 30px;
            border:1px solid var(--glass-border);
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        h2 { margin-top: 0; text-align: center; color: var(--accent); margin-bottom: 20px; text-shadow: 0 0 20px rgba(6,182,212,0.3); }
        
        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-family: 'Cairo';
            margin-bottom: 10px;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
        }
        textarea { resize: vertical; min-height: 100px; }
        
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
        input:disabled, textarea:disabled { background: rgba(255,255,255,0.05); cursor: not-allowed; opacity: 0.7; }

        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #cbd5e1; }

        /* Buttons */
        .btn {
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: 0.3s;
            font-family: 'Cairo';
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: default; transform: none !important; }
        
        .btn-danger { background: var(--danger); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
        .btn-success { background: var(--success); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-accent { background: var(--accent); color: #0f172a; font-weight: 900; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3); }
        .btn-neutral { background: #475569; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; width: auto; }

        /* Fingerprint Section */
        .fingerprint-section {
            text-align: center; padding: 40px;
            background: rgba(255,255,255,0.02); border-radius: 20px;
            border: 1px dashed var(--accent); margin-bottom: 30px;
        }
        .actions-container { display: flex; justify-content: center; gap: 30px; margin-top: 20px; flex-wrap: wrap; }

        /* Big Fingerprint Button */
        .finger-btn {
            width: 140px; height: 140px; border-radius: 50%; background: var(--bg-deep);
            border: 4px solid var(--accent); color: var(--accent); font-size: 3.5rem;
            cursor: pointer; transition: 0.3s; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.1);
        }
        .finger-btn span { font-size: 1rem; margin-top: 10px; font-weight: bold; }
        .finger-btn:hover { transform: scale(1.05); box-shadow: 0 0 50px rgba(6, 182, 212, 0.4); }
        .finger-btn:active, .finger-btn.scanning {
            background: var(--accent); color: var(--bg-deep);
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); } 70% { box-shadow: 0 0 0 25px rgba(6, 182, 212, 0); } 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); } }

        .scan-status { margin-top: 20px; font-size: 1.3rem; font-weight: bold; min-height: 40px; }
        .current-status-badge {
            background: rgba(255,255,255,0.1); padding: 10px 25px; border-radius: 50px;
            border: 1px solid var(--glass-border); display: inline-block; margin-bottom: 15px;
            font-weight: bold; font-size: 1.1rem;
        }

        /* Tabs */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; overflow-x: auto; }
        .tab-btn { background: transparent; border: 1px solid var(--glass-border); color: #94a3b8; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: 'Cairo'; transition: 0.3s; white-space: nowrap; flex: 1; text-align: center; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Tables */
        .table-container {
            overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 20px;
            padding: 15px; border: 1px solid var(--glass-border); margin-top: 20px;
            margin-bottom: 20px;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 800px; direction: ltr; /* Force LTR for Tables Content */ }
        th { background: rgba(99, 102, 241, 0.15); color: var(--accent); padding: 15px; text-align: center; font-weight: bold; border-radius: 8px; white-space: nowrap; font-size: 0.95rem; }
        tbody tr { background: rgba(255,255,255,0.02); transition: 0.2s; cursor: default; }
        tbody tr:hover { background: rgba(255,255,255,0.05); }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; vertical-align: middle; position: relative; }
        td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; text-align: left; padding-left: 20px; font-weight: bold;}
        td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        /* Badges */
        .badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; display: inline-block; }
        .bg-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .bg-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .bg-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .bg-info { background: rgba(6, 182, 212, 0.2); color: var(--accent); border: 1px solid var(--accent); }
        .bg-off { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid #94a3b8; }

        /* Strikethrough Effect for Sick Leave */
        .strike-text {
            text-decoration: line-through;
            text-decoration-color: var(--danger);
            text-decoration-thickness: 2px;
            opacity: 0.7;
        }

        /* Admin Hover Action */
        .admin-editable:hover::after {
            content: '\f303'; /* FontAwesome Pen Icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--accent);
            font-size: 0.8rem;
            opacity: 0.5;
        }

        /* Toasts */
        #toast-container { position: fixed; top: 20px; left: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 320px; direction: rtl; }
        .toast { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-left: 5px solid var(--accent); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; transform: translateX(-120%); transition: transform 0.4s; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: var(--success); }

        .hidden { display: none !important; }
        .section-title { font-size: 1.3rem; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }

        /* Admin Controls */
        .admin-controls {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            display: none;
        }
        .admin-controls.visible { display: block; }
        
        .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media(max-width: 600px) { .grid-2-col { grid-template-columns: 1fr; } }

        .time-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid var(--glass-border); }
        .time-field { display: flex; flex-direction: column; }
        .time-field input { margin-bottom: 0; text-align: center; font-size: 1.1rem; font-weight: bold; }

        /* Report Card */
        .report-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);
            border: 1px solid var(--accent);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .report-title {
            color: var(--accent);
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.03);
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            border-left: 3px solid #94a3b8;
            text-align: right;
        }
        .report-item.success { border-left-color: var(--success); }
        .report-item.warning { border-left-color: var(--warning); }
        
        .report-text { font-size: 0.95rem; color: #e2e8f0; }
        .report-badge { font-size: 0.85rem; font-weight: bold; padding: 4px 10px; border-radius: 8px; }
        .badge-swap { background: var(--warning); color: #000; }

        /* Date Range Controls for Report */
        .date-range-controls {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border);
            align-items: flex-end;
        }
        .date-control { flex: 1; min-width: 140px; }
        .date-control label { margin-bottom: 5px; font-size: 0.85rem; }
        .date-control input { margin-bottom: 0; }

        /* English Table Override */
        .english-text { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        /* Status Icons */
        .status-icon { font-size: 1.2rem; }

        /* --- ANNOUNCEMENT & ACKNOWLEDGMENT STYLES (NEW) --- */
        .announcement-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(15, 23, 42, 0.6) 100%);
            border: 2px solid var(--success);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.1);
        }
        
        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }

        .ann-tag {
            background: var(--success);
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .announcement-body {
            font-size: 1.2rem;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: 25px;
            color: #fff;
        }

        .announcement-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }

        .ref-me-btn {
            background: linear-gradient(45deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Cairo';
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transition: 0.3s;
        }
        .ref-me-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6); }
        .ref-me-btn:disabled { background: #334155; color: #94a3b8; cursor: default; transform: none; box-shadow: none; }

        .ref-badge {
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 12px;
            font-family: monospace;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        /* History List */
        .history-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 3px solid #475569;
        }
        .history-item.acknowledged { border-right-color: var(--success); }
        .history-meta { font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px; display: flex; justify-content: space-between; }

        /* --- CORRECTION MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 10000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        
        .modal-card {
            background: #1e293b; border: 1px solid var(--primary); border-radius: 20px;
            padding: 30px; width: 100%; max-width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.3rem; color: var(--accent); font-weight: bold; }
        .close-modal { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; }
        .close-modal:hover { color: white; }

        .correction-options { display: grid; gap: 10px; margin-bottom: 20px; }
        .correction-option {
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;
            border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: 0.2s;
        }
        .correction-option:hover { background: rgba(255,255,255,0.1); }
        .correction-option.selected { border-color: var(--accent); background: rgba(6,182,212,0.1); }
        .correction-option input { width: auto; margin: 0; }

        .correction-note { font-size: 0.85rem; color: #94a3b8; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }

    </style>
</head>
<body>

    <div class="container">
        <div id="toast-container"></div>

        <div class="main-card">
            <h2>ğŸ”¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø¹Ø© Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</h2>

            <!-- Login Section -->
            <div id="loginSection" style="max-width: 400px; margin: 50px auto; text-align: center; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 20px;">
                <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn btn-success" onclick="attemptLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="hidden">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3 id="welcomeMsg">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h3>
                    
                    <div style="display:flex; gap: 10px;">
                        <button class="btn btn-neutral" onclick="goToIndex()" style="width:auto; font-size:0.9rem;">
                            <i class="fa fa-reply"></i> Ø®Ø±ÙˆØ¬ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                        <button class="btn btn-danger" onclick="logout()" style="width:auto; font-size:0.9rem;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>

                <!-- Navigation Bar -->
                <div class="tabs-nav">
                    <button class="tab-btn active" onclick="switchTab('attendance')">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                    <!-- NEW TAB HERE -->
                    <button class="tab-btn" onclick="switchTab('announcements')">ğŸ“¢ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ø¥Ù‚Ø±Ø§Ø±Ø§Øª</button>
                    <button class="tab-btn" onclick="switchTab('shifts')">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</button>
                    <button class="tab-btn admin-only" onclick="switchTab('report')">ğŸ“ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
                </div>

                <!-- Tab 1: Attendance -->
                <div id="tab-attendance" class="tab-content active">
                    
                    <div class="fingerprint-section">
                        <p style="color: #94a3b8; margin-bottom: 20px;">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø£Ùˆ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</p>
                        
                        <div id="myCurrentStatus" class="current-status-badge" style="margin-bottom:20px;">
                            <i class="fa fa-info-circle"></i> <span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</span>
                        </div>

                        <div class="actions-container">
                            <div class="finger-btn" onclick="scanFingerprint()">
                                <i class="fa-solid fa-fingerprint"></i>
                                <span>ØªØ³Ø¬ÙŠÙ„<br>Ø¨ØµÙ…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                            </div>
                        </div>

                        <div id="scanStatus" class="scan-status"></div>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;" class="admin-only">
                        <label id="dateLabel" for="attendanceDateView">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¶:</label>
                        <input type="date" id="attendanceDateView" style="width: auto; display:inline-block;" onchange="renderAttendanceTable()">
                        <span style="font-size:0.85rem; color:var(--warning); margin-right: auto;"><i class="fa fa-hand-pointer"></i> Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¬Ù„ Ù„Ù„ØªØµØ­ÙŠØ­</span>
                    </div>

                    <div class="table-container">
                        <div class="section-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Status</th>
                                    <th>Clock In</th>
                                    <th>Clock Out</th>
                                    <th class="admin-only">Action</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody"></tbody>
                        </table>
                    </div>

                </div>

                <!-- NEW TAB 2: Announcements & Acknowledgments -->
                <div id="tab-announcements" class="tab-content">
                    
                    <!-- Admin: Post Announcement -->
                    <div class="admin-controls" id="adminAnnouncementPanel">
                        <h4 style="margin-top:0; color:var(--success); display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                            <i class="fa fa-bullhorn"></i> Ù†Ø´Ø± ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                        </h4>
                        <div style="margin-bottom:15px;">
                            <label>Ù†Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ / Ø§Ù„Ù‚Ø±Ø§Ø±:</label>
                            <textarea id="announcementInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§... Ù…Ø«Ù„Ø§Ù‹: ØªØºÙŠÙŠØ± Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø±Ø³Ù…ÙŠ"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="postAnnouncement()">
                            <i class="fa fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                        </button>
                    </div>

                    <!-- User: Active Announcement -->
                    <div id="activeAnnouncementArea">
                        <!-- Will be populated by JS -->
                        <div style="text-align:center; padding:40px; color:#94a3b8;">
                            <i class="fa fa-check-circle" style="font-size:3rem; margin-bottom:15px; opacity:0.5;"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ù‚Ø±Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                        </div>
                    </div>

                    <!-- History List -->
                    <div class="section-title" style="margin-top:40px;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
                    <div id="announcementsHistoryList" style="max-height: 400px; overflow-y: auto; padding-right:5px;">
                        <!-- History Items -->
                    </div>

                </div>

                <!-- Tab 3: Shifts -->
                <div id="tab-shifts" class="tab-content">
                    <div class="table-container">
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                            <div>
                                <div class="section-title" id="shiftTableTitle" style="margin-bottom:0; border:none;">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</div>
                                <small id="weekRangeDisplay" style="color:var(--accent); margin-top:5px; display:block;">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: --</small>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;" class="admin-only">
                                <label id="shiftDateLabel" for="shiftDateView">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
                                <input type="date" id="shiftDateView" style="width: auto; display:inline-block;" onchange="onShiftDateChange()">
                            </div>
                        </div>
                        <p style="color:#94a3b8; margin-bottom:15px;" id="shiftTableDesc">Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</p>

                        <div id="adminShiftControls" class="admin-controls">
                            <h4 style="margin-top:0; color:var(--accent); display:flex; align-items:center; gap:8px; margin-bottom:20px;">
                                <i class="fa fa-pen-to-square"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·)
                            </h4>
                            
                            <div class="grid-2-col">
                                <div>
                                    <label>Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                                    <select id="schedUserSelect"></select>
                                </div>
                                <div>
                                    <label>Ø§Ù„ÙŠÙˆÙ…:</label>
                                    <select id="schedDaySelect"></select>
                                </div>
                            </div>
                            
                            <div style="margin-top:15px;">
                                <label>Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <select id="schedStatusSelect" onchange="toggleSchedInputs()">
                                    <option value="work">â° ÙˆØ±Ø¯ÙŠØ© Ø¹Ù…Ù„</option>
                                    <option value="Off">ğŸŒ´ Ø¥Ø¬Ø§Ø²Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
                                    <option value="Absent">âŒ ØºÙŠØ§Ø¨</option>
                                    <option value="Annual Leave">ğŸ”– Ø¥Ø¬Ø§Ø²Ø© Ø³Ù†ÙˆÙŠØ©</option>
                                    <option value="Sick Leave">ğŸ¥ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©</option>
                                </select>
                            </div>

                            <div id="schedTimeInputs" class="time-group" style="display:none;">
                                <div class="time-field">
                                    <label style="font-size:0.8rem; text-align:center;">ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡</label>
                                    <input type="time" id="schedStartTime">
                                </div>
                                <div class="time-field">
                                    <label style="font-size:0.8rem; text-align:center;">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                                    <input type="time" id="schedEndTime">
                                </div>
                            </div>

                            <button class="btn btn-accent" style="margin-top:20px;" onclick="saveShiftToDB()">
                                <i class="fa fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>
                        </div>

                        <table id="shiftsTable">
                            <thead></thead>
                            <tbody id="shiftsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 4: Report (Admin Only) -->
                <div id="tab-report" class="tab-content">
                    <div class="report-card">
                        <div class="report-title">
                            <i class="fa-solid fa-clipboard-check"></i>
                            ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù†Ø·Ø§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ)
                        </div>
                        
                        <div class="date-range-controls">
                            <div class="date-control">
                                <label for="reportFromDate">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="reportFromDate">
                            </div>
                            <div class="date-control">
                                <label for="reportToDate">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="reportToDate">
                            </div>
                            <button class="btn btn-accent" onclick="renderReport()" style="margin-bottom:0; width:auto; padding: 0 25px;">
                                <i class="fa fa-magnifying-glass"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                        </div>

                        <div id="reportContainer">
                            <p style="text-align:center; color:#94a3b8;">Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
                        </div>

                        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                            <button onclick="exportProfessionalExcel()" class="btn btn-success" style="height:45px; background: linear-gradient(135deg, #10b981, #059669);">
                                Excel ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ ğŸ“¥
                            </button>

                            <button onclick="exportAbsencesOnNonWorkDays()" class="btn btn-warning" style="height:45px; background: linear-gradient(135deg, #f59e0b, #d97706);">
                                Excel ØºÙŠØ§Ø¨ ÙÙŠ Ø£ÙŠØ§Ù… ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„Ø© ğŸ“¥
                            </button>

                            <button onclick="runSmartArchiving()" class="btn btn-dark" style="height:45px; border: 1px solid var(--primary);">
                                ğŸ“¦ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- CORRECTION MODAL -->
    <div id="correctionModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title"><i class="fa fa-wrench"></i> ØªØµØ­ÙŠØ­ Ø§Ù„Ø³Ø¬Ù„</div>
                <button class="close-modal" onclick="closeCorrectionModal()">&times;</button>
            </div>
            
            <div class="correction-note">
                <i class="fa fa-info-circle"></i> Ù‡Ø°Ø§ Ø§Ù„ØªØµØ­ÙŠØ­ Ø³ÙŠØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….
            </div>

            <div class="correction-options">
                <!-- Option 1: Sick Leave (Strike through) -->
                <label class="correction-option" onclick="selectCorrectionOption(this)">
                    <input type="radio" name="corrType" value="Sick Leave">
                    <div>
                        <div style="font-weight:bold; color:var(--warning);">ğŸ¥ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© (Ø¨ØµØ­Ø©)</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">Ø³ÙŠØªÙ… Ø´Ø·Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ¥Ø­Ø§Ù„ØªÙ‡ Ù„Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©.</div>
                    </div>
                </label>

                <!-- Option 2: Annual Leave -->
                <label class="correction-option" onclick="selectCorrectionOption(this)">
                    <input type="radio" name="corrType" value="Annual Leave">
                    <div>
                        <div style="font-weight:bold; color:var(--accent);">ğŸ”– Ø¥Ø¬Ø§Ø²Ø© Ø³Ù†ÙˆÙŠØ©</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">Ø¥Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ… ÙƒØ¥Ø¬Ø§Ø²Ø© Ø³Ù†ÙˆÙŠØ© Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø±ØµÙŠØ¯.</div>
                    </div>
                </label>

                <!-- Option 3: Present (Correcting Absent Mistake) -->
                <label class="correction-option" onclick="selectCorrectionOption(this)">
                    <input type="radio" name="corrType" value="Present">
                    <div>
                        <div style="font-weight:bold; color:var(--success);">âœ… Ø­Ø¶ÙˆØ± (ØªØµØ­ÙŠØ­ Ø®Ø·Ø£)</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">Ø§Ù„Ù…ÙˆØ¸Ù Ø­Ø¶Ø± ÙˆÙ„ÙƒÙ†Ù‡ Ø³ÙØ¬Ù„ ØºÙŠØ§Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ø®Ø·Ø£.</div>
                    </div>
                </label>
            </div>

            <div class="grid-2-col">
                <button class="btn btn-neutral" onclick="closeCorrectionModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-accent" onclick="submitCorrection()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµØ­ÙŠØ­</button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBojsAZ73wpf-4cD8TviULncyxIIOUO2qY",
            authDomain: "brak-nagaf.firebaseapp.com",
            projectId: "brak-nagaf",
            storageBucket: "brak-nagaf.firebasestorage.app",
            messagingSenderId: "149166416863",
            appId: "1:149166416863:web:e94fe392f868da07bbda6a",
            measurementId: "G-Z82Y7NHNGE",
            databaseURL: "https://brak-nagaf-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let allUsersData = {};
        let allScheduleData = {}; 
        let allAnnouncementsData = []; // New: To store announcements
        const MANAGERS = ['mahmoud', 'abutamim', 'ahmed'];
        
        // --- Correction Modal State ---
        let correctionTarget = { username: null, date: null };

        // --- Initialization ---
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;
        
        document.getElementById('attendanceDateView').value = todayStr;
        document.getElementById('shiftDateView').value = todayStr;
        document.getElementById('reportFromDate').value = todayStr;
        document.getElementById('reportToDate').value = todayStr;

        // --- Core Functions ---

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function getWeekKey(dateStr) {
            const d = new Date(dateStr);
            const day = d.getDay();
            const diff = (day + 1) % 7; 
            d.setDate(d.getDate() - diff);
            return d.toISOString().split('T')[0];
        }

        function attemptLogin(savedU = null, savedP = null) {
            const u = savedU || document.getElementById('usernameInput').value.trim().toLowerCase();
            const p = savedP || document.getElementById('passwordInput').value.trim();

            if(allUsersData[u] && allUsersData[u].password === p) {
                currentUser = allUsersData[u];
                currentUser.role = MANAGERS.includes(u) ? 'admin' : 'employee';

                const datePicker = document.getElementById('attendanceDateView');
                const dateLabel = document.getElementById('dateLabel');
                const shiftDatePicker = document.getElementById('shiftDateView');
                const shiftDateLabel = document.getElementById('shiftDateLabel');
                const shiftTitle = document.getElementById('shiftTableTitle');
                const shiftDesc = document.getElementById('shiftTableDesc');
                const adminControls = document.getElementById('adminShiftControls');
                const adminAnnPanel = document.getElementById('adminAnnouncementPanel');
                const adminOnlyElements = document.querySelectorAll('.admin-only');

                if(currentUser.role === 'employee') {
                    datePicker.disabled = true;
                    datePicker.value = todayStr;
                    dateLabel.innerText = "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… (Ù…ØºÙ„Ù‚):";
                    
                    shiftDatePicker.disabled = true;
                    shiftDatePicker.value = todayStr;
                    
                    shiftTitle.innerText = "ğŸ“… Ø¬Ø¯ÙˆÙ„ Ù…Ù†Ø§ÙˆØ¨Ø§ØªÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹";
                    shiftDesc.innerText = "Ø¬Ø¯ÙˆÙ„Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ (Ø§Ù„ÙŠÙˆÙ…ÙŠ)";
                    
                    adminControls.classList.remove('visible'); 
                    adminAnnPanel.classList.remove('visible'); // Hide Announcement Input
                    adminOnlyElements.forEach(el => el.classList.add('hidden'));

                    checkAndSetAutoAbsent(); 

                } else {
                    datePicker.disabled = false;
                    dateLabel.innerText = "Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ø±Ø¶:";
                    
                    shiftDatePicker.disabled = false;
                    shiftDateLabel.innerText = "Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø¹Ø±Ø¶/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:";
                    
                    shiftTitle.innerText = "ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†";
                    shiftDesc.innerText = "Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª";

                    adminControls.classList.add('visible'); 
                    adminAnnPanel.classList.add('visible'); // Show Announcement Input
                    populateUserSelect(); 
                    adminOnlyElements.forEach(el => el.classList.remove('hidden'));
                    startAttendanceListener();
                }

                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${currentUser.realName || currentUser.username}`;

                localStorage.setItem('elshamaa_user', u);
                localStorage.setItem('elshamaa_pass', p);
                
                updateMyStatusDisplay(); 
                renderAttendanceTable();
                onShiftDateChange(); 
                renderAnnouncements(); // Load announcements
            } else {
                if(!savedU) alert("Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            }
        }

        function logout() {
            localStorage.removeItem('elshamaa_user');
            localStorage.removeItem('elshamaa_pass');
            location.reload();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            if(tabName === 'shifts') {
                onShiftDateChange();
                if(currentUser.role === 'admin') updateDayDropdown();
            }
            if(tabName === 'report') {
                renderReport();
            }
            if(tabName === 'announcements') {
                renderAnnouncements();
            }
        }

        // --- Fingerprint & Attendance ---

        function checkAndSetAutoAbsent() {
            const dateKeyFb = todayStr;
            const weekKey = getWeekKey(dateKeyFb);
            const dayIndex = (new Date().getDay() + 1) % 7; // 0=Sat, 6=Fri
            
            const mySchedule = (allScheduleData[currentUser.username] && allScheduleData[currentUser.username][weekKey])
                               ? allScheduleData[currentUser.username][weekKey][dayIndex] : null;

            const todayAtt = (currentUser.attendance && currentUser.attendance[dateKeyFb]) ? currentUser.attendance[dateKeyFb] : null;

            if (mySchedule && mySchedule !== 'Off' && !mySchedule.includes('Leave')) {
                if (!todayAtt) {
                    db.ref(`users/${currentUser.username}/attendance/${dateKeyFb}`).set({
                        status: 'Absent',
                        date: dateKeyFb,
                        clockIn: null,
                        clockOut: null,
                        auto: true
                    }).then(() => {
                        console.log("Auto Absent Set");
                    });
                }
            }
            else if (mySchedule && mySchedule === 'Off' && !todayAtt) {
                 db.ref(`users/${currentUser.username}/attendance/${dateKeyFb}`).set({
                        status: 'Off',
                        date: dateKeyFb,
                        clockIn: null,
                        clockOut: null
                    });
            }
        }

        function scanFingerprint() {
            const btn = document.querySelector('.finger-btn');
            const statusTxt = document.getElementById('scanStatus');
            
            if(btn.classList.contains('scanning')) return;

            btn.classList.add('scanning');
            statusTxt.innerText = "Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ØµÙ…Ø©...";
            statusTxt.style.color = "var(--warning)";

            setTimeout(() => {
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                const dateKeyFb = todayStr;

                const weekKey = getWeekKey(dateKeyFb);
                const dayIndex = (now.getDay() + 1) % 7; 
                const mySchedule = (allScheduleData[currentUser.username] && allScheduleData[currentUser.username][weekKey])
                                   ? allScheduleData[currentUser.username][weekKey][dayIndex] : null;

                const todayAtt = (currentUser.attendance && currentUser.attendance[dateKeyFb]) ? currentUser.attendance[dateKeyFb] : null;
                
                const isCurrentlyAbsent = (todayAtt && todayAtt.status === 'Absent');
                const hasClockIn = (todayAtt && todayAtt.clockIn);
                const hasClockOut = (todayAtt && todayAtt.clockOut);

                const updates = {};

                if (!hasClockIn || isCurrentlyAbsent) {
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/clockIn`] = timeString;
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/status`] = 'Present';
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/date`] = dateKeyFb;
                    
                    if (mySchedule === 'Off') {
                        statusTxt.innerText = `âœ… ÙŠØ§ Ø¨Ø·Ù„! Ø´ØºÙ„ ÙÙŠ ÙŠÙˆÙ… Ø¥Ø¬Ø§Ø²Ø© (${timeString})`;
                        statusTxt.style.color = "#eab308"; 
                    } else if (mySchedule && mySchedule.includes('Leave')) {
                        statusTxt.innerText = `âœ… Ù…Ø¬Ù‡ÙˆØ¯ Ø±Ø§Ø¦Ø¹! Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ ÙŠÙˆÙ… Ø¥Ø¬Ø§Ø²Ø© (${timeString})`;
                        statusTxt.style.color = "#eab308";
                    } else if (isCurrentlyAbsent) {
                        statusTxt.innerText = `âœ… ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±: ${timeString}`;
                        statusTxt.style.color = "var(--warning)";
                    } else {
                        statusTxt.innerText = `âœ… Ù†ÙˆØ±Ù†Ø§ ÙŠØ§ ØºØ§Ù„ÙŠ! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (${timeString})`;
                        statusTxt.style.color = "var(--success)";
                    }
                } else if (!hasClockOut) {
                    updates[`users/${currentUser.username}/attendance/${dateKeyFb}/clockOut`] = timeString;
                    statusTxt.innerText = `ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­: ${timeString}`;
                    statusTxt.style.color = "var(--accent)";
                } else {
                    statusTxt.innerText = "âš ï¸ Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª ÙˆØ±Ø¯ÙŠØªÙƒ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…!";
                    statusTxt.style.color = "var(--text-light)";
                }

                if(Object.keys(updates).length > 0) {
                    db.ref().update(updates).then(() => {
                        setTimeout(() => {
                            btn.classList.remove('scanning');
                            if(!currentUser.attendance) currentUser.attendance = {};
                            currentUser.attendance[dateKeyFb] = { 
                                ...(currentUser.attendance[dateKeyFb] || {}), 
                                ...updates[`users/${currentUser.username}/attendance/${dateKeyFb}`] 
                            };
                            updateMyStatusDisplay();
                            renderAttendanceTable();
                        }, 500);
                    });
                } else {
                    btn.classList.remove('scanning');
                }

            }, 1500);
        }

        function updateMyStatusDisplay() {
            const display = document.getElementById('myCurrentStatus');
            const dateKeyFb = todayStr;
            const att = (currentUser.attendance && currentUser.attendance[dateKeyFb]) ? currentUser.attendance[dateKeyFb] : null;

            if(!att) {
                display.innerHTML = '<i class="fa fa-info-circle"></i> <span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</span>';
                display.style.borderColor = "var(--glass-border)";
                display.style.color = "var(--text-light)";
            } else if (att.status === 'Present') {
                display.innerHTML = `<i class="fa fa-check-circle status-icon"></i> <span>Ø­Ø§Ø¶Ø± (Ø¯Ø®ÙˆÙ„: ${att.clockIn})</span>`;
                display.style.borderColor = "var(--success)";
                display.style.color = "var(--success)";
            } else if (att.status === 'Sick Leave') {
                display.innerHTML = `<i class="fa fa-briefcase-medical status-icon"></i> <span>Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© (${att.clockIn})</span>`;
                display.style.borderColor = "var(--warning)";
                display.style.color = "var(--warning)";
            } else if (att.status === 'Absent') {
                display.innerHTML = `<i class="fa fa-xmark-circle status-icon"></i> <span>ØºØ§Ø¦Ø¨ (Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¨Ø¹Ø¯)</span>`;
                display.style.borderColor = "var(--danger)";
                display.style.color = "var(--danger)";
            } else if (att.status === 'Off') {
                display.innerHTML = `<i class="fa fa-coffee status-icon"></i> <span>Ø¥Ø¬Ø§Ø²Ø©</span>`;
                display.style.borderColor = "var(--accent)";
                display.style.color = "var(--accent)";
            }
        }

        // --- Shift Management (Admin) ---
        function populateUserSelect() {
            const sel = document.getElementById('schedUserSelect');
            sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option>';
            Object.keys(allUsersData).forEach(u => {
                if(!MANAGERS.includes(u)) {
                    const name = allUsersData[u].realName || u;
                    sel.innerHTML += `<option value="${u}">${name}</option>`;
                }
            });
        }

        function onShiftDateChange() {
            updateDayDropdown();      
            renderShiftsTable();      
        }

        function updateDayDropdown() {
            const inputDateStr = document.getElementById('shiftDateView').value;
            if(!inputDateStr) return;

            const inputDate = new Date(inputDateStr);
            const daysToSaturday = (inputDate.getDay() + 1) % 7;
            const saturdayDate = new Date(inputDate);
            saturdayDate.setDate(inputDate.getDate() - daysToSaturday);

            const endDate = new Date(saturdayDate);
            endDate.setDate(saturdayDate.getDate() + 6);
            const sStr = `${saturdayDate.getDate()}/${saturdayDate.getMonth()+1}`;
            const eStr = `${endDate.getDate()}/${endDate.getMonth()+1}`;
            document.getElementById('weekRangeDisplay').innerText = `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${sStr} - ${eStr}`;

            const dayNames = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'];
            const select = document.getElementById('schedDaySelect');
            const currentVal = select.value;
            select.innerHTML = '';

            for(let i=0; i<7; i++) {
                let currentDayDate = new Date(saturdayDate);
                currentDayDate.setDate(saturdayDate.getDate() + i);
                const d = String(currentDayDate.getDate()).padStart(2, '0');
                const m = String(currentDayDate.getMonth() + 1).padStart(2, '0');
                const dayName = dayNames[i];
                const dateLabel = `${dayName} (${d}/${m})`; 
                
                const option = document.createElement('option');
                option.value = i;
                option.text = dateLabel;
                select.appendChild(option);
            }
            
            if(currentVal !== '') select.value = currentVal;
        }

        function toggleSchedInputs() {
            const val = document.getElementById('schedStatusSelect').value;
            const timeGroup = document.getElementById('schedTimeInputs');
            if(val === 'work') {
                timeGroup.style.display = 'grid';
            } else {
                timeGroup.style.display = 'none'; 
            }
        }

        function saveShiftToDB() {
            const user = document.getElementById('schedUserSelect').value;
            const dayIndex = document.getElementById('schedDaySelect').value;
            const status = document.getElementById('schedStatusSelect').value;
            const start = document.getElementById('schedStartTime').value;
            const end = document.getElementById('schedEndTime').value;

            if(!user) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù");
            if(dayIndex === "") return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ…");

            const selectedDateStr = document.getElementById('shiftDateView').value;
            const weekKey = getWeekKey(selectedDateStr);

            let valueToSave = "";
            if(status === 'work') {
                if(!start || !end) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡");
                valueToSave = `${start} - ${end}`;
            } else {
                valueToSave = status;
            }

            db.ref(`schedules/${user}/${weekKey}/${dayIndex}`).set(valueToSave).then(() => {
                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
                renderShiftsTable(); 
            }).catch(err => {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + err.message);
            });
        }

        // --- NEW: Announcements & Acknowledgment Logic ---

        function postAnnouncement() {
            const text = document.getElementById('announcementInput').value.trim();
            if(!text) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡");

            const newAnnRef = db.ref('announcements').push({
                text: text,
                author: currentUser.username,
                timestamp: Date.now(),
                dateStr: new Date().toLocaleDateString('ar-EG')
            });

            document.getElementById('announcementInput').value = '';
            showToast("ØªÙ… Ø§Ù„Ù†Ø´Ø±", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.");
        }

        function markAsUnderstood(annId) {
            if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø·Ù„Ø§Ø¹ ÙˆØ§Ù„Ø¥Ù‚Ø±Ø§Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ØŸ")) return;

            const refId = 'REF-' + Math.floor(Math.random() * 1000000); // Generate simple ref ID
            const timestamp = Date.now();

            // Save acknowledgment under user node
            db.ref(`users/${currentUser.username}/acknowledgments/${annId}`).set({
                acknowledgedAt: timestamp,
                refId: refId
            }).then(() => {
                showToast("ØªÙ… Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±", `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ù‚Ø±Ø§Ø±Ùƒ. Ø§Ù„Ù…Ø±Ø¬Ø¹: ${refId}`);
                renderAnnouncements(); // Refresh UI
            });
        }

        function renderAnnouncements() {
            const activeArea = document.getElementById('activeAnnouncementArea');
            const historyList = document.getElementById('announcementsHistoryList');
            const announcements = Object.values(allAnnouncementsData || {}).sort((a,b) => b.timestamp - a.timestamp);
            
            activeArea.innerHTML = '';
            historyList.innerHTML = '';

            if(announcements.length === 0) {
                activeArea.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;"><i class="fa fa-bell-slash" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</p></div>';
                return;
            }

            // Get user's acknowledgments
            const myAcks = currentUser.acknowledgments || {};

            // Determine the latest UNREAD announcement
            let latestUnread = null;
            for(let ann of announcements) {
                if(!myAcks[ann.key || ann.id]) { // Assuming Firebase key handling
                    // Check if we stored the key. Since I used .push(), I need to access the key.
                    // The loop structure in init() handles keys.
                    // Wait, allAnnouncementsData needs to store keys.
                    break;
                }
            }

            // Correct logic for finding key in Object.values is tricky. 
            // Better to reconstruct with keys.
            const annArray = Object.keys(allAnnouncementsData || {}).map(key => {
                return { ...allAnnouncementsData[key], key: key };
            }).sort((a,b) => b.timestamp - a.timestamp);

            // Find first unacknowledged
            let activeCard = null;
            for(let ann of annArray) {
                if(!myAcks[ann.key]) {
                    activeCard = ann;
                    break;
                }
            }

            // Render Active Card
            if(activeCard) {
                const date = new Date(activeCard.timestamp).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                activeArea.innerHTML = `
                    <div class="announcement-card">
                        <div class="announcement-header">
                            <span class="ann-tag"><i class="fa fa-exclamation-circle"></i> ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù… Ø¬Ø¯ÙŠØ¯</span>
                            <span style="color:#94a3b8; font-size:0.9rem;">${date}</span>
                        </div>
                        <div class="announcement-body">${activeCard.text}</div>
                        <div class="announcement-footer">
                            <span style="font-size:0.9rem; color:#cbd5e1; margin-left: auto;">Ù…Ù†: Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
                            <button class="ref-me-btn" onclick="markAsUnderstood('${activeCard.key}')">
                                <i class="fa fa-check-double"></i> Ù…Ø±Ø¬Ø¹ Ù„ÙŠ (Ø¥Ù‚Ø±Ø§Ø± Ø¨Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…)
                            </button>
                        </div>
                    </div>
                `;
            } else if(annArray.length > 0) {
                // All read, show the latest one as read-only
                const latest = annArray[0];
                const ackData = myAcks[latest.key];
                const date = new Date(latest.timestamp).toLocaleDateString('ar-EG');
                
                activeArea.innerHTML = `
                    <div class="announcement-card" style="border-color: var(--accent); background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);">
                        <div class="announcement-header">
                            <span class="ann-tag" style="background:var(--accent)"><i class="fa fa-check"></i> ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</span>
                            <span style="color:#94a3b8; font-size:0.9rem;">${date}</span>
                        </div>
                        <div class="announcement-body" style="opacity:0.8">${latest.text}</div>
                        <div class="announcement-footer">
                            <span class="ref-badge">Ø±Ù‚Ù… Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±: ${ackData ? ackData.refId : 'N/A'}</span>
                            <span style="color:var(--success); font-weight:bold;"><i class="fa fa-check-circle"></i> Ù„Ù‚Ø¯ Ø£Ù‚Ø±Ø±Øª Ø¨Ù‡Ø°Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹</span>
                        </div>
                    </div>
                `;
            }

            // Render History
            let historyHTML = '';
            annArray.forEach(ann => {
                const isAck = !!myAcks[ann.key];
                const date = new Date(ann.timestamp).toLocaleDateString('ar-EG');
                const ackInfo = isAck ? `<span style="color:var(--success)">Ù…ÙÙ‚Ø± (Ø§Ù„Ù…Ø±Ø¬Ø¹: ${myAcks[ann.key].refId})</span>` : '<span style="color:var(--warning)">ØºÙŠØ± Ù…ÙÙ‚Ø±</span>';
                
                historyHTML += `
                    <div class="history-item ${isAck ? 'acknowledged' : ''}">
                        <div class="history-meta">
                            <span>${date}</span>
                            ${ackInfo}
                        </div>
                        <div style="font-size:0.95rem;">${ann.text}</div>
                    </div>
                `;
            });
            historyList.innerHTML = historyHTML;
        }

        // --- Correction Modal Logic ---

        function openCorrectionModal(username, date) {
            correctionTarget = { username, date };
            document.getElementById('correctionModal').classList.add('active');
            // Reset selection
            document.querySelectorAll('input[name="corrType"]').forEach(el => el.checked = false);
            document.querySelectorAll('.correction-option').forEach(el => el.classList.remove('selected'));
        }

        function closeCorrectionModal() {
            document.getElementById('correctionModal').classList.remove('active');
            correctionTarget = { username: null, date: null };
        }

        function selectCorrectionOption(el) {
            // Visual selection logic
            document.querySelectorAll('.correction-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            // Check the radio inside
            el.querySelector('input').checked = true;
        }

        function submitCorrection() {
            const selected = document.querySelector('input[name="corrType"]:checked');
            if(!selected) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªØµØ­ÙŠØ­");
            
            const type = selected.value;
            const { username, date } = correctionTarget;
            
            let updates = {};

            // Logic for "Strike through" (Sick Leave) vs "Correction" (Mistake)
            if (type === 'Sick Leave') {
                updates[`users/${username}/attendance/${date}/status`] = 'Sick Leave';
            } 
            else if (type === 'Annual Leave') {
                updates[`users/${username}/attendance/${date}/status`] = 'Annual Leave';
            }
            else if (type === 'Present') {
                updates[`users/${username}/attendance/${date}/status`] = 'Present';
                const att = allUsersData[username].attendance[date];
                if(!att.clockIn) {
                    updates[`users/${username}/attendance/${date}/clockIn`] = '09:00'; 
                    updates[`users/${username}/attendance/${date}/note`] = 'Manual Correction';
                }
            }

            db.ref().update(updates).then(() => {
                closeCorrectionModal();
                renderAttendanceTable();
                showToast("ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­", `ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ${username} Ø¨Ù†Ø¬Ø§Ø­.`);
            });
        }

        // --- Display Tables ---

        function renderAttendanceTable() {
            let dateInput;
            if(currentUser.role === 'employee') {
                dateInput = todayStr;
            } else {
                dateInput = document.getElementById('attendanceDateView').value;
            }

            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            const dateKeyFb = dateInput; 
            
            let users = [];
            if(currentUser.role === 'admin') {
                users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));
            } else {
                users = [currentUser];
            }

            users.forEach(u => {
                const att = (u.attendance && u.attendance[dateKeyFb]) ? u.attendance[dateKeyFb] : null;
                
                let statusText = '--';
                let colorClass = 'bg-off';
                let icon = '';
                let timeClass = ''; // For strikethrough
                
                if(att && att.status) {
                    if(att.status === 'Present') { 
                        statusText = 'Present'; colorClass = 'bg-success'; icon = '<i class="fa fa-check"></i>'; 
                    }
                    else if(att.status === 'Late') { statusText = 'Late'; colorClass = 'bg-warning'; icon = '<i class="fa fa-clock"></i>'; }
                    else if(att.status === 'Absent') { statusText = 'Absent'; colorClass = 'bg-danger'; icon = '<i class="fa fa-xmark"></i>'; }
                    else if(att.status === 'Off') { statusText = 'Off'; colorClass = 'bg-off'; icon = '<i class="fa fa-coffee"></i>'; }
                    else if(att.status === 'Sick Leave') { 
                        statusText = 'Sick Leave'; colorClass = 'bg-warning'; icon = '<i class="fa fa-briefcase-medical"></i>'; 
                        timeClass = 'strike-text'; // STRIKE THROUGH THE TIME
                    }
                    else if(att.status === 'Annual Leave') { 
                        statusText = 'Annual Leave'; colorClass = 'bg-info'; icon = '<i class="fa fa-plane"></i>'; 
                        timeClass = 'strike-text';
                    }
                    else { statusText = att.status; icon = ''; } 
                }
                
                const statusBadge = `<span class="badge ${colorClass}">${icon} ${statusText}</span>`;

                // Apply strikethrough class to times if needed
                const clockIn = att ? (att.clockIn || '--:--') : '--:--';
                const clockOut = att ? (att.clockOut || '--:--') : '--:--';
                const timeDecoration = timeClass ? `class="${timeClass}"` : '';

                let actionBtn = '';
                if(currentUser.role === 'admin') {
                    actionBtn = `
                        <button class="btn btn-sm btn-accent" style="margin:0 5px;" onclick="openCorrectionModal('${u.username}', '${dateKeyFb}')">
                            <i class="fa fa-wrench"></i> ØªØµØ­ÙŠØ­
                        </button>
                    `;
                }

                // If admin, make row clickable hint
                const rowClass = (currentUser.role === 'admin') ? 'admin-editable' : '';
                const rowClick = (currentUser.role === 'admin') ? `onclick="openCorrectionModal('${u.username}', '${dateKeyFb}')"` : '';

                tbody.innerHTML += `
                    <tr class="${rowClass}" ${rowClick}>
                        <td class="english-text">${u.realName || u.username}</td>
                        <td>${statusBadge}</td>
                        <td style="font-family:monospace; font-size:1.1rem; direction:ltr" ${timeDecoration}>${clockIn}</td>
                        <td style="font-family:monospace; font-size:1.1rem; direction:ltr" ${timeDecoration}>${clockOut}</td>
                        ${currentUser.role === 'admin' ? `<td style="white-space:nowrap">${actionBtn}</td>` : ''}
                    </tr>
                `;
            });
        }

        function renderShiftsTable() {
            const thead = document.querySelector('#shiftsTable thead');
            const tbody = document.getElementById('shiftsTableBody');
            tbody.innerHTML = '';
            let baseDateStr;
            if(currentUser.role === 'employee') {
                baseDateStr = todayStr;
            } else {
                baseDateStr = document.getElementById('shiftDateView').value;
            }

            const weekKey = getWeekKey(baseDateStr);
            const saturdayDate = new Date(weekKey);
            const dayNamesEn = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            let headerHTML = '<tr><th class="english-text">Employee</th>';
            for(let i=0; i<7; i++) {
                let currentDayDate = new Date(saturdayDate);
                currentDayDate.setDate(saturdayDate.getDate() + i);
                const d = String(currentDayDate.getDate()).padStart(2, '0');
                const m = String(currentDayDate.getMonth() + 1).padStart(2, '0');
                const dateStr = `${d}/${m}`;
                const dayName = dayNamesEn[i];
                headerHTML += `<th class="english-text">${dayName} <br> <span style="font-size:0.8em">${dateStr}</span></th>`;
            }
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            let users = [];
            if(currentUser.role === 'admin') {
                users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));
                users.sort((a,b) => (a.realName || a.username).localeCompare(b.realName || b.username));
            } else {
                users = [currentUser];
            }

            users.forEach(u => {
                let row = `<tr><td class="english-text">${u.realName || u.username}</td>`;
                
                const userWeekData = (allScheduleData[u.username] && allScheduleData[u.username][weekKey]) 
                                      ? allScheduleData[u.username][weekKey] : {};

                for(let i=0; i<7; i++) {
                    const shift = userWeekData[i]; 
                    let cellContent = '<span style="color:#555; font-size:0.8rem">-</span>';

                    if(shift) {
                        if(shift === 'Off') {
                            cellContent = '<span class="badge bg-off english-text">Off</span>';
                        } else if(shift === 'Absent') {
                            cellContent = '<span class="badge bg-danger english-text">Absent</span>';
                        } else if(shift.includes('Leave')) {
                             cellContent = '<span class="badge bg-warning english-text">Leave</span>';
                        } else {
                            cellContent = `<span class="badge bg-info english-text" style="direction:ltr; display:inline-block">${shift}</span>`;
                        }
                    }
                    row += `<td>${cellContent}</td>`;
                }
                row += '</tr>';
                tbody.innerHTML += row;
            });
        }

        function renderReport() {
            const container = document.getElementById('reportContainer');
            const fromDateStr = document.getElementById('reportFromDate').value;
            const toDateStr = document.getElementById('reportToDate').value;

            if(!fromDateStr || !toDateStr) {
                container.innerHTML = '<p style="text-align:center; color:var(--danger);">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.</p>';
                return;
            }

            if(fromDateStr > toDateStr) {
                container.innerHTML = '<p style="text-align:center; color:var(--danger);">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.</p>';
                return;
            }

            let users = [];
            if(currentUser.role === 'admin') {
                users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));
                users.sort((a,b) => (a.realName || a.username).localeCompare(b.realName || b.username));
            } else {
                users = [currentUser];
            }

            if(users.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ø¹Ø±Ø¶</p>';
                return;
            }

            let htmlContent = '';
            const dayNamesAr = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'];

            let current = new Date(fromDateStr);
            const end = new Date(toDateStr);

            while(current <= end) {
                const dateStr = current.toISOString().split('T')[0];
                const dayIndex = (current.getDay() + 1) % 7;
                const weekKey = getWeekKey(dateStr);
                const dayName = dayNamesAr[dayIndex];

                users.forEach(user => {
                    const username = user.username;
                    const name = user.realName || username;

                    const att = (user.attendance && user.attendance[dateStr]) ? user.attendance[dateStr] : null;

                    const schedule = (allScheduleData[username] && allScheduleData[username][weekKey])
                                     ? allScheduleData[username][weekKey][dayIndex] : null;

                    let itemHTML = '';

                    // Logic for Report
                    if (schedule && (schedule === 'Off' || schedule.includes('Leave'))) {
                        if (att && att.status === 'Present') {
                            itemHTML = `
                                <div class="report-item success">
                                    <div class="report-text">
                                        <strong>${name}</strong> (${dateStr} - ${dayName}): <br>
                                        ÙƒØ§Ù† Ù…Ø¬Ø¯ÙˆÙ„ <strong>${schedule}</strong>ØŒ Ù„ÙƒÙ†Ù‡ <strong>Ø­Ø¶Ø± ÙˆØ¹Ù…Ù„</strong>.
                                    </div>
                                    <span class="report-badge bg-success">Ø¹Ù…Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</span>
                                </div>
                            `;
                        }
                    }
                    else if (schedule && schedule !== 'Off' && !schedule.includes('Absent') && !schedule.includes('Leave')) {
                        if (!att || att.status === 'Absent') {
                            itemHTML = `
                                <div class="report-item warning">
                                    <div class="report-text">
                                        <strong>${name}</strong> (${dateStr} - ${dayName}): <br>
                                        Ù…Ø¬Ø¯ÙˆÙ„ ÙˆØ±Ø¯ÙŠØ© <strong>${schedule}</strong>ØŒ ÙˆÙ„ÙƒÙ†Ù‡ <strong>ØºØ§Ø¦Ø¨</strong>.
                                    </div>
                                    <span class="report-badge bg-danger">ØºÙŠØ§Ø¨ ÙÙŠ ÙˆØ±Ø¯ÙŠØ©</span>
                                </div>
                            `;
                        }
                    }

                    if(itemHTML) {
                        htmlContent += itemHTML;
                    }
                });

                current.setDate(current.getDate() + 1);
            }

            if(htmlContent === '') {
                htmlContent = `<div style="text-align:center; padding:20px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø¶ÙˆØ± Ø¨ÙŠÙ† ${fromDateStr} Ùˆ ${toDateStr}.<br>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ØªØ²Ù…ÙˆØ§ Ø¨Ø¬Ø¯ÙˆÙ„Ù‡Ù….</div>`;
            }

            container.innerHTML = htmlContent;
        }

        function exportToExcel() {
            const fromDateStr = document.getElementById('reportFromDate').value;
            const toDateStr = document.getElementById('reportToDate').value;
            const searchName = document.getElementById('searchEmployeeName').value.trim().toLowerCase();

            if (!fromDateStr || !toDateStr) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            let reportData = [];
            let absentCount = 0;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ† (Ø·Ù‡ Ø£Ùˆ Ø§Ù„ÙƒÙ„)
            let usersToProcess = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));

            if (searchName) {
                usersToProcess = usersToProcess.filter(u =>
                    (u.realName && u.realName.toLowerCase().includes(searchName)) ||
                    u.username.toLowerCase().includes(searchName)
                );
            }

            let currentDate = new Date(fromDateStr);
            const endDate = new Date(toDateStr);

            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayIndex = (currentDate.getDay() + 1) % 7;
                const weekKey = getWeekKey(dateStr);

                usersToProcess.forEach(user => {
                    const schedule = (allScheduleData[user.username] && allScheduleData[user.username][weekKey])
                                     ? allScheduleData[user.username][weekKey][dayIndex] : null;

                    const att = (user.attendance && user.attendance[dateStr]) ? user.attendance[dateStr] : null;

                    // Ø§Ù„Ù…Ù†Ø·Ù‚: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ ÙˆØ±Ø¯ÙŠØ© (ÙˆÙ„ÙŠØ³ Ø¥Ø¬Ø§Ø²Ø©) ÙˆØ§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ§Ø¨ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„
                    const isWorkDay = schedule && schedule !== 'Off' && !schedule.includes('Leave');
                    const isAbsent = !att || att.status === 'Absent';

                    if (isWorkDay && isAbsent) {
                        absentCount++;
                        reportData.push({
                            "Ø§Ù„ØªØ§Ø±ÙŠØ®": dateStr,
                            "Ø§Ù„ÙŠÙˆÙ…": new Intl.DateTimeFormat('ar-EG', {weekday: 'long'}).format(currentDate),
                            "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù": user.realName || user.username,
                            "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©": schedule,
                            "Ø§Ù„Ø­Ø§Ù„Ø©": "ØºÙŠØ§Ø¨ ÙÙŠ ÙŠÙˆÙ… Ø¹Ù…Ù„"
                        });
                    }
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (reportData.length === 0) {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØºÙŠØ§Ø¨ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯.");
                return;
            }

            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© XLSX
            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨");

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            const fileName = `ØªÙ‚Ø±ÙŠØ±_ØºÙŠØ§Ø¨_${searchName || 'Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†'}_${fromDateStr}.xlsx`;
            XLSX.writeFile(wb, fileName);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø©
            document.getElementById('reportContainer').innerHTML = `
                <div class="report-item warning">
                    <div class="report-text">
                        ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ‚Ø±ÙŠØ± Ù„Ù€ (<strong>${searchName || 'Ø§Ù„ÙƒÙ„'}</strong>).
                        Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„: <strong>${absentCount}</strong> Ù…Ø±Ø©.
                    </div>
                </div>
            `;
        }

        function exportAbsencesOnNonWorkDays() {
            const fromDateStr = document.getElementById('reportFromDate').value;
            const toDateStr = document.getElementById('reportToDate').value;

            if (!fromDateStr || !toDateStr) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            let reportData = [];

            let users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));

            users.forEach(user => {
                let count = 0;
                let currentDate = new Date(fromDateStr);
                const endDate = new Date(toDateStr);

                while (currentDate <= endDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayIndex = (currentDate.getDay() + 1) % 7;
                    const weekKey = getWeekKey(dateStr);

                    const schedule = (allScheduleData[user.username] && allScheduleData[user.username][weekKey])
                                     ? allScheduleData[user.username][weekKey][dayIndex] : null;

                    const att = (user.attendance && user.attendance[dateStr]) ? user.attendance[dateStr] : null;

                    const isWorkDay = schedule && schedule !== 'Off' && !schedule.includes('Leave') && !schedule.includes('Absent');

                    if (!isWorkDay && att && att.status === 'Absent') {
                        count++;
                    }

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (count > 0) {
                    reportData.push({
                        "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù": user.realName || user.username,
                        "Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ ÙÙŠ Ø£ÙŠØ§Ù… ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„Ø©": count
                    });
                }
            });

            if (reportData.length === 0) {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØºÙŠØ§Ø¨ ÙÙŠ Ø£ÙŠØ§Ù… ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯.");
                return;
            }

            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ØºÙŠØ§Ø¨ ÙÙŠ Ø£ÙŠØ§Ù… ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„Ø©");

            const fileName = `ØºÙŠØ§Ø¨_ÙÙŠ_Ø£ÙŠØ§Ù…_ØºÙŠØ±_Ù…Ø¬Ø¯ÙˆÙ„Ø©_${fromDateStr}_Ø¥Ù„Ù‰_${toDateStr}.xlsx`;
            XLSX.writeFile(wb, fileName);

            document.getElementById('reportContainer').innerHTML = `
                <div class="report-item warning">
                    <div class="report-text">
                        ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØºÙŠØ§Ø¨ ÙÙŠ Ø£ÙŠØ§Ù… ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„Ø©.
                        Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØºØ§Ø¨ÙˆØ§ ÙÙŠ Ø£ÙŠØ§Ù… ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„Ø©: ${reportData.length}.
                    </div>
                </div>
            `;
        }

        function quickSetStatus(username, dateKey, status) {
            let msg = status === 'Present' ? 'Ø­Ø§Ø¶Ø±' : 'ØºØ§Ø¦Ø¨';
            if(!confirm(`ØªØ£ÙƒÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${msg}ØŸ`)) return;
            const updates = {};
            updates[`users/${username}/attendance/${dateKey}/status`] = status;
            if(status === 'Absent') {
                updates[`users/${username}/attendance/${dateKey}/clockIn`] = null;
                updates[`users/${username}/attendance/${dateKey}/clockOut`] = null;
            }
            db.ref().update(updates).then(() => renderAttendanceTable());
        }

        function startAttendanceListener() {
            db.ref('users').on('child_changed', (snapshot) => {
                const updatedUser = snapshot.val();
                const username = snapshot.key;
                if (username === currentUser.username) return;

                const todayKey = todayStr;
                if (updatedUser.attendance && updatedUser.attendance[todayKey]) {
                    const att = updatedUser.attendance[todayKey];
                    const name = updatedUser.realName || username;
                    if (att.clockIn && att.status !== 'Absent') {
                        showToast(`${name} Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„`, `Ø§Ù„ÙˆÙ‚Øª: ${att.clockIn}`);
                    }
                }
            });
        }

        function showToast(title, msg) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast success';
            t.innerHTML = `<div><h5>${title}</h5><p>${msg}</p></div>`;
            c.appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(),400); }, 5000);
        }

        function init() {
            db.ref('users').on('value', snap => {
                allUsersData = snap.val() || {};
                if(!currentUser) {
                    const savedU = localStorage.getItem('elshamaa_user');
                    const savedP = localStorage.getItem('elshamaa_pass');
                    if(savedU && savedP) attemptLogin(savedU, savedP);
                } else {
                    if(allUsersData[currentUser.username]) currentUser = allUsersData[currentUser.username];
                    // Refresh announcements if user data updates (acks change)
                    if(document.getElementById('tab-announcements').classList.contains('active')) {
                        renderAnnouncements();
                    }
                }
            });

            db.ref('schedules').on('value', snap => {
                allScheduleData = snap.val() || {};
                if(document.getElementById('tab-shifts').classList.contains('active')) {
                    renderShiftsTable();
                }
                if(document.getElementById('tab-report').classList.contains('active')) {
                    renderReport();
                }
            });

            // NEW: Announcements Listener
            db.ref('announcements').on('value', snap => {
                allAnnouncementsData = snap.val() || {};
                if(currentUser && document.getElementById('tab-announcements').classList.contains('active')) {
                    renderAnnouncements();
                }
            });
        }

        // 1. ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Excel Ù…ÙØµÙ„ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ
        function exportProfessionalExcel() {
            const fromDateStr = document.getElementById('reportFromDate').value;
            const toDateStr = document.getElementById('reportToDate').value;

            if (!fromDateStr || !toDateStr) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            let reportData = [];
            let users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));

            let currentDate = new Date(fromDateStr);
            const endDate = new Date(toDateStr);

            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayIndex = (currentDate.getDay() + 1) % 7;
                const weekKey = getWeekKey(dateStr);
                const dayNameAr = new Intl.DateTimeFormat('ar-EG', { weekday: 'long' }).format(currentDate);

                users.forEach(user => {
                    const att = (user.attendance && user.attendance[dateStr]) ? user.attendance[dateStr] : null;
                    const schedule = (allScheduleData[user.username] && allScheduleData[user.username][weekKey])
                                     ? allScheduleData[user.username][weekKey][dayIndex] : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

                    reportData.push({
                        "Ø§Ù„ØªØ§Ø±ÙŠØ®": dateStr,
                        "Ø§Ù„ÙŠÙˆÙ…": dayNameAr,
                        "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù": user.realName || user.username,
                        "Ø§Ù„Ø­Ø§Ù„Ø©": att ? (att.status || "Ù…Ø³Ø¬Ù„") : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„",
                        "ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±": att ? (att.clockIn || "--") : "--",
                        "ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù": att ? (att.clockOut || "--") : "--",
                        "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©": schedule
                    });
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ");
            XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø´Ù…Ø¹Ø©_Ø§Ù„Ù…ÙØµÙ„_${fromDateStr}.xlsx`);
            showToast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±", "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­");
        }

        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ÙŠÙ† ÙÙ‚Ø· ÙˆØ§Ù„Ø°ÙŠÙ† ØªØºÙŠØ¨ÙˆØ§
        function exportAbsencesOnNonWorkDays() {
            const fromDateStr = document.getElementById('reportFromDate').value;
            const toDateStr = document.getElementById('reportToDate').value;

            if (!fromDateStr || !toDateStr) {
                alert("ÙŠØ§ Ø±ÙŠØ³ØŒ Ø­Ø¯Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù† ÙˆØ¥Ù„Ù‰) Ø§Ù„Ø£ÙˆÙ„!");
                return;
            }

            let reportData = [];
            let users = Object.values(allUsersData).filter(u => u.username && !MANAGERS.includes(u.username));

            let currentDate = new Date(fromDateStr);
            const endDate = new Date(toDateStr);

            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayIndex = (currentDate.getDay() + 1) % 7;
                const weekKey = getWeekKey(dateStr);
                const dayNameAr = new Intl.DateTimeFormat('ar-EG', { weekday: 'long' }).format(currentDate);

                users.forEach(user => {
                    const att = (user.attendance && user.attendance[dateStr]) ? user.attendance[dateStr] : null;
                    const schedule = (allScheduleData[user.username] && allScheduleData[user.username][weekKey])
                                     ? allScheduleData[user.username][weekKey][dayIndex] : null;

                    // 1. ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø´Ø®Øµ Ø¹Ù†Ø¯Ù‡ ÙˆØ±Ø¯ÙŠØ© ÙØ¹Ù„Ø§Ù‹ (Ù…Ø´ Off ÙˆÙ…Ø´ ÙØ§Ø¶ÙŠ)
                    const hasScheduledShift = schedule && schedule !== 'Off' && !schedule.includes('Leave');

                    // 2. ÙØ­Øµ Ù‡Ù„ Ù‡Ùˆ ØºØ§Ø¦Ø¨ (Ø¥Ù…Ø§ Ø­Ø§Ù„ØªÙ‡ Absent Ø£Ùˆ Ù…ÙÙŠØ´ Ø³Ø¬Ù„ Ø®Ø§Ù„Øµ ÙˆÙ‡Ùˆ Ø¹Ù†Ø¯Ù‡ ÙˆØ±Ø¯ÙŠØ©)
                    const isAbsent = (att && att.status === 'Absent') || (!att && hasScheduledShift);

                    // Ø§Ù„Ø´Ø±Ø· Ø¨ØªØ§Ø¹Ùƒ: "Ù„Ùˆ Ø¹Ù†Ø¯Ù‡ ÙˆØ±Ø¯ÙŠØ© ÙŠÙ†Ø²Ù„ Ù„ÙŠØ§ Ø¨Ø³.. Ø¥Ù†Ù…Ø§ Ù„Ùˆ Ù…Ø¹Ù†Ø¯ÙˆØ´ Ù…ÙŠÙ†Ø²Ù„Ø´"
                    if (hasScheduledShift && isAbsent) {
                        reportData.push({
                            "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù": user.realName || user.username,
                            "Ø§Ù„ØªØ§Ø±ÙŠØ®": dateStr,
                            "Ø§Ù„ÙŠÙˆÙ…": dayNameAr,
                            "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©": schedule,
                            "Ø§Ù„Ø­Ø§Ù„Ø©": "ØºØ§Ø¦Ø¨ Ø¹Ù† ÙˆØ±Ø¯ÙŠØªÙ‡ âŒ"
                        });
                    }
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (reportData.length === 0) {
                alert("Ù…Ù„Ù‚ØªØ´ Ø£ÙŠ Ø­Ø§Ù„Ø§Øª ØºÙŠØ§Ø¨ Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¹Ù†Ø¯Ù‡Ù… ÙˆØ±Ø¯ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø¯ÙŠ.");
                return;
            }

            try {
                const ws = XLSX.utils.json_to_sheet(reportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ÙŠÙ†");
                XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_ØºÙŠØ§Ø¨_Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ÙŠÙ†_${fromDateStr}.xlsx`);
                showToast("ØªÙ… Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬", "Ø§Ù„Ø´ÙŠØª Ø¬Ø§Ù‡Ø² ÙˆÙÙŠÙ‡ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ÙŠÙ† Ø§Ù„Ù„ÙŠ ØºØ§Ø¨ÙˆØ§ Ø¨Ø³.");
            } catch (err) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
            }
        }

        // 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ø°ÙƒÙŠØ© (ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        function runSmartArchiving() {
            if (!confirm("Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ù…Ø± Ø¹Ù„ÙŠÙ‡Ø§ Ø£ÙƒØ«Ø± Ù…Ù† 60 ÙŠÙˆÙ…Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;

            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
            
            let archiveCount = 0;
            const updates = {};

            Object.keys(allUsersData).forEach(username => {
                const attendance = allUsersData[username].attendance;
                if (attendance) {
                    Object.keys(attendance).forEach(dateKey => {
                        const recordDate = new Date(dateKey);
                        if (recordDate < sixtyDaysAgo) {
                            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ø£Ø±Ø´ÙŠÙ
                            updates[`archives/${username}/${dateKey}`] = attendance[dateKey];
                            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø·
                            updates[`users/${username}/attendance/${dateKey}`] = null;
                            archiveCount++;
                        }
                    });
                }
            });

            if (archiveCount === 0) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø£Ø±Ø´ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.");
                return;
            }

            db.ref().update(updates).then(() => {
                alert(`ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ù†Ù‚Ù„ ${archiveCount} Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.`);
            }).catch(err => {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ©:", err);
                alert("ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙØ©.");
            });
        }

        init();

    </script>
</body>
</html>
