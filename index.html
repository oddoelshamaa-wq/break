<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ² -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --meeting-color: #f39c12;
            --prayer-color: #2980b9;
            --emergency-color: #c0392b;
            --dark-text: #2d3436;
            --light-bg: #ecf0f1;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            color: var(--dark-text);
        }

        /* ÙˆÙ…ÙŠØ¶ Ø£Ø­Ù…Ø± */
        @keyframes flash-red {
            0% { background-color: #ffcccc; box-shadow: inset 0 0 0 0 red; }
            50% { background-color: #ff0000; box-shadow: inset 0 0 50px 20px red; }
            100% { background-color: #ffcccc; box-shadow: inset 0 0 0 0 red; }
        }

        .alarm-mode {
            background: none !important;
            animation: flash-red 0.8s infinite;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        h2, h3 { color: #2c3e50; text-align: center; font-weight: 700; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            color: white;
            transition: all 0.3s ease;
            margin: 3px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .btn-primary { background: linear-gradient(45deg, #2980b9, #3498db); }
        .btn-danger { background: linear-gradient(45deg, #c0392b, #e74c3c); }
        .btn-success { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .btn-warning { background: linear-gradient(45deg, #f39c12, #f1c40f); color: #fff; }
        .btn-info { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
        .btn-dark { background: #2d3436; }
        .btn-purple { background: linear-gradient(45deg, #8e44ad, #9b59b6); } 
        .btn-emergency { background: linear-gradient(45deg, #c0392b, #e74c3c); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } 100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } }

        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-family: 'Cairo', sans-serif;
        }
        input:focus { outline: none; border-color: var(--primary-color); }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            font-size: 0.95rem;
        }
        th { background: #2c3e50; color: white; padding: 15px; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background-color: #f8f9fa; }

        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; flex-wrap: wrap;}
        .hidden { display: none !important; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .bg-red { background-color: #ff7675; color: white; }
        .bg-green { background-color: #55efc4; color: #2d3436; }
        .bg-orange { background-color: #f39c12; color: white; }
        .bg-blue { background-color: #3498db; color: white; }
        .bg-purple { background-color: #9b59b6; color: white; }
        .bg-dark-red { background-color: #c0392b; color: white; }
        
        .timer-display { font-size: 3.5rem; font-weight: 800; color: var(--primary-color); margin: 15px 0; }
        .timer-label { font-size: 1.2rem; color: #777; margin-bottom: 5px; }

        .employee-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .control-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: #f8f9fa;
        }
        .control-card:hover { transform: translateY(-5px); }
        
        .card-general { border-color: var(--success-color); }
        .card-prayer { border-color: var(--prayer-color); }
        .card-meeting { border-color: var(--meeting-color); }
        .card-emergency { border-color: var(--emergency-color); background: #fff0f0; }

        .filter-box {
            background: #f1f2f6; padding: 20px; border-radius: 15px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; align-items: end; border: 1px solid #ddd;
        }

        .online-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .dot-green { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .dot-grey { background-color: #95a5a6; }

        .settings-box {
            background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;
        }

        .manager-info {
            background: #2d3436; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
        #overtimeReportTable th { background-color: #8e44ad; }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loading">
    <div class="loader"></div>
    <h3 style="color: var(--primary-color);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</h3>
</div>

<!-- ============ Ø§Ù„Ø£ØµÙˆØ§Øª ============ -->
<!-- ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ÙˆØ¸Ù Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚ØªÙ‡ -->
<audio id="alarmSound" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<!-- ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ· Ù„Ù„Ù…Ø¯ÙŠØ± (Ø¯Ø®ÙˆÙ„ Ø¨Ø±ÙŠÙƒ Ø¬Ø¯ÙŠØ¯) -->
<audio id="notifySound">
    <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mp3">
</audio>

<!-- ØµÙˆØª Ø±Ù†ÙŠÙ† Ù…Ø³ØªÙ…Ø± Ù„Ù„Ù…Ø¯ÙŠØ± (Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©) -->
<audio id="requestRing" loop>
    <source src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" type="audio/mp3">
</audio>
<!-- ================================= -->

<div class="container hidden" id="mainContainer">
    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginSection">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: var(--primary-color);">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h1>
            <p style="font-size: 1.1rem; color: #555;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª ÙˆØ§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</p>
        </div>
        <div style="max-width: 400px; margin: auto; padding: 30px; background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border-radius: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" id="loginUser" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            
            <label style="display:block; margin-bottom:5px; font-weight:bold;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="loginPass" placeholder="******">
            
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; margin-top: 20px; padding: 12px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† -->
    <div id="adminSection" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <div>
                <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸš€</h2>
                <span id="currentManagerDisplay" class="manager-info"></span>
                <!-- Ø²Ø± Ù„ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø²Ø¹Ø¬Ø§Ù‹ -->
                <button onclick="toggleAdminMute()" class="btn btn-sm btn-info" id="muteBtn" style="margin-right:10px">ğŸ”Š Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„</button>
            </div>
            <button onclick="logout()" class="btn btn-dark">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸ”’</button>
        </div>

        <div class="nav-tabs">
            <button onclick="switchAdminTab('monitor')" class="btn btn-primary">ğŸ“¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­ÙŠØ©</button>
            <button onclick="switchAdminTab('requests')" class="btn btn-emergency">ğŸš¨ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ <span id="badgeEmergency" class="status-badge bg-red hidden">!</span></button>
            <button onclick="switchAdminTab('overtime')" class="btn btn-purple">ğŸ•’ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… <span id="badgeOvertime" class="status-badge bg-red hidden">!</span></button>
            <button onclick="switchAdminTab('reports')" class="btn btn-warning">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</button>
            <button onclick="switchAdminTab('users')" class="btn btn-success">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© -->
        <div id="tab-monitor">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¢Ù†</h3>
                <button onclick="endDay()" class="btn btn-danger">ğŸ›‘ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
            </div>
            <div id="activeBreakCount" style="text-align:center; margin:10px 0; font-weight:bold; color:var(--primary-color);"></div>
            <table id="monitorTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù… (Ù…ØªØ¨Ù‚ÙŠ)</th>
                        <th>ØµÙ„Ø§Ø©</th>
                        <th>Ù…ÙŠØªÙ†Ø¬</th>
                        <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="monitorBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© -->
        <div id="tab-requests" class="hidden">
            <h3>ğŸš¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
            <table id="emergencyRequestsTable">
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="emergencyRequestsBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="tab-overtime" class="hidden">
            <h3>âš™ï¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <div class="settings-box">
                <label style="font-weight:bold;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù…:</label>
                <div style="display:flex; max-width:300px; margin:10px auto; gap:10px;">
                    <input type="number" id="maxBreaksInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: 2" style="margin:0;">
                    <button onclick="saveSettings()" class="btn btn-success">Ø­ÙØ¸</button>
                </div>
            </div>
            <table id="overtimeRequestsTable">
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th><th>ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="overtimeRequestsBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <div id="tab-reports" class="hidden">
            <h3>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„</h3>
            <div class="filter-box">
                <div><label>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù:</label><select id="reportUserSelect"><option value="">-- Ø§Ø®ØªØ± --</option></select></div>
                <div><label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label><input type="date" id="filterStartDate"></div>
                <div><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label><input type="date" id="filterEndDate"></div>
                <div><button onclick="renderUserReport()" class="btn btn-primary" style="width: 100%;">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ğŸ”</button></div>
            </div>
            
            <div style="margin-top:30px; border: 2px solid #8e44ad; border-radius: 10px; padding: 10px; background: #fbf6ff;">
                <h4 style="color: #8e44ad;">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Audit Log)</h4>
                <div id="overtimeStats" style="text-align: center; margin-bottom: 10px; font-weight: bold;"></div>
                <table id="overtimeReportTable">
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                            <th>ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¨ÙˆØ§Ø³Ø·Ø© (Ø§Ù„Ù…Ø¯ÙŠØ±)</th>
                        </tr>
                    </thead>
                    <tbody id="overtimeReportBody"></tbody>
                </table>
            </div>

            <div style="margin-top:30px;">
                <h4>ğŸ—“ï¸ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¨Ø±ÙŠÙƒØ§Øª</h4>
                <table id="reportTable">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø±ÙŠÙƒ</th><th>ØµÙ„Ø§Ø©</th><th>Ù…ÙŠØªÙ†Ø¬</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆÙØ± ØªØ§ÙŠÙ… (Ù„Ù„ÙŠÙˆÙ…)</th></tr></thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="tab-users" class="hidden">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px dashed #ccc; margin-bottom: 20px;">
                <h4 style="margin-top:0; color: var(--primary-color);">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="newRealName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
                    <input type="text" id="newUsername" placeholder="User Name">
                    <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <input type="number" id="newAllowance" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… (Ø¯Ù‚ÙŠÙ‚Ø©)" value="45">
                </div>
                <button onclick="saveUser()" class="btn btn-success" style="width:100%; margin-top:10px;">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            </div>
            <table id="usersManagementTable">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>User</th><th>Pass</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="usersManagementBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div id="employeeSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <h4 id="welcomeMsg" style="margin:0;"></h4>
             <button onclick="logout()" class="btn btn-dark btn-sm">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div style="text-align: center;">
            <div style="background: #f1f2f6; padding: 20px; border-radius: 30px; margin: 20px auto; max-width: 600px;">
                <div id="timerLabel" class="timer-label">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</div>
                <div class="timer-display" id="userTimer">00:00</div>
                <h3 id="userStatusMsg"></h3>
                <div id="overtimeAlert" class="hidden status-badge bg-red" style="font-size: 1.2rem; padding: 10px;">ØªØ¬Ø§ÙˆØ²Øª ÙˆÙ‚Øª Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…Ø³Ù…ÙˆØ­!</div>
            </div>

            <div id="controlsArea">
                <div style="max-width: 400px; margin: auto; margin-bottom: 15px;">
                    <input type="text" id="breakReason" placeholder="Ø£ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù‡Ù†Ø§..." style="text-align: center;">
                </div>

                <div class="employee-controls">
                    <div class="control-card card-general">
                        <h4>ğŸ” Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…</h4>
                        <button onclick="startMyBreak('general')" class="btn btn-success" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>
                    <div class="control-card card-prayer">
                        <h4>ğŸ•Œ ØµÙ„Ø§Ø©</h4>
                        <button onclick="startMyBreak('prayer')" class="btn btn-info" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>
                    <div class="control-card card-meeting">
                        <h4>ğŸ¤ Ù…ÙŠØªÙ†Ø¬</h4>
                        <button onclick="startMyBreak('meeting')" class="btn btn-warning" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>
                    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ -->
                    <div class="control-card card-emergency">
                        <h4>ğŸš¨ Ø®Ø±ÙˆØ¬ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ</h4>
                        <p style="font-size:0.75rem; color:#c0392b;">ÙŠØªØ·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</p>
                        <div id="emergencyStatusArea">
                            <button onclick="requestEmergency()" id="btnReqEmergency" class="btn btn-dark btn-sm" style="width:100%">Ø·Ù„Ø¨ Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; border-top: 2px dashed #ddd; padding-top: 20px;">
                    <h4 style="color: #8e44ad;">ğŸ’¼ Ø·Ù„Ø¨ Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠ (Overtime)</h4>
                    <div id="overtimeRequestForm">
                        <div style="display:flex; max-width:400px; margin:auto; gap:10px;">
                            <input type="number" id="otHours" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª" style="margin:0;">
                            <button onclick="requestOvertime()" class="btn btn-purple">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                        </div>
                    </div>
                    <div id="overtimeStatus" style="margin-top:10px; font-weight:bold;"></div>
                </div>
            </div>

            <div id="stopArea" class="hidden" style="margin-top: 20px;">
                <button onclick="stopMyBreak()" class="btn btn-danger" style="padding: 15px 40px; font-size: 1.5rem; width: 100%; max-width: 300px;">ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ²
    const firebaseConfig = {
        apiKey: "AIzaSyC2J8fVx7qAz_g33gUNQxXMEJHsWeFrjuk",
        authDomain: "break-3ccd9.firebaseapp.com",
        projectId: "break-3ccd9",
        storageBucket: "break-3ccd9.firebasestorage.app",
        messagingSenderId: "785237776836",
        appId: "1:785237776836:web:0a0062bf07359391fd6c91",
        databaseURL: "https://break-3ccd9-default-rtdb.firebaseio.com/"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch (e) { console.error(e); }

    let allUsersData = {};
    let globalSettings = { maxGeneralBreaks: 100 };
    let currentUser = null; 
    let timerInterval = null;
    let isDataLoaded = false;
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª
    let previousBreakStates = {}; // Ù„ØªØªØ¨Ø¹ Ù…Ù† ÙƒØ§Ù† ÙÙŠ Ø¨Ø±ÙŠÙƒ Ø³Ø§Ø¨Ù‚Ø§Ù‹
    let adminSoundMuted = false;  // Ø²Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø¯ÙŠØ±
    let isFirstLoadSound = true; // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£ØµÙˆØ§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const MANAGERS_CONFIG = [
        { username: 'mahmoud', name: 'Ù…Ø­Ù…ÙˆØ¯', pass: '112233' },
        { username: 'abutamim', name: 'Ø£Ø¨Ùˆ ØªÙ…ÙŠÙ…', pass: '445566' },
        { username: 'ahmed', name: 'Ø£Ø­Ù…Ø¯ ÙŠØ­ÙŠÙ‰', pass: '778899' }
    ];

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function initManagers() {
        MANAGERS_CONFIG.forEach(m => {
            db.ref('users/' + m.username).once('value', snap => {
                if (!snap.exists()) {
                    db.ref('users/' + m.username).set({
                        username: m.username,
                        realName: m.name,
                        password: m.pass,
                        role: "admin",
                        state: "offline"
                    });
                } else {
                    db.ref('users/' + m.username).update({
                        realName: m.name,
                        role: 'admin',
                        password: m.pass 
                    });
                }
            });
        });
    }

    db.ref('settings').on('value', snap => {
        if(snap.val()) {
            globalSettings = snap.val();
            document.getElementById('maxBreaksInput').value = globalSettings.maxGeneralBreaks || '';
        }
    });

    // ============================================
    // Ø§Ù„Ù…ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙˆÙ‡Ù†Ø§ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ØµÙˆØ§Øª)
    // ============================================
    db.ref('users').on('value', (snapshot) => {
        const data = snapshot.val();
        allUsersData = data || {};
        
        if (!isDataLoaded) {
            isDataLoaded = true;
            initManagers(); 
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('hidden');
            checkSavedSession();
            
            // Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ØŒ Ù†Ø®Ø²Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ±Ù†Ø´
            Object.values(allUsersData).forEach(u => {
                previousBreakStates[u.username] = u.isOnBreak;
            });
            isFirstLoadSound = false;
        }

        // ============ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ============
        if (currentUser && currentUser.role === 'admin') {
            let hasPendingRequests = false;
            let someoneStartedBreak = false;

            Object.values(allUsersData).forEach(u => {
                // 1. ÙØ­Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Ø£ÙˆÙØ± ØªØ§ÙŠÙ… Ø£Ùˆ Ø®Ø±ÙˆØ¬ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ)
                if ((u.emergencyRequest && u.emergencyRequest.status === 'pending') || 
                    (u.overtimeRequest && u.overtimeRequest.status === 'pending')) {
                    hasPendingRequests = true;
                }

                // 2. ÙØ­Øµ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØµÙˆØª Ø¨Ø³ÙŠØ·)
                if (u.isOnBreak && !previousBreakStates[u.username] && !isFirstLoadSound) {
                    someoneStartedBreak = true;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                previousBreakStates[u.username] = u.isOnBreak;
            });

            const ringAudio = document.getElementById('requestRing');
            const notifyAudio = document.getElementById('notifySound');

            if (!adminSoundMuted) {
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                if (hasPendingRequests) {
                    if (ringAudio.paused) {
                        ringAudio.currentTime = 0;
                        ringAudio.play().catch(e => console.log("Audio permission needed"));
                    }
                } else {
                    ringAudio.pause();
                    ringAudio.currentTime = 0;
                }

                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù‚ØµÙŠØ± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø¨Ø±ÙŠÙƒ
                if (someoneStartedBreak) {
                    notifyAudio.currentTime = 0;
                    notifyAudio.play().catch(e => console.log("Audio permission needed"));
                }
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙƒØªÙˆÙ…ØŒ ÙˆÙ‚Ù ÙƒÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
                ringAudio.pause();
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ (Badges)
            let pendingEm = Object.values(allUsersData).some(u => u.emergencyRequest && u.emergencyRequest.status === 'pending');
            let pendingOt = Object.values(allUsersData).some(u => u.overtimeRequest && u.overtimeRequest.status === 'pending');
            
            if(pendingEm) document.getElementById('badgeEmergency').classList.remove('hidden');
            else document.getElementById('badgeEmergency').classList.add('hidden');
            
            if(pendingOt) document.getElementById('badgeOvertime').classList.remove('hidden');
            else document.getElementById('badgeOvertime').classList.add('hidden');
        }
        // ========================================================

        if(!document.getElementById('adminSection').classList.contains('hidden')) {
            renderMonitorTable();
            renderUserManagementTable();
            renderOvertimeRequests();
            renderEmergencyRequests();
            updateReportSelect();
        }
        
        if(currentUser && allUsersData[currentUser.username]) {
            const updated = allUsersData[currentUser.username];
            updated.role = currentUser.role; 
            currentUser = updated;
            if(currentUser.role !== 'admin') updateUserUI();
        }
    });

    // --- ÙˆØ¸ÙŠÙØ© ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø¯ÙŠØ± ---
    function toggleAdminMute() {
        adminSoundMuted = !adminSoundMuted;
        const btn = document.getElementById('muteBtn');
        const ring = document.getElementById('requestRing');
        
        if (adminSoundMuted) {
            btn.innerText = "ğŸ”‡ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ…";
            btn.classList.replace('btn-info', 'btn-secondary');
            ring.pause();
        } else {
            btn.innerText = "ğŸ”Š Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„";
            btn.classList.replace('btn-secondary', 'btn-info');
        }
    }

    // --- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
    function checkSavedSession() {
        const savedUser = localStorage.getItem('break_sys_user');
        
        if(savedUser && allUsersData[savedUser]) {
            currentUser = allUsersData[savedUser];
            const isManager = MANAGERS_CONFIG.some(m => m.username === savedUser) || currentUser.role === 'admin';
            
            if (isManager) {
                currentUser.role = 'admin';
                showAdmin();
            } else {
                currentUser.role = 'employee';
                setupPresence(savedUser);
                showEmployee();
            }
        } else {
            showSection('loginSection');
        }
    }

    function attemptLogin() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        
        if(allUsersData[u] && allUsersData[u].password === p) {
            currentUser = allUsersData[u];
            
            if(currentUser.role === 'admin') {
                localStorage.setItem('break_sys_user', u);
                showAdmin();
            } else {
                localStorage.setItem('break_sys_user', u);
                setupPresence(u);
                showEmployee();
            }
        } else {
            alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        }
    }

    function setupPresence(username) {
        const connectedRef = db.ref(".info/connected");
        const userStatusRef = db.ref("users/" + username + "/state");
        connectedRef.on("value", (snap) => {
            if (snap.val() === false) return;
            userStatusRef.onDisconnect().set("offline").then(() => userStatusRef.set("online"));
        });
    }

    function showSection(id) {
        ['loginSection','adminSection','employeeSection'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function logout() { 
        if(currentUser && currentUser.role !== 'admin') {
            db.ref("users/" + currentUser.username + "/state").set("offline");
        }
        localStorage.removeItem('break_sys_user'); 
        currentUser=null; 
        clearInterval(timerInterval); 
        showSection('loginSection'); 
        stopAlarm();
        // Ø¥ÙŠÙ‚Ø§Ù Ø£ØµÙˆØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø£ÙŠØ¶Ø§Ù‹
        document.getElementById('requestRing').pause();
    }

    function showAdmin() { 
        showSection('adminSection'); 
        document.getElementById('currentManagerDisplay').innerText = `ğŸ‘¤ ${currentUser.realName}`;
        switchAdminTab('monitor'); 
        startTimer(); 
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„ÙÙˆØ±ÙŠ
        Object.values(allUsersData).forEach(u => {
            previousBreakStates[u.username] = u.isOnBreak;
        });
    }
    function showEmployee() { showSection('employeeSection'); initUserDash(); }
    
    function switchAdminTab(tab) {
        ['tab-monitor','tab-reports','tab-users', 'tab-overtime', 'tab-requests'].forEach(t => document.getElementById(t).classList.add('hidden'));
        document.getElementById('tab-'+tab).classList.remove('hidden');
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(!document.getElementById('adminSection').classList.contains('hidden')) renderMonitorTable();
            if(!document.getElementById('employeeSection').classList.contains('hidden')) updateUserUI();
        }, 1000);
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ (Admin) ---
    function renderEmergencyRequests() {
        const tbody = document.getElementById('emergencyRequestsBody');
        tbody.innerHTML = '';
        let count = 0;

        Object.values(allUsersData).forEach(u => {
            if(u.emergencyRequest && u.emergencyRequest.status === 'pending') {
                count++;
                tbody.innerHTML += `
                    <tr>
                        <td>${u.realName}</td>
                        <td style="color:red; font-weight:bold;">${u.emergencyRequest.reason}</td>
                        <td>${new Date(u.emergencyRequest.timestamp).toLocaleTimeString('ar-EG')}</td>
                        <td>
                            <button onclick="handleEmergency('${u.username}', true)" class="btn btn-success btn-sm">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                            <button onclick="handleEmergency('${u.username}', false)" class="btn btn-danger btn-sm">Ø±ÙØ¶</button>
                        </td>
                    </tr>
                `;
            }
        });
        if(count === 0) tbody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
    }

    window.handleEmergency = (username, approved) => {
        if(!currentUser || currentUser.role !== 'admin') return alert("ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø¯ÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø©");
        
        const updates = {};
        updates[`users/${username}/emergencyRequest/status`] = approved ? 'approved' : 'rejected';
        updates[`users/${username}/emergencyRequest/approvedBy`] = currentUser.realName; 
        
        db.ref().update(updates).then(() => {
             // Ø§Ù„ØµÙˆØª Ø³ÙŠØªÙˆÙ‚Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù… ØªØ¹Ø¯ pending
             // alert(approved ? "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨" : "ØªÙ… Ø§Ù„Ø±ÙØ¶");
        });
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… (Admin) ---
    function renderOvertimeRequests() {
        const tbody = document.getElementById('overtimeRequestsBody');
        tbody.innerHTML = '';
        
        Object.values(allUsersData).forEach(u => {
            if(u.overtimeRequest && u.overtimeRequest.status === 'pending') {
                tbody.innerHTML += `
                    <tr>
                        <td>${u.realName}</td>
                        <td style="font-weight:bold; color:#8e44ad;">${u.overtimeRequest.hours} Ø³Ø§Ø¹Ø§Øª</td>
                        <td>${new Date(u.overtimeRequest.timestamp).toLocaleTimeString('ar-EG')}</td>
                        <td>
                            <button onclick="handleOvertime('${u.username}', true)" class="btn btn-success btn-sm">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                            <button onclick="handleOvertime('${u.username}', false)" class="btn btn-danger btn-sm">Ø±ÙØ¶</button>
                        </td>
                    </tr>
                `;
            }
        });
        if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
    }

    window.handleOvertime = (username, approved) => {
        const req = allUsersData[username].overtimeRequest;
        if(!req) return;
        
        const updates = {};
        updates[`users/${username}/overtimeRequest/status`] = approved ? 'approved' : 'rejected';
        updates[`users/${username}/overtimeRequest/handledBy`] = currentUser.realName;

        if(approved) {
            const currentBalance = allUsersData[username].approvedOvertimeBalance || 0;
            updates[`users/${username}/approvedOvertimeBalance`] = currentBalance + parseFloat(req.hours);
            
            const historyKey = Date.now();
            updates[`users/${username}/overtimeHistory/${historyKey}`] = {
                date: new Date().toLocaleDateString('ar-EG'),
                hours: parseFloat(req.hours),
                approvedBy: currentUser.realName 
            };
        }
        
        db.ref().update(updates); // Ø³ÙŠØªÙˆÙ‚Ù Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    };

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
    function renderUserManagementTable() {
        const tbody = document.getElementById('usersManagementBody');
        tbody.innerHTML = '';
        Object.values(allUsersData).forEach(u => {
            if(u.role === 'admin') return; 
            tbody.innerHTML += `
                <tr>
                    <td>${u.realName}</td>
                    <td>${u.username}</td>
                    <td>${u.password}</td>
                    <td>${u.allowance} Ø¯Ù‚ÙŠÙ‚Ø©</td>
                    <td><button onclick="deleteUser('${u.username}')" class="btn btn-danger btn-sm">Ø­Ø°Ù</button></td>
                </tr>`;
        });
    }

    function saveUser() {
        const u = document.getElementById('newUsername').value.trim();
        const p = document.getElementById('newPassword').value;
        const n = document.getElementById('newRealName').value;
        const a = parseInt(document.getElementById('newAllowance').value);

        if(!u || !p || !n) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        if(allUsersData[u]) return alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯!");
        
        db.ref('users/' + u).set({
            username: u, realName: n, password: p, allowance: a,
            role: 'employee', state: 'offline'
        }).then(() => alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­"));
    }

    window.deleteUser = (u) => { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ")) db.ref('users/'+u).remove(); }
    window.saveSettings = () => {
        const max = document.getElementById('maxBreaksInput').value;
        db.ref('settings').update({ maxGeneralBreaks: parseInt(max) }).then(()=>alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"));
    }

    // --- Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ---
    function renderMonitorTable() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        let activeGeneralBreaks = 0;

        Object.values(allUsersData).forEach(u => {
            if(u.role === 'admin') return; 

            let gen = u.usedSeconds || 0;
            let currentDuration = 0;

            if (u.isOnBreak && u.lastStartTime) {
                currentDuration = Math.floor((Date.now() - u.lastStartTime) / 1000);
                if (u.breakType === 'general' || u.breakType === 'emergency') {
                    gen += currentDuration;
                    if(u.breakType === 'general') activeGeneralBreaks++;
                }
            }

            const isOnline = u.state === 'online';
            const onlineIndicator = `<span class="online-dot ${isOnline ? 'dot-green' : 'dot-grey'}"></span>`;

            let statusBadge = '<span class="status-badge bg-green">Ù…ØªØ§Ø­</span>';
            if (u.isOnBreak) {
                if (u.breakType === 'general') statusBadge = `<span class="status-badge bg-red">â›” Ø¨Ø±ÙŠÙƒ (${u.lastReason})</span>`;
                else if (u.breakType === 'prayer') statusBadge = `<span class="status-badge bg-blue">ğŸ•Œ ÙŠØµÙ„ÙŠ</span>`;
                else if (u.breakType === 'meeting') statusBadge = `<span class="status-badge bg-orange">ğŸ¤ Ù…ÙŠØªÙ†Ø¬</span>`;
                else if (u.breakType === 'emergency') statusBadge = `<span class="status-badge bg-dark-red">ğŸš¨ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ</span>`;
            }

            const allowanceSec = u.allowance * 60;
            const remaining = allowanceSec - gen;
            const remDisplay = remaining >= 0 ? formatTime(remaining) : `<span style="color:red; font-weight:bold;">${formatTime(Math.abs(remaining))}</span>`;

            const actionBtn = u.isOnBreak ? `<button onclick="forceStop('${u.username}')" class="btn btn-warning btn-sm">Ø¥Ù†Ù‡Ø§Ø¡</button>` : '-';

            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold">${u.realName} ${onlineIndicator}</td>
                    <td>${statusBadge}</td>
                    <td>${remDisplay}</td>
                    <td>${formatTime(u.prayerSeconds || 0)}</td>
                    <td>${formatTime(u.meetingSeconds || 0)}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        });

        const limit = globalSettings.maxGeneralBreaks || 100;
        document.getElementById('activeBreakCount').innerHTML = 
            `Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù…: <span style="font-size:1.2em; ${activeGeneralBreaks >= limit ? 'color:red' : 'color:green'}">${activeGeneralBreaks} / ${limit}</span>`;
    }

    window.forceStop = (username) => {
        if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ù†Ø´Ø§Ø· Ø§Ù„Ù…ÙˆØ¸Ù Ù‚Ø³Ø±ÙŠØ§Ù‹ØŸ")) return;
        const u = allUsersData[username];
        const d = Math.floor((Date.now() - u.lastStartTime) / 1000);
        
        const updates = { isOnBreak: false, lastStartTime: null };
        if(u.breakType === 'general' || u.breakType === 'emergency') updates.usedSeconds = (u.usedSeconds||0) + d;
        else if(u.breakType === 'prayer') updates.prayerSeconds = (u.prayerSeconds||0) + d;
        else if(u.breakType === 'meeting') updates.meetingSeconds = (u.meetingSeconds||0) + d;

        db.ref('users/'+username).update(updates);
    }

    window.endDay = () => {
        if(!confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ… ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
        const today = new Date().toLocaleDateString('ar-EG');
        const updates = {};
        
        Object.values(allUsersData).forEach(u => {
            if(u.role === 'admin') return;

            let gen = u.usedSeconds || 0;
            let pra = u.prayerSeconds || 0;
            let met = u.meetingSeconds || 0;
            if(u.isOnBreak) {
                const d = Math.floor((Date.now() - u.lastStartTime) / 1000);
                if(u.breakType === 'general' || u.breakType === 'emergency') gen += d;
                else if(u.breakType === 'prayer') pra += d;
                else if(u.breakType === 'meeting') met += d;
            }

            const k = Date.now();
            updates['users/'+u.username+'/history/'+k] = { 
                date: today, 
                totalGeneral: gen, 
                totalPrayer: pra, 
                totalMeeting: met, 
                approvedOvertime: u.approvedOvertimeBalance || 0
            };
            
            updates['users/'+u.username+'/usedSeconds'] = 0;
            updates['users/'+u.username+'/prayerSeconds'] = 0;
            updates['users/'+u.username+'/meetingSeconds'] = 0;
            updates['users/'+u.username+'/isOnBreak'] = false;
            updates['users/'+u.username+'/lastStartTime'] = null;
            updates['users/'+u.username+'/breakType'] = null;
            updates['users/'+u.username+'/emergencyRequest'] = null;
            updates['users/'+u.username+'/overtimeRequest'] = null;
            updates['users/'+u.username+'/approvedOvertimeBalance'] = 0;
        });
        db.ref().update(updates).then(() => alert("ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­ âœ…"));
    }

    // --- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ ---
    window.updateReportSelect = () => {
        const sel = document.getElementById('reportUserSelect');
        if(sel.options.length <= 1) {
             Object.values(allUsersData).forEach(u => {
                 if(u.role !== 'admin') sel.innerHTML += `<option value="${u.username}">${u.realName}</option>`;
             });
        }
    }

    window.renderUserReport = () => {
        const uName = document.getElementById('reportUserSelect').value;
        const tbody = document.getElementById('reportBody');
        const otBody = document.getElementById('overtimeReportBody');
        const otStats = document.getElementById('overtimeStats');
        
        tbody.innerHTML = ''; otBody.innerHTML = ''; otStats.innerHTML = '';
        
        if(!uName) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù");
        const user = allUsersData[uName];

        if(user.overtimeHistory) {
            let otCount = 0;
            let totalOtHours = 0;
            const sortedOt = Object.values(user.overtimeHistory).sort((a,b) => b.date.localeCompare(a.date));

            sortedOt.forEach(ot => {
                otCount++;
                totalOtHours += ot.hours;
                otBody.innerHTML += `
                    <tr>
                        <td>${user.realName}</td>
                        <td>${ot.date}</td>
                        <td style="color:#8e44ad; font-weight:bold;">${ot.hours} Ø³Ø§Ø¹Ø©</td>
                        <td style="color:green;">âœ… ${ot.approvedBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    </tr>
                `;
            });
            
            if(otCount > 0) {
                otStats.innerHTML = `Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…: ${otCount} Ù…Ø±Ø© | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${totalOtHours} Ø³Ø§Ø¹Ø©`;
                otBody.innerHTML += `<tr style="background:#f0f0f0; font-weight:bold;"><td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${otCount} Ù…Ø±Ø© - Ù…Ø¬Ù…ÙˆØ¹ ${totalOtHours} Ø³Ø§Ø¹Ø©</td></tr>`;
            }
        } else {
            otBody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø£ÙˆÙØ± ØªØ§ÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù</td></tr>';
        }

        if(user.history) {
            Object.values(user.history).reverse().forEach(h => {
                tbody.innerHTML += `
                    <tr>
                        <td>${h.date}</td>
                        <td>${formatTime(h.totalGeneral)}</td>
                        <td>${formatTime(h.totalPrayer)}</td>
                        <td>${formatTime(h.totalMeeting)}</td>
                        <td>${h.approvedOvertime} Ø³</td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±</td></tr>';
        }
    }

    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù ---
    function initUserDash() {
        document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.realName}`;
        startTimer();
    }

    window.requestEmergency = () => {
        const reason = document.getElementById('breakReason').value.trim();
        if(!reason) return alert("âš ï¸ Ù‡Ø§Ù…: ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Ø®Ø§Ù†Ø© 'Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ø±ÙŠÙƒ' Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬!");

        db.ref(`users/${currentUser.username}/emergencyRequest`).set({
            reason: reason,
            status: 'pending',
            timestamp: Date.now()
        }).then(() => alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ğŸš¨\nØ§Ù†ØªØ¸Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±."));
    }

    window.requestOvertime = () => {
        const h = document.getElementById('otHours').value;
        if(!h || h <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª");
        
        db.ref(`users/${currentUser.username}/overtimeRequest`).set({
            hours: h,
            status: 'pending',
            timestamp: Date.now()
        }).then(() => alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… Ù„Ù„Ù…Ø¯ÙŠØ± âœ…"));
    }

    window.startMyBreak = (type) => {
        if(currentUser.isOnBreak) return alert("Ø£Ù†Øª ÙÙŠ Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙØ¹Ù„");

        if(type === 'emergency') {
            const req = currentUser.emergencyRequest;
            if(!req || req.status !== 'approved') return alert("ÙŠØ¬Ø¨ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹!");
        }

        if(type === 'general') {
            const limit = globalSettings.maxGeneralBreaks || 100;
            const currentCount = Object.values(allUsersData).filter(u => u.isOnBreak && u.breakType === 'general').length;
            if(currentCount >= limit) return alert(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${limit}) Ù…ÙƒØªÙ…Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø£Ùˆ Ø·Ù„Ø¨ Ø®Ø±ÙˆØ¬ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ.`);
        }

        let reason = document.getElementById('breakReason').value.trim();
        if(type === 'prayer') reason = "ØµÙ„Ø§Ø©";
        if(type === 'meeting') reason = "Ù…ÙŠØªÙ†Ø¬";
        if(type === 'emergency') reason = currentUser.emergencyRequest.reason + " (Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ)";
        
        if((type === 'general' || type === 'emergency') && !reason) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨");

        db.ref('users/' + currentUser.username).update({
            isOnBreak: true,
            breakType: type,
            lastStartTime: Date.now(),
            lastReason: reason
        });
    }

    window.stopMyBreak = () => {
        if(!currentUser.isOnBreak) return;
        const type = currentUser.breakType;
        const duration = Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
        
        const updates = { isOnBreak: false, lastStartTime: null, breakType: null, lastReason: "" };
        
        if(type === 'general' || type === 'emergency') updates.usedSeconds = (currentUser.usedSeconds || 0) + duration;
        else if(type === 'prayer') updates.prayerSeconds = (currentUser.prayerSeconds || 0) + duration;
        else if(type === 'meeting') updates.meetingSeconds = (currentUser.meetingSeconds || 0) + duration;

        if(type === 'emergency') updates.emergencyRequest = null;

        db.ref('users/' + currentUser.username).update(updates);
        document.getElementById('breakReason').value = "";
    }

    function updateUserUI() {
        const timerDisplay = document.getElementById('userTimer');
        const label = document.getElementById('timerLabel');
        const statusMsg = document.getElementById('userStatusMsg');
        const emStatusArea = document.getElementById('emergencyStatusArea');
        const otStatus = document.getElementById('overtimeStatus');

        if(currentUser.emergencyRequest) {
            const st = currentUser.emergencyRequest.status;
            if(st === 'pending') {
                emStatusArea.innerHTML = `<span class="status-badge bg-orange">â³ Ø§Ù„Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>`;
            } else if(st === 'approved') {
                emStatusArea.innerHTML = `<button onclick="startMyBreak('emergency')" class="btn btn-emergency btn-sm" style="width:100%">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†!</button>
                                          <p style="font-size:0.7rem; color:green;">ÙˆØ§ÙÙ‚: ${currentUser.emergencyRequest.approvedBy}</p>`;
            } else if(st === 'rejected') {
                emStatusArea.innerHTML = `<span class="status-badge bg-red">âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</span> 
                                          <button onclick="clearEmergencyReq()" style="font-size:0.7rem; border:none; background:none; text-decoration:underline; cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>`;
            }
        } else {
            emStatusArea.innerHTML = `<button onclick="requestEmergency()" class="btn btn-dark btn-sm" style="width:100%">Ø·Ù„Ø¨ Ø®Ø±ÙˆØ¬</button>`;
        }

        if(currentUser.overtimeRequest) {
            const st = currentUser.overtimeRequest.status;
            if(st === 'pending') otStatus.innerHTML = `<span style="color:orange">â³ Ø·Ù„Ø¨Ùƒ (${currentUser.overtimeRequest.hours}Ø³) Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>`;
            else if(st === 'approved') otStatus.innerHTML = `<span style="color:green">âœ… ÙˆØ§ÙÙ‚ ${currentUser.overtimeRequest.handledBy} Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ</span>`;
            else if(st === 'rejected') otStatus.innerHTML = `<span style="color:red">âŒ ØªÙ… Ø§Ù„Ø±ÙØ¶</span>`;
        } else {
            otStatus.innerHTML = '';
        }

        if(currentUser.isOnBreak) {
            document.getElementById('controlsArea').classList.add('hidden');
            document.getElementById('stopArea').classList.remove('hidden');
            
            const elapsed = Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
            
            if(currentUser.breakType === 'meeting' || currentUser.breakType === 'prayer') {
                label.innerText = currentUser.lastReason;
                timerDisplay.innerText = formatTime(elapsed);
                timerDisplay.style.color = currentUser.breakType === 'meeting' ? "var(--meeting-color)" : "var(--prayer-color)";
                statusMsg.innerText = "";
                stopAlarm();
            } else {
                const totalUsed = (currentUser.usedSeconds || 0) + elapsed;
                const remaining = (currentUser.allowance * 60) - totalUsed;
                label.innerText = `ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬: ${currentUser.lastReason}`;
                
                if(remaining >= 0) {
                    timerDisplay.innerText = formatTime(remaining);
                    timerDisplay.style.color = "var(--primary-color)";
                    statusMsg.innerText = "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯";
                    stopAlarm();
                } else {
                    timerDisplay.innerText = "-" + formatTime(Math.abs(remaining));
                    timerDisplay.style.color = "red";
                    statusMsg.innerText = "ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­!";
                    playAlarm();
                }
            }
        } else {
            document.getElementById('controlsArea').classList.remove('hidden');
            document.getElementById('stopArea').classList.add('hidden');
            stopAlarm();
            document.getElementById('overtimeAlert').classList.add('hidden');

            const remaining = (currentUser.allowance * 60) - (currentUser.usedSeconds || 0);
            label.innerText = "Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ";
            if(remaining >= 0) {
                timerDisplay.innerText = formatTime(remaining);
                timerDisplay.style.color = "#2d3436";
                statusMsg.innerText = "";
            } else {
                timerDisplay.innerText = "00:00";
                statusMsg.innerText = `Ù„Ø¯ÙŠÙƒ ØªØ¬Ø§ÙˆØ² Ø³Ø§Ø¨Ù‚: ${formatTime(Math.abs(remaining))}`;
                statusMsg.style.color = "red";
            }
        }
    }

    window.clearEmergencyReq = () => { db.ref('users/'+currentUser.username+'/emergencyRequest').remove(); }

    function playAlarm() {
        document.body.classList.add('alarm-mode');
        document.getElementById('overtimeAlert').classList.remove('hidden');
        const audio = document.getElementById('alarmSound');
        if(audio.paused) audio.play().catch(e=>{});
    }
    
    function stopAlarm() {
        document.body.classList.remove('alarm-mode');
        const audio = document.getElementById('alarmSound');
        audio.pause(); audio.currentTime=0;
    }

    function formatTime(s) {
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        return `${m}:${sec}`;
    }
</script>
</body>
</html>
