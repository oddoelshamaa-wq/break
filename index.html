            
                            <!DOCTYPE html>
                            <html lang="ar" dir="rtl">
                            <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- تم تحديث هذا السطر للسماح بعمل المكتبات -->
        <meta http-equiv="Content-Security-Policy" content="default-src * data: blob: filesystem: about: ws: wss: 'unsafe-inline' 'unsafe-eval'; script-src * data: blob: 'unsafe-inline' 'unsafe-eval'; connect-src * data: blob: 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src * data: blob: ; style-src * data: blob: 'unsafe-inline'; font-src * data: blob: 'unsafe-inline';">
        <title>ELSHAMAA | إدارة البريك</title>

                                <!-- كود أيقونة الموقع (Favicon) -->
                                <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" type="image/png">

                                <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
                                <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
                                <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
                                <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
                                <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


                                <style>
                                    :root {
                                        --bg-deep: #020617;
                                        --glass: rgba(15, 23, 42, 0.6);
                                        --glass-border: rgba(255, 255, 255, 0.08);
                                        /* الألوان الجديدة: Indigo & Cyan */
                                        --primary: #6366f1; /* Indigo */
                                        --accent: #06b6d4;  /* Cyan */
                                        --success: #10b981;
                                        --danger: #f43f5e;
                                        --warning: #fbbf24;
                                        --vip-gold: linear-gradient(45deg, #ffd700, #b8860b);
                                        --text-light: #f1f5f9;
                                        --logo-gradient: linear-gradient(135deg, #818cf8 0%, #22d3ee 100%);
                                    }

                                    body { 
                                        font-family: 'Cairo', sans-serif; 
                                        background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%); 
                                        margin: 0; padding: 20px 10px; min-height: 100vh; color: var(--text-light); 
                                        overflow-x: hidden;
                                    }

                                    /* خلفية Aura متحركة */
                                    .aura { position: fixed; width: 600px; height: 600px; border-radius: 50%; filter: blur(120px); z-index: -1; opacity: 0.15; animation: move 20s infinite alternate; }
                                    .aura-1 { background: var(--primary); top: -200px; left: -200px; }
                                    .aura-2 { background: var(--accent); bottom: -200px; right: -200px; animation-delay: -10s; }
                                    @keyframes move { from { transform: translate(0,0); } to { transform: translate(100px, 100px); } }

                                    @keyframes oxidation-glow {
                                        0% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.05); }
                                        50% { box-shadow: 0 0 60px rgba(239, 68, 68, 0.6); background: rgba(239, 68, 68, 0.15); border-color: var(--danger); }
                                        100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.05); }
                                    }
                                    .وضع-التنبيه { animation: oxidation-glow 0.8s infinite !important; }

                                    .container { 
                                        max-width: 1200px; margin: auto; background: var(--glass); backdrop-filter: blur(30px);
                                        border-radius: 35px; border: 1px solid var(--glass-border); padding: 30px;
                                        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
                                    }

                                    /* تنسيق صور البروفايل */
                                    .profile-img {
                                        width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
                                        border: 2px solid var(--primary); vertical-align: middle; margin-left: 10px;
                                        background: #1e293b;
                                    }
                                    
                                    .profile-pic-container {
                                        position: relative;
                                        display: inline-block;
                                    }

                                    .profile-img-lg {
                                        width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
                                        border: 3px solid var(--primary); margin-bottom: 15px;
                                        box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
                                        background: #1e293b;
                                        transition: 0.3s;
                                    }

                                    .change-pic-btn {
                                        position: absolute; bottom: 15px; right: 0;
                                        background: var(--primary); color: white; border: none;
                                        width: 30px; height: 30px; border-radius: 50%;
                                        cursor: pointer; display: flex; align-items: center; justify-content: center;
                                        font-size: 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                                        transition: 0.3s;
                                    }
                                    .change-pic-btn:hover { transform: scale(1.1); background: var(--accent); }

                                    /* أزرار 3D */
                                    .btn { 
                                        padding: 12px 18px; border: none; border-radius: 16px; cursor: pointer; 
                                        font-weight: 700; font-family: 'Cairo'; color: white; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                                        display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;
                                        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
                                    }
                                    .btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 12px 20px rgba(0,0,0,0.3); }
                                    .btn:active { transform: translateY(2px); }
                                    .btn-disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
                                    .btn-primary { background: linear-gradient(135deg, #0ea5e9, #2563eb); }
                                    .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
                                    .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); }
                                    .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; }
                                    .btn-vip { background: var(--vip-gold); color: #000; }
                                    .btn-dark { background: #334155; }

                                    input, select, textarea { 
                                        padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
                                        border-radius: 14px; color: white; font-family: 'Cairo'; margin-bottom: 10px; transition: 0.3s;
                                    }
                                    input:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); outline: none; }

                                    /* جداول */
                                    .table-responsive { width: 100%; overflow-x: auto; border-radius: 20px; border: 1px solid var(--glass-border); margin-top: 15px; }
                                    table { width: 100%; border-collapse: collapse; min-width: 900px; background: rgba(0,0,0,0.2); }
                                    th { background: rgba(255,255,255,0.05); color: var(--primary); padding: 15px; font-size: 0.85rem; }
                                    td { padding: 12px; border-bottom: 1px solid var(--glass-border); text-align: center; font-size: 0.85rem; }

                                    /* العداد الدائري */
                                    .timer-container { position: relative; width: 220px; height: 220px; margin: 0 auto; filter: drop-shadow(0 0 15px var(--primary)); }
                                    .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
                                    .timer-circle-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 12; }
                                    .timer-circle-fg { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.4s; }
                                    .timer-text-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; }
                                    .timer-big-text { font-size: 3.2rem; font-weight: 900; line-height: 1; }

                                    /* تخطيط الموظف الجديد */
                                    .employee-hero-grid {
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 25px;
                                        align-items: stretch;
                                        margin-bottom: 25px;
                                    }

                                    .hero-card {
                                        background: rgba(255, 255, 255, 0.03);
                                        border: 1px solid var(--glass-border);
                                        border-radius: 30px;
                                        padding: 30px;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                                    }

                                    .broadcast-box {
                                        text-align: right;
                                        height: 100%;
                                    }

                                    .log-container {
                                        flex: 1;
                                        overflow-y: auto;
                                        max-height: 220px;
                                        margin-top: 10px;
                                        padding-left: 5px;
                                    }

                                    .broadcast-item {
                                        background: rgba(255,255,255,0.05);
                                        border-right: 4px solid var(--primary);
                                        padding: 12px;
                                        border-radius: 12px;
                                        margin-bottom: 10px;
                                        font-size: 0.9rem;
                                        animation: slideIn 0.3s ease;
                                    }

                                    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

                                    .welcome-back-msg {
                                        background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(0, 0, 0, 0.4)) !important;
                                        border: 1px solid var(--primary) !important;
                                        color: white !important;
                                        font-weight: bold;
                                        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
                                        padding: 15px;
                                        border-radius: 15px;
                                        margin-bottom: 20px;
                                        text-align: center;
                                    }

                                    @keyframes bounceIn {
                                        0% { transform: scale(0.3); opacity: 0; }
                                        50% { transform: scale(1.05); opacity: 1; }
                                        70% { transform: scale(0.9); }
                                        100% { transform: scale(1); }
                                    }

                                    .server-clock-box { background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 20px; border: 1px solid var(--glass-border); text-align: center; }
                                    .clock-time { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: block; }

                                    #broadcastOverlay {
                                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95);
                                        z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px);
                                    }
                                    .broadcast-content {
                                        background: #000; border: 4px solid var(--danger); padding: 40px; border-radius: 40px;
                                        max-width: 600px; width: 90%; text-align: center; box-shadow: 0 0 80px var(--danger);
                                    }

                                    .hidden { display: none !important; }
                                    .badge-count { background: var(--danger); color: white; padding: 2px 7px; border-radius: 50%; font-size: 0.7rem; margin-right: 5px; }
                                    
                                    .fun-title-badge {
                                        display: inline-block;
                                        background: var(--vip-gold);
                                        color: #000;
                                        padding: 5px 15px;
                                        border-radius: 20px;
                                        font-weight: 900;
                                        font-size: 1rem;
                                        margin-top: 5px;
                                        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
                                        animation: pulseTitle 2s infinite;
                                    }
                                    @keyframes pulseTitle { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

                                    /* =============================================
                                    تظبيط الموبايل (Responsive Mobile Style)
                                    ============================================= */
                                    @media (max-width: 768px) {

                                        /* 1. الحاوية الرئيسية */
                                        .container {
                                            width: 95% !important;
                                            padding: 15px !important;
                                            margin: 10px auto !important;
                                            border-radius: 20px !important;
                                        }

                                        /* 2. الهيدر (صورة البروفايل والاسم والزراير) */
                                        .header-wrapper {
                                            flex-direction: column !important; /* يرصهم تحت بعض */
                                            text-align: center !important;
                                            gap: 20px !important;
                                        }

                                        .header-wrapper > div {
                                            justify-content: center !important;
                                            width: 100% !important;
                                            flex-direction: column !important;
                                        }

                                        .digital-clock-container {
                                            margin: 10px auto !important; /* توسيط الساعة */
                                            width: 100% !important;
                                        }

                                        /* 3. شبكة العداد والتنبيهات */
                                        .employee-hero-grid {
                                            grid-template-columns: 1fr !important; /* عمود واحد */
                                            gap: 15px !important;
                                        }

                                        /* 4. زراير التحكم (بريك - صلاة - ميتنج) */
                                        #controlsArea > div {
                                            grid-template-columns: 1fr 1fr !important; /* زرارين جنب بعض */
                                        }

                                        /* 5. الجداول (عشان متبوظش الشكل) */
                                        .table-responsive {
                                            overflow-x: auto !important; /* سكرول بالعرض */
                                            -webkit-overflow-scrolling: touch;
                                        }

                                        table {
                                            min-width: 600px !important; /* عرض أدنى عشان الكلام ميتفعصش */
                                        }

                                        th, td {
                                            font-size: 0.8rem !important; /* تصغير الخط سنة */
                                            padding: 8px !important;
                                        }

                                        /* 6. تحسين الساعة والتاريخ على الموبايل (الأدمن) */
                                        #adminSection {
                                            padding: 10px !important;
                                        }

                                        #adminSection > div:first-child {
                                            flex-direction: column !important;
                                            gap: 15px !important;
                                            padding: 10px !important;
                                        }

                                        /* الساعة والتاريخ - صفحة الأدمن */
                                        #adminSection > div:first-child > div:first-child {
                                            display: flex !important;
                                            justify-content: center !important;
                                            width: 100% !important;
                                            order: -1 !important; /* تحريك الساعة لفوق */
                                            margin-bottom: 10px !important;
                                        }

                                        /* الساعة بتاع الأدمن - تصغير على الموبايل */
                                        #adminSection [style*="display: flex; justify-content: center; margin-bottom: 25px"] {
                                            margin-bottom: 15px !important;
                                            width: 100% !important;
                                        }

                                        #adminSection [style*="display: flex; justify-content: center; margin-bottom: 25px"] > div {
                                            padding: 10px 20px !important;
                                            border-radius: 18px !important;
                                        }

                                        #adminSection [style*="display: flex; justify-content: center; margin-bottom: 25px"] span[style*="font-size: 2rem"] {
                                            font-size: 1.5rem !important;
                                        }

                                        #adminSection [style*="display: flex; justify-content: center; margin-bottom: 25px"] #adminServerTime {
                                            font-size: 1.4rem !important;
                                        }

                                        #adminSection [style*="display: flex; justify-content: center; margin-bottom: 25px"] #adminServerDate {
                                            font-size: 0.9rem !important;
                                        }

                                        /* أزرار الأدمن - تحسين على الموبايل */
                                        #adminSection div[style*="display: flex; gap"] {
                                            flex-direction: column !important;
                                            gap: 10px !important;
                                            width: 100% !important;
                                        }

                                        #adminSection button {
                                            width: 100% !important;
                                            padding: 10px !important;
                                        }

                                        /* الجدول بتاع المراقبة */
                                        #tab-monitor {
                                            overflow-x: auto !important;
                                            -webkit-overflow-scrolling: touch !important;
                                        }

                                        #tab-monitor table {
                                            font-size: 0.75rem !important;
                                        }

                                        #tab-monitor td {
                                            padding: 6px !important;
                                        }

                                        .admin-table-ctrl {
                                            flex-direction: column !important;
                                        }

                                        .admin-table-ctrl select,
                                        .admin-table-ctrl button {
                                            width: 100% !important;
                                            font-size: 0.7rem !important;
                                            padding: 6px !important;
                                        }

                                        /* تحسينات إضافية للموبايل - الجدول والأزرار */
                                        #monitorBody tr {
                                            display: block !important;
                                            margin-bottom: 15px !important;
                                            border: 1px solid rgba(99, 102, 241, 0.3) !important;
                                            border-radius: 12px !important;
                                            padding: 10px !important;
                                            background: rgba(255,255,255,0.02) !important;
                                        }

                                        #monitorBody td {
                                            display: block !important;
                                            width: 100% !important;
                                            margin-bottom: 8px !important;
                                            text-align: right !important;
                                            padding: 8px !important;
                                            border: none !important;
                                        }

                                        #monitorBody td:last-child {
                                            margin-bottom: 0 !important;
                                        }

                                        #monitorBody td:before {
                                            content: attr(data-label);
                                            font-weight: bold;
                                            color: var(--primary);
                                            margin-bottom: 4px;
                                            display: block;
                                            font-size: 0.85rem;
                                        }

                                        /* الأسماء والملفات - موبايل */
                                        #monitorBody .profile-img {
                                            width: 35px !important;
                                            height: 35px !important;
                                        }

                                        #monitorBody div[style*="display:flex"] {
                                            flex-direction: column !important;
                                            align-items: flex-start !important;
                                            gap: 8px !important;
                                            width: 100% !important;
                                        }

                                        /* الأزرار والتحكم - موبايل - أحجام أكبر وسهلة الضغط */
                                        #monitorBody button {
                                            width: 100% !important;
                                            font-size: 0.8rem !important;
                                            padding: 10px !important;
                                            margin-bottom: 6px !important;
                                            min-height: 44px !important;
                                            cursor: pointer !important;
                                            touch-action: manipulation !important;
                                        }

                                        #monitorBody select {
                                            width: 100% !important;
                                            font-size: 0.8rem !important;
                                            padding: 10px !important;
                                            margin-bottom: 6px !important;
                                            min-height: 44px !important;
                                            cursor: pointer !important;
                                            -webkit-appearance: none !important;
                                            appearance: none !important;
                                            background-color: rgba(99, 102, 241, 0.1) !important;
                                            border: 1px solid rgba(99, 102, 241, 0.3) !important;
                                        }

                                        .admin-row-top {
                                            display: flex !important;
                                            flex-direction: column !important;
                                            gap: 8px !important;
                                            width: 100% !important;
                                        }

                                        .admin-row-top select,
                                        .admin-row-top button {
                                            width: 100% !important;
                                            min-height: 44px !important;
                                        }

                                        .admin-table-ctrl {
                                            width: 100% !important;
                                            display: flex !important;
                                            flex-direction: column !important;
                                        }

                                        /* منطقة الخطر (Danger Zone) */
                                        #dangerZone {
                                            margin-top: 50px !important;
                                            padding: 20px !important;
                                            width: 100% !important;
                                            box-sizing: border-box !important;
                                        }

                                        #dangerZone div {
                                            flex-direction: column !important; /* الزراير تحت بعض */
                                            gap: 15px !important;
                                        }

                                        #dangerZone button {
                                            width: 100% !important; /* الزرار ياخد العرض كله */
                                        }

                                        /* 7. القوائم المنسدلة وحقول الإدخال */
                                        input, select, textarea {
                                            font-size: 16px !important; /* عشان الموبايل ميعملش زوم لوحده */
                                        }

                                        /* 8. ويدجت الصلاة (يظهر تحت شوية) */
                                        .prayer-toggle-btn {
                                            top: auto !important;
                                            bottom: 120px !important;
                                            left: 0 !important;
                                        }
                                        .prayer-widget.active {
                                            top: auto !important;
                                            bottom: 120px !important;
                                            left: 50px !important;
                                            max-width: 250px !important;
                                        }

                                        /* 9. تحسينات عامة */
                                        .aura { display: none !important; } /* إخفاء الخلفية المتحركة لتوفير البطارية */
                                        h2, h3 { font-size: 1.5rem !important; }

                                        .hero-card { padding: 20px; }
                                        .timer-container { width: 180px; height: 180px; }
                                        .timer-big-text { font-size: 2.5rem; }

        /* =============================================
        تنسيقات الموبايل المطورة للمشرف (Admin Mobile)
        ============================================= */
        /* 1. الرسالة المنبثقة (التي ظهرت في الصورة) */
        #funnyToast {
            width: 85% !important;
            padding: 10px 15px !important;
            font-size: 0.85rem !important;
            top: 10px !important; /* تقريبها للأعلى */
            border-width: 2px !important;
        }

        /* 2. حاوية لوحة الإدارة الرئيسية */
        #adminSection > div:first-child {
            flex-direction: column !important; /* ترتيب العناصر عمودياً */
            padding: 15px !important;
            gap: 15px !important;
            text-align: center !important;
        }

        /* 3. اسم المشرف واللقب */
        #adminSection h2 {
            display: block !important;
            margin-bottom: 5px !important;
            font-size: 1.4rem !important;
        }

        #currentManagerDisplay {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            margin-right: 0 !important;
            gap: 5px;
        }

        .the-boss-name {
            font-size: 1.1rem !important;
        }

        /* 4. توزيع الأزرار (تسجيل خروج، صوت، تصفير) */
        /* جعلها تظهر بشكل شبكي Grid متناسق */
        #adminSection div[style*="display: flex; gap: 10px;"] {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important; /* زرارين في كل صف */
            width: 100% !important;
            gap: 10px !important;
        }

        /* زر تصفير اليوم - نجعله يأخذ العرض كاملاً لوحده */
        #secretResetBtn {
            grid-column: span 2 !important; /* يأخذ الصف كاملاً */
            width: 100% !important;
            padding: 12px !important;
            margin-top: 5px !important;
        }

        #adminSoundToggle, #adminSection button[onclick="logout()"] {
            width: 100% !important;
            height: 50px !important; /* توحيد الطول */
            margin: 0 !important;
            font-size: 0.85rem !important;
            justify-content: center !important;
        }

        /* 5. قسم إرسال الرسائل */
        #adminSection div[style*="background: rgba(239, 68, 68, 0.05)"] {
            padding: 15px !important;
            border-radius: 20px !important;
        }

        #broadcastTarget, #broadcastInput {
            width: 100% !important;
            font-size: 0.9rem !important;
        }

        /* 6. شريط التبويبات (المراقبة، التقارير...) */
        #adminSection div[style*="overflow-x: auto"] {
            display: flex !important;
            gap: 8px !important;
            padding-bottom: 15px !important;
            justify-content: flex-start !important;
            -webkit-overflow-scrolling: touch;
        }

        #adminSection div[style*="overflow-x: auto"] .btn {
            flex: 0 0 auto !important; /* منع الأزرار من الانكماش */
            font-size: 0.75rem !important;
            padding: 8px 12px !important;
        }

        /* 7. عدادات الحالة (متواجد/بريك/صلاة) */
        #statusCountersDisplay {
            font-size: 0.8rem !important;
            border-right: none !important;
            padding-right: 0 !important;
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 10px !important;
            text-align: right !important;
        }

        /* 1. إخفاء رأس الجدول (العناوين) لأننا سنحول الجدول لكروت */
        #tab-monitor thead {
            display: none !important;
        }

        /* 2. تحويل كل صف (Row) إلى كارت منفصل */
        #monitorBody tr {
            display: flex !important;
            flex-direction: column !important;
            background: rgba(255, 255, 255, 0.04) !important;
            margin-bottom: 15px !important;
            border-radius: 20px !important;
            padding: 15px !important;
            border: 1px solid var(--glass-border) !important;
            position: relative !important;
        }

        /* 3. تنسيق الخلايا (الخانات) داخل الكارت */
        #monitorBody td {
            display: block !important;
            text-align: right !important;
            border: none !important;
            padding: 5px 0 !important;
            width: 100% !important;
        }

        /* 4. إبراز اسم الموظف والصورة */
        #monitorBody td:first-child {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            padding-bottom: 10px !important;
            margin-bottom: 10px !important;
        }

        /* 5. جعل "الوقت المتبقي" (البريك) يظهر بشكل كبير وواضح في الزاوية */
        #monitorBody td:nth-child(3) {
            position: absolute !important;
            top: 15px !important;
            left: 15px !important; /* لجهة اليسار */
            width: auto !important;
            background: rgba(0, 0, 0, 0.3) !important;
            padding: 10px 15px !important;
            border-radius: 12px !important;
            border: 1px solid var(--primary) !important;
        }

        #monitorBody td:nth-child(3) span {
            font-size: 1.4rem !important; /* تكبير وقت البريك */
            color: var(--primary) !important;
            display: block !important;
        }

        /* إضافة كلمة "البريك" فوق الوقت لتوضيحه */
        #monitorBody td:nth-child(3)::before {
            content: "البريك المتبقي";
            display: block;
            font-size: 0.65rem;
            color: #aaa;
            margin-bottom: 2px;
        }

        /* 6. تنسيق الصلاة والمتابعة (المتبع) */
        #monitorBody td:nth-child(4), #monitorBody td:nth-child(5) {
            display: inline-block !important;
            width: 48% !important; /* جنب بعض */
            font-size: 0.8rem !important;
            background: rgba(0,0,0,0.2);
            padding: 8px !important;
            border-radius: 10px;
            margin-top: 5px;
        }

        /* 7. أزرار التحكم (إيقاف / ملف / تشغيل) */
        #monitorBody td:last-child {
            margin-top: 15px !important;
            padding-top: 10px !important;
            border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
            display: flex !important;
            justify-content: space-between !important;
            gap: 10px !important;
        }

        #monitorBody td:last-child button,
        #monitorBody td:last-child .admin-row-top {
            flex: 1 !important;
            width: 100% !important;
            height: 45px !important;
            font-size: 0.85rem !important;
        }

        /* تنسيق القائمة المنسدلة (البريك/الصلاة) داخل الكارت */
        .admin-row-top select {
            width: 100% !important;
            height: 40px !important;
            margin-bottom: 5px !important;
        }

        /* حالة الأكسدة (الوميض الأحمر) */
        .وضع-التنبيه {
            border: 2px solid #ef4444 !important;
            animation: oxidation-glow 0.8s infinite !important;
        }

        .container, .hero-card, .broadcast-content {
            backdrop-filter: none !important; /* إلغاء التغبيش */
            background: rgba(15, 23, 42, 0.95) !important; /* لون خلفية ثابت */
        }
    }

                                    /* تنسيقات حقول الإدخال والقوائم الجديدة */
                                    .form-control-glass {
                                        width: 100%;
                                        background: rgba(0, 0, 0, 0.4);
                                        border: 1px solid var(--glass-border);
                                        color: white;
                                        padding: 15px;
                                        border-radius: 12px;
                                        margin-bottom: 15px;
                                        font-family: 'Cairo', sans-serif;
                                        font-size: 1rem;
                                        outline: none;
                                        transition: 0.3s;
                                        /* لإصلاح شكل القائمة المنسدلة */
                                        appearance: none;
                                        -webkit-appearance: none;
                                        -moz-appearance: none;
                                        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                                        background-repeat: no-repeat;
                                        background-position: left 15px center; /* السهم على اليسار لأن الموقع RTL */
                                        background-size: 15px;
                                    }

                                    textarea.form-control-glass {
                                        background-image: none; /* إزالة السهم من الـ textarea */
                                        resize: vertical;
                                    }

                                    .form-control-glass:focus {
                                        border-color: var(--primary);
                                        background: rgba(0, 0, 0, 0.6);
                                        box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
                                    }

                                    /* تنسيق صناديق الرفع (Upload Boxes) */
                                    .upload-box {
                                        background: rgba(255, 255, 255, 0.05);
                                        border: 1px dashed var(--glass-border);
                                        border-radius: 12px;
                                        padding: 15px;
                                        text-align: center;
                                        transition: 0.3s;
                                    }

                                    .upload-box:hover {
                                        background: rgba(255, 255, 255, 0.1);
                                        border-color: var(--primary);
                                    }

                                    .file-name-display {
                                        font-size: 0.8rem;
                                        color: #aaa;
                                        margin-top: 5px;
                                        white-space: nowrap;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                    }

                                    /* إصلاح مشكلة ظهور العناصر المخفية */
                                    .hidden {
                                        display: none !important;
                                    }

                                    /* تنسيق خيارات القائمة المنسدلة */
                                    #broadcastTarget option {
                                        padding: 8px;
                                        border-bottom: 1px solid rgba(255,255,255,0.05);
                                    }
                                    #broadcastTarget option:checked {
                                        background: var(--primary) !important;
                                        color: white;
                                    }

                                    /* تأثير الوميض للزر عند وجود تنبيه */
                                    @keyframes glow-red {
                                        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); border-color: #ef4444; }
                                        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); border-color: #ff0000; }
                                        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: #ef4444; }
                                    }

                                    .alert-mode {
                                        animation: glow-red 1.5s infinite;
                                        background: linear-gradient(135deg, #7f1d1d, #b91c1c) !important; /* لون أحمر غامق */
                                        color: white !important;
                                        font-weight: bold;
                                        transform: scale(1.05); /* تكبير بسيط */
                                    }

                                    /* تصميم صندوق الساعة الجديد */
                                    .digital-clock-container {
                                        background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
                                        border: 1px solid var(--glass-border);
                                        border-right: 4px solid var(--primary); /* خط ملون على اليمين */
                                        padding: 10px 20px;
                                        border-radius: 15px;
                                        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
                                        text-align: center;
                                        min-width: 140px;
                                    }

                                    .digital-time {
                                        font-family: 'Courier New', monospace; /* خط رقمي */
                                        font-size: 1.6rem;
                                        font-weight: 900;
                                        color: var(--primary);
                                        text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
                                        line-height: 1;
                                        display: block;
                                        margin-bottom: 5px;
                                    }

                                    .digital-date {
                                        font-size: 0.85rem;
                                        color: #94a3b8;
                                        font-weight: 600;
                                        letter-spacing: 1px;
                                        display: block;
                                    }

                                    /* تنسيق زر تغيير الصورة (الكاميرا) */
                                    .edit-pic-badge {
                                        position: absolute;
                                        bottom: 5px;
                                        right: -5px;
                                        width: 30px;
                                        height: 30px;
                                        background: var(--dark);
                                        border: 2px solid var(--primary);
                                        border-radius: 50%;
                                        color: white;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        cursor: pointer;
                                        font-size: 0.9rem;
                                        transition: 0.3s;
                                        z-index: 5;
                                    }
                                    .edit-pic-badge:hover {
                                        background: var(--primary);
                                        transform: scale(1.1);
                                    }

                                    /* تنسيق الحاوية عشان العناصر متدخلش في بعض */
                                    .header-wrapper {
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        background: rgba(255,255,255,0.03);
                                        padding: 15px;
                                        border-radius: 20px;
                                        margin-bottom: 25px;
                                        flex-wrap: wrap;
                                        gap: 15px;
                                    }

                            /* تصميم اللوجو ELSHAMAA */
                            .logo-container {
                                display: inline-flex;
                                flex-direction: column;
                                align-items: flex-start;
                                padding: 10px;
                            }

                            .logo-text {
                                font-family: 'Montserrat', 'Cairo', sans-serif;
                                font-size: 2.8rem;
                                font-weight: 900;
                                line-height: 1;
                                background: var(--logo-gradient);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.3));
                                letter-spacing: -1px;
                                margin: 0;
                            }

                            .logo-tagline {
                                font-size: 0.75rem;
                                color: var(--accent);
                                text-transform: uppercase;
                                letter-spacing: 4px;
                                margin-top: 5px;
                                font-weight: 700;
                                opacity: 0.8;
                            }

                            /* تعديل الأزرار لتناسب الألوان الجديدة */
                            .btn-primary {
                                background: linear-gradient(135deg, #6366f1, #4338ca) !important;
                                box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
                            }
                            .btn-primary:hover {
                                box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
                            }

                            .digital-clock-container {
                                border-right: 4px solid var(--accent) !important;
                                background: rgba(15, 23, 42, 0.8);
                            }
                            .digital-time {
                                color: var(--accent) !important;
                            }

                            /* تأثير اسم صاحب الموقع */
                            .brand-name {
                                font-family: 'Cairo', sans-serif;
                                font-weight: 900;
                                background: linear-gradient(45deg, #ffd700, #fff5b7, #fbbf24);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
                                letter-spacing: 2px;
                                text-transform: uppercase;
                            }

                            /* 3. تعديل الساعة الرقمية لتناسب الألوان الجديدة */
                            .digital-clock-container {
                                background: rgba(0, 0, 0, 0.4);
                                border-right: 4px solid var(--primary) !important;
                                border-radius: 15px;
                            }
                            .digital-time {
                                color: var(--primary) !important;
                                text-shadow: 0 0 10px rgba(251, 191, 36, 0.5) !important;
                            }

                            /* تأثير اسم صاحب الموقع */
                            .the-boss-name {
                                background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
                                background-size: 200% auto;
                                color: #fff;
                                background-clip: text;
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                font-weight: 900;
                                font-size: 1.3rem; /* تكبير الخط */
                                animation: shine 3s linear infinite; /* حركة اللمعة */
                                text-shadow: 0 0 20px rgba(251, 245, 183, 0.4);
                                font-family: 'Cairo', sans-serif;
                                letter-spacing: 1px;
                            }

                            /* حركة اللمعة */
                            @keyframes shine {
                                to {
                                    background-position: 200% center;
                                }
                            }

                            /* تنسيق التاج */
                            .boss-crown {
                                display: inline-block;
                                font-size: 1.4rem;
                                margin-left: 5px;
                                filter: drop-shadow(0 0 10px gold);
                                animation: crown-float 2s ease-in-out infinite;
                            }

                            /* حركة التاج (يطير ويميل) */
                            @keyframes crown-float {
                                0%, 100% { transform: translateY(0) rotate(0deg); }
                                50% { transform: translateY(-5px) rotate(10deg); }
                            }

                            /* --- ويدجت الصلاة --- */
                            .prayer-widget {
                                position: fixed;
                                top: 15%;
                                left: 20px; /* على اليسار */
                                width: 220px;
                                background: rgba(15, 23, 42, 0.95);
                                border: 1px solid var(--primary);
                                border-radius: 20px;
                                padding: 15px;
                                z-index: 8000;
                                color: white;
                                box-shadow: 0 0 30px rgba(0,0,0,0.6);
                                backdrop-filter: blur(10px);
                                transition: 0.3s;
                                font-family: 'Cairo', sans-serif;
                                transform: translateX(-240px); /* مخفي افتراضياً */
                            }

                                    /* زر إظهار الويدجت */
                                    .prayer-toggle-btn {
                                        position: fixed;
                                        top: 15%;
                                        left: 0;
                                        width: 40px;
                                        height: 50px;
                                        background: var(--primary);
                                        border-radius: 0 10px 10px 0;
                                        z-index: 8001;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        cursor: pointer;
                                        box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
                                        font-size: 1.2rem;
                                        transition: 0.3s;
                                    }
                                    .prayer-toggle-btn:hover { padding-left: 5px; }

                                    /* كلاس التفعيل للإظهار */
                                    .prayer-widget.active { transform: translateX(0); }
                                    .prayer-toggle-btn.active { left: 220px; border-radius: 50%; width: 30px; height: 30px; top: 14%; }

                                    .next-prayer-box {
                                        background: rgba(56, 189, 248, 0.1);
                                        border: 1px dashed var(--primary);
                                        border-radius: 12px;
                                        padding: 10px;
                                        text-align: center;
                                        margin-bottom: 15px;
                                    }

                                    .next-prayer-name { color: var(--warning); font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }
                                    .next-prayer-timer { font-size: 1.4rem; font-weight: 900; color: white; direction: ltr; font-family: monospace; }

                                    .prayer-list { list-style: none; padding: 0; margin: 0; font-size: 0.85rem; }
                                    .prayer-item {
                                        display: flex; justify-content: space-between;
                                        padding: 8px 5px;
                                        border-bottom: 1px solid rgba(255,255,255,0.1);
                                    }
                                    .prayer-item:last-child { border-bottom: none; }
                                    .prayer-item.current-prayer { color: var(--success); font-weight: bold; background: rgba(16, 185, 129, 0.1); border-radius: 5px; }
                                    .prayer-item.next-prayer-highlight { color: var(--warning); font-weight: bold; border-right: 3px solid var(--warning); padding-right: 8px;}

                                    @media (max-width: 768px) {
                                        .prayer-widget { top: auto; bottom: 80px; left: 10px; transform: translateX(-250px); }
                                        .prayer-toggle-btn { top: auto; bottom: 100px; }
                                        .prayer-toggle-btn.active { top: auto; bottom: 280px; left: 210px; }
                                    }

                                    /* أنيميشن الرقص لزرار الملف */
                                    @keyframes dance {
                                        0%, 100% { transform: rotate(0deg) scale(1); }
                                        25% { transform: rotate(5deg) scale(1.1); }
                                        50% { transform: rotate(-5deg) scale(1.1); }
                                        75% { transform: rotate(3deg) scale(1.1); }
                                    }
                                    .dance-alert {
                                        animation: dance 0.5s infinite !important;
                                        background: linear-gradient(45deg, #f472b6, #fbbf24) !important; /* لون بينك في ذهبي */
                                        border: 2px solid white !important;
                                    }

                                    /* تنسيقات قسم الشركاء */
                                    .partners-section {
                                        background: rgba(255,255,255,0.03);
                                        border: 1px solid var(--glass-border);
                                        border-radius: 25px;
                                        padding: 20px;
                                        margin: 20px 0;
                                        text-align: center;
                                        overflow: hidden;
                                    }

                                    .partners-slider {
                                        width: 100%;
                                        overflow: hidden;
                                        position: relative;
                                    }

                                    .partners-track {
                                        display: flex;
                                        gap: 20px;
                                        animation: scrollPartners 30s linear infinite;
                                        width: calc(150px * 10); /* 5 صور أصلية + 5 مكررة */
                                    }

                                    .partner-logo {
                                        width: 150px;
                                        height: 80px;
                                        object-fit: contain;
                                        border-radius: 10px;
                                        background: rgba(255,255,255,0.1);
                                        padding: 10px;
                                        transition: 0.3s;
                                        flex-shrink: 0;
                                    }

                                    .partner-logo:hover {
                                        transform: scale(1.05);
                                        background: rgba(255,255,255,0.2);
                                    }

                                    @keyframes scrollPartners {
                                        0% { transform: translateX(0); }
                                        100% { transform: translateX(-50%); }
                                    }

                                    /* الإيموجي اللي هيطير في الشاشة */
                                    .floating-emoji {
                                        position: fixed;
                                        bottom: -100px;
                                        font-size: 2rem;
                                        z-index: 99999;
                                        pointer-events: none;
                                        animation: flyUp 3s linear forwards;
                                    }

                                    @keyframes flyUp {
                                        to {
                                            transform: translateY(-110vh) rotate(360deg);
                                            opacity: 0;
                                        }
                                    }

                                    /* رسالة المفاجأة */
                                    #funnyToast {
                                        position: fixed;
                                        top: 20px;
                                        left: 50%;
                                        transform: translateX(-50%) translateY(-100px);
                                        background: rgba(255, 255, 255, 0.95);
                                        color: #000;
                                        padding: 15px 30px;
                                        border-radius: 50px;
                                        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                                        z-index: 100000;
                                        font-weight: 900;
                                        transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                        border: 3px solid #f472b6;
                                    }
                                    #funnyToast.show { transform: translateX(-50%) translateY(20px); }

    /* تنسيقات مطورة لمعرض الصور */
    #galleryGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        padding: 10px;
    }

    .gallery-card {
        position: relative;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid var(--glass-border);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        aspect-ratio: 1/1;
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .gallery-card:hover {
        transform: translateY(-10px) scale(1.02);
        border-color: var(--accent);
        box-shadow: 0 15px 30px rgba(6, 182, 212, 0.2);
    }

    .gallery-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: zoom-in;
        transition: 0.5s;
    }

    .gallery-card:hover .gallery-img {
        filter: brightness(0.7);
    }

    .gallery-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        background: linear-gradient(transparent, rgba(0,0,0,0.9));
        transform: translateY(20px);
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
    }

    .gallery-card:hover .gallery-info {
        transform: translateY(0);
        opacity: 1;
    }

    /* زر الحذف داخل الكارت */
    .delete-gallery-btn {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(244, 63, 94, 0.9);
        color: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: 0.3s;
        opacity: 0;
        transform: translateX(-10px);
    }

    .gallery-card:hover .delete-gallery-btn {
        opacity: 1;
        transform: translateX(0);
    }

    .delete-gallery-btn:hover {
        background: #ef4444;
        transform: scale(1.1);
    }
                                </style>
                            </head>
                            <body>

                            <!-- مدخلات مخفية لرفع الصور -->
                            <input type="file" id="selfPicInput" style="display:none" accept="image/*" onchange="handleFileUpload(this, 'self')">
                            <input type="file" id="adminPicInput" style="display:none" accept="image/*" onchange="handleFileUpload(this, 'admin')">

                            <div class="aura aura-1"></div>
                            <div class="aura aura-2"></div>

                            <div id="loading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                <div style="border:5px solid var(--glass-border); border-top:5px solid var(--primary); border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;"></div>
                                <div class="logo-container">
                                    <h1 class="logo-text">ELSHAMAA</h1>
                                    <span class="logo-tagline">Smart Management System</span>
                                </div>
                            </div>

                            <div class="logo-container">
                                <h1 class="logo-text">ELSHAMAA</h1>
                                <span class="logo-tagline">Smart Management System</span>
                            </div>

    <!-- =============================================
        🔊 نظام الأصوات الكامل - 5 أصوات مختلفة
        ============================================= -->

    <!-- 1. صوت التنبيه (Alarm) - بيب قصير -->
    <audio id="alarmSound" loop preload="auto">
        <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>

    <!-- 2. صوت الإشعار (Notify) - تنويه خفيف -->
    <audio id="notifySound" preload="none">
        <source src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" type="audio/mp3">
    </audio>

    <!-- 3. صوت الجرس (Request Ring) - جرس متكرر -->
    <audio id="requestRing" loop preload="none">
        <source src="https://assets.mixkit.co/active_storage/sfx/1110/1110-preview.mp3" type="audio/mp3">
    </audio>

    <!-- 4. صوت البث (Broadcast) - رسائل إدارية عاجلة -->
    <audio id="broadcastSound" loop preload="none">
        <source src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" type="audio/mp3">
    </audio>

    <!-- 5. صوت المخالفة (Complaint) - شكاوى وانتهاكات -->
    <audio id="complaintSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mp3">
    </audio>

                            <div id="forceSoundOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.98); z-index:20000; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                                <div class="broadcast-content" style="border-color: var(--primary); box-shadow: 0 0 50px var(--primary);">
                                    <h1 style="color:var(--primary)">نظام الإدارة الذكي 2026</h1>
                                    <p>يرجى تفعيل الواجهة لبدء استلام التنبيهات والرسائل الإدارية اللحظية.</p>
                                    <button onclick="activateSystemAndSound()" class="btn btn-primary" style="width:100%; padding:20px; font-size:1.3rem; margin-top:20px;">✅ بدء الدوام وتفعيل الصوت</button>
                                </div>

                            </div>

                            <!-- زر وويدجت الصلاة -->
                            <div class="prayer-toggle-btn" onclick="togglePrayerWidget()">🕌</div>

                            <div id="prayerWidget" class="prayer-widget">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <h4 style="margin:0; color:var(--primary);">مواقيت الصلاة (القاهرة)</h4>
                                </div>

                                <!-- عداد الصلاة القادمة -->
                                <div class="next-prayer-box">
                                    <span class="next-prayer-name" id="nextPrayerName">جاري التحميل...</span>
                                    <span class="next-prayer-timer" id="nextPrayerCount">--:--:--</span>
                                </div>

                                <!-- جدول الصلوات -->
                                <ul class="prayer-list" id="prayerList">
                                    <!-- سيتم ملء البيانات بالجافاسكريبت -->
                                </ul>

                                <div style="font-size:0.7rem; color:#aaa; text-align:center; margin-top:10px;">
                                    بتوقيت الهيئة المصرية العامة للمساحة
                                </div>
                            </div>

                            <div id="broadcastOverlay">
                                <div class="broadcast-content">
                                    <div style="font-size: 5rem;">🚨</div>
                                    <h1 style="color: var(--danger);">تنبيه إداري عاجل</h1>
                                    <p id="broadcastMsgText" style="font-size: 1.6rem; font-weight: bold; margin: 25px 0;"></p>
                                    <button onclick="acknowledgeBroadcast()" class="btn btn-danger" style="width:100%; padding:20px; font-size:1.3rem;">استلمت الرسالة (إيقاف الصوت)</button>
                                </div>
                            </div>

                            <!-- رسالة المفاجأة -->
                            <div id="funnyToast">👀 <span id="funnyToastText">أوبا! في مفاجأة نزلت في ملفك دلوقتي!</span> 😂</div>

                            <!-- نافذة عرض الأرشيف المتطورة -->
                            <div id="archiveModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:20000; padding:20px; overflow-y:auto; backdrop-filter: blur(5px);">
                                <div style="max-width:1100px; margin:30px auto; background:#1e293b; border:1px solid gold; border-radius:20px; padding:30px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.1);">

                                    <!-- الهيدر -->
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                                        <h2 style="color:gold; margin:0; display:flex; align-items:center; gap:10px;">
                                            🕵️ سجل رقابة المشرفين (الأرشيف)
                                        </h2>
                                        <div style="display:flex; gap:10px;">
                                            <button onclick="clearAllArchiveLogs()" class="btn btn-danger" style="background:#dc2626;">🗑️ مسح الكل</button>
                                            <button onclick="document.getElementById('archiveModal').classList.add('hidden')" class="btn btn-dark">إغلاق ✖</button>
                                        </div>
                                    </div>

                                    <!-- أدوات البحث والفلترة -->
                                    <div style="background:rgba(255,255,255,0.03); padding:20px; border-radius:15px; border:1px solid rgba(255,255,255,0.1); margin-bottom:20px;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">

                                            <!-- بحث بالاسم -->
                                            <div>
                                                <label style="color:#aaa; font-size:0.9rem; margin-bottom:5px; display:block;">🔍 بحث (مشرف أو موظف)</label>
                                                <input type="text" id="archiveSearchInput" placeholder="اكتب الاسم هنا..." class="form-control-glass" style="margin:0; border-color: gold;" onkeyup="filterArchiveTable()">
                                            </div>

                                            <!-- من تاريخ -->
                                            <div>
                                                <label style="color:#aaa; font-size:0.9rem; margin-bottom:5px; display:block;">📅 من تاريخ</label>
                                                <input type="date" id="archiveDateFrom" class="form-control-glass" style="margin:0;" onchange="filterArchiveTable()">
                                            </div>

                                            <!-- إلى تاريخ -->
                                            <div>
                                                <label style="color:#aaa; font-size:0.9rem; margin-bottom:5px; display:block;">📅 إلى تاريخ</label>
                                                <input type="date" id="archiveDateTo" class="form-control-glass" style="margin:0;" onchange="filterArchiveTable()">
                                            </div>

                                            <!-- زر إعادة تعيين -->
                                            <div>
                                                <button onclick="resetArchiveFilters()" class="btn btn-dark" style="width:100%; border:1px solid #666;">↺ إعادة تعيين</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- الجدول -->
                                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                        <table style="width:100%;">
                                            <thead style="position: sticky; top: 0; background: #1e293b; z-index: 1;">
                                                <tr>
                                                    <th style="color:gold; border-bottom: 2px solid gold;">المشرف (الفاعل)</th>
                                                    <th style="border-bottom: 2px solid gold;">نوع الإجراء</th>
                                                    <th style="border-bottom: 2px solid gold;">الضحية (الموظف)</th>
                                                    <th style="border-bottom: 2px solid gold;">التفاصيل</th>
                                                    <th style="border-bottom: 2px solid gold;">التوقيت</th>
                                                    <th style="border-bottom: 2px solid gold; color:var(--danger)">تحكم</th> <!-- الخانة الجديدة -->
                                                </tr>
                                            </thead>
                                            <tbody id="archiveBody"></tbody>
                                        </table>
                                    </div>

                                    <div id="archiveCountBadge" style="text-align: left; margin-top: 10px; color: #888; font-size: 0.9rem;"></div>
                                </div>
                            </div>

                            <!-- نافذة الملف الوظيفي والشكاوى -->
                            <div id="profileModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:15000; backdrop-filter:blur(10px); overflow-y:auto;">
                                <div style="max-width:800px; margin:50px auto; background:#1e293b; border:1px solid var(--primary); border-radius:25px; padding:30px; position:relative;">
                                    <button onclick="closeProfileModal()" style="position:absolute; top:20px; left:20px; background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✖</button>

                                    <div style="text-align:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px; margin-bottom:20px;">
                                        <img id="modalProfilePic" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--primary); object-fit:cover;">
                                        <h2 id="modalRealName" style="margin:10px 0 5px 0; color:var(--primary);"></h2>
                                        <p id="modalUserName" style="color:#aaa; margin:0;"></p>
                                    </div>

                                    <!-- قسم الإضافة (يظهر للمدير فقط) -->
                                    <div id="adminAddComplaintArea" class="hidden" style="background:rgba(239,68,68,0.1); padding:20px; border-radius:15px; border:1px dashed var(--danger); margin-bottom:25px;">
                                        <h4 style="margin-top:0; color:var(--danger);">🚨 تسجيل مخالفة / شكوى جديدة</h4>
                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                            <input type="text" id="complaintTitle" placeholder="عنوان المخالفة (مثلاً: تأخير، سوء سلوك..)">
                                            <input type="number" id="deductionAmount" placeholder="قيمة الخصم (إن وجد)">
                                        </div>
                                        <textarea id="complaintDetails" style="width:100%; height:80px; margin-top:10px;" placeholder="تفاصيل الشكوى..."></textarea>

                                        <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                                            <label style="cursor:pointer; background:var(--dark); padding:10px; border-radius:10px; border:1px solid var(--glass-border);">
                                                📷 إرفاق دليل (سكرين شوت)
                                                <input type="file" id="complaintEvidence" accept="image/*" style="display:none" onchange="previewEvidence(this)">
                                            </label>
                                            <span id="evidenceFileName" style="font-size:0.8rem; color:#aaa;"></span>
                                        </div>
                                        <img id="evidencePreview" src="" style="max-height:100px; display:none; margin-top:10px; border-radius:10px; border:1px solid var(--danger);">

                                        <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                                            <label style="cursor:pointer; background:var(--primary); color:#000; padding:10px; border-radius:10px; border:1px solid var(--glass-border); font-weight:bold;">
                                                🎙️ إرفاق تسجيل مكالمة
                                                <input type="file" id="complaintAudioInput" accept="audio/*" style="display:none" onchange="previewAudio(this)">
                                            </label>
                                            <span id="audioFileName" style="font-size:0.8rem; color:#aaa;"></span>
                                        </div>

                                        <audio id="audioPreviewPlayer" controls style="width:100%; margin-top:10px; display:none; border-radius:20px;"></audio>

                                        <button onclick="submitComplaint()" class="btn btn-danger" style="width:100%; margin-top:15px;">تسجيل المخالفة وحفظ في الملف</button>
                                    </div>

                                    <!-- سجل المخالفات -->
                                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
                                        <h3 style="color:var(--text-light); margin:0;">📂 السجل الوظيفي</h3>

                                        <!-- قسم الفلترة الجديد -->
                                        <div style="display:flex; gap:5px; background:rgba(0,0,0,0.3); padding:5px; border-radius:10px; border:1px solid var(--glass-border);">
                                            <input type="date" id="historyDateFrom" style="margin:0; padding:5px; font-size:0.8rem; width:110px;">
                                            <span style="color:white; align-self:center;">:</span>
                                            <input type="date" id="historyDateTo" style="margin:0; padding:5px; font-size:0.8rem; width:110px;">
                                            <button onclick="renderComplaintsHistory(currentProfileTarget)" class="btn btn-primary btn-sm">🔍</button>
                                            <button onclick="clearHistoryFilters()" class="btn btn-dark btn-sm">❌</button>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>التاريخ</th>
                                                    <th>المخالفة</th>
                                                    <th>التفاصيل</th>
                                                    <th>الخصم</th>
                                                    <th>الدليل</th>
                                                    <th>بواسطة</th>
                                                    <th>إجراء</th>
                                                </tr>
                                            </thead>
                                            <tbody id="complaintsHistoryBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- نافذة تغيير كلمة المرور -->
                            <div id="changePassModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:16000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
                                <div style="background:#1e293b; border:1px solid var(--primary); border-radius:25px; padding:30px; width:90%; max-width:400px; text-align:center;">
                                    <h3 style="color:var(--primary); margin-bottom:20px;">🔐 تحديث كلمة المرور</h3>

                                    <input type="password" id="oldPassInput" placeholder="كلمة المرور الحالية" class="form-control-glass" style="width:100%;">
                                    <input type="password" id="newPassInput" placeholder="كلمة المرور الجديدة" class="form-control-glass" style="width:100%;">
                                    <input type="password" id="confirmPassInput" placeholder="تأكيد الكلمة الجديدة" class="form-control-glass" style="width:100%;">

                                    <div style="display:flex; gap:10px; margin-top:20px;">
                                        <button onclick="submitChangePassword()" class="btn btn-success" style="flex:1;">تحديث الآن</button>
                                        <button onclick="closePassModal()" class="btn btn-dark" style="flex:1;">إلغاء</button>
                                    </div>
                                </div>
                            </div>

                            <!-- نافذة إعداد باسورد الملف الشخصي فقط -->
                            <div id="filePassModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:16000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
                                <div style="background:#1e293b; border:2px solid var(--accent); border-radius:25px; padding:30px; width:90%; max-width:400px; text-align:center;">
                                    <h3 id="filePassTitle" style="color:var(--accent); margin-bottom:20px;">🔒 قفل خصوصية الملف</h3>
                                    
                                    <div id="oldFilePassArea" class="hidden">
                                        <input type="password" id="oldFilePassInput" placeholder="كلمة سر الملف الحالية" class="form-control-glass" style="width:100%;">
                                    </div>
                                    
                                    <input type="password" id="newFilePassInput" placeholder="كلمة سر الملف الجديدة" class="form-control-glass" style="width:100%;">
                                    <input type="password" id="confirmFilePassInput" placeholder="تأكيد الكلمة الجديدة" class="form-control-glass" style="width:100%;">
                                    
                                    <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 15px;">هذا الباسورد لحماية "ملف الشكاوى" فقط ولا يغير باسورد دخولك.</p>

                                    <div style="display:flex; gap:10px;">
                                        <button onclick="saveFilePassword()" class="btn btn-primary" style="flex:2; background:var(--accent);">حفظ القفل</button>
                                        <button onclick="closeFilePassModal()" class="btn btn-dark" style="flex:1;">إلغاء</button>
                                    </div>
                                </div>
                            </div>

                            <!-- نافذة تكبير الصورة -->
                            <div id="imgZoomModal" class="hidden" onclick="this.classList.add('hidden')" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:20000; display:flex; justify-content:center; align-items:center;">
                                <img id="zoomedImg" src="" style="max-width:90%; max-height:90%; border-radius:10px; box-shadow:0 0 50px rgba(255,255,255,0.2);">
                            </div>

                            <!-- نافذة إدخال باسورد فتح الملف (بديلة للـ prompt) -->
                            <div id="accessFileModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:17000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
                                <div style="background:#1e293b; border:2px solid var(--primary); border-radius:20px; padding:30px; width:90%; max-width:350px; text-align:center;">
                                    <h3 style="color:white; margin-bottom:20px;">🔒 هذا الملف محمي</h3>
                                    <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">أدخل كلمة سر خصوصية الملف للمتابعة</p>

                                    <input type="password" id="accessFilePassInput" placeholder="●●●●●●" class="form-control-glass" style="width:100%; text-align:center; font-size:1.5rem; letter-spacing: 5px;">

                                    <div style="display:flex; gap:10px; margin-top:10px;">
                                        <button onclick="confirmAccessFile()" class="btn btn-primary" style="flex:1;">فتح الملف</button>
                                        <button onclick="closeAccessModal()" class="btn btn-dark" style="flex:1;">إلغاء</button>
                                    </div>
                                </div>
                            </div>

                            <div class="container hidden" id="mainContainer">
                                
                                <!-- قسم تسجيل الدخول -->
                                <div id="loginSection" style="max-width: 400px; margin: 80px auto; text-align: center;">
                                    <h2 style="font-size: 2rem; margin-bottom: 30px;">🔐 تسجيل الدخول</h2>
                                    <div style="background: var(--glass); padding: 30px; border-radius: 30px; border: 1px solid var(--glass-border);">
                                        <input type="text" id="loginUser" placeholder="اسم المستخدم" style="width:100%">
                                        <input type="password" id="loginPass" placeholder="كلمة المرور" style="width:100%">
                                        <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; padding: 15px;">دخول للنظام</button>
                                    </div>
                                </div>

                                <!-- لوحة المشرف -->
                                <div id="adminSection" class="hidden">
                                    <!-- الساعة والتاريخ للأدمن - في الأعلى -->
                                    <div style="display: flex; justify-content: center; margin-bottom: 25px;">
                                        <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(6, 182, 212, 0.3)); padding: 16px 35px; border-radius: 25px; border: 2px solid rgba(99, 102, 241, 0.6); box-shadow: 0 0 30px rgba(99, 102, 241, 0.5), inset 0 0 15px rgba(99, 102, 241, 0.2); backdrop-filter: blur(10px);">
                                            <div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                                                <span style="font-size: 2rem;">⏰</span>
                                                <div>
                                                    <span style="font-family: 'Courier New', monospace; font-weight: 900; font-size: 2rem; color: #38bdf8; text-shadow: 0 0 15px rgba(56, 189, 248, 0.9); letter-spacing: 2px;" id="adminServerTime">00:00:00 AM</span>
                                                    <br>
                                                    <span id="adminServerDate" style="font-size: 1.1rem; color: #06b6d4; font-weight: 700; opacity: 0.95; letter-spacing: 1px; display: block; text-align: center;">--/--/----</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px;">
                                        <div>
                                            <h2 style="margin:0; color:var(--primary); display:inline-block;">لوحة الإدارة 🚀</h2>
                                            <!-- اسم المشرف -->
                                            <span id="currentManagerDisplay" style="font-weight: bold; opacity: 0.8; margin-right: 15px; font-size: 1.1rem;"></span>
                                            <!-- أيقونة الأرشيف لمحمود -->
                                            <span id="secretArchiveBtn" onclick="openSecretArchive()" class="hidden"
                                                style="cursor: pointer; font-size: 1.5rem; margin-right: 10px; vertical-align: middle;"
                                                title="الأرشيف السري">🕵️</span>
                                            <button id="secretResetBtn" class="hidden btn btn-danger btn-sm" onclick="endDay()">تصفير اليوم</button>
                                        </div>

                                        <!-- أزرار التحكم الإضافية -->
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <!-- زر تبديل الصوت -->
                                            <button id="adminSoundToggle" onclick="toggleAdminSound()" class="btn btn-success btn-sm" style="padding: 8px 15px; border-radius: 12px; display: flex; align-items: center; gap: 5px;" title="تبديل التنبيهات الصوتية">
                                                <span>🔊 الصوت: مفعل</span>
                                            </button>

                                            <!-- زر تسجيل الخروج للمشرفين -->
                                            <button onclick="logout()" class="btn btn-danger btn-sm" style="padding: 8px 20px; border-radius: 12px; display: flex; align-items: center; gap: 8px;">
                                                <span>تسجيل خروج</span>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                                    <polyline points="16 17 21 12 16 7"></polyline>
                                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>

    <!-- لوحة التميز والأداء المحدثة -->
    <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(6, 182, 212, 0.1)); border: 2px solid var(--primary); border-radius: 30px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="margin:0; color:var(--primary); font-size: 1.2rem; font-weight: 900;">🏆 لوحة التميز والأداء (رفع سكرين شوت)</h4>
            <div id="perfPreviewContainer" style="display:none; position:relative; animation: bounceIn 0.5s;">
                <img id="perfPreviewImg" src="" style="width:50px; height:50px; border-radius:12px; border:2px solid var(--accent); object-fit:cover; box-shadow: 0 0 15px var(--accent);">
                <button onclick="clearPerfImg()" style="position:absolute; top:-8px; right:-8px; background:#ef4444; color:white; border-radius:50%; width:22px; height:22px; border:none; cursor:pointer; font-weight:bold; font-size:12px;">×</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px;">
            <!-- اختيار الموظفين -->
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <label style="font-size: 0.75rem; color: #aaa; margin-right: 10px;">🎯 اختيار الموظف/المجموعة:</label>
                <select id="broadcastTarget" multiple class="form-control-glass" style="height: 100px; padding: 10px; font-size: 0.85rem; background: rgba(0,0,0,0.5);">
                    <option value="all" selected>📣 للجميع</option>
                </select>
            </div>
            
            <!-- نص الأداء -->
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <label style="font-size: 0.75rem; color: #aaa; margin-right: 10px;">📝 وصف التميز أو التنبيه:</label>
                <textarea id="broadcastInput" class="form-control-glass" style="height: 100px; resize: none; font-size: 1rem; line-height: 1.5; background: rgba(0,0,0,0.5);" placeholder="اكتب هنا.. مثلاً: 'عاش يا بطل على أعلى مكالمة النهاردة!'"></textarea>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <!-- زر رفع السكرين -->
            <label class="btn btn-dark" style="flex: 1; background: #1e293b; border: 1px solid var(--primary); display: flex; align-items: center; justify-content: center; gap: 10px; height: 50px; font-size: 0.9rem; cursor: pointer;">
                📷 إرفاق سكرين شوت
                <input type="file" id="performanceImgInput" accept="image/*" style="display:none" onchange="previewPerformanceImg(this)">
            </label>

            <!-- زر الإرسال -->
            <button id="btnSendPerformance" onclick="uploadAndSendPerformance()" class="btn btn-primary" style="flex: 2; height: 50px; font-size: 1.1rem; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--accent)) !important;">
                🚀 نشر في السجل وبث مباشر
            </button>
        </div>
    </div>





                                    <!-- زر جديد لفتح معرض الصور (للمشرف والموظف) -->
                                    <button onclick="openPerformanceGallery()" class="btn btn-vip" style="width: 100%; margin-bottom: 20px; background: linear-gradient(45deg, #06b6d4, #6366f1); color: white;">
                                        🖼️ فتح معرض سجل الأداء (الصور السابقة)
                                    </button>

                                    <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px;">
                                        <button onclick="switchAdminTab('monitor')" class="btn btn-primary btn-sm">📡 المراقبة</button>
                                        <button onclick="switchAdminTab('emergency')" class="btn btn-danger btn-sm">🚨 طوارئ <span id="emBadge" class="badge-count hidden">0</span></button>
                                        <button onclick="switchAdminTab('meetings')" class="btn btn-warning btn-sm">🤝 اجتماع <span id="meetBadge" class="badge-count hidden">0</span></button>
                                        <button onclick="switchAdminTab('overtime')" class="btn btn-primary btn-sm" style="background:#8e44ad">🕒 الإضافي <span id="otBadge" class="badge-count hidden">0</span></button>
                                        <button onclick="switchAdminTab('permissions')" class="btn btn-primary btn-sm" style="background:#6b21a8">🚪 أذونات <span id="permBadge" class="badge-count hidden">0</span></button>
                                        <button onclick="switchAdminTab('reports')" class="btn btn-success btn-sm">📊 التقارير</button>
                                        <button onclick="switchAdminTab('users')" class="btn btn-dark btn-sm">⚙️ الموظفين</button>
                                        <button onclick="switchAdminTab('groups')" class="btn btn-primary btn-sm">👥 المجموعات</button>
                                    </div>

    <!-- قسم الجدول الأسبوعي للصلاة - للمشرف -->
    <div id="weeklyPrayerSection" style="background: rgba(6, 182, 212, 0.1); border: 1px solid var(--accent); padding: 15px; border-radius: 20px; margin-bottom: 20px; margin-top: 20px;">
        <h4 style="margin:0 0 10px 0; color:var(--accent);">📅 إعداد الجدول الأسبوعي للصلاة</h4>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px;">
            <button onclick="selectWeeklyDay(0)" class="btn btn-dark btn-sm day-btn" id="day-0">السبت</button>
            <button onclick="selectWeeklyDay(1)" class="btn btn-dark btn-sm day-btn" id="day-1">الأحد</button>
            <button onclick="selectWeeklyDay(2)" class="btn btn-dark btn-sm day-btn" id="day-2">الاثنين</button>
            <button onclick="selectWeeklyDay(3)" class="btn btn-dark btn-sm day-btn" id="day-3">الثلاثاء</button>
            <button onclick="selectWeeklyDay(4)" class="btn btn-dark btn-sm day-btn" id="day-4">الأربعاء</button>
            <button onclick="selectWeeklyDay(5)" class="btn btn-dark btn-sm day-btn" id="day-5">الخميس</button>
        </div>

        <div id="weeklyConfigArea" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px;">
            <p id="selectedDayLabel" style="color: var(--accent); font-weight: bold;">اختر يوماً لتعديل ترتيبه</p>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <select id="weeklyUserSelect" class="form-control-glass" style="flex: 2; margin-bottom: 0;">
                    <!-- سيتم ملؤه بالموظفين -->
                </select>
                <button onclick="addUserToWeeklyDay()" class="btn btn-primary" style="flex: 1;">إضافة لليوم</button>
            </div>
            <div id="weeklyDayOrderDisplay" style="display: flex; flex-direction: column; gap: 5px; min-height: 50px;">
                <!-- الترتيب سيظهر هنا -->
            </div>
            <button onclick="saveWeeklySchedule()" class="btn btn-success" style="width: 100%; margin-top: 15px;">💾 حفظ جدول هذا اليوم</button>
        </div>
    </div>

    <!-- لوحة عرض الجدول الأسبوعي للمشرف -->
    <div id="adminWeeklyBoard" style="margin-top: 25px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--accent); border-radius: 25px; padding: 20px;">
        <h4 style="color:var(--accent); text-align: center; margin-bottom: 20px;">📋 السجل العام لجدول الصلاة الأسبوعي</h4>
        <div class="table-responsive">
            <table style="min-width: 100%; border-collapse: separate; border-spacing: 0 10px;">
                <thead>
                    <tr style="background: rgba(6, 182, 212, 0.2);">
                        <th style="padding: 12px; border-radius: 12px 0 0 12px;">اليوم</th>
                        <th style="padding: 12px; border-radius: 0 12px 12px 0;">ترتيب الموظفين (بالتسلسل)</th>
                    </tr>
                </thead>
                <tbody id="adminWeeklyLogBody">
                    <!-- سيتم ملؤه تلقائياً -->
                </tbody>
            </table>
        </div>
    </div>

                                    <div id="tab-monitor">
                                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 25px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: center;">
                                            <div>🍔 حد البريك: <input type="number" id="maxBreaksInput" style="width:50px; margin:0;" value="3"></div>
                                            <div>🕌 حد الصلاة: <input type="number" id="maxPrayersInput" style="width:50px; margin:0;" value="2"></div>
                                            <button onclick="updateLimits()" class="btn btn-primary btn-sm">حفظ</button>
                                            <div id="statusCountersDisplay" style="font-weight: bold; color: var(--primary); font-size: 1.1rem; border-right: 1px solid var(--glass-border); padding-right: 20px;"></div>
                                        </div>

                                        <!-- التحكم في وقت الصلاة للمشرف -->
                                        <div style="background: rgba(56, 189, 248, 0.1); padding: 15px; border-radius: 20px; border: 1px solid var(--primary); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="font-size: 1.5rem;">🕌</span>
                                                <div>
                                                    <h4 style="margin:0; color: var(--primary);">نافذة وقت الصلاة</h4>
                                                    <small id="prayerStatusText" style="color: #aaa;">الحالة: جاري التحميل...</small>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 10px;">
                                                <button onclick="setPrayerWindow(true)" class="btn btn-success btn-sm">✅ فتح وقت الصلاة الآن</button>
                                                <button onclick="setPrayerWindow(false)" class="btn btn-danger btn-sm">🛑 إغلاق وقت الصلاة</button>
                                            </div>
                                        </div>

                                        <!-- لوحة التحكم في وقت الصلاة (زر واحد للجميع) -->
                                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 20px; border: 1px solid var(--success); margin-bottom: 20px;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                                <span style="font-size: 1.8rem;">🕌</span>
                                                <div>
                                                    <h4 style="margin:0; color: var(--success);">وقت الصلاة</h4>
                                                    <small style="color: #ccc;">اضغط عند الأذان لإضافة 15 دقيقة للجميع</small>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 10px;">
                                                <button onclick="addPrayerTimeGlobal()" class="btn btn-success" style="font-weight:bold; padding: 10px 20px;">
                                                    ➕ توزيع 15 دقيقة للكل
                                                </button>
                                                <button onclick="forceResetPrayerOnly()" class="btn btn-dark btn-sm" style="border:1px solid #ef4444; color:#ef4444;">
                                                    🔄 تصفير عدادات الصلاة (حل المشاكل)
                                                </button>
                                            </div>
                                        </div>



        <!-- قسم ترتيب دور الصلاة - للمشرف -->
        <div id="prayerQueueSection" style="background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 20px; margin-bottom: 20px;">
            <h4 style="margin:0 0 10px 0; color:var(--primary);">📅 ترتيب دور الصلاة (الطابور)</h4>
            <div id="rotationSelectionArea" style="margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px;">
                <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 10px;">اختر الموظفين الذين سيشملهم جدول التدوير:</p>
                <div id="rotationMembersSelector" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- الأسماء ستظهر هنا تلقائياً -->
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="queueUserSelect" class="form-control-glass" style="width: 100%; color: white;">
                    <option value="">-- اختر الموظف لإضافته للدور --</option>
                </select>
                <button onclick="addToQueue()" class="btn btn-primary" style="flex: 1;">➕ إضافة للدور</button>
                <button onclick="clearQueue()" class="btn btn-danger" style="flex: 1;">🗑 تصفير الدور</button>
            </div>

            <div id="queueDisplay" style="display: flex; gap: 10px; overflow-x: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 15px; min-height: 50px;">
                <!-- سيظهر الموظفين المرتبين هنا كبطاقات صغيرة -->
        </div>
    </div>

    <!-- حاوية الأزرار - تظهر بجانب بعضها -->
    <div style="display: flex; gap: 12px; margin-top: 15px; width: 100%;">
        
        <!-- الزر الأيسر: السجل السحابي (تصميم داكن) -->
        <button onclick="openPrayerCloudHistory()" class="btn" style="background: #334155; flex: 1; border: 1px solid rgba(255,255,255,0.1); font-weight: bold;">
            السجل السحابي 📜
        </button>
        
        <!-- الزر الأيمن: حفظ الترتيب (تصميم إنديجو/بنفسجي ملون) -->
        <button onclick="saveCurrentOrderToHistory()" class="btn" style="background: linear-gradient(135deg, #6366f1, #4f46e5); flex: 1; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); font-weight: bold;">
            ☁️ حفظ الترتيب الحالي للسحابة
        </button>
        
    </div>



        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                            <input type="text" id="monitorSearch" placeholder="بحث عن موظف..." style="flex:1" oninput="renderMonitorTable()">
                                            <button onclick="endDay()" class="btn btn-danger btn-sm">إقفال اليوم 🛑</button>
                                        </div>

                                        <div class="table-responsive">
                                            <table>
                                                <thead>
                                                    <tr><th>الموظف والجهاز</th><th>الحالة والسبب</th><th>البريك (متبقي)</th><th>صلاة / متبع</th><th>ميتنج / VIP</th><th>التحكم</th></tr>
                                                </thead>
                                                <tbody id="monitorBody"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div id="tab-emergency" class="hidden"><h3>🚨 طلبات الطوارئ</h3><div class="table-responsive"><table><thead><tr><th>الموظف</th><th>السبب</th><th>الوقت</th><th>القرار</th></tr></thead><tbody id="adminEmBody"></tbody></table></div></div>
                                    <div id="tab-meetings" class="hidden"><h3>🤝 طلبات الاجتماعات</h3><div class="table-responsive"><table><thead><tr><th>الموظف</th><th>السبب</th><th>الوقت</th><th>القرار</th></tr></thead><tbody id="adminMeetBody"></tbody></table></div></div>
                                    <div id="tab-overtime" class="hidden"><h3>🕒 طلبات الإضافي</h3><div class="table-responsive"><table><thead><tr><th>الموظف</th><th>الساعات</th><th>الوقت</th><th>القرار</th></tr></thead><tbody id="adminOtBody"></tbody></table></div></div>

                                    <div id="tab-permissions" class="hidden">
                                        <h3 style="color:#a855f7">🚪 طلبات الاستأذان والمغادرة</h3>
                                        <div class="table-responsive">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>الموظف</th>
                                                        <th>عدد الساعات</th>
                                                        <th>السبب</th>
                                                        <th>وقت الطلب</th>
                                                        <th>القرار</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="adminPermBody"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div id="tab-reports" class="hidden">
        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 25px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                <div>
                    <label style="display:block; margin-bottom:5px; color:#aaa;">اختر الموظف:</label>
                    <select id="reportUserSelect" style="width:100%"></select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px; color:#aaa;">من تاريخ:</label>
                    <input type="date" id="filterStartDate" style="width:100%">
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px; color:#aaa;">إلى تاريخ:</label>
                    <input type="date" id="filterEndDate" style="width:100%">
                </div>
                <button onclick="renderUserReport()" class="btn btn-primary" style="height:45px;">🔍 عرض النتائج</button>
            </div>

            <!-- أزرار تحميل الإكسل الجديدة -->
            <button onclick="exportProfessionalExcel()" class="btn btn-success" style="height:45px; background: linear-gradient(135deg, #10b981, #059669);">
                Excel تقرير مفصل 📥
            </button>

            <button onclick="runSmartArchiving()" class="btn btn-dark" style="height:45px; border: 1px solid var(--primary);">
                📦 أرشفة البيانات القديمة
            </button>

                </div>

        <!-- ملخص التقرير الرقمي -->
        <div class="hidden" id="monthlySummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;">
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:20px; text-align:center; border:1px solid var(--danger);"><small>الأكسدة</small><p id="monthTotalBreaks" style="font-size:1.4rem; color:var(--danger); font-weight:bold;">0 د</p></div>
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:20px; text-align:center;"><small>الصلاة</small><p id="monthTotalPrayer" style="font-size:1.4rem;">0 د</p></div>
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:20px; text-align:center; border:1px solid var(--success);"><small>المتابعة</small><p id="monthTotalFollowUp" style="font-size:1.4rem; color:var(--success);">0 د</p></div>
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:20px; text-align:center; border:1px solid #ffd700;"><small>VIP</small><p id="monthTotalVIP" style="font-size:1.4rem; color:#ffd700;">0 د</p></div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr><th>اليوم</th><th>السجل</th><th>الإجمالي</th><th>صافي الأكسدة</th></tr>
                </thead>
                <tbody id="sessionsReportBody"></tbody>
            </table>
        </div>

                <!-- ======================================================= -->
                <!-- منطقة الخطر (Danger Zone) - معزولة وبعيدة جداً -->
                <!-- ======================================================= -->

                <!-- لاحظ: margin-top: 150px دي هي اللي بتبعدها جداً عن إيدك -->
                <div id="dangerZone" class="hidden" style="margin-top: 150px; margin-bottom: 50px; padding: 40px; border: 3px dashed rgba(239, 68, 68, 0.4); border-radius: 30px; background: rgba(0, 0, 0, 0.4); text-align: center;">

                    <div style="font-size: 3rem; margin-bottom: 10px;">☢️</div>
                    <h3 style="color: var(--danger); margin: 0 0 10px 0; font-weight: 900;">منطقة الحذف النهائي</h3>
                    <p style="color: #aaa; margin-bottom: 30px; font-size: 0.9rem;">
                        هذه المنطقة تحتوي على إجراءات لا يمكن التراجع عنها.<br>
                        تم وضعها هنا عمداً لتكون بعيدة عن الاستخدام اليومي.
                    </p>

                    <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap;">
                        <!-- الأزرار كبيرة وواضحة -->
                        <button id="rangeDeleteBtn" onclick="deleteReportsInRange()" class="btn btn-warning" style="padding: 15px 40px; font-size: 1.1rem; border: 2px solid #f59e0b;">
                            🗑 حذف الفترة المحددة
                        </button>

                        <button id="masterDeleteBtn" onclick="deleteAllReports()" class="btn btn-danger" style="padding: 15px 40px; font-size: 1.1rem; border: 2px solid #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);">
                            🔥 تصفير ومسح الكل (Format)
                        </button>
                    </div>

                </div>
                                    </div>

                                    <div id="tab-users" class="hidden">
                                        <div style="background: var(--glass); padding: 25px; border-radius: 30px; border: 1px dashed var(--glass-border); margin-bottom: 25px;">
                                            <h4>📝 إدارة الموظفين</h4>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                                <input type="text" id="newRealName" placeholder="الاسم الحقيقي">
                                                <input type="text" id="newUsername" placeholder="Username">
                                                <input type="text" id="newPassword" placeholder="Password">
                                                <input type="number" id="newAllowance" value="45">
                                                <input type="text" id="newFunTitle" placeholder="اللقب (مثلاً: أشطر كتكوت)" style="border-color: var(--vip-gold);">
                                                <select id="newUserGroup">
                                                    <option value="واتساب">جروب واتساب</option>
                                                    <option value="طلبات">جروب طلبات</option>
                                                </select>

                                                <div style="grid-column: span 2; display: flex; gap: 5px;">
                                                    <input type="text" id="newProfilePic" placeholder="رابط الصورة أو اختر من الجهاز" style="flex:1">
                                                    <button onclick="document.getElementById('adminPicInput').click()" class="btn btn-dark">📁 رفع</button>
                                                </div>
                                            </div>
                                <div style="margin: 15px 0; display: flex; gap: 20px;">
                                    <label style="color:#ffd700"><input type="checkbox" id="isVIPUser"> ⭐ VIP</label>
                                    <label style="color:var(--success)"><input type="checkbox" id="canFollowUp"> 📞 متابعة</label>

                                    <!-- الكود الجديد: خيار خدمة العملاء -->
                                    <label style="color:var(--primary); font-weight:bold; border:1px solid var(--primary); padding:0 10px; border-radius:10px;">
                                        <input type="checkbox" id="isCSAgent"> 🎧 خدمة عملاء (مكالمات + بريك فقط)
                                    </label>

                                </div>
                                            <button onclick="saveUser()" id="saveUserBtn" class="btn btn-success" style="width:100%">حفظ</button>
                                        </div>
                                        <div class="table-responsive"><table><thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>User</th>
                                    <!-- تم إضافة ID لهذه الخانات للتحكم بها -->
                                    <th id="headerUserPass">Pass</th>
                                    <th id="headerFilePass" style="color:var(--accent)">قفل الملف</th>
                                    <th>المدة</th>
                                    <th>اللقب/الدلع</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead><tbody id="usersManagementBody"></tbody></table></div>
                                    </div>

                                    <!-- قسم إدارة المجموعات -->
                                    <div id="tab-groups" class="hidden">
                                        <div style="background: var(--glass); padding: 25px; border-radius: 30px; border: 1px dashed var(--glass-border); margin-bottom: 25px;">
                                            <h4>👥 إنشاء وإدارة المجموعات</h4>
                                            <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">

                                                <!-- إدخال اسم المجموعة وزر الإنشاء -->
                                                <div style="flex: 1; min-width: 250px;">
                                                    <input type="text" id="groupNameInput" placeholder="اسم المجموعة (مثلاً: طلبات)" style="width: 100%; margin-bottom: 15px;">
                                                    <button onclick="createNewGroup()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                                                        🔗 إنشاء المجموعة
                                                    </button>
                                                </div>

                                                <!-- قائمة اختيار الأعضاء (تظهر الموظفين المتاحين) -->
                                                <div style="flex: 1; min-width: 250px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; max-height: 200px; overflow-y: auto;">
                                                    <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 10px;">اختر أعضاء المجموعة:</p>
                                                    <div id="membersSelectorList">
                                                        <!-- سيتم ملؤه بواسطة JS -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- جدول المجموعات (نفس اللي في الصورة) -->
                                        <div class="table-responsive">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>اسم المجموعة</th>
                                                        <th>الأعضاء</th>
                                                        <th>الحالة الآن</th>
                                                        <th>تحكم</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="groupsManagementBody">
                                                    <!-- المجموعات ستظهر هنا -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- ================= لوحة الموظف ================= -->
                                <div id="employeeSection" class="hidden">
                                    <!-- الهيدر الجديد المنظم -->
                                    <!-- صف الأزرار العلوي للموظف المحدث -->
                                    <button id="myProfileBtn" onclick="openMyProfile()" class="btn btn-dark btn-sm" style="margin-top:8px; position:relative; border:1px solid var(--glass-border);">
                                        📂 ملفي والشكاوى
                                        <span id="profileNotificationBadge" class="hidden" style="position:absolute; top:-8px; left:-8px; background:red; color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:0.7rem;">0</span>
                                    </button>

                                    <button onclick="openPrayerCloudHistory()" class="btn btn-dark btn-sm" style="margin-top:8px; border:1px solid #6366f1;">
                                        ☁️ سجل الصلوات السحابي
                                    </button>

                                    <button onclick="openFilePassModal(false)" class="btn btn-dark btn-sm" style="margin-top:8px; border:1px solid var(--accent); color:var(--accent);">
                                        🔑 تغيير قفل الملف
                                    </button>

                                    <button onclick="openPerformanceGallery()" class="btn btn-dark btn-sm" style="margin-top:8px; border:1px solid #06b6d4; color:#06b6d4;">
                                        🖼️ معرض التميز والأداء
                                    </button>

                                    <!-- الزر الجديد الذي طلبته هنا -->
                                    <button onclick="document.getElementById('weeklyScheduleModal').classList.remove('hidden')" class="btn btn-dark btn-sm" style="margin-top:8px; border:1px solid #10b981; color:#10b981;">
                                        🗓️ جدول الترتيب الأسبوعي
                                    </button>

                                    <div class="header-wrapper">

                                        <!-- الجزء اليمين: الصورة والبيانات -->
                                        <div style="display: flex; align-items: center; gap: 20px;">

                                            <!-- صورة البروفايل مع زر الكاميرا -->
                                            <div class="profile-pic-container" style="position: relative;">
                                                <img id="userProfilePicDisplay" src="" class="profile-img-lg" style="margin:0;">

                                                <!-- زر 1: تغيير الصورة (الكاميرا) -->
                                                <button onclick="updateMyProfilePic()" class="edit-pic-badge" title="تغيير الصورة">📷</button>
                                            </div>

                                            <!-- الاسم وزر الملف -->
                                            <div>
                                                <h2 id="welcomeMsg" style="margin:0; font-size:1.4rem; line-height:1.2;"></h2>
                                                <div id="userFunTitleDisplay"></div>
                                            </div>
                                        </div>

                                        <!-- الجزء الشمال: الساعة والتاريخ (التصميم الجديد) -->
                                        <div style="display: flex; align-items: center; gap: 20px;">
                                            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(6, 182, 212, 0.3)); padding: 14px 28px; border-radius: 22px; border: 2px solid rgba(99, 102, 241, 0.6); box-shadow: 0 0 25px rgba(99, 102, 241, 0.5), inset 0 0 12px rgba(99, 102, 241, 0.2); backdrop-filter: blur(10px);">
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <span style="font-size: 1.5rem;">⏰</span>
                                                    <div>
                                                        <span id="userServerTime" style="font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.5rem; color: #38bdf8; text-shadow: 0 0 12px rgba(56, 189, 248, 0.9); letter-spacing: 2px;">00:00:00</span>
                                                        <br>
                                                        <span id="userServerDate" style="font-size: 0.95rem; color: #06b6d4; font-weight: 700; opacity: 0.95; letter-spacing: 1px;">10/01/2026</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <button onclick="logout()" class="btn btn-danger btn-sm" style="height: 45px; width: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);" title="تسجيل خروج">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                                    <polyline points="16 17 21 12 16 7"></polyline>
                                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- قسم العدادات والرسائل -->
                                    <div class="employee-hero-grid">
                                        <div class="hero-card">
                                            <div id="welcomeBackArea"></div>
                                            <div class="timer-container">
                                                <svg class="timer-svg">
                                                    <circle cx="110" cy="110" r="100" class="timer-circle-bg"></circle>
                                                    <circle cx="110" cy="110" r="100" class="timer-circle-fg" id="timerCircle" stroke-dasharray="628" stroke-dashoffset="0"></circle>
                                                </svg>
                                                <div class="timer-text-overlay">
                                                    <div class="timer-big-text" id="userTimer">00:00</div>
                                                    <div id="timerLabel">رصيد البريك</div>
                                                    <div id="elapsedTime" style="font-size: 0.8rem; color: #aaa; margin-top: 5px;"></div>
                                                </div>
                                            </div>
                                            <h3 id="userStatusMsg" style="color: var(--success); text-align: center; margin-top: 15px;">متاح ✅</h3>
                                            <div id="overtimeAlert" class="hidden" style="background: var(--danger); padding: 10px; border-radius: 15px; margin-top: 10px;">⚠️ أكسدة!</div>
                                        </div>
                                        <div class="hero-card broadcast-box">
                                            <h4 style="color:var(--primary); border-bottom:1px solid var(--glass-border); padding-bottom:10px;">🔔 التوجيهات</h4>
                                            <div id="employeeBroadcastLog" class="log-container"></div>
                                        </div>
                                    </div>

                                    <!-- قسم الشركاء -->
                                    <div class="partners-section" style="background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 25px; padding: 20px; margin: 20px 0; text-align: center;">


                                        </div>

                                    <!-- صندوق تنبيه اكتمال العدد -->
                                    <div id="breakLimitAlert" style="display:none; background:rgba(220, 38, 38, 0.2); border:1px solid #ef4444; color:#ffcccc; padding:15px; border-radius:15px; margin:15px 0; text-align:center; font-weight:bold; animation: pulse 2s infinite;">
                                    </div>

                                    <!-- منطقة التحكم والأزرار (هنا كان الخطأ، يجب أن تكون داخل employeeSection) -->
                                    <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 30px; padding: 25px; text-align: center;">
                                        
                                        <!-- لوحة الجودة / خدمة العملاء -->
                                        <div id="csAgentDashboard" class="hidden" style="margin-top:20px;">
                                            <div style="background:rgba(56, 189, 248, 0.1); border:1px solid var(--primary); padding:20px; border-radius:20px; margin-bottom:25px;">
                                                <h3 style="margin-top:0; color:var(--primary); display:flex; align-items:center; gap:10px;">
                                                    🎧 رفع تقييم مكالمة (Quality Assurance)
                                                </h3>
                                                
                                                <select id="csTargetUser" class="form-control-glass">
                                                    <option value="">-- اختر الموظف --</option>
                                                </select>

                                                <input type="text" id="csCallTitle" placeholder="رقم العميل أو عنوان المكالمة" class="form-control-glass">
                                                <textarea id="csCallNote" placeholder="ملاحظات الجودة / التقييم..." class="form-control-glass" style="height:80px;"></textarea>
                                                
                                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                                                    <div class="upload-box">
                                                        <label style="cursor:pointer; display:block; text-align:center; color:var(--primary);">
                                                            🎙️ ملف الصوت
                                                            <input type="file" id="csAudioInput" accept="audio/*" style="display:none" onchange="previewCsAudio(this)">
                                                        </label>
                                                        <div id="csAudioName" class="file-name-display"></div>
                                                    </div>
                                                    <div class="upload-box">
                                                        <label style="cursor:pointer; display:block; text-align:center; color:var(--warning);">
                                                            🖼️ سكرين شوت
                                                            <input type="file" id="csImageInput" accept="image/*" style="display:none" onchange="previewCsImage(this)">
                                                        </label>
                                                        <div id="csImageName" class="file-name-display"></div>
                                                    </div>
                                                </div>
                                                <img id="csImagePreview" src="" style="display:none; width:100px; height:100px; object-fit:cover; border-radius:10px; margin:0 auto 15px auto; border:2px solid var(--warning);">
                                                <button onclick="uploadCsCall()" class="btn btn-primary" style="width:100%;">💾 حفظ في ملف الموظف</button>
                                            </div>
                                        </div>

                                        <!-- الأزرار العادية للموظف -->
                                        <div id="controlsArea">
                                            <input type="text" id="breakReason" placeholder="اكتب سبب النشاط هنا..." class="form-control-glass" style="text-align: center; font-size: 1.1rem;">
                                            
                                            <div id="vipControlArea" class="hidden" style="margin-bottom: 20px;">
                                                <button onclick="startMyBreak('استراحة VIP')" class="btn btn-vip" style="width:100%; max-width:500px;">👑 بدء استراحة VIP</button>
                                            </div>

                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; max-width: 800px; margin: 0 auto;">
                                                <div style="border:1px solid var(--success); padding:8px; border-radius:15px;"><h4>🍔 بريك</h4><button onclick="startMyBreak('بريك عام')" class="btn btn-success" style="width:100%">ابدأ</button></div>
                                                <div style="border:1px solid var(--primary); padding:8px; border-radius:15px;"><h4>🕌 صلاة</h4><button onclick="startMyBreak('صلاة')" class="btn btn-primary" style="width:100%">ابدأ</button></div>

        <div style="border:1px solid var(--warning); padding:8px; border-radius:15px;"><h4>🤝 ميتنج</h4><div id="meetingStatusArea"><button onclick="sendMeetingRequest()" class="btn btn-warning" style="width:100%">طلب</button></div></div>

        <div id="followUpCard" class="hidden" style="border:1px solid #10b981; padding:8px; border-radius:15px;"><h4>📞 متابع</h4><button onclick="startMyBreak('متابع عميل')" class="btn btn-success" style="width:100%; background:#10b981;">ابدأ</button></div>
                                                <div style="border:1px solid var(--danger); padding:8px; border-radius:15px;"><h4>🚨 طوارئ</h4><div id="emStatusArea"><button onclick="sendEmRequest()" class="btn btn-danger" style="width:100%">طلب</button></div></div>
                                            </div>

                            

                                            <!-- قسم الإضافي -->
                                            <div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 25px; border: 1px solid var(--glass-border); max-width: 500px; margin: 25px auto 0;">
                                                <h4 style="margin:0 0 10px 0; color:var(--primary)">💼 طلب إضافي</h4>
                                                <div style="display: flex; gap: 10px;">
                                                    <input type="number" id="otHoursInput" placeholder="ساعات" class="form-control-glass" style="margin:0; flex:1">
                                                    <button onclick="sendOtRequest()" class="btn btn-primary">إرسال</button>
                                                </div>
                                                <p id="otStatusDisplay"></p>
                                            </div>

                                            <!-- قسم طلب الاستأذان (يوضع تحت قسم الإضافي في لوحة الموظف) -->
                                            <div style="margin-top: 15px; padding: 20px; background: rgba(168, 85, 247, 0.1); border-radius: 25px; border: 1px solid #a855f7; max-width: 500px; margin: 15px auto;">
                                                <h4 style="margin:0 0 10px 0; color:#c084fc">🚪 طلب استأذان / مغادرة</h4>

                                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                                    <input type="number" id="permHoursInput" placeholder="عدد الساعات" class="form-control-glass" style="margin:0; flex:1">
                                                    <input type="text" id="permReasonInput" placeholder="سبب الاستأذان..." class="form-control-glass" style="margin:0; flex:2">
                                                </div>

                                                <div id="permStatusArea">
                                                    <button onclick="sendPermRequest()" class="btn btn-primary" style="background: linear-gradient(135deg, #a855f7, #7e22ce); width: 100%;">إرسال الطلب</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- زر الإيقاف -->
                                        <div id="stopArea" class="hidden">
                                            <button onclick="stopMyBreak()" class="btn btn-danger" style="padding: 25px; width: 100%; max-width: 600px; font-size: 1.6rem; border-radius: 25px;">🛑 إنهاء النشاط والعودة</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <script>
                                // منع القائمة اليمنى (Right Click)
                                document.addEventListener('contextmenu', event => event.preventDefault());

                                // منع اختصارات لوحة المفاتيح المشهورة لفتح Inspect Element
                                document.onkeydown = function(e) {
                                    if (e.keyCode == 123) { // F12
                                        return false;
                                    }
                                    if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
                                        return false;
                                    }
                                    if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
                                        return false;
                                    }
                                    if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
                                        return false;
                                    }
                                    if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U (رؤية السورس)
                                        return false;
                                    }
                                }

                                // تكوين Firebase
                                const firebaseConfig = {
                                    apiKey: "AIzaSyBojsAZ73wpf-4cD8TviULncyxIIOUO2qY",
                                    authDomain: "brak-nagaf.firebaseapp.com",
                                    projectId: "brak-nagaf",
                                    storageBucket: "brak-nagaf.firebasestorage.app",
                                    messagingSenderId: "149166416863",
                                    appId: "1:149166416863:web:e94fe392f868da07bbda6a",
                                    measurementId: "G-Z82Y7NHNGE",
                                    // تم استنتاج رابط قاعدة البيانات بناءً على اسم المشروع الجديد
                                    databaseURL: "https://brak-nagaf-default-rtdb.firebaseio.com/"
                                };

                                let db;
                                try {
                                    firebase.initializeApp(firebaseConfig);
                                    db = firebase.database();
                                } catch(e) {
                                    console.error("Firebase Error:", e);
                                }

                                let allUsersData = {}, currentUser = null, timerInterval = null, isLoaded = false;
                                let adminTypingBuffer = {}, adminSelectBuffer = {}, editingUserKey = null, soundActive = false;
                                let maxBreaksAllowed = 3, maxPrayersAllowed = 2, lastReceivedBroadcastID = localStorage.getItem('last_broadcast_id') || "";
                                let currentProfileTarget = null; // الموظف الذي نعرض ملفه حالياً
                                let csAudioBase64 = null;
                                let csImageBase64 = null;
                                let lastUnreadCount = 0; // متغير لتذكر العدد السابق
                                let pendingProfileUser = null;
                                let isPrayerWindowOpen = false;
                                let cachedArchiveData = []; // متغير عالمي لتخزين بيانات الأرشيف مؤقتاً لتسريع البحث
                                let allGroupsData = {}; // متغير لتخزين بيانات المجموعات
                                let currentQueue = []; // متغير لتخزين الطابور الحالي
                                // متغير لحفظ "شكل" الجدول الأخير عشان منرسموش لو مفيش تغيير هيكلي
                                let lastTableStructure = "";

    // 1. المتغيرات
    let selectedRotationMembers = []; // الموظفين اللي المشرف اختارهم بس
    let currentRotationOffset = 0;

    // 2. تحديث قائمة الاختيار (Checkbox لكل موظف)
    function updateRotationSelectorUI() {
        const container = document.getElementById('rotationMembersSelector');
        if(!container) return;
        
        let html = '';
        Object.values(allUsersData).forEach(u => {
            if(u.username && !MANAGERS.includes(u.username)) {
                const isChecked = selectedRotationMembers.includes(u.username) ? 'checked' : '';
                html += `
                    <label style="background:rgba(255,255,255,0.05); padding:5px 10px; border-radius:10px; cursor:pointer;">
                        <input type="checkbox" class="rot-check" value="${u.username}" ${isChecked} onchange="updateSelectedFromUI()"> 
                        ${u.realName || u.username}
                    </label>`;
            }
        });
        container.innerHTML = html;
    }

    // 3. تحديث المصفوفة لما المشرف يعلم على حد
    function updateSelectedFromUI() {
        const checks = document.querySelectorAll('.rot-check:checked');
        selectedRotationMembers = Array.from(checks).map(c => c.value);
        renderRotationTable();
    }

    // 4. حفظ الإعدادات في Firebase
    function saveRotationSettings() {
        db.ref('settings/prayerRotation').set({
            members: selectedRotationMembers, // القائمة الثابتة
            offset: currentRotationOffset    // الرقم اللي بيحرك الدور
        }).then(() => {
            applyRotationToQueue(); // تطبيق الترتيب فوراً على الطابور
            alert("تم حفظ مجموعة التدوير وتحديث الدور بنجاح ✅");
        });
    }

    // 6. تدوير الأدوار (اللفافة)
    function rotateManually() {
        // أضف هذا السطر في البداية:


        const n = selectedRotationMembers.length;
        if (n === 0) return alert("اختار الموظفين أولاً!");

        currentRotationOffset = (currentRotationOffset + 1) % n;

        db.ref('settings/prayerRotation/offset').set(currentRotationOffset).then(() => {
            applyRotationToQueue();
            alert("🔄 تم تدوير الدور وحفظ النسخة السابقة في السجل!");
        });
    }

    // دالة لحفظ الترتيب الحالي في نود جديد بالداتابيز


    // 7. تطبيق الترتيب على "طابور الصلاة" عشان الموظف يشوفه
    function applyRotationToQueue() {
        const n = selectedRotationMembers.length;
        if (n === 0) return;

        // بناء الطابور المرتب بناءً على الساقية الحالية
        let sortedQueue = [];
        for (let i = 0; i < n; i++) {
            // نبحث عن الشخص الذي ترتيبه الحالي هو (i+1)
            // الطريقة الرياضية الصحيحة لجعل الترتيب عادلاً ومتحركاً
            let memberIndex = selectedRotationMembers.findIndex((un, idx) => {
                return ((idx + currentRotationOffset) % n) === i;
            });
            sortedQueue.push(selectedRotationMembers[memberIndex]);
        }

        // إرسال الترتيب النهائي لـ Firebase ليراه الموظفون
        db.ref('settings/prayerQueue').set(sortedQueue);
    }

                                // إعدادات Cloudinary (تم تحديثها ببياناتك)
                                // 1. ده الاسم اللي جبته من الصورة بتاعتك
                                const CLOUD_NAME = "dr2ekwtae";

                                // 2. ده لازم تجيبه من الإعدادات زي ما شرحتلك فوق (تأكد إنه Unsigned)
                                const UPLOAD_PRESET = "my_preset";

                                async function uploadToCloudinary(file) {
                                    if (!file) return null;

                                    const formData = new FormData();
                                    formData.append("file", file);
                                    formData.append("upload_preset", UPLOAD_PRESET);

                                    try {
                                        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
                                            method: "POST",
                                            body: formData
                                        });

                                        const data = await response.json();

                                        if (!response.ok) {
                                            // هنا السيرفر هيقولنا السبب بالظبط
                                            console.error("Cloudinary Error:", data);
                                            alert("خطأ من السيرفر: " + (data.error ? data.error.message : "خطأ غير معروف"));
                                            return null;
                                        }

                                        return data.secure_url;
                                    } catch (error) {
                                        console.error("Upload Error:", error);
                                        alert("فشل الاتصال بالسيرفر، تأكد من جودة النت.");
                                        return null;
                                    }
                                }

                                // 1. تعديل دالة فتح البروفايل لاستخدام النافذة الآمنة
                                function openUserProfile(username) {
                                    const u = allUsersData[username];
                                    if(!u) return;

                                    const isAdmin = MANAGERS.includes(currentUser.username);
                                    const isOwner = (currentUser.username === username);

                                    // إذا كان الموظف هو من يفتح ملفه
                                    if (!isAdmin && isOwner) {
                                        // إذا لم يكن لديه باسورد بعد
                                        if (!u.filePassword) {
                                            alert("🔒 لم تقم بتعيين كلمة سر لخصوصية ملفك بعد. يرجى تعيينها الآن.");
                                            openFilePassModal(true);
                                            return;
                                        }

                                        // بدلاً من prompt، نفتح النافذة الآمنة
                                        pendingProfileUser = username;
                                        document.getElementById('accessFilePassInput').value = ''; // تصفير الحقل
                                        document.getElementById('accessFileModal').classList.remove('hidden');
                                        document.getElementById('accessFilePassInput').focus();
                                        return;
                                    }

                                    // لو أدمن، يفتح علطول
                                    loadProfileData(username);
                                }

                                // دالة التحقق من الباسورد في النافذة الجديدة
                                function confirmAccessFile() {
                                    const inputPass = document.getElementById('accessFilePassInput').value;
                                    const u = allUsersData[pendingProfileUser];

                                    if (inputPass === u.filePassword) {
                                        document.getElementById('accessFileModal').classList.add('hidden');
                                        loadProfileData(pendingProfileUser); // فتح الملف
                                    } else {
                                        alert("❌ كلمة السر غير صحيحة!");
                                        document.getElementById('accessFilePassInput').value = '';
                                    }
                                }

                                function closeAccessModal() {
                                    document.getElementById('accessFileModal').classList.add('hidden');
                                    pendingProfileUser = null;
                                }

                                // دالة تحميل البيانات (فصلناها لتسهيل الاستدعاء)
                                function loadProfileData(username) {
                                    currentProfileTarget = username;
                                    const u = allUsersData[username];
                                    const isAdmin = MANAGERS.includes(currentUser.username);

                                    document.getElementById('profileModal').classList.remove('hidden');
                                    document.getElementById('modalRealName').innerText = u.realName || username;
                                    document.getElementById('modalUserName').innerText = `@${u.username}`;
                                    document.getElementById('modalProfilePic').src = u.profilePic || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';

                                    if (isAdmin) {
                                        document.getElementById('adminAddComplaintArea').classList.remove('hidden');
                                    } else {
                                        document.getElementById('adminAddComplaintArea').classList.add('hidden');
                                        // تحديث حالة المشاهدة
                                        if (u.complaints) {
                                            Object.keys(u.complaints).forEach(key => {
                                                if (!u.complaints[key].seen && !u.complaints[key].acknowledged) {
                                                    db.ref(`users/${username}/complaints/${key}`).update({ seen: true });
                                                }
                                            });
                                        }
                                    }

                                    // تصفير الفلاتر عند الفتح
                                    clearHistoryFilters(false);
                                    renderComplaintsHistory(username);
                                }

                                // دالة تصفير الفلاتر
                                function clearHistoryFilters(reload = true) {
                                    document.getElementById('historyDateFrom').value = '';
                                    document.getElementById('historyDateTo').value = '';
                                    if(reload && currentProfileTarget) renderComplaintsHistory(currentProfileTarget);
                                }

                                // 2. تعديل دالة عرض الشكاوى (لإضافة الفلترة + إخفاء الحذف عن abutamim)
                                function renderComplaintsHistory(username) {
                                    const tbody = document.getElementById('complaintsHistoryBody');
                                    tbody.innerHTML = '';

                                    if (!allUsersData[username]) return;

                                    const u = allUsersData[username];
                                    const viewingMyOwnProfile = (currentUser.username === username);

                                    // التعديل هنا: السماح بالحذف لأي شخص رتبته admin بدون استثناءات
                                    const canDelete = currentUser.role === 'admin';

                                    // قراءة الفلاتر
                                    const filterFrom = document.getElementById('historyDateFrom').value;
                                    const filterTo = document.getElementById('historyDateTo').value;

                                    if (u.complaints) {
                                        const keys = Object.keys(u.complaints).reverse().slice(0, 50);

                                        keys.forEach(key => {
                                            const c = u.complaints[key];

                                            // منطق الفلترة بالتاريخ
                                            if (filterFrom || filterTo) {
                                                // تحويل تاريخ الشكوى من DD/MM/YYYY إلى YYYY-MM-DD للمقارنة
                                                const parts = c.date.split('/');
                                                const cDateISO = `${parts[2]}-${parts[1]}-${parts[0]}`;

                                                if (filterFrom && cDateISO < filterFrom) return; // تخطي
                                                if (filterTo && cDateISO > filterTo) return; // تخطي
                                            }

                                            let actionCell = '';

                                            // منطق الحالات
                                            if (c.acknowledged) {
                                                actionCell += `<div style="color:#10b981; font-weight:bold; font-size:0.9rem;">✔ تم التأكيد</div>`;
                                            } else if (c.seen) {
                                                if (currentUser.role === 'admin') {
                                                    actionCell += `<div style="color:#3b82f6; font-size:0.85rem;">👁️ شاهدها</div>`;
                                                } else if (viewingMyOwnProfile) {
                                                    actionCell += `<button onclick="acknowledgeComplaint('${key}')" class="btn btn-vip btn-sm" style="animation: pulse 2s infinite;">✍ موافق</button>`;
                                                }
                                            } else {
                                                if (currentUser.role === 'admin') {
                                                    actionCell += `<div style="color:#f59e0b; font-size:0.85rem;">⏳ لم يفتح</div>`;
                                                }
                                            }

                                            // زر الحذف (يظهر فقط إذا كان مسموح له)
                                            if (canDelete) {
                                                actionCell += `<div style="margin-top:5px;">
                                                    <button onclick="deleteComplaint('${username}', '${key}')" class="btn btn-danger btn-sm">🗑</button>
                                                </div>`;
                                            }

                                            // المرفقات
                                            const evidenceBtn = c.evidence ? `<button onclick="showZoomImage('${c.evidence}')" class="btn btn-primary btn-sm">📷</button>` : '';
                                            const audioPlayer = c.audioRecord ? `<div style="margin-top:5px;"><audio controls src="${c.audioRecord}" style="height:25px; width:150px;"></audio></div>` : '';
                                            const proofCell = (evidenceBtn || audioPlayer) ? `<div>${evidenceBtn} ${audioPlayer}</div>` : '-';

                                            // لون الصف
                                            let rowColor = 'rgba(255,255,255,0.02)';
                                            if (!c.acknowledged && !c.seen) rowColor = 'rgba(245, 158, 11, 0.08)';
                                            if (!c.acknowledged && c.seen) rowColor = 'rgba(59, 130, 246, 0.08)';

                                            tbody.innerHTML += `
                                                <tr style="background:${rowColor}; border-bottom:1px solid rgba(255,255,255,0.05);">
                                                    <td>${escapeHtml(c.date)}<br><small style="opacity:0.7">${escapeHtml(c.time)}</small></td>
                                                    <td style="color:var(--primary); font-weight:bold;">${escapeHtml(c.title)}</td>
                                                    <td style="font-size:0.9rem;">${escapeHtml(c.details)}</td>
                                                    <td style="color:#ffd700;">${c.amount > 0 ? escapeHtml(c.amount.toString()) : '-'}</td>
                                                    <td>${proofCell}</td>
                                                    <td>${escapeHtml(c.uploader || c.admin || 'System')}</td>
                                                    <td style="text-align:center;">${actionCell}</td>
                                                </tr>
                                            `;
                                        });
                                    } else {
                                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">نظيف 🌟 (أو لا توجد نتائج للبحث)</td></tr>';
                                    }
                                }

                                // 3. تأمين دالة الحذف أيضاً
                                // دالة حذف الشكوى (متاحة لجميع المشرفين مع الرقابة الصارمة)
    function deleteComplaint(username, key) {
        // 1. التأكد أن المستخدم مشرف
        if (currentUser.role !== 'admin') {
            alert("⛔ عذراً، الحذف للمشرفين فقط.");
            return;
        }

        // 2. رسالة تحذير
        if(!confirm("⚠️ هل أنت متأكد من حذف هذه المخالفة؟\n\nسيتم تسجيل العملية في سجل الرقابة (الأرشيف) مع اسمك وتفاصيل المحذوف.")) return;

        const complaintRef = db.ref('users/' + username + '/complaints/' + key);

        // 3. قراءة البيانات قبل الحذف لتسجيلها
        complaintRef.once('value', (snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                // تجهيز نص الأرشيف
                const deletedDetails = `قام (${currentUser.realName || currentUser.username}) بحذف مخالفة للموظف (${username}). تفاصيل المخالفة المحذوفة: [العنوان: ${data.title}] - [الخصم: ${data.amount || 0}] - [السبب: ${data.details}] - [تاريخ المخالفة: ${data.date}]`;

                // 4. التسجيل في الأرشيف (admin_logs)
                // نستخدم دالة logDeletionAction الموجودة عندك بالفعل
                logDeletionAction("حذف مخالفة من الملف", username, deletedDetails);

                // 5. تنفيذ الحذف الآن
                complaintRef.remove()
                    .then(() => {
                        alert("✅ تم الحذف وتم تسجيل العملية في الأرشيف للمراجعة.");
                        renderComplaintsHistory(username); // تحديث الجدول فوراً
                    })
                    .catch((error) => {
                        alert("حدث خطأ: " + error.message);
                    });
            } else {
                alert("المخالفة غير موجودة أو تم حذفها مسبقاً.");
                renderComplaintsHistory(username);
            }
        });
    }

                                // دالة للتحقق من الشكاوى الجديدة في ملف الموظف
                                function checkProfileNotifications(userData) {
                                    const badge = document.getElementById('profileNotificationBadge');
                                    const btn = document.getElementById('myProfileBtn');
                                    const sound = document.getElementById('complaintSound');

                                    if (!userData || !userData.complaints) {
                                        badge.classList.add('hidden');
                                        btn.classList.remove('alert-mode', 'dance-alert');
                                        return;
                                    }

                                    const unreadCount = Object.values(userData.complaints).filter(c => !c.acknowledged).length;

                                    if (unreadCount > 0) {
                                        badge.innerText = unreadCount;
                                        badge.classList.remove('hidden');
                                        badge.style.display = 'flex';

                                        // الزرار هيرقص وينور
                                        btn.classList.add('dance-alert');

                                        // لو في حاجة جديدة لسه واصلة
                                        if (unreadCount > lastUnreadCount) {
                                            triggerFunnySurprise(); // شغل الحفلة
                                            if (soundActive) {
                                                sound.play().catch(e => console.log("Sound error"));
                                            }
                                        }
                                    } else {
                                        badge.classList.add('hidden');
                                        btn.classList.remove('alert-mode', 'dance-alert');
                                    }
                                    lastUnreadCount = unreadCount;
                                }

                                // دالة الحفلة المضحكة
                                function triggerFunnySurprise() {
                                    const messages = [
                                        "أومال إيه اللي في ملفك ده يا بطل؟ 😂",
                                        "المدير بيمسي عليك بحاجة حلوة في الملف 🎁",
                                        "شكلك عملت مصيبة.. روح شوف ملفك بسرعة! 🏃‍♂️",
                                        "في هدية (أو خناقة) مستنياك في الملف 👀",
                                        "يا عيني على اللي اتكتب في السجل النهاردة! 📝"
                                    ];

                                    // إظهار الرسالة
                                    const toast = document.getElementById('funnyToast');
                                    document.getElementById('funnyToastText').innerText = messages[Math.floor(Math.random() * messages.length)];
                                    toast.classList.add('show');

                                    // طير إيموجيات في الشاشة
                                    for(let i=0; i<15; i++) {
                                        setTimeout(() => {
                                            const emoji = document.createElement('div');
                                            emoji.className = 'floating-emoji';
                                            const icons = ['🎁', '🚨', '📜', '😂', '👻', '🔥'];
                                            emoji.innerText = icons[Math.floor(Math.random() * icons.length)];
                                            emoji.style.left = Math.random() * 100 + "vw";
                                            emoji.style.animationDuration = (Math.random() * 2 + 2) + "s";
                                            document.body.appendChild(emoji);
                                            setTimeout(() => emoji.remove(), 4000);
                                        }, i * 200);
                                    }

                                    // إخفاء الرسالة بعد 5 ثواني
                                    setTimeout(() => {
                                        toast.classList.remove('show');
                                    }, 5000);
                                }
                                
                                // دالة تسجيل عمليات الحذف (أرشيف الرقابة)
                                function logDeletionAction(actionType, targetName, details) {
                                    const logData = {
                                        adminName: currentUser.realName || currentUser.username, // مين اللي مسح
                                        adminUser: currentUser.username,
                                        action: actionType, // نوع المسح (حذف موظف، حذف شكوى..)
                                        target: targetName, // الضحية (اسم الموظف اللي اتمسح له حاجة)
                                        details: details || "لا توجد تفاصيل",
                                        timestamp: getServerTime(),
                                        dateStr: getServerDateString() + ' ' + getServerTimeString()
                                    };

                                    // الحفظ في مكان اسمه admin_logs
                                    db.ref('admin_logs').push(logData);
                                }

                                // Helper function to escape HTML to prevent XSS
                                function escapeHtml(text) {
                                    const div = document.createElement('div');
                                    div.textContent = text;
                                    return div.innerHTML;
                                }

                                let initialServerTime = Date.now(), initialPerformanceTime = performance.now();
                                db.ref(".info/serverTimeOffset").on("value", (snap) => {
                                    initialServerTime = Date.now() + (snap.val() || 0);
                                    initialPerformanceTime = performance.now();
                                });

                                function getServerTime() { return initialServerTime + (performance.now() - initialPerformanceTime); }
                                function getServerDateString() { const d = new Date(getServerTime()); return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`; }
                                function getServerTimeString() { const d = new Date(getServerTime()); let h = d.getHours(); const m = d.getMinutes().toString().padStart(2, '0'), s = d.getSeconds().toString().padStart(2, '0'), ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; return `${h.toString().padStart(2, '0')}:${m}:${s} ${ampm}`; }

                                const MANAGERS = ['mahmoud', 'abutamim', 'ahmed'];

                                function getDeviceType() {
                                    const ua = navigator.userAgent;
                                    if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "tablet";
                                    if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) return "mobile";
                                    return "desktop";
                                }

                                const localLoadTime = Date.now();
                                db.ref('refreshSignal').on('value', (snap) => {
                                    const signalTime = snap.val();
                                    if (signalTime && signalTime > localLoadTime && currentUser && currentUser.role !== 'admin') { location.reload(); }
                                });

                                function triggerGlobalRefresh() { db.ref('refreshSignal').set(getServerTime()); }

    function activateSystemAndSound() {
        sessionStorage.setItem('systemActive', 'true');
        soundActive = true;

        // تفعيل جميع الأصوات (فك الحظر من المتصفح)
        const allSounds = ['alarmSound', 'notifySound', 'broadcastSound', 'complaintSound', 'requestRing'];

        allSounds.forEach(id => {
            const audio = document.getElementById(id);
            if (audio) {
                audio.volume = 0; // صامت (للتجهيز فقط)
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = 1; // إرجاع الصوت لوضعه الطبيعي
                }).catch(e => console.log("Audio init:", e));
            }
        });

        document.getElementById('forceSoundOverlay').style.display = 'none';
        alert("✅ تم تفعيل النظام والأصوات بنجاح!");
        startGlobalTimer();
    }

                                function activateAdminSound() {
                                    ['alarmSound', 'notifySound', 'requestRing', 'broadcastSound'].forEach(id => {
                                        const s = document.getElementById(id);
                                        s.volume = 0;
                                        s.play().then(() => {
                                            s.pause(); s.currentTime = 0; s.volume = 1;
                                        }).catch(e => console.log(e));
                                    });
                                    soundActive = true;
                                    sessionStorage.setItem('systemActive', 'true');
                                    if ("Notification" in window) Notification.requestPermission();
                                    alert("تم تفعيل التنبيهات الصوتية بنجاح 🔊");
                                }

                                // دالة تبديل الصوت للمشرفين
                                function toggleAdminSound() {
                                    // عكس الحالة الحالية
                                    soundActive = !soundActive;

                                    const soundBtn = document.getElementById('adminSoundToggle');
                                    const ringAudio = document.getElementById('requestRing');

                                    if (soundActive) {
                                        // حالة التفعيل
                                        soundBtn.innerHTML = "🔊 الصوت: مفعل";
                                        soundBtn.classList.remove('btn-danger');
                                        soundBtn.classList.add('btn-success');

                                        // محاولة تشغيل صامت لفك حظر المتصفح للصوت
                                        ['notifySound', 'requestRing'].forEach(id => {
                                            const s = document.getElementById(id);
                                            s.volume = 0;
                                            s.play().then(() => { s.pause(); s.currentTime = 0; s.volume = 1; }).catch(e => {});
                                        });

                                        alert("🔊 تم تفعيل التنبيهات الصوتية");
                                    } else {
                                        // حالة الكتم
                                        soundBtn.innerHTML = "🔇 الصوت: مكتوم";
                                        soundBtn.classList.remove('btn-success');
                                        soundBtn.classList.add('btn-danger');

                                        // إيقاف الجرس فوراً إذا كان يعمل
                                        if (ringAudio) {
                                            ringAudio.pause();
                                            ringAudio.currentTime = 0;
                                        }

                                        alert("🔇 تم كتم جميع التنبيهات الصوتية");
                                    }
                                }

                                // الاستماع للرسائل الجديدة فقط لتشغيل الصوت
                                db.ref('broadcasts').on('child_added', (snap) => {
                                    if (isInitialLoad) return; // تجاهل الرسائل القديمة عند فتح الصفحة

                                    const b = snap.val();
                                    const bKey = snap.key;

                                    // التأكد أن الرسالة تخص الموظف الحالي وليست مرسلة قديمة
                                    if (currentUser && currentUser.role !== 'admin') {
                                        let forMe = (!b.target || b.target === 'all');
                                        if(!forMe) {
                                            let targets = Array.isArray(b.target) ? b.target : [b.target];
                                            if(targets.includes(currentUser.username)) forMe = true;
                                        }

                                        if(forMe) {
                                            showBroadcastOverlay(b);
                                            // الصوت يعمل هنا فقط عند إضافة "ابن" جديد للنود وليس عند الحذف
                                            if (soundActive) document.getElementById('broadcastSound').play().catch(e => {});
                                        }
                                    }
                                });

                                // تحديث السجل فقط عند حدوث أي تغيير (إضافة أو حذف) بدون صوت
                                // متغير عالمي لحفظ الرسايل في الذاكرة
                                let cachedBroadcasts = {};

                                db.ref('broadcasts').on('value', (snap) => {
                                    const data = snap.val() || {};
                                    cachedBroadcasts = data;
                                    const employeeLog = document.getElementById('employeeBroadcastLog');

                                    renderBroadcastLog(); // استدعاء دالة الرسم

                                    const keys = Object.keys(data).sort((a, b) => data[b].timestamp - data[a].timestamp);

                                    if (keys.length > 0) {
                                        const latestKey = keys[0];
                                        const b = data[latestKey];

                                        // التحقق: هل هذه رسالة جديدة ولم يتم عرضها من قبل؟ وهل أرسلت منذ أقل من 10 ثوانٍ؟
                                        const isVeryRecent = (getServerTime() - b.timestamp) < 10000;

                                        if (latestKey !== lastReceivedBroadcastID && isVeryRecent) {
                                            lastReceivedBroadcastID = latestKey;
                                            localStorage.setItem('last_broadcast_id', latestKey);

                                            if (currentUser && currentUser.role !== 'admin') {
                                                let forMe = (!b.target || b.target === 'all');
                                                if(!forMe) {
                                                    let targets = Array.isArray(b.target) ? b.target : Object.values(b.target);
                                                    if(targets.includes(currentUser.username)) forMe = true;
                                                }

                                        if(forMe) {
                                            showBroadcastOverlay(b); // هذه الدالة الآن تشغل الصوت تلقائياً
                                        }
                                            }
                                        }
                                    }
                                });

                                function renderBroadcastLog() {
                                    const data = cachedBroadcasts;
                                    const employeeLog = document.getElementById('employeeBroadcastLog');
                                    const adminLog = document.getElementById('adminBroadcastLog');

                                    if(employeeLog) employeeLog.innerHTML = "";
                                    if(adminLog) adminLog.innerHTML = "";

                                    // ترتيب الرسايل من الأحدث للأقدم
                                    const keys = Object.keys(data).sort((a, b) => data[b].timestamp - data[a].timestamp);

                                    keys.forEach(key => {
                                        const b = data[key];
                                        const timeStr = new Date(b.timestamp).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});

                                        // رسم لوحة الإدارة (الأدمن)
                                        const adminImageTag = b.image ? `<br><img src="${b.image}" style="width:100px; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="showZoomImage('${b.image}')">` : "";
                                        if (adminLog) {
                                            adminLog.innerHTML += `<div style="padding:4px; border-bottom:1px solid rgba(255,255,255,0.1)"><b>[${timeStr}]</b> ${b.message} ${adminImageTag} <button onclick="deleteBroadcast('${key}')" style="background:none; border:none; color:red; cursor:pointer;">🗑</button></div>`;
                                        }

                                        // رسم لوحة الموظف (بشرط يكون مسجل دخول)
                                        if (employeeLog && currentUser) {
                                            let isForMe = (!b.target || b.target === 'all');
                                            if(!isForMe) {
                                                let targets = Array.isArray(b.target) ? b.target : (typeof b.target === 'object' ? Object.values(b.target) : [b.target]);
                                                if(targets.includes(currentUser.username)) isForMe = true;
                                            }
        if(isForMe) {
            const imageTag = b.image ? `<br><img src="${b.image}" style="width:100px; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="showZoomImage('${b.image}')">` : "";
            employeeLog.innerHTML += `<div class="broadcast-item"><b>[${timeStr}]</b> ${b.message || ''} ${imageTag}</div>`;
        }
                                        }
                                    });
                                }

                                // الاستماع لحالة نافذة الصلاة وتحديث الواجهة
                                db.ref('settings/prayerOpen').on('value', (snap) => {
                                    isPrayerWindowOpen = snap.val() === true;

                                    // تحديث النص في لوحة الأدمن
                                    const statusText = document.getElementById('prayerStatusText');
                                    if (statusText) {
                                        statusText.innerText = isPrayerWindowOpen ? "الحالة: مفتوحة الآن (يمكن للموظفين الصلاة)" : "الحالة: مغلقة (الزر معطل عند الموظفين)";
                                        statusText.style.color = isPrayerWindowOpen ? "var(--success)" : "var(--danger)";
                                    }

                                    // تحديث زر الصلاة عند الموظف
                                    updatePrayerButton();
                                });

                                // معاينة الصورة قبل الإرسال
                                function previewBroadcastImg(input) {
                                    if (input.files && input.files[0]) {
                                        const reader = new FileReader();
                                        reader.onload = function(e) {
                                            document.getElementById('brImgPreview').src = e.target.result;
                                            document.getElementById('brImgPreviewContainer').style.display = 'block';
                                        }
                                        reader.readAsDataURL(input.files[0]);
                                    }
                                }

                                // إزالة الصورة المختارة
                                function removeBrImg() {
                                    document.getElementById('broadcastImageInput').value = "";
                                    document.getElementById('brImgPreviewContainer').style.display = 'none';
                                }

                                // إرسال البث مع الصورة
                                async function sendBroadcastWithImage() {
                                    const msg = document.getElementById('broadcastInput').value.trim();
                                    const imageFile = document.getElementById('broadcastImageInput').files[0];
                                    const select = document.getElementById('broadcastTarget');
                                    const sendBtn = document.getElementById('sendBrBtn');

                                    let selectedValues = Array.from(select.selectedOptions).map(option => option.value);
                                    if (selectedValues.length === 0) selectedValues = ['all'];

                                    if (!msg && !imageFile) return alert("اكتب رسالة أو ارفع صورة");

                                    // تغيير حالة الزر
                                    sendBtn.disabled = true;
                                    sendBtn.innerHTML = "⏳ جاري الرفع والإرسال...";

                                    try {
                                        let imageUrl = "";
                                        if (imageFile) {
                                            imageUrl = await uploadToCloudinary(imageFile); // استخدام دالة الرفع الموجودة لديك
                                        }

                                        db.ref('broadcasts').push({
                                            message: msg,
                                            image: imageUrl,
                                            timestamp: getServerTime(),
                                            sender: currentUser.username,
                                            target: selectedValues.includes('all') ? 'all' : selectedValues
                                        });

                                        // إعادة ضبط الحقول
                                        document.getElementById('broadcastInput').value = "";
                                        removeBrImg();
                                        alert("تم إرسال الإعلان بنجاح ✅");
                                    } catch (e) {
                                        alert("حدث خطأ أثناء الرفع");
                                    } finally {
                                        sendBtn.disabled = false;
                                        sendBtn.innerHTML = "إرسال التنبيه الآن 🚀";
                                    }
                                }

                                function setPrayerWindow(status) {
        // تحديث حالة الفتح والغلق في قاعدة البيانات فقط
        // تم إزالة تصفير العدادات وتم إزالة إرسال البرودكاست (التنبيه الصارخ)
        db.ref('settings/prayerOpen').set(status).then(() => {
            const msg = status ? "تم إتاحة زر الصلاة للموظفين ✅" : "تم حجب زر الصلاة عن الموظفين 🛑";
            alert(msg); // التنبيه يظهر للمدير فقط للتأكيد
        });
    }

                                function addPrayerTimeGlobal() {
                                    if(!confirm("توزيع 15 دقيقة صلاة للكل؟")) return;

                                    db.ref('users').once('value', (snap) => {
                                        const users = snap.val();
                                        const updates = {};
                                        const timestamp = getServerTime();

                                        Object.keys(users).forEach(un => {
                                            if(!MANAGERS.includes(un)) {
                                                updates[`users/${un}/prayerLimit`] = 900; // 15 دقيقة
                                                updates[`users/${un}/prayerSeconds`] = 0;
                                                // إضافة سجل صغير للمتابعة (اختياري)
                                                updates[`users/${un}/lastPrayerDistribution`] = timestamp;
                                            }
                                        });

                                        updates['settings/prayerOpen'] = true;

                                        db.ref().update(updates).then(() => {
                                            alert("🚀 تم توزيع الرصيد على الجميع بنجاح. يمكنك الآن رؤية العداد المحدث في الأعلى.");
                                        });
                                    });
                                }

                                function deleteBroadcast(key) {
        if(confirm("هل تريد حذف هذا التنبيه؟ (سيختفي من السجل ولن يصل إشعار للموظفين)")) {
            logDeletionAction("حذف تنبيه عام", "الكل", "تم حذف رسالة برودكاست");
            db.ref('broadcasts/' + key).remove();
        }
    }
    function showBroadcastOverlay(data) {
        const overlay = document.getElementById('broadcastOverlay');
        const msgText = document.getElementById('broadcastMsgText');
        const sound = document.getElementById('broadcastSound');

        // بناء المحتوى: صورة + نص
        let contentHtml = "";
        if (data.image) {
            contentHtml += `<img src="${data.image}" style="max-width:100%; border-radius:20px; margin-bottom:20px; border:3px solid #6366f1; box-shadow:0 0 30px rgba(99, 102, 241, 0.5); cursor:pointer;" onclick="showZoomImage('${data.image}')">`;
        }
        contentHtml += `<h2 style="color:white; margin-bottom:10px;">${data.message || 'تنبيه إداري جديد'}</h2>`;
        contentHtml += `<p style="color:#06b6d4; font-size:0.9rem;">بواسطة: ${data.sender || 'الإدارة'}</p>`;

        msgText.innerHTML = contentHtml;
        overlay.style.display = 'flex';

        if (soundActive && sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log("Sound blocked"));
        }
    }
                                function acknowledgeBroadcast() { document.getElementById('broadcastOverlay').style.display = 'none'; const s = document.getElementById('broadcastSound'); s.pause(); s.currentTime = 0; }

                                // 1. معاينة الصورة
                                function previewPerformanceImg(input) {
                                    if (input.files && input.files[0]) {
                                        const reader = new FileReader();
                                        reader.onload = (e) => {
                                            document.getElementById('perfPreviewImg').src = e.target.result;
                                            document.getElementById('perfPreviewContainer').style.display = 'block';
                                        };
                                        reader.readAsDataURL(input.files[0]);
                                    }
                                }

                                function clearPerfImg() {
                                    document.getElementById('performanceImgInput').value = "";
                                    document.getElementById('perfPreviewContainer').style.display = 'none';
                                }

                                // 2. الرفع إلى Cloudinary والإرسال
                                async function uploadAndSendPerformance() {
                                    const file = document.getElementById('performanceImgInput').files[0];
                                    const text = document.getElementById('performanceInput').value.trim();
                                    const btn = document.getElementById('btnSendPerformance');
                                    const target = Array.from(document.getElementById('performanceTarget').selectedOptions).map(o => o.value);

                                    if (!file && !text) return alert("يرجى اختيار صورة أو كتابة نص!");

                                    btn.disabled = true;
                                    btn.innerHTML = "⏳ جاري الرفع لـ Cloudinary...";

                                    try {
                                        let imageUrl = "";
                                        if (file) {
                                            // استخدام دالة الرفع الموجودة في كودك الأصلي
                                            imageUrl = await uploadToCloudinary(file);
                                        }

                                        const data = {
                                            message: text || "",
                                            image: imageUrl, // الرابط اللي راجع من كلوديناري
                                            timestamp: getServerTime(),
                                            sender: currentUser.realName || currentUser.username,
                                            target: targets
                                        };

                                        // الحفظ في Firebase (سيظهر كبث فوري وسيُحفظ في السجل)
                                        await db.ref('performance').push(data);
                                        await db.ref('broadcasts').push(data);

                                        alert("تم رفع الصورة وإرسالها للسجل بنجاح! ✅");
                                        document.getElementById('performanceInput').value = "";
                                        clearPerfImg();

                                    } catch (e) {
                                        console.error(e);
                                        alert("فشل الرفع، تأكد من إعدادات Cloudinary");
                                    } finally {
                                        btn.disabled = false;
                                        btn.innerHTML = "🚀 إرسال للأرشيف والبث";
                                    }
                                }

                                // 3. فتح معرض الصور وجلب البيانات
    function openPerformanceGallery() {
        const modal = document.getElementById('performanceGalleryModal');
        const grid = document.getElementById('galleryGrid');

        if(!modal || !grid) return alert("خطأ في تعريف حاوية المعرض");

        // إظهار النافذة
        modal.classList.remove('hidden');
        grid.innerHTML = '<p style="color:#06b6d4; text-align:center; grid-column: 1 / -1; padding: 100px; font-size:1.2rem; animation:pulse 1.5s infinite;">⏳ جاري فحص سجل الصور...</p>';

        // سحب البيانات من Firebase (نود البث)
        db.ref('broadcasts').once('value', (snap) => {
            const data = snap.val();

            if(!data) {
                grid.innerHTML = '<p style="color:#666; text-align:center; grid-column: 1 / -1; padding: 100px;">لا توجد صور في السجل حالياً 📂</p>';
                return;
            }

            grid.innerHTML = ""; // تصفير المحتوى
            let hasAnyImages = false;

            // ترتيب الصور من الأحدث للأقدم
            const keys = Object.keys(data).sort((a, b) => data[b].timestamp - data[a].timestamp);

            keys.forEach(key => {
                const b = data[key];

                // التأكد من أن المنشور يحتوي على صورة مرفوعة على كلوديناري
                if(b.image && b.image.includes('cloudinary')) {
                    hasAnyImages = true;

                    grid.innerHTML += `
                        <div class="gallery-item" style="background:#0f172a; border-radius:20px; overflow:hidden; border:1px solid rgba(255,255,255,0.05); transition:0.3s; position:relative; aspect-ratio:1/1; cursor:pointer;" onclick="showZoomImage('${b.image}')">
                            <img src="${b.image}" style="width:100%; height:100%; object-fit:cover; transition:0.5s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">

                            <div style="position:absolute; bottom:0; left:0; width:100%; background:linear-gradient(transparent, rgba(0,0,0,0.9)); padding:12px; pointer-events:none;">
                                <div style="color:#06b6d4; font-size:0.8rem; font-weight:bold;">👤 ${b.sender || 'Admin'}</div>
                                <div style="color:#888; font-size:0.7rem;">📅 ${new Date(b.timestamp).toLocaleDateString('ar-EG')}</div>
                            </div>
                        </div>
                    `;
                }
            });

            if (!hasAnyImages) {
                grid.innerHTML = '<p style="color:#666; text-align:center; grid-column: 1 / -1; padding: 100px;">السجل يحتوي على نصوص فقط.. لا توجد صور 🖼️</p>';
            }
        });
    }

    db.ref('settings/limits').on('value', (snap) => {
        const limits = snap.val() || { breaks: 3, prayers: 2 };

        // تحديث القيم في الذاكرة
        maxBreaksAllowed = limits.breaks;
        maxPrayersAllowed = limits.prayers;

        // 1. تحديث خانات الإدخال (للمشرف)
        if(document.getElementById('maxBreaksInput')) document.getElementById('maxBreaksInput').value = maxBreaksAllowed;
        if(document.getElementById('maxPrayersInput')) document.getElementById('maxPrayersInput').value = maxPrayersAllowed;

        // 2. تحديث الواجهة فوراً بناءً على نوع المستخدم
        if (currentUser) {
            if (currentUser.role === 'admin') {
                // لو إنت أدمن: هيعيد رسم الجدول والعداد العلوي (1/2) فوراً
                renderMonitorTable();
            } else {
                // لو موظف: هيعيد فحص هل البريك متاح ولا مقفول بناءً على الرقم الجديد
                checkBreakLimit();
            }
        }
    });

    function renderRotationTable() {
        const tbody = document.getElementById('rotationTableBody');
        if(!tbody) return;
        tbody.innerHTML = '';

        const n = selectedRotationMembers.length;
        if(n === 0) {
            tbody.innerHTML = '<tr><td colspan="4">اختر الأسماء التي تصلي أولاً.</td></tr>';
            return;
        }

        selectedRotationMembers.forEach((un, index) => {
            const u = allUsersData[un];
            if(!u) return;

            // المعادلة الصحيحة للساقية (طرح الإزاحة لضمان تقدم الدور للأعلى)

            // 1. ترتيبه في الصلاة الحالية (مثلاً الظهر)
            let pos1 = ((index - currentRotationOffset) % n + n) % n + 1;

            // 2. ترتيبه في الصلاة القادمة (مثلاً العصر)
            let pos2 = ((index - (currentRotationOffset + 1)) % n + n) % n + 1;

            // 3. ترتيبه بكرة (التدوير اللي بعده)
            let pos3 = ((index - (currentRotationOffset + 2)) % n + n) % n + 1;

            tbody.innerHTML += `
                <tr style="${pos1 === 1 ? 'background: rgba(56, 189, 248, 0.1); border-right: 4px solid #38bdf8;' : ''}">
                    <td style="font-weight:bold; color:gold;">${u.realName || un}</td>
                    <td style="color:${pos1 === 1 ? '#38bdf8' : 'white'}; font-weight:${pos1 === 1 ? 'bold' : 'normal'}">
                        #${pos1} ${pos1 === 1 ? '(عليه الدور)' : ''}
                    </td>
                    <td style="opacity:0.8;">#${pos2}</td>
                    <td style="color:var(--primary); font-weight:bold;">
                        سيصبح #${pos3} بكرة
                    </td>
                </tr>`;
        });
    }

    db.ref('settings/prayerRotation').on('value', (snap) => {
        const data = snap.val() || { members: [], offset: 0 };
        selectedRotationMembers = data.members || [];
        currentRotationOffset = data.offset || 0;
        updateRotationSelectorUI();
        renderRotationTable();
        applyRotationToQueue();
    });

                                db.ref('users').on('value', (snap) => {
                                    const newData = snap.val() || {};
                                    if (currentUser && currentUser.role === 'admin' && isLoaded && soundActive) {
                                        let pending = false;
                                        Object.keys(newData).forEach(un => {
                                            if (MANAGERS.includes(un)) return;
                                            if (newData[un].isOnBreak && (!allUsersData[un] || !allUsersData[un].isOnBreak)) document.getElementById('notifySound').play().catch(e=>{});
                                            if (
                                                (newData[un].otRequest && newData[un].otRequest.status === 'قيد الانتظار') ||
                                                (newData[un].emRequest && newData[un].emRequest.status === 'قيد الانتظار') ||
                                                (newData[un].meetingRequest && newData[un].meetingRequest.status === 'قيد الانتظار') ||
                                                (newData[un].permRequest && newData[un].permRequest.status === 'قيد الانتظار')
                                            ) {
                                                pending = true;
                                            }
                                        });
                                        const ring = document.getElementById('requestRing');
                                        if (pending) { if (ring.paused) ring.play().catch(e=>{}); } else { ring.pause(); ring.currentTime = 0; }
                                    }
                                    allUsersData = newData;
                                    if (currentUser) {
                                        renderBroadcastLog(); // ضيف السطر ده هنا عشان أول ما يتعرف عليك يظهر التوجيهات فوراً
                                    }
                                    if (!isLoaded) { isLoaded = true; document.getElementById('loading').style.display = 'none'; document.getElementById('mainContainer').classList.remove('hidden'); checkSavedSession(); }
                                    if (currentUser) {
                                        const updatedMe = allUsersData[currentUser.username];
                                        if(updatedMe) { const r = currentUser.role; currentUser = updatedMe; currentUser.role = r; }
            if (currentUser.role === 'admin') {
                // حساب "شكل" الجدول الحالي (عدد الموظفين + أسماؤهم + حالاتهم)
                const currentTableStructure = Object.values(allUsersData).filter(u => u && u.username && !MANAGERS.includes(u.username)).map(u => `${u.username}-${u.isOnBreak}-${u.breakType}-${u.state}`).join('|');

                // لو الشكل اتغير (موظف جديد أو غادر أو غير حالته)، نرسم الجدول من جديد
                if (currentTableStructure !== lastTableStructure) {
                    lastTableStructure = currentTableStructure;
                    renderMonitorTable();
                } else {
                    // لو مفيش تغيير هيكلي، بنحدث الأرقام بس
                    updateMonitorValuesOnly();
                }

                renderAdminEmRequests(); renderAdminMeetingRequests(); renderAdminOtRequests(); renderAdminPermRequests(); renderUserManagementTable(); updateBroadcastTargets();

                if(['mahmoud', 'ahmed'].includes(currentUser.username)) {
                    document.getElementById('masterDeleteBtn').classList.remove('hidden');
                    document.getElementById('rangeDeleteBtn').classList.remove('hidden');
                } else {
                    document.getElementById('masterDeleteBtn').classList.add('hidden');
                    document.getElementById('rangeDeleteBtn').classList.add('hidden');
                }

    if (currentUser.role === 'admin') {
        // قائمة المسموح لهم
        const superAdmins = ['mahmoud', 'ahmed'];

        if (superAdmins.includes(currentUser.username)) {
            // إظهار المنطقة
            document.getElementById('dangerZone').classList.remove('hidden');

            // تغيير الاسم على الزرار
            const myName = currentUser.realName || currentUser.username;
            document.getElementById('rangeDeleteBtn').innerHTML = `🗑 حذف الفترة (${myName})`;
            document.getElementById('masterDeleteBtn').innerHTML = `🔥 تصفير الكل (${myName})`;
        } else {
            // إخفاء المنطقة لأي حد تاني
            document.getElementById('dangerZone').classList.add('hidden');
        }
    }

                if(!document.getElementById('tab-reports').classList.contains('hidden')) renderUserReport();
            }
            else { updateUserUI(); updateEmStatus(); updateMeetingStatus(); updateOtStatus(); updatePermStatus(); checkBreakLimit(); checkProfileNotifications(currentUser); }
                                    }
                                });

                                function updateLimits() {
                                    const b = parseInt(document.getElementById('maxBreaksInput').value);
                                    const p = parseInt(document.getElementById('maxPrayersInput').value); // هذا هو الرقم "2" في الصورة

                                    db.ref('settings/limits').set({
                                        breaks: b,
                                        prayers: p
                                    }).then(() => {
                                        alert("تم حفظ الحدود الجديدة بنجاح ✅");
                                    });
                                }

    function checkBreakLimit() {
        if(!currentUser || currentUser.role === 'admin') return;
        const box = document.getElementById('breakLimitAlert');
        const breakBtn = document.querySelector("button[onclick=\"startMyBreak('بريك عام')\"]");

        let isBlocked = false;
        let message = "";

        if (currentUser.groupName && currentUser.groupName !== "") {
            // فحص الجروب
            const inMyGroupOnBreak = Object.values(allUsersData).filter(u =>
                u.groupName === currentUser.groupName &&
                u.username !== currentUser.username &&
                u.isOnBreak && (u.breakType === 'بريك عام' || u.breakType === 'طوارئ')
            );
            if (inMyGroupOnBreak.length >= 1) {
                isBlocked = true;
                message = `يا بطل، زميلك في مجموعة (${currentUser.groupName}) في البريك حالياً. أول ما يرجع الطريق هيكون مفتوح ليك! 💪`;
            }
        } else {
            // فحص المستقلين (التعديل هنا)
            const soloUsersOnBreak = Object.values(allUsersData).filter(u =>
                (!u.groupName || u.groupName === "") &&
                u.isOnBreak && (u.breakType === 'بريك عام' || u.breakType === 'طوارئ')
            ).length;

            if (soloUsersOnBreak >= maxBreaksAllowed) {
                isBlocked = true;
                // النص الجديد اللي إنت طلبته
                message = `يا بطل، زمايلك كلهم في البريك دلوقتي. استنى دقايق لحد ما حد يرجع عشان نفضل شغالين.. أول ما حد يرجع الطريق هيكون مفتوح ليك! 💪`;
            }
        }

        if (isBlocked) {
            box.style.display = 'block';
            box.innerHTML = message;
            if(breakBtn) {
                breakBtn.disabled = true;
                breakBtn.style.opacity = "0.5";
                breakBtn.style.cursor = "not-allowed";
            }
        } else {
            box.style.display = 'none';
            if(breakBtn) {
                breakBtn.disabled = false;
                breakBtn.style.opacity = "1";
                breakBtn.style.cursor = "pointer";
            }
        }
    }

                                function checkSavedSession() { const s = localStorage.getItem('break_sys_user'); if (s && allUsersData[s]) { currentUser = allUsersData[s]; currentUser.role = MANAGERS.includes(s) ? 'admin' : 'employee'; if (currentUser.role === 'admin') showAdmin(); else { setupPresence(s); showEmployee(); } startGlobalTimer(); } }
                                
                                function attemptLogin() { 
                                    const u = document.getElementById('loginUser').value.trim().toLowerCase(), p = document.getElementById('loginPass').value.trim(); 
                                    if (allUsersData[u] && allUsersData[u].password === p) { 
                                        currentUser = allUsersData[u]; currentUser.role = MANAGERS.includes(u) ? 'admin' : 'employee'; 
                                        localStorage.setItem('break_sys_user', u); if (currentUser.role === 'admin') showAdmin(); else { setupPresence(u); showEmployee(); } 
                                    } else alert('بيانات الدخول غير صحيحة'); 
                                }

                                function setupPresence(un) { 
                                    const s = db.ref("users/" + un + "/state"), dRef = db.ref("users/" + un + "/device");
                                    db.ref(".info/connected").on("value", snap => { if (snap.val()) { s.onDisconnect().set("offline").then(() => { s.set("online"); dRef.set(getDeviceType()); }); } }); 
                                }

                                function logout() { 
                                    if(currentUser && currentUser.role !== 'admin') {
                                        const today = getServerDateString().replace(/\//g, '-');
                                        // تسجيل وقت الانصراف عند الضغط على تسجيل الخروج
                                        db.ref(`users/${currentUser.username}/attendance/${today}`).update({
                                            clockOut: getServerTimeString()
                                        });
                                        db.ref("users/"+currentUser.username+"/state").set("offline");
                                    }
                                    localStorage.removeItem('break_sys_user'); 
                                    sessionStorage.removeItem('systemActive'); 
                                    location.reload(); 
                                }

                                function showAdmin() {
                                    document.getElementById('loginSection').classList.add('hidden');
                                    document.getElementById('adminSection').classList.remove('hidden');

                                    // المكان: داخل دالة showAdmin()
                                    const managerNameEl = document.getElementById('currentManagerDisplay');
                                    const realName = currentUser.realName || currentUser.username;

                                    if (currentUser.username === 'mahmoud') {
                                        // لو المستخدم هو محمود (صاحب الموقع)
                                        managerNameEl.innerHTML = `
                                            <span class="boss-crown">👑</span>
                                            <span class="the-boss-name">${realName} (CEO)</span>
                                        `;
                                    } else {
                                        // لو أي مشرف تاني (عادي)
                                        managerNameEl.innerText = `المشرف: ${realName}`;
                                        managerNameEl.style.color = ""; // ريست للألوان
                                        managerNameEl.className = "";   // ريست للكلاسات
                                    }

                                    // إظهار الزر السري لمحمود فقط
                                    if (currentUser.username === 'mahmoud') {
                                        document.getElementById('secretResetBtn').classList.remove('hidden');
                                    } else {
                                        document.getElementById('secretResetBtn').classList.add('hidden');
                                    }

                                    switchAdminTab('monitor');
                                    startGlobalTimer();
                                }
                                
                                // متغير لمنع تشغيل الصوت عند تحميل الصفحة لأول مرة للرسائل القديمة
                                let isInitialLoad = true;

                                function showEmployee() { 
                                    document.getElementById('loginSection').classList.add('hidden'); 
                                    document.getElementById('employeeSection').classList.remove('hidden'); 
                                    document.getElementById('welcomeMsg').innerText = `أهلاً، ${currentUser.realName || currentUser.username}`; 
                                    
                                    // --- تسجيل وقت الحضور (Clock-In) ---
                                    const today = getServerDateString().replace(/\//g, '-');
                                    const attendanceRef = db.ref(`users/${currentUser.username}/attendance/${today}`);
                                    
                                    attendanceRef.once('value', (snap) => {
                                        if (!snap.exists() || !snap.val().clockIn) {
                                            attendanceRef.update({
                                                clockIn: getServerTimeString(),
                                                lastSeen: getServerTimeString()
                                            });
                                        } else {
                                            // تحديث آخر ظهور باستمرار
                                            attendanceRef.update({ lastSeen: getServerTimeString() });
                                        }
                                    });
                                    // ----------------------------------
                                    
                                    const pPic = currentUser.profilePic || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                                    document.getElementById('userProfilePicDisplay').src = pPic;
                                    const titleBox = document.getElementById('userFunTitleDisplay');
                                    if(currentUser.funTitle) titleBox.innerHTML = `<div class="fun-title-badge">✨ ${currentUser.funTitle} ✨</div>`;
                                    else titleBox.innerHTML = "";
                                    if (sessionStorage.getItem('systemActive') === 'true') { document.getElementById('forceSoundOverlay').style.display = 'none'; soundActive = true; startGlobalTimer(); }
                                    else { document.getElementById('forceSoundOverlay').style.display = 'flex'; }

                                    updateWeeklyLogDisplays();
                                }

                                // --- نظام رفع الصور الجديد ---
                                function updateMyProfilePic() { document.getElementById('selfPicInput').click(); }

                                async function handleFileUpload(input, mode) {
                                    if (input.files && input.files[0]) {
                                        const file = input.files[0];
                                        // تنبيه بسيط للمستخدم
                                        const statusMsg = mode === 'self' ? "جاري تحديث صورتك..." : "جاري رفع الصورة...";
                                        alert(statusMsg);

                                        const downloadURL = await uploadToCloudinary(file);

                                        if (downloadURL) {
                                            if (mode === 'self') {
                                                db.ref('users/' + currentUser.username).update({ profilePic: downloadURL })
                                                .then(() => alert("تم تحديث صورتك بنجاح! 🎉"));
                                            } else if (mode === 'admin') {
                                                document.getElementById('newProfilePic').value = downloadURL;
                                                alert("تم تجهيز رابط الصورة.");
                                            }
                                        }
                                    }
                                }
                                // ----------------------------

                                function switchAdminTab(t) {
        // أخفي كل التبويبات القديمة والجديدة
        const tabs = ['tab-monitor', 'tab-reports', 'tab-users', 'tab-groups', 'tab-overtime', 'tab-emergency', 'tab-meetings', 'tab-permissions'];

        tabs.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.classList.add('hidden');
        });

        // أظهر التبويب المطلوب
        const target = document.getElementById('tab-' + t);
        if (target) {
            target.classList.remove('hidden');
        }

        // تحديث القائمة المنسدلة لو فتحنا التقارير
        if(t === 'reports') updateReportSelect();

        // تحديث جدول الاستأذان لو فتحنا التبويب
        if (t === 'permissions') renderAdminPermRequests();

        // تحديث قائمة المجموعات لو فتحنا التبويب
        if (t === 'groups') {
            updateMembersSelector();
            renderGroupsTable();
        }

        // تحديث قائمة الصلاة وترتيب الدور لو فتحنا المراقبة
        if (t === 'monitor') {
            populateQueueSelect();
            renderPrayerQueue();
        }
    }
                                
    function startGlobalTimer() {
        if(timerInterval) clearInterval(timerInterval);
        
        // تحديث الساعة والتاريخ فوراً قبل بدء الـ Interval
        const timeStr = getServerTimeString();
        const dateStr = getServerDateString();
        
        // تحديث الساعة في لوحة الموظف
        const timeEl = document.getElementById('userServerTime');
        const dateEl = document.getElementById('userServerDate');
        if(timeEl) timeEl.innerText = timeStr;
        if(dateEl) dateEl.innerText = dateStr;

        // تحديث الساعة والتاريخ في لوحة الأدمن لو موجودة
        const adminTimeEl = document.getElementById('adminServerTime');
        const adminDateEl = document.getElementById('adminServerDate');
        if(adminTimeEl) adminTimeEl.innerText = timeStr;
        if(adminDateEl) adminDateEl.innerText = dateStr;
        
        // تحديث الموظف فوراً أيضاً
        if(currentUser && currentUser.role !== 'admin') {
            updateUserUI();
        }
        
        timerInterval = setInterval(() => {
            try {
                const timeStr = getServerTimeString();
                const dateStr = getServerDateString();

                // تحديث الساعة في لوحة الموظف
                const timeEl = document.getElementById('userServerTime');
                const dateEl = document.getElementById('userServerDate');
                if(timeEl) timeEl.innerText = timeStr;
                if(dateEl) dateEl.innerText = dateStr;

                // تحديث الساعة والتاريخ في لوحة الأدمن لو موجودة
                const adminTimeEl = document.getElementById('adminServerTime');
                const adminDateEl = document.getElementById('adminServerDate');
                if(adminTimeEl) adminTimeEl.innerText = timeStr;
                if(adminDateEl) adminDateEl.innerText = dateStr;

                // باقي منطق التايمر (البريك والأكسدة)
                if(currentUser && currentUser.role !== 'admin') {
                    updateUserUI(); 
                } else if (currentUser && currentUser.role === 'admin') {
                    updateMonitorValuesOnly();
                }
            } catch (e) {
                console.error("Timer Error: ", e);
            }
        }, 1000);
    }

    function renderMonitorTable() {
        const tbody = document.getElementById('monitorBody');
        if(!tbody) return; // تأكد من وجود الـ tbody
        
        const search = document.getElementById('monitorSearch');
        const searchVal = search ? search.value.toLowerCase() : '';

        tbody.innerHTML = '';

        // عدادات للحالة العامة
        let actB = 0, actP = 0; // بريك وصلاة
        let onlineCount = 0; // عدد الفاتحين
        let totalCount = 0;  // إجمالي الموظفين

        // 1. تحويل البيانات لمصفوفة عشان نقدر نرتبها
        let usersList = Object.values(allUsersData).filter(u => {
            // استبعاد المديرين واستبعاد الغير موجودين في البحث
            if (!u || !u.username || MANAGERS.includes(u.username)) return false;
            if (searchVal && !(u.realName || u.username).toLowerCase().includes(searchVal)) return false;
            return true;
        });

        // 2. الترتيب الذكي (المتواجدين أولاً)
        usersList.sort((a, b) => {
            // الأولوية الأولى: الحالة (online يجي قبل offline)
            const stateA = (a.state === 'online') ? 1 : 0;
            const stateB = (b.state === 'online') ? 1 : 0;
            if (stateA !== stateB) return stateB - stateA; // الكبير (1) يجي الأول

            // الأولوية الثانية: اللي في بريك يجي فوق (اختياري)
            // const breakA = a.isOnBreak ? 1 : 0;
            // const breakB = b.isOnBreak ? 1 : 0;
            // if (breakA !== breakB) return breakB - breakA;

            // الأولوية الثالثة: ترتيب أبجدي بالاسم
            const nameA = a.realName || a.username;
            const nameB = b.realName || b.username;
            return nameA.localeCompare(nameB);
        });

        // 3. رسم الجدول
        usersList.forEach(u => {
            totalCount++;
            const isOnline = u.state === 'online';
            if (isOnline) onlineCount++;

            let lg = u.usedSeconds||0, lp = u.prayerSeconds||0, lm = u.meetingSeconds||0, lf = u.followUpSeconds||0, lv = u.vipSeconds||0;

            // حساب الوقت المباشر لو هو في بريك حالياً
            if (u.isOnBreak && u.lastStartTime) {
                let elap = Math.floor((getServerTime() - u.lastStartTime) / 1000);
                if (u.breakType === 'بريك عام' || u.breakType === 'طوارئ') { lg += elap; actB++; }
                else if (u.breakType === 'صلاة') { lp += elap; actP++; }
                else if (u.breakType === 'ميتنج') lm += elap;
                else if (u.breakType === 'متابع عميل') lf += elap;
                else if (u.breakType === 'استراحة VIP') lv += elap;
            }

            const rem = ((u.allowance||45)*60) - lg;

            // تنسيق حالة الاتصال
            const onlineDot = isOnline
                ? `<span style="display:inline-block; width:10px; height:10px; background:#10b981; border-radius:50%; margin-right:5px; box-shadow:0 0 5px #10b981;"></span> <span style="color:#10b981; font-size:0.8rem;">متصل</span>`
                : `<span style="display:inline-block; width:10px; height:10px; background:#64748b; border-radius:50%; margin-right:5px;"></span> <span style="color:#64748b; font-size:0.8rem;">غير متصل</span>`;

            const deviceIcon = u.device === 'mobile' ? '📱' : (u.device === 'tablet' ? '📲' : '💻');
            const pPic = u.profilePic || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            const imgTag = `<img src="${pPic}" class="profile-img">`;

            // القيمة المحفوظة في القائمة المنسدلة
            const savedS = adminSelectBuffer[u.username] || 'بريك عام';

            const statusCell = u.isOnBreak
                ? `<span style="color:var(--danger); font-weight:bold; animation: pulse 2s infinite;">${u.breakType}</span>`
                : '<span style="color:var(--success);">متاح ✅</span>';

            const ctrl = u.isOnBreak
                ? `<button onclick="adminStop('${u.username}')" class="btn btn-danger btn-sm">🛑 إيقاف</button> <button onclick="openUserProfile('${u.username}')" class="btn btn-dark btn-sm" title="الملف والشكاوى">📂</button>`
                : `<div class="admin-table-ctrl"><div class="admin-row-top"><select id="sel_${u.username}" onchange="saveAdminSelect('${u.username}', this.value)" style="width:80px;"><option value="بريك عام" ${savedS=='بريك عام'?'selected':''}>بريك</option><option value="صلاة" ${savedS=='صلاة'?'selected':''}>صلاة</option><option value="ميتنج" ${savedS=='ميتنج'?'selected':''}>ميتنج</option><option value="متابع عميل" ${savedS=='متابع عميل'?'selected':''}>متابع</option><option value="استراحة VIP" ${savedS=='استراحة VIP'?'selected':''}>VIP</option></select><button onclick="adminStart('${u.username}')" class="btn btn-success btn-sm">▶</button><button onclick="openUserProfile('${u.username}')" class="btn btn-dark btn-sm" title="الملف والشكاوى">📂</button></div></div>`;

            // تظليل الصف لو غير متصل (باهت)
            const rowStyle = isOnline ? '' : 'opacity: 0.5; filter: grayscale(0.8);';

            // تنبيه الأكسدة
            const alertClass = (u.isOnBreak && u.breakType==='بريك عام' && rem < 300 && rem > 0) ? 'وضع-التنبيه' : '';

            const prayerCreditStatus = u.prayerLimit > 0
                ? `<small style="color:#10b981; display:block;">(رصيد: ${formatTime(u.prayerLimit)}) ✅</small>`
                : `<small style="color:#64748b; display:block;">(لا يوجد رصيد) ⚪</small>`;

            tbody.innerHTML += `
                <tr class="${alertClass}" style="${rowStyle}">
                    <td style="text-align:right;">
                        <div style="display:flex; align-items:center;">
                            ${imgTag}
                            <div style="flex:1;">
                                <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                    ${u.realName || u.username} ${u.isVIP ? '⭐' : ''}
                                    <!-- إضافة تاج صغير يوضح اسم المجموعة -->
                                    <span style="font-size: 0.65rem; color: #6366f1; background: rgba(99, 102, 241, 0.1); padding: 2px 6px; border-radius: 4px; margin-right: 8px; border: 1px solid rgba(99, 102, 241, 0.2);">
                                        📁 ${u.groupName || 'بلا مجموعة'}
                                    </span>
                                </div>
                                <div style="font-size:0.75rem;">${onlineDot} | ${deviceIcon}</div>
                            </div>
                        </div>
                    </td>
                    <td>${statusCell}<br><small>${u.lastReason || ''}</small></td>
                    <td><span id="rem_${u.username}" style="font-weight:bold; font-size:1.1rem; color:${rem>=0?'white':'var(--danger)'}">${rem>=0?formatTime(rem):'-'+formatTime(Math.abs(rem))}</span></td>
                    <td><span id="pray_${u.username}">${formatTime(lp)}</span><br>${prayerCreditStatus}<small>متبع: <span id="follow_${u.username}">${formatTime(lf)}</span></small></td>
                    <td><span id="meet_${u.username}">${formatTime(lm)}</span><br><small>VIP: <span id="vip_${u.username}">${formatTime(lv)}</span></small></td>
                    <td>${ctrl}</td>
                </tr>`;
        });

        // حساب إحصائيات الصلاة
        let usersWithCredit = 0; // اللي استلموا الـ 15 دقيقة
        let usersFinishedPrayer = 0; // اللي خلصوا صلاتهم

        Object.values(allUsersData).forEach(u => {
            if (u.username && !MANAGERS.includes(u.username)) {
                if (u.prayerLimit > 0) usersWithCredit++;
                if (u.prayerCountToday > 0) usersFinishedPrayer++;
            }
        });

        // تحديث شريط الحالة العلوي
        const statusDisplay = document.getElementById('statusCountersDisplay');
        if(statusDisplay) {
            statusDisplay.innerHTML = `
                <div style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center;">
                    <span style="color:#10b981;">🟢 متواجد: ${onlineCount}</span>
                    <span style="color:#6366f1;">🍔 بريك: (${actB}/${maxBreaksAllowed})</span>
                    <span style="color:#06b6d4;">🕌 صلاة الآن: (${actP}/${maxPrayersAllowed})</span>
                    <span style="color:#ffd700; border-right: 2px solid #444; padding-right:15px;">📥 استلموا الرصيد: ${usersWithCredit}</span>
                    <span style="color:#f43f5e;">✅ أتموا الصلاة: ${usersFinishedPrayer}</span>
                </div>
            `;
        }
    }

                                function updateMonitorValuesOnly() {
                                    // بنلف على الموظفين ونحدث الخلايا اللي محتاجة تحديث بس من غير ما نمسح الجدول
                                    Object.values(allUsersData).forEach(u => {
                                        if (!u || !u.username || MANAGERS.includes(u.username)) return;

                                        let lg = u.usedSeconds || 0, lp = u.prayerSeconds || 0, lm = u.meetingSeconds || 0,
                                            lf = u.followUpSeconds || 0, lv = u.vipSeconds || 0;

                                        if (u.isOnBreak && u.lastStartTime) {
                                            let elap = Math.floor((getServerTime() - u.lastStartTime) / 1000);
                                            if (u.breakType === 'بريك عام' || u.breakType === 'طوارئ') lg += elap;
                                            else if (u.breakType === 'صلاة') lp += elap;
                                            else if (u.breakType === 'ميتنج') lm += elap;
                                            else if (u.breakType === 'متابع عميل') lf += elap;
                                            else if (u.breakType === 'استراحة VIP') lv += elap;
                                        }

                                        const rem = ((u.allowance || 45) * 60) - lg;

                                        // تحديث "البريك المتبقي"
                                        const rEl = document.getElementById(`rem_${u.username}`);
                                        if (rEl) {
                                            const newTime = rem >= 0 ? formatTime(rem) : "-" + formatTime(Math.abs(rem));
                                            if (rEl.innerText !== newTime) { // تحديث فقط لو الرقم اتغير
                                                rEl.innerText = newTime;
                                                rEl.style.color = rem >= 0 ? "white" : "var(--danger)";
                                            }
                                        }

                                        // تحديث باقي العدادات (الصلاة، الميتنج، الخ)
                                        const updateText = (id, val) => {
                                            const el = document.getElementById(id);
                                            if (el && el.innerText !== formatTime(val)) el.innerText = formatTime(val);
                                        };

                                        updateText(`pray_${u.username}`, lp);
                                        updateText(`meet_${u.username}`, lm);
                                        updateText(`follow_${u.username}`, lf);
                                        updateText(`vip_${u.username}`, lv);
                                    });
                                }

                                function renderUserReport() {
                                    const un = document.getElementById('reportUserSelect').value; if(!un) return;
                                    const u = allUsersData[un], sB = document.getElementById('sessionsReportBody'), mS = document.getElementById('monthlySummary'), start = document.getElementById('filterStartDate').value, end = document.getElementById('filterEndDate').value;
                                    sB.innerHTML = ''; mS.classList.remove('hidden');
                                    let tOx=0, tPr=0, tFo=0, tVi=0; const allowS = (u.allowance||45)*60;
                                    if (u.sessions) {
                                        const grouped = {};
                                        Object.keys(u.sessions).forEach(k => {
                                            const s = u.sessions[k], cD = s.date.split('/').reverse().join('-');
                                            if ((start && cD < start) || (end && cD > end)) return;
                                            if(!grouped[s.date]) grouped[s.date] = { acts: [], total: 0, prayer: 0, follow: 0, vip: 0 };
                                            const dur = parseInt(s.duration) || 0;
                                            let deleteBtnHTML = ""; if(['mahmoud', 'ahmed'].includes(currentUser.username)) deleteBtnHTML = `<button onclick="deleteSpecificSession('${un}', '${k}')" style="background:var(--danger); border:none; color:white; border-radius:5px; padding:2px 6px; cursor:pointer; font-size:0.7rem; margin-right:5px;">حذف</button>`;
                                            
                                            const timeDisplay = s.startTime ?
                                                `<span style="color:#aaa; margin-left:8px; font-size:0.7rem;">
                                                    (خروج: ${s.startTime} | رجوع: ${s.endTime || '---'})
                                                </span>` : "";

                                            grouped[s.date].acts.push(`
        <div style="font-size:0.8rem; display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; border-right:4px solid var(--primary);">
            <span style="flex:1;">
                <b style="color:var(--primary); font-size:0.9rem;">${s.type}</b> 
                <span style="margin:0 10px;">⬅</span>
                ${timeDisplay}
                <span style="margin-right:15px; color:#fff;">المدة: <b>${Math.round(dur/60)}د</b></span>
                <br>
                <small style="opacity:0.6; display:block; margin-top:4px;">📌 السبب: ${s.reason||'--'}</small>
            </span>
            ${deleteBtnHTML}
        </div>
    `);
                                            if(s.type === 'بريك عام' || s.type === 'طوارئ') grouped[s.date].total += dur;
                                            else if(s.type === 'صلاة') grouped[s.date].prayer += dur; else if(s.type === 'متابع عميل') grouped[s.date].follow += dur; else if(s.type === 'استراحة VIP') grouped[s.date].vip += dur;
                                        });
                                        Object.keys(grouped).sort((a,b)=>b.localeCompare(a)).forEach(d => {
                                            const ox = Math.max(0, grouped[d].total - allowS); tOx += ox; tPr += grouped[d].prayer; tFo += grouped[d].follow; tVi += grouped[d].vip;
                                            sB.innerHTML += `<tr><td>${d}</td><td>${grouped[d].acts.join('')}</td><td>${Math.round(grouped[d].total/60)}د</td><td style="color:${ox>0? 'var(--danger)':'var(--success)'}">${Math.round(ox/60)}د</td></tr>`;
                                        });
                                    }
                                    document.getElementById('monthTotalBreaks').innerText = Math.round(tOx/60) + " د";
                                    document.getElementById('monthTotalPrayer').innerText = Math.round(tPr/60) + " د";
                                    document.getElementById('monthTotalFollowUp').innerText = Math.round(tFo/60) + " د";
                                    document.getElementById('monthTotalVIP').innerText = Math.round(tVi/60) + " د";
                                }

                                function deleteSpecificSession(un, key) { if(!['mahmoud', 'ahmed'].includes(currentUser.username)) return; if(confirm("حذف السجل؟")) db.ref(`users/${un}/sessions/${key}`).remove().then(() => renderUserReport()); }

                                window.adminStart = (un) => {
                                    const type = adminSelectBuffer[un] || 'بريك عام';
                                    const reason = adminTypingBuffer[un] || 'بدء إداري';

                                    // 1. جلب بيانات كل الموظفين للفحص
                                    db.ref('users').once('value', (snapshot) => {
                                        const allUsers = snapshot.val() || {};
                                        const targetUser = allUsers[un];
                                        const groupName = targetUser.groupName;

                                        // 2. إذا كان الموظف ينتمي لمجموعة، نفحص زملاءه
                                        if (groupName) {
                                            const activeInGroup = Object.values(allUsers).filter(u =>
                                                u.isOnBreak &&
                                                u.groupName === groupName &&
                                                u.username !== un && // استثناء الموظف نفسه
                                                (u.breakType === 'بريك عام' || u.breakType === 'طوارئ')
                                            );

                                            if (activeInGroup.length >= 1) {
                                                const outPerson = activeInGroup[0].realName || activeInGroup[0].username;
                                                alert(`⚠️ تنبيه للمشرف: \n الموظف (${un}) ينتمي لمجموعة (${groupName})، والزميل (${outPerson}) في الخارج بالفعل. \n لا يسمح بخروج اثنين من نفس المجموعة.`);
                                                return; // إيقاف العملية
                                            }
                                        }

                                        // 3. إذا كان الطريق خالياً أو الموظف بلا مجموعة، يتم التنفيذ
                                        db.ref('users/'+un).update({
                                            isOnBreak: true,
                                            breakType: type,
                                            lastStartTime: getServerTime(),
                                            lastReason: reason
                                        }).then(() => triggerGlobalRefresh());
                                    });
                                };
    window.adminStop = (un) => {
        const u = allUsersData[un], d = Math.floor((getServerTime() - u.lastStartTime)/1000);
        db.ref('users/'+un+'/sessions').push({
            date: getServerDateString(),
            type: u.breakType,
            reason: u.lastReason || 'إيقاف إداري',
            duration: d,
            startTime: new Date(u.lastStartTime).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}),
            // أضف هذا السطر الجديد بالأسفل
            endTime: getServerTimeString()
        });
        const up = { isOnBreak: false, lastStartTime: null, lastEndedTime: getServerTime(), lastEndedType: u.breakType };
        if(u.breakType==='بريك عام' || u.breakType==='طوارئ') { up.usedSeconds = (u.usedSeconds||0)+d; if(u.breakType==='طوارئ') up.emRequest = null; }
        else if(u.breakType==='صلاة') up.prayerSeconds = (u.prayerSeconds||0)+d;
        else if(u.breakType==='ميتنج') { up.meetingSeconds = (u.meetingSeconds||0)+d; up.meetingRequest = null; }
        else if(u.breakType==='متابع عميل') up.followUpSeconds = (u.followUpSeconds||0)+d;
        else if(u.breakType==='استراحة VIP') up.vipSeconds = (u.vipSeconds||0)+d;
        db.ref('users/'+un).update(up).then(() => {
            // إزالة الموظف من الطابور إذا كان في صلاة وهو الأول
            if(u.breakType === 'صلاة') {
                db.ref('settings/prayerQueue').once('value', (snap) => {
                    let queue = snap.val() || [];
                    // إذا كان الموظف الذي أوقفه المشرف هو الأول في الطابور
                    if (queue[0] === un) {
                        queue.shift();
                        db.ref('settings/prayerQueue').set(queue);
                    }
                });
            }
            triggerGlobalRefresh();
        });
    };

    function openPrayerHistory() {
        document.getElementById('prayerHistoryModal').classList.remove('hidden');
        const content = document.getElementById('prayerHistoryContent');
        content.innerHTML = '<p style="text-align:center;">جاري تحميل الأرشيف...</p>';

        // جلب آخر 20 سجل صلاة
        db.ref('prayer_order_history').limitToLast(20).once('value', (snap) => {
            const data = snap.val();
            if (!data) {
                content.innerHTML = '<p style="text-align:center;">لا توجد سجلات سابقة بعد.</p>';
                return;
            }

            content.innerHTML = '';
            // ترتيب السجلات من الأحدث للأقدم
            const keys = Object.keys(data).reverse();

            keys.forEach(key => {
                const record = data[key];
                let orderHTML = '';

                record.order.forEach(item => {
                    orderHTML += `
                        <div style="display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:5px 10px; border-radius:8px; margin-bottom:5px; border-right:3px solid ${item.position === 1 ? 'var(--success)' : 'var(--primary)'}">
                            <span>#${item.position} - ${item.name}</span>
                            ${item.position === 1 ? '<span style="color:var(--success); font-size:0.7rem;">(الأول)</span>' : ''}
                        </div>
                    `;
                });

                content.innerHTML += `
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px dashed #444; padding-bottom:5px;">
                            <span style="color:var(--accent); font-size:0.8rem; font-weight:bold;">🕒 ${record.dateStr}</span>
                            <span style="color:#aaa; font-size:0.7rem;">بواسطة: ${record.admin}</span>
                        </div>
                        <div>${orderHTML}</div>
                    </div>
                `;
            });
        });
    }

    // 1. دالة حفظ لقطة من الترتيب للسحابة (Firebase)
    function saveCurrentOrderToHistory() {
        if (!currentQueue || currentQueue.length === 0) {
            return alert("الطابور فارغ، لا يوجد موظفين لحفظ ترتيبهم!");
        }

        const membersOrder = currentQueue.map((username, index) => {
            const u = allUsersData[username];
            return {
                username: username,
                realName: u ? (u.realName || username) : username,
                position: index + 1
            };
        });

        const snapshot = {
            admin: currentUser.realName || currentUser.username,
            timestamp: getServerTime(),
            dateDisplay: getServerDateString() + " " + getServerTimeString(),
            order: membersOrder
        };

        db.ref('prayer_cloud_history').push(snapshot).then(() => {
            alert("✅ تم حفظ ترتيب الطابور الحالي في السجل السحابي بنجاح");
        }).catch(err => {
            alert("❌ فشل الحفظ: " + err.message);
        });
    }

    function openPrayerCloudHistory() {
        document.getElementById('prayerCloudModal').classList.remove('hidden');
        const content = document.getElementById('cloudHistoryContent');
        content.innerHTML = '<p style="text-align:center; color:var(--primary);">جاري جلب السجلات من السحابة... ☁️</p>';

        db.ref('prayer_cloud_history').limitToLast(30).once('value', (snap) => {
            const data = snap.val();
            if (!data) {
                content.innerHTML = '<p style="text-align:center; color:#aaa; padding:20px;">لا توجد سجلات محفوظة حالياً.</p>';
                return;
            }

            content.innerHTML = '';
            const entries = Object.entries(data).reverse();

            entries.forEach(([key, record]) => {
                let listItems = '';
                record.order.forEach(item => {
                    listItems += `
                        <div style="display:flex; justify-content:space-between; padding:8px 12px; background:rgba(255,255,255,0.03); margin-bottom:5px; border-radius:8px; border-right:4px solid ${item.position === 1 ? '#10b981' : '#6366f1'}">
                            <span style="font-size:0.9rem; font-weight:bold;">#${item.position} - ${item.realName}</span>
                            ${item.position === 1 ? '<span style="color:#10b981; font-size:0.75rem; font-weight:bold;">(الأول)</span>' : ''}
                        </div>
                    `;
                });

                // التعديل هنا: زر الحذف يظهر لمحمود فقط حصرياً
                const deleteBtn = (currentUser.username === 'mahmoud') ? 
                    `<div style="text-align:left; margin-top:5px;">
                        <button onclick="deleteCloudPrayerLog('${key}')" style="background:none; border:none; color:#ef4444; font-size:0.8rem; cursor:pointer; font-weight:bold;">🗑 حذف السجل النهائي</button>
                    </div>` : '';

                content.innerHTML += `
                    <div style="background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05); border-radius:15px; padding:15px; margin-bottom:15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#aaa; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; margin-bottom:10px;">
                            <span>📅 ${record.dateDisplay}</span>
                            <span>👤 المشرف: ${record.admin}</span>
                        </div>
                        <div>${listItems}</div>
                        ${deleteBtn}
                    </div>
                `;
            });
        });
    }

    // 3. دالة حذف سجل صلاة (اختياري)
    function deleteCloudPrayerLog(key) {
        // حماية برمجية: التأكد أن المستخدم هو محمود حصراً
        if (currentUser.username !== 'mahmoud') {
            alert("⛔ عذراً.. صلاحية حذف السجلات السحابية مقصورة على المدير (محمود) فقط.");
            return;
        }

        if(confirm("هل أنت متأكد من حذف هذا الترتيب نهائياً من السحابة؟")) {
            db.ref('prayer_cloud_history/' + key).remove()
            .then(() => {
                alert("تم الحذف بنجاح ✅");
                openPrayerCloudHistory(); // تحديث القائمة
            })
            .catch(err => alert("خطأ في الحذف: " + err.message));
        }
    }

    function startMyBreak(t) {
        if (currentUser.isOnBreak) return;

        // --- الجزء الجديد: فحص إجبارية السبب ---
        const reasonInput = document.getElementById('breakReason');
        const reasonValue = reasonInput.value.trim();

        if (reasonValue === "") {
            alert("⚠️ عذراً.. يجب كتابة سبب النشاط أولاً قبل البدء!");
            reasonInput.focus(); // وضع المؤشر داخل الخانة تلقائياً
            reasonInput.style.border = "2px solid #ef4444"; // تلوين الخانة بالأحمر للتنبيه
            return; // الخروج من الدالة ومنع بدء البريك
        } else {
            reasonInput.style.border = "1px solid var(--glass-border)"; // إعادة اللون الطبيعي إذا كتب
        }
        // ---------------------------------------

        // --- 1. منطق الصلاة (طابور + حد عددي) ---
        if (t === 'صلاة') {
            const myIndex = (currentQueue || []).indexOf(currentUser.username);
            if (myIndex === -1) {
                alert("🛑 اسمك غير موجود في طابور الصلاة حالياً!");
                return;
            }
            if (myIndex >= maxPrayersAllowed) {
                alert(`⏳ لم يحن دورك بعد! أنت رقم (${myIndex + 1}) والمدير يسمح بخروج أول (${maxPrayersAllowed}) فقط.`);
                return;
            }
            const activePrayers = Object.values(allUsersData).filter(u => u.isOnBreak && u.breakType === 'صلاة').length;
            if (activePrayers >= maxPrayersAllowed) {
                alert(`🛑 عذراً.. الحد المسموح به حالياً هو (${maxPrayersAllowed}) موظف، وهناك بالفعل ${activePrayers} بالخارج.`);
                return;
            }
        }

        // --- 2. منطق البريك العام (استقلال المجموعات عن الحد العام) ---
        if (t === 'بريك عام' || t === 'طوارئ') {
            if (currentUser.groupName && currentUser.groupName !== "") {
                // لو الموظف في ج
                const inMyGroupOnBreak = Object.values(allUsersData).filter(u =>
                    u.groupName === currentUser.groupName &&
                    u.isOnBreak &&
                    (u.breakType === 'بريك عام' || u.breakType === 'طوارئ')
                );
                if (inMyGroupOnBreak.length >= 1) {
                    alert(`🛑 مجموعتك (${currentUser.groupName}) فيها زميل بالخارج فعلاً. لا يمكن خروج اثنين من نفس المجموعة.`);
                    return;
                }
                // ملاحظة: هنا تجاهلنا تماماً الـ maxBreaksAllowed لأن الموظف في مجموعة مستقلة
            } else {
                // لو الموظف مستقل (بدون جروب): يخضع للحد العام المحسوب على المستقلين فقط
                const soloUsersOnBreak = Object.values(allUsersData).filter(u =>
                    (!u.groupName || u.groupName === "") &&
                    u.isOnBreak &&
                    (u.breakType === 'بريك عام' || u.breakType === 'طوارئ')
                ).length;

                if (soloUsersOnBreak >= maxBreaksAllowed) {
                    alert(`🛑 حد البريك للموظفين المستقلين ممتلئ حالياً (${maxBreaksAllowed}/${maxBreaksAllowed}).`);
                    return;
                }
            }
        }

        // --- 3. التنفيذ الفعلي ---
        let reason = document.getElementById('breakReason').value.trim() || t;
        db.ref('users/' + currentUser.username).update({
            isOnBreak: true,
            breakType: t,
            lastStartTime: getServerTime(),
            lastReason: reason
        }).then(() => {
            if (t === 'صلاة' && (!currentUser.prayerLimit || currentUser.prayerLimit === 0)) {
                db.ref('users/' + currentUser.username).update({ prayerLimit: 900 });
            }
        });
    }

    // دالة مساعدة لتنفيذ بدء البريك
    function executeBreakStart(t) {
        let r = document.getElementById('breakReason').value.trim();
        db.ref('users/'+currentUser.username).update({
            isOnBreak: true,
            breakType: t,
            lastStartTime: getServerTime(),
            lastReason: r || t
        });
    }

                                function stopMyBreak() {
                                    const u = currentUser;

                                    // إذا كان النشاط صلاة، نظهر نافذة التأكيد أولاً
                                    if (u.breakType === 'صلاة') {
                                        const nextPrayerName = document.getElementById('nextPrayerName').innerText.replace("المتبقي على ", "") || "الصلاة";
                                        document.getElementById('prayerCheckTitle').innerText = `هل أتممت ${nextPrayerName}؟`;
                                        document.getElementById('prayerCheckModal').classList.remove('hidden');
                                        return; // نتوقف هنا وننتظر رد الموظف من النافذة
                                    }

                                    // إذا كان نشاطاً عادياً، نكمل الإجراء الطبيعي
                                    finalizeStopBreak(false); // false تعني ليس صلاة مؤكدة
                                }

                                // دالة جديدة لإنهاء النشاط بشكل نهائي
                                function finalizeStopBreak(didFinishPrayer) {
                                    const u = currentUser;
                                    const d = Math.floor((getServerTime() - u.lastStartTime) / 1000);

                                    // تسجيل الجلسة في السجل
                                    db.ref('users/' + u.username + '/sessions').push({
                                        date: getServerDateString(),
                                        type: u.breakType,
                                        reason: u.lastReason + (u.breakType === 'صلاة' ? (didFinishPrayer ? " (أتم الصلاة ✅)" : " (لم يصلِّ ❌)") : ""),
                                        duration: d,
                                        startTime: new Date(u.lastStartTime).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}),
                                        endTime: getServerTimeString()
                                    });

                                    const up = {
                                        isOnBreak: false,
                                        lastStartTime: null,
                                        lastEndedTime: getServerTime(),
                                        lastEndedType: u.breakType
                                    };

                                    // تحديث العدادات
                                    if (u.breakType === 'بريك عام' || u.breakType === 'طوارئ') {
                                        up.usedSeconds = (u.usedSeconds || 0) + d;
                                        if (u.breakType === 'طوارئ') up.emRequest = null;
                                    } else if (u.breakType === 'صلاة') {
                                        up.prayerSeconds = (u.prayerSeconds || 0) + d;
                                        up.prayerCountToday = (u.prayerCountToday || 0) + 1;

                                        // --- الجزء الأهم: إدارة الطابور بناءً على الإجابة ---
                                        if (didFinishPrayer) {
                                            // لو صلى: نمسحه من الطابور فوراً عشان اللي بعده يدخل
                                            removeFromQueueByUsername(u.username);
                                        } else {
                                            // لو ما صلاش: يفضل في الطابور زي ما هو عشان دوره ما يروحش
                                            console.log("الموظف لم يصلِّ، سيبقى في الطابور.");
                                        }
                                    } else if (u.breakType === 'ميتنج') {
                                        up.meetingSeconds = (u.meetingSeconds || 0) + d;
                                        up.meetingRequest = null;
                                    } else if (u.breakType === 'متابع عميل') {
                                        up.followUpSeconds = (u.followUpSeconds || 0) + d;
                                    } else if (u.breakType === 'استراحة VIP') {
                                        up.vipSeconds = (u.vipSeconds || 0) + d;
                                    }

                                    db.ref('users/' + u.username).update(up).then(() => {
                                        document.getElementById('breakReason').value = "";
                                        document.getElementById('prayerCheckModal').classList.add('hidden');
                                    });
                                }

                                // دالة التعامل مع ضغطة الزر في نافذة الصلاة
                                function confirmPrayerStatus(didPray) {
                                    finalizeStopBreak(didPray);
                                }

                                async function exportProfessionalExcel() {
                                    const startDateVal = document.getElementById('filterStartDate').value;
                                    const endDateVal = document.getElementById('filterEndDate').value;

                                    if (!startDateVal || !endDateVal) return alert("📅 حدد التاريخ أولاً يا مدير!");

                                    const workbook = new ExcelJS.Workbook();

                                    // 1. إنشاء ورقة الملخص
                                    const summarySheet = workbook.addWorksheet('ملخص الأداء العام', { views: [{ rightToLeft: true }] });

                                    // 2. إنشاء ورقة التفاصيل (التفنيدة)
                                    const detailsSheet = workbook.addWorksheet('سجل التفاصيل اليومي', { views: [{ rightToLeft: true }] });

                                    let summaryRows = [];
                                    let detailedLogs = [];

                                    // معالجة البيانات من مصفوفة allUsersData الموجودة في الكود
                                    Object.values(allUsersData).forEach(u => {
                                        if (!u.username || MANAGERS.includes(u.username)) return;

                                        let uS = { name: u.realName || u.username, days: new Set(), ox: 0, prayer: 0, meet: 0, vip: 0, ot: 0, perm: 0, comp: 0, cash: 0 };

                                        if (u.sessions) {
                                            let daily = {};
                                            Object.entries(u.sessions).forEach(([key, s]) => {
                                                const sD = s.date.split('/').reverse().join('-');
                                                if (sD >= startDateVal && sD <= endDateVal) {
                                                    uS.days.add(s.date);
                                                    const dur = parseInt(s.duration) || 0;
                                                    const durMin = Math.round(dur/60);

                                                    detailedLogs.push([s.date, uS.name, s.type, durMin + " دقيقة", s.reason || "بدون سبب"]);

                                                    if (s.type === 'بريك عام' || s.type === 'طوارئ') daily[s.date] = (daily[s.date] || 0) + dur;
                                                    else if (s.type === 'صلاة') uS.prayer += dur;
                                                    else if (s.type === 'ميتنج') uS.meet += dur;
                                                    else if (s.type === 'استراحة VIP') uS.vip += dur;
                                                }
                                            });
                                            const allow = (u.allowance || 45) * 60;
                                            Object.values(daily).forEach(v => { if(v > allow) uS.ox += (v - allow); });
                                        }

                                        // إضافة بيانات الإضافي والشكاوى
                                        if (u.overtimeHistory) {
                                            Object.values(u.overtimeHistory).forEach(ot => {
                                                const otD = ot.date.split('/').reverse().join('-');
                                                if (otD >= startDateVal && otD <= endDateVal) {
                                                    uS.ot += parseFloat(ot.hours) || 0;
                                                    detailedLogs.push([ot.date, uS.name, "إضافي", ot.hours + " ساعة", "معتمد"]);
                                                }
                                            });
                                        }

                                        if (u.complaints) {
                                            Object.values(u.complaints).forEach(c => {
                                                const cD = c.date.split('/').reverse().join('-');
                                                if (cD >= startDateVal && cD <= endDateVal) {
                                                    uS.comp++; uS.cash += parseFloat(c.amount) || 0;
                                                    detailedLogs.push([c.date, uS.name, "مخالفة/خصم", c.amount + " ج.م", c.title]);
                                                }
                                            });
                                        }

                                        summaryRows.push([uS.name, uS.days.size, Math.round(uS.ox/60), Math.round(uS.prayer/60), Math.round(uS.meet/60), Math.round(uS.vip/60), uS.ot, uS.perm, uS.comp, uS.cash]);
                                    });

                                    // --- تنسيق العناوين والألوان ---
                                    summarySheet.getRow(1).values = ["اسم الموظف", "أيام الحضور", "الأكسدة (د)", "الصلاة (د)", "الميتنج (د)", "VIP (د)", "إضافي (س)", "استأذان (س)", "المخالفات", "الخصم (ج.م)"];
                                    summarySheet.getRow(1).eachCell(cell => {
                                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };
                                        cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
                                    });

                                    summaryRows.forEach(row => summarySheet.addRow(row));

                                    // تنسيق ورقة التفاصيل
                                    detailsSheet.getRow(1).values = ["التاريخ", "الموظف", "النوع", "المدة", "السبب"];
                                    detailsSheet.getRow(1).eachCell(cell => {
                                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF10B981' } };
                                        cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
                                    });

                                    detailedLogs.forEach(row => detailsSheet.addRow(row));

                                    // ضبط العرض وتصدير الملف
                                    const buffer = await workbook.xlsx.writeBuffer();
                                    saveAs(new Blob([buffer]), `ELSHAMAA_Report_${startDateVal}.xlsx`);
                                }

                                // دالة مساعدة لحذف الموظف من الطابور باسم المستخدم
                                function removeFromQueueByUsername(username) {
                                    db.ref('settings/prayerQueue').once('value', (snap) => {
                                        let queue = snap.val() || [];
                                        const index = queue.indexOf(username);
                                        if (index !== -1) {
                                            queue.splice(index, 1);
                                            db.ref('settings/prayerQueue').set(queue);
                                        }
                                    });
                                }

                                function updatePrayerButton() {
                                    const prayerBtn = document.querySelector("button[onclick=\"startMyBreak('صلاة')\"]");
                                    if (!prayerBtn || !currentUser || currentUser.role === 'admin') return;

                                    const myIndex = (currentQueue || []).indexOf(currentUser.username);

                                    // التعديل هنا: الزرار يفتح لو ترتيبك (0 أو 1 أو 2...) أصغر من الليميت اللي الإدارة حددته
                                    const isMyTurn = (myIndex !== -1 && myIndex < maxPrayersAllowed);

                                    if (!isMyTurn) {
                                        prayerBtn.disabled = true;
                                        prayerBtn.style.opacity = "0.5";
                                        prayerBtn.style.cursor = "not-allowed";
                                        prayerBtn.title = "انتظر دورك في الطابور أو وصول العدد المسموح";
                                    } else {
                                        prayerBtn.disabled = false;
                                        prayerBtn.style.opacity = "1";
                                        prayerBtn.style.cursor = "pointer";
                                        prayerBtn.title = "تفضل، دورك متاح الآن";
                                    }
                                }

                                function updateUserUI() {
                                    if(!currentUser || currentUser.role === 'admin') return;
                                    const u = currentUser;
                                    const timerText = document.getElementById('userTimer');
                                    const lbl = document.getElementById('timerLabel');
                                    const msg = document.getElementById('userStatusMsg');
                                    const circle = document.getElementById('timerCircle');
                                    const welcomeArea = document.getElementById('welcomeBackArea');
                                    const circ = 628;
                                    const allowTotal = (u.allowance || 45) * 60;

                                    // --- أولاً: التحكم في ظهور الأزرار بناءً على نوع الموظف (VIP / CS) ---

                                    // إظهار زر VIP إذا كان الموظف VIP
                                    const vipArea = document.getElementById('vipControlArea');
                                    if (u.isVIP) vipArea.classList.remove('hidden');
                                    else vipArea.classList.add('hidden');

                                    // إظهار زر المتابعة إذا كان لديه صلاحية
                                    const followArea = document.getElementById('followUpCard');
                                    if (u.canFollowUp) followArea.classList.remove('hidden');
                                    else followArea.classList.add('hidden');

                                    // منطق خدمة العملاء (CS Agent)
                                    const csDashboard = document.getElementById('csAgentDashboard');
                                    const normalControls = document.getElementById('controlsArea');
                                    const stopArea = document.getElementById('stopArea');

                                    if (u.isCS) {
                                        // لو الموظف خدمة عملاء (CS)
                                        if (!u.isOnBreak) {
                                            // وهو شغال (مش في بريك):
                                            // 1. اظهر لوحة التقييم والجودة
                                            csDashboard.classList.remove('hidden');

                                            // 2. اظهر أزرار البريك العادية (ده التعديل اللي انت محتاجه) ✅
                                            normalControls.classList.remove('hidden');

                                            // 3. اخفي زر الإيقاف الأحمر الكبير
                                            stopArea.classList.add('hidden');

                                            // تحديث قائمة الموظفين
                                            populateCsEmployeeList();
                                        } else {
                                            // وهو في بريك:
                                            // اخفي لوحة الجودة وأزرار البريك
                                            csDashboard.classList.add('hidden');
                                            normalControls.classList.add('hidden');

                                            // اظهر زر إنهاء البريك
                                            stopArea.classList.remove('hidden');
                                        }
                                    } else {
                                        // ... (باقي الكود للموظف العادي زي ما هو ماتغيروش) ...
                                        csDashboard.classList.add('hidden');
                                        if (u.isOnBreak) {
                                            normalControls.classList.add('hidden');
                                            stopArea.classList.remove('hidden');
                                        } else {
                                            normalControls.classList.remove('hidden');
                                            stopArea.classList.add('hidden');
                                        }
                                    }

                                    // --- إضافة منطق الطابور (الحالة والتحكم) ---
                                    // --- التعديل الجديد لمنطق الطابور المرن ---
                                    let queuePosition = (currentQueue || []).indexOf(u.username);
                                    // الموظف مسموح له لو ترتيبه في الطابور أقل من العدد المسموح به (مثلاً 0 و 1 لو الحد 2)
                                    let isMyTurn = true;
                                    if (currentQueue && currentQueue.length > 0) {
                                        if (queuePosition !== -1) {
                                            // لو الموظف جوه الطابور، بنشوف هل ترتيبه ضمن المسموح بهم؟
                                            isMyTurn = (queuePosition < maxPrayersAllowed);
                                        } else {
                                            // لو مش في الطابور خالص، الأزرار تفتح عادي (إلا لو المدير قافل الصلاة)
                                            isMyTurn = true;
                                        }
                                    }

                                    // --- ثانياً: تحديث العداد والوقت ---
                                    if (u.isOnBreak) {
                                        welcomeArea.innerHTML = "";
                                        msg.innerText = "أنت الآن في: " + u.breakType;
                                        const elap = Math.floor((getServerTime() - u.lastStartTime) / 1000);
                                        document.getElementById('elapsedTime').innerText = `مدة البريك الحالية: ${formatTime(elap)}`;

                                        // لو الموظف في حالة صلاة
                                        if (u.breakType === 'صلاة') {
                                            const limit = u.prayerLimit || 0; // الرصيد المتاح
                                            const usedPre = u.prayerSeconds || 0; // المستهلك قديماً
                                            const current = elap; // المستهلك الآن

                                            // المتبقي = الرصيد الكلي - (المستهلك قديماً + المستهلك الآن)
                                            const remaining = limit - (usedPre + current);

                                            if (remaining > 0) {
                                                timerText.innerText = formatTime(remaining);
                                                lbl.innerText = "رصيد الصلاة المتبقي";
                                                timerText.style.color = "#38bdf8"; // أزرق
                                                circle.style.stroke = "#38bdf8";

                                                // رسم الدائرة (نسبة تقريبية على 15 دقيقة للشكل)
                                                let pct = (remaining / 900);
                                                circle.style.strokeDashoffset = circ - (pct * circ);
                                            } else {
                                                // الرصيد خلص
                                                timerText.innerText = "00:00";
                                                // تحويل تلقائي للبريك (الدالة اللي ضفناها قبل كده)
                                                autoConvertPrayerToBreak();
                                            }
                                        }
                                        // --- منطق البريك العام (الأكسدة) ---
                                        else if (u.breakType === 'بريك عام' || u.breakType === 'طوارئ' || u.breakType === 'استراحة VIP') {
                                            const rem = allowTotal - ((u.usedSeconds || 0) + (u.breakType === 'استراحة VIP' ? 0 : elap));

                                            let pct = (rem / allowTotal); if (pct < 0) pct = 0;
                                            circle.style.strokeDashoffset = circ - (pct * circ);

                                            if (u.breakType === 'استراحة VIP') {
                                                timerText.innerText = formatTime(elap);
                                                lbl.innerText = "مدة الـ VIP";
                                                circle.style.stroke = "#ffd700"; // لون ذهبي
                                            } else if (rem >= 0) {
                                                lbl.innerText = "رصيد متبقي";
                                                timerText.innerText = formatTime(rem);
                                                timerText.style.color = "white";
                                                circle.style.stroke = "#10b981";
                                                stopAlarm();
                                            } else {
                                                lbl.innerText = "أكسدة";
                                                timerText.innerText = "-" + formatTime(Math.abs(rem));
                                                timerText.style.color = "#ef4444";
                                                circle.style.stroke = "#ef4444";
                                                playAlarm();
                                            }
                                        }
                                        // باقي الأنواع (ميتنج، متابعة...)
                                        else {
                                            timerText.innerText = formatTime(elap);
                                            lbl.innerText = "مدة " + u.breakType;
                                            circle.style.stroke = "#f59e0b";
                                            circle.style.strokeDashoffset = 0;
                                        }
                                    } else {
                                        stopAlarm();
                                        const rem = allowTotal - (u.usedSeconds || 0);
                                        timerText.innerText = rem >= 0 ? formatTime(rem) : "00:00";
                                        timerText.style.color = "white";
                                        lbl.innerText = "رصيد البريك";
                                        let pct = (rem / allowTotal); if (pct < 0) pct = 0;
                                        circle.style.strokeDashoffset = circ - (pct * circ);
                                        circle.style.stroke = "var(--primary)";

                                        const myIndex = (currentQueue || []).indexOf(u.username);
                                        const isMyTurn = (myIndex !== -1 && myIndex < maxPrayersAllowed); // التعديل هنا

                                        if (isMyTurn) {
                                            msg.innerText = "🌟 دورك الآن في الصلاة! تفضل بالبدء ✅";
                                            msg.style.color = "#10b981";
                                        } else if (myIndex >= maxPrayersAllowed) {
                                            msg.innerText = `⏳ أنت رقم (${myIndex + 1}) في الطابور.. انتظر خروج زملائك`;
                                            msg.style.color = "#f59e0b";
                                        } else {
                                            msg.innerText = "متاح للعمل ✅";
                                            msg.style.color = "var(--success)";
                                        }

                                        if (u.lastEndedTime && (Math.floor((getServerTime() - u.lastEndedTime) / 1000) < 300)) {
                                            const userTitle = u.funTitle || 'يا بطل';
                                            let customMsg = "";

                                            // تحديد الرسالة بناءً على نوع النشاط اللي لسه خلصان
                                            switch (u.lastEndedType) {
                                                case 'صلاة':
                                                    customMsg = `تقبل الله يا ${userTitle} 🕌 الحرم إن شاء الله`;
                                                    break;
                                                case 'بريك عام':
                                                    customMsg = `حمد الله على السلامة يا ${userTitle} 🍔 نورت مكتبك`;
                                                    break;
                                                case 'ميتنج':
                                                    customMsg = `كفارة يا ${userTitle}! مابغيت تخلص من الميتنج؟ 🤝😂`;
                                                    break;
                                                case 'طوارئ':
                                                    customMsg = `لعله خير يا ${userTitle}.. حمد الله على سلامتك 🚨`;
                                                    break;
                                                case 'متابع عميل':
                                                    customMsg = `عاش يا وحش المتابعة.. نورتنا تاني 📞`;
                                                    break;
                                                default:
                                                    customMsg = `نورت مكانك يا ${userTitle} من جديد ❤️`;
                                            }

                                            welcomeArea.innerHTML = `<div class="welcome-back-msg" style="animation: bounceIn 0.8s ease;">${customMsg}</div>`;
                                        } else welcomeArea.innerHTML = "";
                                    }

                                    // تحديث زر الصلاة
                                    updatePrayerButton();
                                }

                                function formatTime(s) { if(isNaN(s) || s < 0) return "00:00"; return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
                                function playAlarm() { if(soundActive) { document.body.classList.add('وضع-التنبيه'); document.getElementById('overtimeAlert').classList.remove('hidden'); document.getElementById('alarmSound').play().catch(e=>{}); } }
                                function stopAlarm() { document.body.classList.remove('وضع-التنبيه'); if(document.getElementById('overtimeAlert')) document.getElementById('overtimeAlert').classList.add('hidden'); document.getElementById('alarmSound').pause(); }
                                function saveAdminTyping(u, v) { adminTypingBuffer[u] = v; }
                                function saveAdminSelect(u, v) { adminSelectBuffer[u] = v; }
                                function updateReportSelect() { const sel = document.getElementById('reportUserSelect'); sel.innerHTML = '<option value="">-- اختر موظف --</option>'; Object.values(allUsersData).forEach(u => { if(u.username && !MANAGERS.includes(u.username)) sel.innerHTML += `<option value="${u.username}">${u.realName || u.username}</option>`; }); }
                                function updateBroadcastTargets() {
                                    const sel = document.getElementById('broadcastTarget'); const old = Array.from(sel.selectedOptions).map(o => o.value);
                                    let h = '<option value="all">📣 للجميع</option>';
                                    Object.values(allUsersData).forEach(u => { if(u.username && !MANAGERS.includes(u.username)) h += `<option value="${u.username}">👤 ${u.realName || u.username}</option>`; });
                                    if (sel.innerHTML !== h) { sel.innerHTML = h; old.forEach(v => { const o = sel.querySelector(`option[value="${v}"]`); if(o) o.selected = true; }); }
                                }

                                function sendEmRequest() { const r = document.getElementById('breakReason').value.trim(); if(!r) return alert("اكتب السبب"); db.ref('users/'+currentUser.username+'/emRequest').set({ reason: r, status: 'قيد الانتظار', timestamp: getServerTime() }); }

                                function updateEmStatus() {
                                    const el = document.getElementById('emStatusArea');
                                    if(!currentUser.emRequest) {
                                        el.innerHTML = `<button onclick="sendEmRequest()" class="btn btn-danger" style="width:100%">طلب</button>`;
                                        return;
                                    }
                                    if(currentUser.emRequest.status === 'قيد الانتظار') {
                                        el.innerHTML = `<span style="color:orange;">⏳...</span>`;
                                    } else if(currentUser.emRequest.status === 'تم القبول') {
                                        el.innerHTML = `<button onclick="startMyBreak('طوارئ')" class="btn btn-success btn-sm" style="width:100%">ابدأ</button>`;
                                    } else {
                                        el.innerHTML = `<span style="color:red; font-weight:bold;">❌ تم الرفض</span>`;
                                        setTimeout(() => {
                                            if(currentUser.emRequest && (currentUser.emRequest.status === 'رُفض' || currentUser.emRequest.status.includes('رفض'))) {
                                                db.ref('users/'+currentUser.username+'/emRequest').remove();
                                            }
                                        }, 4000);
                                    }
                                }

                                function renderAdminEmRequests() { const tb = document.getElementById('adminEmBody'); tb.innerHTML = ''; let c = 0; Object.values(allUsersData).forEach(u => { if(u.emRequest && u.emRequest.status === 'قيد الانتظار') { c++; tb.innerHTML += `<tr><td>${u.realName}</td><td>${u.emRequest.reason}</td><td>${new Date(u.emRequest.timestamp).toLocaleTimeString()}</td><td><button onclick="handleEm('${u.username}', true)" class="btn btn-success btn-sm">✔</button><button onclick="handleEm('${u.username}', false)" class="btn btn-danger btn-sm">✖</button></td></tr>`; } }); document.getElementById('emBadge').innerText = c; c > 0 ? document.getElementById('emBadge').classList.remove('hidden') : document.getElementById('emBadge').classList.add('hidden'); }
                                window.handleEm = (un, app) => { if(app) db.ref('users/'+un).update({ isOnBreak: true, breakType: 'طوارئ', lastStartTime: getServerTime(), lastReason: allUsersData[un].emRequest.reason, 'emRequest/status': 'تم القبول' }); else db.ref(`users/${un}/emRequest`).update({ status: 'رُفض' }); triggerGlobalRefresh(); };

                                // دالة إرسال طلب الاستأذان (معدلة)
                                function sendPermRequest() {
                                    console.log("تم الضغط على زر الاستأذان..."); // للتأكد إن الزر شغال

                                    // 1. التأكد من وجود الخانات
                                    const hoursInput = document.getElementById('permHoursInput');
                                    const reasonInput = document.getElementById('permReasonInput');

                                    if (!hoursInput || !reasonInput) {
                                        alert("خطأ برمجي: لم يتم العثور على خانات الإدخال (تأكد من الـ IDs)");
                                        return;
                                    }

                                    const h = hoursInput.value;
                                    const r = reasonInput.value;

                                    // 2. التحقق من البيانات
                                    if(!h || !r) {
                                        alert("⚠️ يا بطل، لازم تكتب عدد الساعات والسبب!");
                                        return;
                                    }

                                    if (!currentUser) {
                                        alert("خطأ: لم يتم التعرف على المستخدم الحالي.");
                                        return;
                                    }

                                    // 3. الإرسال للداتابيز
                                    db.ref('users/'+currentUser.username+'/permRequest').set({
                                        hours: h,
                                        reason: r,
                                        status: 'قيد الانتظار',
                                        timestamp: getServerTime()
                                    }).then(() => {
                                        alert("تم إرسال الطلب للمشرف بنجاح ✅");
                                        // تصفير الخانات
                                        document.getElementById('permHoursInput').value = '';
                                        document.getElementById('permReasonInput').value = '';
                                    }).catch((error) => {
                                        console.error(error);
                                        alert("حدث خطأ أثناء الإرسال: " + error.message);
                                    });
                                }

                                function updatePermStatus() {
                                    const el = document.getElementById('permStatusArea');
                                    if(!currentUser.permRequest) {
                                        el.innerHTML = `<button onclick="sendPermRequest()" class="btn btn-primary" style="background: linear-gradient(135deg, #a855f7, #7e22ce); width: 100%;">إرسال الطلب</button>`;
                                        return;
                                    }
                                    if(currentUser.permRequest.status === 'قيد الانتظار') {
                                        el.innerHTML = `<span style="color:orange;">⏳...</span>`;
                                    } else if(currentUser.permRequest.status === 'تم القبول') {
                                        el.innerHTML = `<span style="color:green; font-weight:bold;">✅ تم القبول</span>`;
                                    } else {
                                        el.innerHTML = `<span style="color:red; font-weight:bold;">❌ تم الرفض</span>`;
                                        setTimeout(() => {
                                            if(currentUser.permRequest && (currentUser.permRequest.status === 'رُفض' || currentUser.permRequest.status.includes('رفض'))) {
                                                db.ref('users/'+currentUser.username+'/permRequest').remove();
                                            }
                                        }, 4000);
                                    }
                                }

                                function renderAdminPermRequests() { const tb = document.getElementById('adminPermBody'); tb.innerHTML = ''; let c = 0; Object.values(allUsersData).forEach(u => { if(u.permRequest && u.permRequest.status === 'قيد الانتظار') { c++; tb.innerHTML += `<tr><td>${u.realName}</td><td>${u.permRequest.hours} ساعة</td><td>${u.permRequest.reason}</td><td>${new Date(u.permRequest.timestamp).toLocaleTimeString()}</td><td><button onclick="handlePerm('${u.username}', true)" class="btn btn-success btn-sm">✔</button><button onclick="handlePerm('${u.username}', false)" class="btn btn-danger btn-sm">✖</button></td></tr>`; } }); document.getElementById('permBadge').innerText = c; c > 0 ? document.getElementById('permBadge').classList.remove('hidden') : document.getElementById('permBadge').classList.add('hidden'); }
    window.handlePerm = (un, app) => {
        if(app) {
            // لو وافق، بنسجل الاستئذان في سجل التاريخ للموظف
            const permData = allUsersData[un].permRequest;
            db.ref(`users/${un}/permHistory/${getServerTime()}`).set({
                date: getServerDateString(),
                hours: permData.hours,
                reason: permData.reason,
                approvedBy: currentUser.username
            });
        }
        // تحديث الحالة لتم القبول أو رُفض
        db.ref(`users/${un}/permRequest`).update({
            status: app ? 'تم القبول' : 'رُفض'
        }).then(() => triggerGlobalRefresh());
    };
                                
                                function sendMeetingRequest() { const r = document.getElementById('breakReason').value.trim(); if(!r) return alert("اكتب السبب"); db.ref('users/'+currentUser.username+'/meetingRequest').set({ reason: r, status: 'قيد الانتظار', timestamp: getServerTime() }); }
                                
                                function updateMeetingStatus() { 
                                    const el = document.getElementById('meetingStatusArea'); 
                                    if(!currentUser.meetingRequest) {
                                        el.innerHTML = `<button onclick="sendMeetingRequest()" class="btn btn-warning" style="width:100%">طلب</button>`;
                                        return;
                                    }
                                    if(currentUser.meetingRequest.status === 'قيد الانتظار') {
                                        el.innerHTML = `<span style="color:orange;">⏳...</span>`;
                                    } else if(currentUser.meetingRequest.status === 'تم القبول') {
                                        el.innerHTML = `<button onclick="startMyBreak('ميتنج')" class="btn btn-success btn-sm" style="width:100%">ابدأ</button>`;
                                    } else {
                                        el.innerHTML = `<span style="color:red; font-weight:bold;">❌ تم الرفض</span>`;
                                        setTimeout(() => {
                                            if(currentUser.meetingRequest && (currentUser.meetingRequest.status === 'رُفض' || currentUser.meetingRequest.status.includes('رفض'))) {
                                                db.ref('users/'+currentUser.username+'/meetingRequest').remove();
                                            }
                                        }, 4000);
                                    }
                                }

                                function renderAdminMeetingRequests() { const tb = document.getElementById('adminMeetBody'); tb.innerHTML = ''; let c = 0; Object.values(allUsersData).forEach(u => { if(u.meetingRequest && u.meetingRequest.status === 'قيد الانتظار') { c++; tb.innerHTML += `<tr><td>${u.realName}</td><td>${u.meetingRequest.reason}</td><td>${new Date(u.meetingRequest.timestamp).toLocaleTimeString()}</td><td><button onclick="handleMeeting('${u.username}', true)" class="btn btn-success btn-sm">✔</button><button onclick="handleMeeting('${u.username}', false)" class="btn btn-danger btn-sm">✖</button></td></tr>`; } }); document.getElementById('meetBadge').innerText = c; c > 0 ? document.getElementById('meetBadge').classList.remove('hidden') : document.getElementById('meetBadge').classList.add('hidden'); }
                                window.handleMeeting = (un, app) => { if(app) db.ref('users/'+un).update({ isOnBreak: true, breakType: 'ميتنج', lastStartTime: getServerTime(), lastReason: allUsersData[un].meetingRequest.reason, 'meetingRequest/status': 'تم القبول' }); else db.ref(`users/${un}/meetingRequest`).update({ status: 'رُفض' }); triggerGlobalRefresh(); };
                                
                                function sendOtRequest() { const h = document.getElementById('otHoursInput').value; if(!h) return; db.ref('users/'+currentUser.username+'/otRequest').set({ hours: h, status: 'قيد الانتظار', timestamp: getServerTime() }); }
                                
                                function updateOtStatus() { 
                                    const el = document.getElementById('otStatusDisplay'); 
                                    if(!currentUser.otRequest) {
                                        el.innerText = "";
                                        return;
                                    }
                                    if (currentUser.otRequest.status === 'قيد الانتظار') {
                                        el.innerText = "⏳ قيد الانتظار";
                                    } else if (currentUser.otRequest.status === 'تم القبول') {
                                        el.innerText = "✅ تم القبول";
                                    } else {
                                        el.innerText = "❌ تم الرفض";
                                        setTimeout(() => {
                                            if(currentUser.otRequest && (currentUser.otRequest.status === 'رُفض' || currentUser.otRequest.status.includes('رفض'))) {
                                                db.ref('users/'+currentUser.username+'/otRequest').remove();
                                            }
                                        }, 4000);
                                    }
                                }

                                function renderAdminOtRequests() { const tb = document.getElementById('adminOtBody'); tb.innerHTML = ''; let c=0; Object.values(allUsersData).forEach(u => { if(u.otRequest && u.otRequest.status === 'قيد الانتظار') { c++; tb.innerHTML += `<tr><td>${u.realName}</td><td>${u.otRequest.hours}س</td><td>${new Date(u.otRequest.timestamp).toLocaleTimeString()}</td><td><button onclick="handleOt('${u.username}', true)" class="btn btn-success btn-sm">✔</button><button onclick="handleOt('${u.username}', false)" class="btn btn-danger btn-sm">✖</button></td></tr>`; } }); document.getElementById('otBadge').innerText = c; c > 0 ? document.getElementById('otBadge').classList.remove('hidden') : document.getElementById('otBadge').classList.add('hidden'); }
                                window.handleOt = (un, app) => { if(app) db.ref(`users/${un}/overtimeHistory/${getServerTime()}`).set({ date: getServerDateString(), hours: allUsersData[un].otRequest.hours, approvedBy: currentUser.username }); db.ref(`users/${un}/otRequest`).update({ status: app ? 'تم القبول' : 'رُفض' }).then(() => triggerGlobalRefresh()); };

                                function renderAdminPermRequests() {
                                    const tb = document.getElementById('adminPermBody');

                                    // تأكد إن الجدول موجود في HTML عشان الكود مايضربش
                                    if(!tb) return;

                                    tb.innerHTML = '';
                                    let c = 0;

                                    Object.values(allUsersData).forEach(u => {
                                        // الشرط: لازم يكون فيه طلب، وحالته "قيد الانتظار"
                                        if(u.permRequest && u.permRequest.status === 'قيد الانتظار') {
                                            c++;
                                            tb.innerHTML += `
                                                <tr>
                                                    <td style="font-weight:bold; color:var(--primary);">${u.realName || u.username}</td>
                                                    <td style="font-weight:bold;">${u.permRequest.hours} ساعة</td>
                                                    <td>${u.permRequest.reason}</td>
                                                    <td style="direction:ltr; font-size:0.8rem; color:#aaa;">${new Date(u.permRequest.timestamp).toLocaleTimeString()}</td>
                                                    <td>
                                                        <button onclick="handlePerm('${u.username}', true)" class="btn btn-success btn-sm">✔ موافق</button>
                                                        <button onclick="handlePerm('${u.username}', false)" class="btn btn-danger btn-sm">✖ رفض</button>
                                                    </td>
                                                </tr>`;
                                        }
                                    });

                                    // تحديث العداد الأحمر فوق الزرار
                                    const badge = document.getElementById('permBadge');
                                    if(badge) {
                                        badge.innerText = c;
                                        c > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
                                    }
                                }
                                function endDay() {
        if (!MANAGERS.includes(currentUser.username)) {
            alert("⛔ عذراً، هذه الصلاحية خاصة بالمشرفين فقط.");
            return;
        }

        if(confirm("⚠️ هل أنت متأكد من تصفير العدادات (بما فيها الصلاة) وبدء يوم جديد؟")) {
            logDeletionAction("تصفير اليوم (End Day)", "الكل", "تم تصفير كافة العدادات بما فيها رصيد الصلاة");

            const updates = {};
            Object.keys(allUsersData).forEach(un => {
                if(!MANAGERS.includes(un)) {
                    updates[`users/${un}/usedSeconds`] = 0;
                    updates[`users/${un}/prayerSeconds`] = 0;
                    updates[`users/${un}/prayerLimit`] = 0; // تصفير رصيد الصلاة
                    updates[`users/${un}/prayerCountToday`] = 0; // تصفير عدد المرات
                    updates[`users/${un}/meetingSeconds`] = 0;
                    updates[`users/${un}/followUpSeconds`] = 0;
                    updates[`users/${un}/vipSeconds`] = 0;
                    updates[`users/${un}/isOnBreak`] = false;
                    updates[`users/${un}/lastStartTime`] = null;
                    updates[`users/${un}/otRequest`] = null;
                    updates[`users/${un}/emRequest`] = null;
                    updates[`users/${un}/meetingRequest`] = null;
                    updates[`users/${un}/permRequest`] = null;
                }
            });

            // إغلاق زر الصلاة تلقائياً عند تقفيل اليوم
            updates['settings/prayerOpen'] = false;

            db.ref().update(updates).then(() => {
                triggerGlobalRefresh();
                alert("✅ تم تصفير اليوم بالكامل وتصفير رصيد الصلاة للجميع.");
            });
        }
    }
                                function forceResetPrayerOnly() {
                                    if(!confirm("هل تريد تصفير بيانات الصلاة لجميع الموظفين؟ (يستخدم في حالة تعليق العدادات)")) return;

                                    db.ref('users').once('value', snap => {
                                        const users = snap.val();
                                        const updates = {};
                                        Object.keys(users).forEach(k => {
                                            updates[`users/${k}/prayerLimit`] = 0;
                                            updates[`users/${k}/prayerSeconds`] = 0;
                                            updates[`users/${k}/prayerCountToday`] = 0;
                                        });
                                        db.ref().update(updates).then(() => alert("✅ تم تصفير كافة بيانات الصلاة. يمكنك التوزيع الآن بشكل صحيح."));
                                    });
                                }
                                function deleteAllReports() { if(!['mahmoud', 'ahmed'].includes(currentUser.username)) return; if(confirm("حذف كل الأرشيف؟")) { Object.keys(allUsersData).forEach(u => { db.ref(`users/${u}/sessions`).remove(); db.ref(`users/${u}/overtimeHistory`).remove(); }); triggerGlobalRefresh(); } }
                                function deleteReportsInRange() {
                                    if(!['mahmoud', 'ahmed'].includes(currentUser.username)) return;
                                    const un = document.getElementById('reportUserSelect').value, start = document.getElementById('filterStartDate').value, end = document.getElementById('filterEndDate').value;
                                    if (!start || !end) return alert("حدد التاريخ");
                                    if (!confirm("حذف السجلات؟")) return;
                                    const targets = un ? [un] : Object.keys(allUsersData).filter(k => !MANAGERS.includes(k));
                                    targets.forEach(userKey => {
                                        const u = allUsersData[userKey];
                                        if (u.sessions) Object.keys(u.sessions).forEach(k => { const parts = u.sessions[k].date.split('/'); const iso = `${parts[2]}-${parts[1]}-${parts[0]}`; if (iso >= start && iso <= end) db.ref(`users/${userKey}/sessions/${k}`).remove(); });
                                    });
                                    alert("تم الحذف"); triggerGlobalRefresh();
                                }

                                function renderUserManagementTable() {
                                    const tb = document.getElementById('usersManagementBody');
                                    if(!tb) return;
                                    tb.innerHTML = '';

                                    // 1. تحديد هل المستخدم الحالي هو محمود أم لا
                                    const isSuperAdmin = ['mahmoud', 'ahmed'].includes(currentUser.username);
                                    const isMahmoud = (currentUser.username === 'mahmoud');

                                    // 2. التحكم في ظهور رؤوس الجدول (العناوين)
                                    const headerPass = document.getElementById('headerUserPass');
                                    const headerFileLock = document.getElementById('headerFilePass');

                                    if (headerPass && headerFileLock) {
                                        if (isMahmoud) {
                                            headerPass.style.display = 'table-cell';
                                            headerFileLock.style.display = 'table-cell';
                                        } else {
                                            headerPass.style.display = 'none';
                                            headerFileLock.style.display = 'none';
                                        }
                                    }

                                    // 3. بناء الجدول
                                    Object.values(allUsersData).forEach(u => {
                                        if(!u || !u.username || MANAGERS.includes(u.username)) return;

                                        // تجهيز خلية قفل الملف
                                        let filePassDisplay = '';
                                        if (isMahmoud) {
                                            filePassDisplay = u.filePassword ?
                                                `<span style="color:var(--accent); font-weight:bold;">${u.filePassword}</span>` :
                                                `<span style="color:#666; font-size:0.7rem;">غير معين</span>`;
                                        }

                                        // تجهيز الخلايا الشرطية (تظهر فقط لمحمود)
                                        // إذا كان محمود: نعرض الخلية بالبيانات
                                        // إذا لم يكن محمود: نعرض نص فارغ '' حتى لا يتم رسم الخلية وتخرب التنسيق
                                        const passCell = isMahmoud ? `<td>${u.password}</td>` : '';
                                        const lockCell = isMahmoud ? `<td style="font-family:monospace;">${filePassDisplay}</td>` : '';

                                        // اللقب
                                        const funTitle = u.funTitle ? `<span style="color:#ffd700">${u.funTitle}</span>` : '---';

                                        tb.innerHTML += `
                                        <tr>
                                            <td>${u.realName || u.username}</td>
                                            <td>${u.username}</td>

                                            ${passCell}  <!-- خلية الباسورد -->
                                            ${lockCell}  <!-- خلية قفل الملف -->

                                            <td>${u.allowance}د</td>
                                            <td>${funTitle}</td>
                                            <td>
                                                <button onclick="openUserProfile('${u.username}')" class="btn btn-dark btn-sm" title="الملف">📂</button>
                                                <button onclick="editUser('${u.username}')" class="btn btn-warning btn-sm">✎</button>
                                                <button onclick="deleteUser('${u.username}')" class="btn btn-danger btn-sm">🗑</button>
                                            </td>
                                        </tr>`;
                                    });
                                }

                                window.saveUser = () => {
                                    const un = document.getElementById('newUsername').value.trim().toLowerCase(), pass = document.getElementById('newPassword').value, name = document.getElementById('newRealName').value, allow = parseInt(document.getElementById('newAllowance').value), isVIP = document.getElementById('isVIPUser').checked, follow = document.getElementById('canFollowUp').checked;
                                    const funTitle = document.getElementById('newFunTitle').value.trim();
                                    const profilePic = document.getElementById('newProfilePic').value.trim();
                                    const isCS = document.getElementById('isCSAgent').checked; // القيمة الجديدة
                                    const group = document.getElementById('newUserGroup').value;
                                    if(!un || !pass || !name) return alert("أكمل البيانات");
                                    const data = { realName: name, password: pass, allowance: allow, isVIP: isVIP, canFollowUp: follow, isCS: isCS, funTitle: funTitle, profilePic: profilePic, groupName: group };
                                    if (editingUserKey) db.ref('users/' + editingUserKey).update(data).then(() => { triggerGlobalRefresh(); alert("تم التحديث"); resetUserForm(); });
                                    else db.ref('users/' + un).set({...data, username: un, role: 'employee', usedSeconds: 0, prayerSeconds: 0, meetingSeconds: 0, followUpSeconds: 0, vipSeconds: 0, isOnBreak: false}).then(() => { triggerGlobalRefresh(); alert("تمت الإضافة"); resetUserForm(); });
                                };
                                
                                window.editUser = (un) => {
                                    const u = allUsersData[un]; editingUserKey = un;
                                    document.getElementById('newUsername').value = u.username; document.getElementById('newUsername').disabled = true;
                                    document.getElementById('newRealName').value = u.realName; document.getElementById('newPassword').value = u.password;
                                    document.getElementById('newAllowance').value = u.allowance; document.getElementById('newFunTitle').value = u.funTitle || '';
                                    document.getElementById('newProfilePic').value = u.profilePic || '';
                                    document.getElementById('isVIPUser').checked = !!u.isVIP; document.getElementById('canFollowUp').checked = !!u.canFollowUp;
                                    document.getElementById('isCSAgent').checked = !!u.isCS;
                                    document.getElementById('newUserGroup').value = u.groupName || '';
                                };
                                
                                function resetUserForm() { editingUserKey = null; document.getElementById('newUsername').disabled = false; document.getElementById('newUsername').value = ''; document.getElementById('newRealName').value = ''; document.getElementById('newPassword').value = ''; document.getElementById('newAllowance').value = '45'; document.getElementById('newFunTitle').value = ''; document.getElementById('newProfilePic').value = ''; document.getElementById('newUserGroup').value = ''; }
                                function deleteUser(un) {
                                    if(confirm("حذف الموظف؟")) {
                                        logDeletionAction("حذف موظف بالكامل", un, "تم مسح حساب الموظف من السيستم");
                                        db.ref('users/'+un).remove().then(() => triggerGlobalRefresh());
                                    }
                                }

                                function openUserProfile(username) {
                                    const u = allUsersData[username];
                                    if(!u) return;

                                    const isAdmin = MANAGERS.includes(currentUser.username);
                                    const isOwner = (currentUser.username === username);

                                    // إذا كان الموظف هو من يفتح ملفه
                                    if (!isAdmin && isOwner) {
                                        // إذا لم يكن لديه باسورد بعد
                                        if (!u.filePassword) {
                                            alert("🔒 لم تقم بتعيين كلمة سر لخصوصية ملفك بعد. يرجى تعيينها الآن.");
                                            openFilePassModal(true);
                                            return;
                                        }

                                        // بدلاً من prompt، نفتح النافذة الآمنة
                                        pendingProfileUser = username;
                                        document.getElementById('accessFilePassInput').value = ''; // تصفير الحقل
                                        document.getElementById('accessFileModal').classList.remove('hidden');
                                        document.getElementById('accessFilePassInput').focus();
                                        return;
                                    }

                                    // لو أدمن، يفتح علطول
                                    loadProfileData(username);
                                }

                                // دالة التحقق من الباسورد في النافذة الجديدة
                                function confirmAccessFile() {
                                    const inputPass = document.getElementById('accessFilePassInput').value;
                                    const u = allUsersData[pendingProfileUser];

                                    if (inputPass === u.filePassword) {
                                        document.getElementById('accessFileModal').classList.add('hidden');
                                        loadProfileData(pendingProfileUser); // فتح الملف
                                    } else {
                                        alert("❌ كلمة السر غير صحيحة!");
                                        document.getElementById('accessFilePassInput').value = '';
                                    }
                                }

                                function closeAccessModal() {
                                    document.getElementById('accessFileModal').classList.add('hidden');
                                    pendingProfileUser = null;
                                }

                                // دالة تحميل البيانات (فصلناها لتسهيل الاستدعاء)
                                function loadProfileData(username) {
                                    currentProfileTarget = username;
                                    const u = allUsersData[username];
                                    const isAdmin = MANAGERS.includes(currentUser.username);

                                    document.getElementById('profileModal').classList.remove('hidden');
                                    document.getElementById('modalRealName').innerText = u.realName || username;
                                    document.getElementById('modalUserName').innerText = `@${u.username}`;
                                    document.getElementById('modalProfilePic').src = u.profilePic || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';

                                    if (isAdmin) {
                                        document.getElementById('adminAddComplaintArea').classList.remove('hidden');
                                    } else {
                                        document.getElementById('adminAddComplaintArea').classList.add('hidden');
                                        // تحديث حالة المشاهدة
                                        if (u.complaints) {
                                            Object.keys(u.complaints).forEach(key => {
                                                if (!u.complaints[key].seen && !u.complaints[key].acknowledged) {
                                                    db.ref(`users/${username}/complaints/${key}`).update({ seen: true });
                                                }
                                            });
                                        }
                                    }

                                    // تصفير الفلاتر عند الفتح
                                    clearHistoryFilters(false);
                                    renderComplaintsHistory(username);
                                }

                                // دالة تصفير الفلاتر
                                function clearHistoryFilters(reload = true) {
                                    document.getElementById('historyDateFrom').value = '';
                                    document.getElementById('historyDateTo').value = '';
                                    if(reload && currentProfileTarget) renderComplaintsHistory(currentProfileTarget);
                                }

                                function closeProfileModal() {
                                    document.getElementById('profileModal').classList.add('hidden');
                                    currentProfileTarget = null;
                                    // تنظيف الحقول
                                    document.getElementById('complaintTitle').value = '';
                                    document.getElementById('deductionAmount').value = '';
                                    document.getElementById('complaintDetails').value = '';

                                    // تنظيف الصور
                                    document.getElementById('complaintEvidence').value = '';
                                    document.getElementById('evidencePreview').style.display = 'none';
                                    document.getElementById('evidencePreview').src = '';
                                    document.getElementById('evidenceFileName').innerText = '';

                                    // تنظيف الصوت
                                    document.getElementById('complaintAudioInput').value = '';
                                    document.getElementById('audioPreviewPlayer').style.display = 'none';
                                    document.getElementById('audioPreviewPlayer').src = '';
                                    document.getElementById('audioPreviewPlayer').pause(); // إيقاف الصوت عند الإغلاق
                                    document.getElementById('audioFileName').innerText = '';
                                }

                                // 2. معالجة صورة الدليل (Preview & Base64)
                                function previewEvidence(input) {
                                    if (input.files && input.files[0]) {
                                        const file = input.files[0];

                                        // 1. فحص الحجم فوراً (أقصى حد 5 ميجا)
                                        if (file.size > 5 * 1024 * 1024) {
                                            alert("الملف كبير جداً! (أكبر من 5 ميجا). اختر ملف أصغر.");
                                            input.value = ""; // إلغاء الاختيار
                                            return;
                                        }

                                        document.getElementById('evidenceFileName').innerText = file.name;

                                        // 2. الطريقة السريعة جداً للمعاينة (بدون تهنيج)
                                        const img = document.getElementById('evidencePreview');
                                        img.src = URL.createObjectURL(file); // سحر السرعة هنا
                                        img.style.display = 'block';

                                        // تنظيف الذاكرة بعد ما الصورة تحمل
                                        img.onload = () => URL.revokeObjectURL(img.src);
                                    }
                                }

                                // 2.1. معالجة ملف الصوت (Preview & Base64)
                                function previewAudio(input) {
                                    if (input.files && input.files[0]) {
                                        const file = input.files[0];

                                        // 1. فحص الحجم
                                        if (file.size > 10 * 1024 * 1024) { // 10 ميجا للصوت
                                            alert("ملف الصوت كبير جداً! يرجى اختيار ملف أصغر.");
                                            input.value = "";
                                            return;
                                        }

                                        document.getElementById('audioFileName').innerText = "تم اختيار: " + file.name;

                                        // 2. الطريقة السريعة للمعاينة
                                        const audioPlayer = document.getElementById('audioPreviewPlayer');
                                        audioPlayer.src = URL.createObjectURL(file); // سحر السرعة هنا
                                        audioPlayer.style.display = 'block';
                                    }
                                }

                                // ==========================================
                                // 2. دالة حفظ الشكوى (بخاصية منع التعليق)
                                // ==========================================
                                async function submitComplaint() {
                                    if (!currentProfileTarget) return;

                                    // بنمسك الزرار عشان نتحكم فيه
                                    const submitBtn = document.querySelector('#adminAddComplaintArea button.btn-danger');
                                    const originalBtnText = submitBtn ? submitBtn.innerText : "تسجيل المخالفة";

                                    const title = document.getElementById('complaintTitle').value.trim();
                                    const amount = document.getElementById('deductionAmount').value.trim();
                                    const details = document.getElementById('complaintDetails').value.trim();
                                    const imgFile = document.getElementById('complaintEvidence').files[0];
                                    const audioFile = document.getElementById('complaintAudioInput').files[0];

                                    // Input validation
                                    if (!title) return alert("اكتب عنوان المخالفة الأول!");
                                    if (title.length < 3) return alert("عنوان المخالفة قصير جداً (أقل من 3 أحرف)");
                                    if (title.length > 100) return alert("عنوان المخالفة طويل جداً (أكثر من 100 حرف)");
                                    if (amount && isNaN(parseFloat(amount))) return alert("قيمة الخصم يجب أن تكون رقماً صحيحاً");
                                    if (parseFloat(amount) < 0) return alert("قيمة الخصم لا يمكن أن تكون سالبة");
                                    if (details.length > 500) return alert("تفاصيل المخالفة طويلة جداً (أكثر من 500 حرف)");

                                    // ---[ هنا الحماية من التعليق ]---
                                    if(submitBtn) {
                                        submitBtn.disabled = true; // بنقفل الزرار خالص
                                        submitBtn.style.opacity = "0.5"; // بنخفف لونه
                                        submitBtn.innerHTML = "⏳ لحظة.. جاري رفع الملفات..."; // بنطمن المستخدم
                                    }

                                    try {
                                        // الرفع بيحصل هنا في الخلفية
                                        let imageUrl = "";
                                        let audioUrl = "";

                                        if (imgFile) imageUrl = await uploadToCloudinary(imgFile);
                                        if (audioFile) audioUrl = await uploadToCloudinary(audioFile);

                                        // بعد ما الملفات تترفع، بنحفظ البيانات كنص خفيف
                                        if(submitBtn) submitBtn.innerHTML = "💾 جاري الحفظ...";

                                        const complaintData = {
                                            date: getServerDateString(),
                                            time: getServerTimeString(),
                                            title: title,
                                            amount: amount || 0,
                                            details: details || "لا توجد تفاصيل",
                                            evidence: imageUrl,    // رابط خفيف
                                            audioRecord: audioUrl, // رابط خفيف
                                            admin: currentUser.realName || currentUser.username,
                                            acknowledged: false
                                        };

                                        await db.ref('users/' + currentProfileTarget + '/complaints').push(complaintData);

                                        alert("تم الحفظ بنجاح والسرعة تمام! 🚀");
                                        closeProfileModal();
                                        triggerGlobalRefresh();

                                    } catch (e) {
                                        console.error(e);
                                        alert("حصلت مشكلة صغيرة، جرب تاني.");
                                    } finally {
                                        // بنرجع الزرار يشتغل تاني في الآخر
                                        if(submitBtn) {
                                            submitBtn.disabled = false;
                                            submitBtn.innerHTML = originalBtnText;
                                            submitBtn.style.opacity = "1";
                                        }
                                    }
                                }

                                function renderComplaintsHistory(username) {
                                    const tbody = document.getElementById('complaintsHistoryBody');
                                    tbody.innerHTML = '';

                                    if (!allUsersData[username]) return;

                                    const u = allUsersData[username];
                                    const viewingMyOwnProfile = (currentUser.username === username);
                                    // السماح لأي مشرف (Admin) برؤية زر الحذف
                                    const canDelete = currentUser.role === 'admin';

                                    // قراءة الفلاتر
                                    const filterFrom = document.getElementById('historyDateFrom').value;
                                    const filterTo = document.getElementById('historyDateTo').value;

                                    if (u.complaints) {
                                        const keys = Object.keys(u.complaints).reverse();

                                        keys.forEach(key => {
                                            const c = u.complaints[key];

                                            // منطق الفلترة بالتاريخ
                                            if (filterFrom || filterTo) {
                                                // تحويل تاريخ الشكوى من DD/MM/YYYY إلى YYYY-MM-DD للمقارنة
                                                const parts = c.date.split('/');
                                                const cDateISO = `${parts[2]}-${parts[1]}-${parts[0]}`;

                                                if (filterFrom && cDateISO < filterFrom) return; // تخطي
                                                if (filterTo && cDateISO > filterTo) return; // تخطي
                                            }

                                            let actionCell = '';

                                            // منطق الحالات
                                            if (c.acknowledged) {
                                                actionCell += `<div style="color:#10b981; font-weight:bold; font-size:0.9rem;">✔ تم التأكيد</div>`;
                                            } else if (c.seen) {
                                                if (currentUser.role === 'admin') {
                                                    actionCell += `<div style="color:#3b82f6; font-size:0.85rem;">👁️ شاهدها</div>`;
                                                } else if (viewingMyOwnProfile) {
                                                    actionCell += `<button onclick="acknowledgeComplaint('${key}')" class="btn btn-vip btn-sm" style="animation: pulse 2s infinite;">✍ موافق</button>`;
                                                }
                                            } else {
                                                if (currentUser.role === 'admin') {
                                                    actionCell += `<div style="color:#f59e0b; font-size:0.85rem;">⏳ لم يفتح</div>`;
                                                }
                                            }

                                            // زر الحذف (يظهر فقط إذا كان مسموح له)
                                            if (canDelete) {
                                                actionCell += `<div style="margin-top:5px;">
                                                    <button onclick="deleteComplaint('${username}', '${key}')" class="btn btn-danger btn-sm">🗑</button>
                                                </div>`;
                                            }

                                            // المرفقات
                                            const evidenceBtn = c.evidence ? `<button onclick="showZoomImage('${c.evidence}')" class="btn btn-primary btn-sm">📷</button>` : '';
                                            const audioPlayer = c.audioRecord ? `<div style="margin-top:5px;"><audio controls src="${c.audioRecord}" style="height:25px; width:150px;"></audio></div>` : '';
                                            const proofCell = (evidenceBtn || audioPlayer) ? `<div>${evidenceBtn} ${audioPlayer}</div>` : '-';

                                            // لون الصف
                                            let rowColor = 'rgba(255,255,255,0.02)';
                                            if (!c.acknowledged && !c.seen) rowColor = 'rgba(245, 158, 11, 0.08)';
                                            if (!c.acknowledged && c.seen) rowColor = 'rgba(59, 130, 246, 0.08)';

                                            tbody.innerHTML += `
                                                <tr style="background:${rowColor}; border-bottom:1px solid rgba(255,255,255,0.05);">
                                                    <td>${c.date}<br><small style="opacity:0.7">${c.time}</small></td>
                                                    <td style="color:var(--primary); font-weight:bold;">${c.title}</td>
                                                    <td style="font-size:0.9rem;">${c.details}</td>
                                                    <td style="color:#ffd700;">${c.amount > 0 ? c.amount : '-'}</td>
                                                    <td>${proofCell}</td>
                                                    <td>${c.uploader || c.admin || 'System'}</td>
                                                    <td style="text-align:center;">${actionCell}</td>
                                                </tr>
                                            `;
                                        });
                                    } else {
                                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">نظيف 🌟 (أو لا توجد نتائج للبحث)</td></tr>';
                                    }
                                }

                                function deleteComplaint(username, key) {
                                    // 1. التأكد أن القائم بالحذف هو مشرف
                                    if (currentUser.role !== 'admin') {
                                        alert("⛔ عذراً، هذه الصلاحية للمشرفين فقط.");
                                        return;
                                    }

                                    // 2. رسالة تأكيد إدارية
                                    if(!confirm("⚠️ تنبيه إداري:\nسيتم حذف هذه المخالفة نهائياً من ملف الموظف.\n\nسيتم تسجيل تفاصيل المخالفة واسمك في أرشيف الرقابة للإدارة العليا.\n\nهل تريد المتابعة؟")) return;

                                    const complaintRef = db.ref('users/' + username + '/complaints/' + key);

                                    // 3. جلب بيانات الشكوى قبل حذفها لأرشفتها
                                    complaintRef.once('value', (snapshot) => {
                                        const data = snapshot.val();
                                        if (data) {
                                            // تجميع محتوى الشكوى المحذوفة في نص واحد
                                            const deletedDetails = `[محتوى الشكوى المحذوفة]: العنوان: (${data.title}) - الخصم: ${data.amount || 0} - التفاصيل: ${data.details} - التاريخ الأصلي: ${data.date}`;
                                            
                                            // 4. تسجيل العملية في سجل الرقابة (admin_logs)
                                            logDeletionAction("حذف مخالفة من السجل", username, deletedDetails);

                                            // 5. الحذف الفعلي
                                            complaintRef.remove()
                                                .then(() => {
                                                    alert("✅ تم الحذف بنجاح، وتم تسجيل العملية في أرشيف الرقابة.");
                                                    renderComplaintsHistory(username); // تحديث الجدول
                                                })
                                                .catch((error) => {
                                                    alert("حدث خطأ أثناء الحذف: " + error.message);
                                                });
                                        } else {
                                            alert("هذه الشكوى غير موجودة بالفعل.");
                                        }
                                    });
                                }

                                function acknowledgeComplaint(key) {
                                    const username = currentProfileTarget;
                                    db.ref('users/' + username + '/complaints/' + key).update({ acknowledged: true })
                                    .then(() => {
                                        renderComplaintsHistory(username);
                                        checkProfileNotifications(allUsersData[username]);
                                    });
                                }

                                function showZoomImage(src) {
                                    document.getElementById('zoomedImg').src = src;
                                    document.getElementById('imgZoomModal').classList.remove('hidden');
                                }

                                // 5. زر للموظف ليفتح ملفه بنفسه
                                function openMyProfile() {
                                    openUserProfile(currentUser.username);
                                }

                                // فتح نافذة تغيير الباسورد
                                function openPassModal() {
                                    document.getElementById('changePassModal').classList.remove('hidden');
                                }

                                // إغلاق النافذة وتنظيف الحقول
                                function closePassModal() {
                                    document.getElementById('changePassModal').classList.add('hidden');
                                    document.getElementById('oldPassInput').value = '';
                                    document.getElementById('newPassInput').value = '';
                                    document.getElementById('confirmPassInput').value = '';
                                }

                                // تنفيذ تغيير كلمة المرور
                                function submitChangePassword() {
                                    const oldPass = document.getElementById('oldPassInput').value;
                                    const newPass = document.getElementById('newPassInput').value;
                                    const confirmPass = document.getElementById('confirmPassInput').value;

                                    // 1. التحقق من الحقول
                                    if (!oldPass || !newPass || !confirmPass) {
                                        alert("⚠️ يرجى ملء جميع الحقول");
                                        return;
                                    }

                                    // 2. التحقق من كلمة المرور القديمة (الموجودة في بيانات المستخدم الحالي)
                                    if (oldPass !== currentUser.password) {
                                        alert("❌ كلمة المرور الحالية غير صحيحة!");
                                        return;
                                    }

                                    // 3. التأكد من تطابق الكلمة الجديدة
                                    if (newPass !== confirmPass) {
                                        alert("❌ كلمة المرور الجديدة غير متطابقة!");
                                        return;
                                    }

                                    // 4. التأكد من طول كلمة المرور (اختياري)
                                    if (newPass.length < 4) {
                                        alert("⚠️ كلمة المرور ضعيفة جداً، يجب أن تكون 4 أرقام أو حروف على الأقل.");
                                        return;
                                    }

                                    // 5. التحديث في قاعدة البيانات
                                    db.ref('users/' + currentUser.username).update({
                                        password: newPass
                                    }).then(() => {
                                        alert("✅ تم تحديث كلمة المرور بنجاح! سيتم الآن تسجيل خروجك لإعادة الدخول بالبيانات الجديدة.");
                                        logout(); // تسجيل خروج تلقائي للأمان
                                    }).catch((error) => {
                                        alert("حدث خطأ أثناء التحديث: " + error.message);
                                    });
                                }

                                // فتح نافذة إعداد باسورد الملف
                                function openFilePassModal(isFirstTime = false) {
                                    document.getElementById('filePassModal').classList.remove('hidden');
                                    const oldArea = document.getElementById('oldFilePassArea');
                                    const title = document.getElementById('filePassTitle');
                                    
                                    if (isFirstTime || !currentUser.filePassword) {
                                        oldArea.classList.add('hidden');
                                        title.innerText = "🔒 إنشاء قفل للملف";
                                    } else {
                                        oldArea.classList.remove('hidden');
                                        title.innerText = "🔄 تغيير قفل الملف";
                                    }
                                }

                                function closeFilePassModal() {
                                    document.getElementById('filePassModal').classList.add('hidden');
                                    document.getElementById('oldFilePassInput').value = '';
                                    document.getElementById('newFilePassInput').value = '';
                                    document.getElementById('confirmFilePassInput').value = '';
                                }

                                // حفظ الباسورد الجديد للملف في الداتابيز
        function saveFilePassword() {
            const oldPass = document.getElementById('oldFilePassInput').value;
            const newPass = document.getElementById('newFilePassInput').value;
            const confirmPass = document.getElementById('confirmFilePassInput').value;

            // لو عنده باسورد قديم لازم يتأكد منه
            if (currentUser.filePassword && oldPass !== currentUser.filePassword) {
                alert("❌ كلمة سر الملف الحالية غير صحيحة");
                return;
            }

            if (!newPass || newPass.length < 2) {
                alert("⚠️ يرجى إدخال كلمة سر صالحة");
                return;
            }

            if (newPass !== confirmPass) {
                alert("❌ الكلمتان غير متطابقتين");
                return;
            }

            // تحديث حقل filePassword فقط في الداتابيز
            db.ref('users/' + currentUser.username).update({
                filePassword: newPass
            }).then(() => {
                alert("✅ تم تعيين قفل الملف بنجاح! يمكنك الآن فتحه.");
                closeFilePassModal();
            });
        }

        // دوال خدمة العملاء الجديدة
        // معاينة ملف الصوت (سريع جداً)
        function previewCsAudio(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // فحص الحجم (5 ميجا)
                if (file.size > 5 * 1024 * 1024) {
                    alert("ملف الصوت كبير جداً! أخره 5 ميجا.");
                    input.value = "";
                    return;
                }
                // عرض الاسم فقط بدون تحميل الملف في الرامات
                document.getElementById('csAudioName').innerText = "✅ " + file.name;
            }
        }

        // معاينة الصورة (سريع جداً)
        function previewCsImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // فحص الحجم
                if (file.size > 5 * 1024 * 1024) {
                    alert("الصورة كبيرة جداً!");
                    input.value = "";
                    return;
                }

                document.getElementById('csImageName').innerText = "✅ " + file.name;

                // عرض الصورة باستخدام الرابط السحري (URL.createObjectURL)
                const img = document.getElementById('csImagePreview');
                img.src = URL.createObjectURL(file);
                img.style.display = 'block';

                // تنظيف الذاكرة بعد التحميل
                img.onload = () => URL.revokeObjectURL(img.src);
            }
        }

        async function uploadCsCall() {
            const targetUser = document.getElementById('csTargetUser').value; // الموظف المختار
            const title = document.getElementById('csCallTitle').value.trim();
            const note = document.getElementById('csCallNote').value.trim();

            const audioFile = document.getElementById('csAudioInput').files[0];
            const imageFile = document.getElementById('csImageInput').files[0];

            // التحقق من البيانات
            if (!targetUser) return alert("الرجاء اختيار اسم الموظف أولاً! ⚠️");
            if (!title) return alert("الرجاء كتابة رقم العميل أو عنوان للمكالمة");
            if (!audioFile && !imageFile) return alert("يجب إرفاق ملف صوت أو صورة كدليل!");

            // ---[ 1. قفل الزرار وتغيير النص ]---
            // بنحدد الزرار اللي في لوحة الـ CS
            const submitBtn = document.querySelector('#csAgentDashboard button.btn-primary');
            const originalText = submitBtn ? submitBtn.innerText : "حفظ في ملف الموظف";

            if(submitBtn) {
                submitBtn.disabled = true; // قفل الزرار
                submitBtn.style.opacity = "0.6";
                submitBtn.innerHTML = "⏳ جاري رفع الملفات..."; // رسالة الطمأنة
            }

            try {
                // ---[ 2. الرفع السريع (في الخلفية) ]---
                let audioUrl = "";
                let imageUrl = "";

                // استخدام دالة الرفع السريعة اللي عملناها قبل كده
                if (audioFile) audioUrl = await uploadToCloudinary(audioFile);
                if (imageFile) imageUrl = await uploadToCloudinary(imageFile);

                // تغيير النص لمرحلة الحفظ
                if(submitBtn) submitBtn.innerHTML = "💾 جاري حفظ البيانات...";

                const recordData = {
                    date: getServerDateString(),
                    time: getServerTimeString(),
                    title: title,
                    details: note || "تقييم جودة",
                    audioRecord: audioUrl,
                    evidence: imageUrl,
                    type: "Quality Review",
                    uploader: currentUser.realName || currentUser.username,
                    acknowledged: false
                };

                // الإرسال لملف الموظف
                await db.ref('users/' + targetUser + '/complaints').push(recordData);

                alert(`تم حفظ التقييم والسرعة تمام! 🚀`);

                // ---[ 3. تنظيف النموذج ]---
                document.getElementById('csCallTitle').value = "";
                document.getElementById('csCallNote').value = "";
                document.getElementById('csAudioInput').value = "";
                document.getElementById('csImageInput').value = "";
                document.getElementById('csAudioName').innerText = "";
                document.getElementById('csImageName').innerText = "";
                document.getElementById('csImagePreview').style.display = 'none';
                document.getElementById('csImagePreview').src = "";

            } catch (e) {
                console.error(e);
                alert("حدث خطأ أثناء الرفع، تأكد من النت.");
            } finally {
                // ---[ 4. إعادة تشغيل الزرار ]---
                if(submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    submitBtn.style.opacity = "1";
                }
            }
        }

        // 1. دالة ملء قائمة الموظفين (يتم استدعاؤها عند تحديث البيانات)
        // دالة ملء قائمة الموظفين (تم تحسينها لمنع القائمة من الغلق أثناء الاختيار)
        function populateCsEmployeeList() {
            const select = document.getElementById('csTargetUser');
            if (!select) return;

            // هام: لو الموظف فاتح القائمة وبيختار، نوقف التحديث عشان القائمة متقفلش في وشه
            if (document.activeElement === select) return;

            const currentVal = select.value;
            let newHTML = '<option value="">-- اختر الموظف --</option>';
            let hasChanges = false;

            Object.values(allUsersData).forEach(u => {
                // نستبعد المديرين ونعرض الموظفين فقط
                if (u.username && !MANAGERS.includes(u.username)) {
                    newHTML += `<option value="${u.username}">👤 ${u.realName || u.username}</option>`;
                }
            });

            // تحديث القائمة فقط لو المحتوى اتغير (عشان الأداء)
            if (select.innerHTML !== newHTML) {
                select.innerHTML = newHTML;
                if (currentVal) select.value = currentVal;
            }
        }

        async function archiveOldComplaints() {
            if (!confirm("⚠️ هل أنت متأكد؟ سيتم نقل الشكاوى التي مر عليها أكثر من 30 يوم إلى الأرشيف لتسريع الموقع.")) return;

            const archiveRef = db.ref('archive/complaints');
            const usersRef = db.ref('users');
            let count = 0;

            // 1. نجيب كل البيانات
            const snapshot = await usersRef.once('value');
            const users = snapshot.val();

            if (!users) return alert("لا توجد بيانات!");

            // 2. نلف على كل مستخدم
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.complaints) {
                    for (const [compKey, compData] of Object.entries(userData.complaints)) {

                        // تحليل التاريخ (DD/MM/YYYY)
                        const parts = compData.date.split('/');
                        const compDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                        const diffTime = Math.abs(new Date() - compDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        // لو الشكوى عدى عليها 30 يوم
                        if (diffDays > 30) {
                            // انسخها للأرشيف
                            await archiveRef.child(userId).child(compKey).set(compData);
                            // امسحها من الملف النشط
                            await usersRef.child(userId + '/complaints/' + compKey).remove();
                            count++;
                        }
                    }
                }
            }

            alert(`تمت أرشفة ${count} شكوى قديمة بنجاح! 🚀\nالموقع الآن سيكون أسرع.`);
            triggerGlobalRefresh();
        }

        function exportMonthlyExcel() {
            const startDateVal = document.getElementById('filterStartDate').value;
            const endDateVal = document.getElementById('filterEndDate').value;

            if (!startDateVal || !endDateVal) {
                return alert("يرجى تحديد تاريخ البداية والنهاية لاستخراج التقرير 📅");
            }

            let reportData = [];

            Object.values(allUsersData).forEach(u => {
                if (!u.username || MANAGERS.includes(u.username)) return;

                let totalBreakTime = 0;
                let totalPrayerTime = 0;
                let totalMeetingTime = 0;
                let totalVIPTime = 0;
                let totalOvertimeHours = 0;
                let totalPermHours = 0; // متغيير الاستأذان الجديد
                let totalDeductions = 0;
                let totalOxidation = 0;

                // حساب السجلات (أكسدة، صلاة، ميتنج، VIP)
                if (u.sessions) {
                    Object.values(u.sessions).forEach(s => {
                        const parts = s.date.split('/');
                        if (parts.length !== 3) return; // Skip invalid dates
                        const sessionDate = `${parts[2]}-${parts[1]}-${parts[0]}`;

                        if (sessionDate >= startDateVal && sessionDate <= endDateVal) {
                            const dur = parseInt(s.duration) || 0;
                            if (s.type === 'بريك عام' || s.type === 'طوارئ') totalBreakTime += dur;
                            else if (s.type === 'صلاة') totalPrayerTime += dur;
                            else if (s.type === 'ميتنج') totalMeetingTime += dur;
                            else if (s.type === 'استراحة VIP') totalVIPTime += dur;
                        }
                    });
                }

                // حساب الإضافي من سجل overtimeHistory
                if (u.overtimeHistory) {
                    Object.values(u.overtimeHistory).forEach(ot => {
                        const parts = ot.date.split('/');
                        const otDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        if (otDate >= startDateVal && otDate <= endDateVal) {
                            totalOvertimeHours += parseFloat(ot.hours) || 0;
                        }
                    });
                }


                if (u.sessions) {
                    let dailyBreaks = {};
                    Object.values(u.sessions).forEach(s => {
                        const parts = s.date.split('/');
                        const sDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        if (sDate >= startDateVal && sDate <= endDateVal) {
                            if (s.type === 'بريك عام' || s.type === 'طوارئ') {
                                dailyBreaks[s.date] = (dailyBreaks[s.date] || 0) + (parseInt(s.duration) || 0);
                            }
                        }
                    });
                    Object.values(dailyBreaks).forEach(dailyTotal => {
                        const allow = (u.allowance || 45) * 60;
                        if (dailyTotal > allow) totalOxidation += (dailyTotal - allow);
                    });
                }

                if (u.complaints) {
                    Object.values(u.complaints).forEach(c => {
                        const parts = c.date.split('/');
                        const compDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        if (compDate >= startDateVal && compDate <= endDateVal) {
                            complaintsCount++;
                            totalDeductions += parseFloat(c.amount) || 0;
                        }
                    });
                }

                reportData.push({
                    "اسم الموظف": u.realName || u.username,
                    "الأكسدة (د)": Math.round(totalOxidation / 60),
                    "الإضافي (س)": totalOvertimeHours,
                    "الاستأذان (س)": totalPermHours, // إضافة العمود الجديد
                    "الخصم (ج.م)": totalDeductions,
                    "الصلاة (د)": Math.round(totalPrayerTime / 60),
                    "الميتنج (د)": Math.round(totalMeetingTime / 60),
                    "VIP (د)": Math.round(totalVIPTime / 60)
                });
            });

            const worksheet = XLSX.utils.json_to_sheet(reportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "تقرير شهري");
            XLSX.writeFile(workbook, `Report_${startDateVal}_to_${endDateVal}.xlsx`);
        }

        function autoConvertPrayerToBreak() {
            // حماية عشان الدالة متتكررش ألف مرة في الثانية
            if (window.isConvertingPrayer) return;
            window.isConvertingPrayer = true;

            const u = currentUser;
            const prayerLimitSeconds = 900; // 15 دقيقة
            
            // تشغيل صوت تنبيه عشان يعرف إن الوقت خلص
            const sound = document.getElementById('notifySound');
            if(sound) sound.play().catch(e => {});

            // 1. حفظ جلسة الصلاة في السجل (عشان تتحسب له إنه صلى)
            db.ref('users/' + u.username + '/sessions').push({
                date: getServerDateString(),
                type: 'صلاة',
                reason: 'انتهاء وقت الصلاة (15د)',
                duration: prayerLimitSeconds
            });

            // 2. تحديث حالة الموظف:
            // - زيادة عداد مرات الصلاة 1
            // - تحويل الحالة لـ "بريك عام"
            // - تصفير وقت البداية عشان يبدأ يعد بريك من الصفر
            const updates = {
                prayerCountToday: (u.prayerCountToday || 0) + 1, // كده حسبنا عليه المرة دي
                prayerSeconds: (u.prayerSeconds || 0) + prayerLimitSeconds, // ضيفنا الوقت لإجمالي صلواته
                breakType: 'بريك عام', // حولناه بريك
                lastStartTime: getServerTime(), // تصفير العداد للبريك الجديد
                lastReason: 'أكسدة تلقائية بعد الصلاة 🕌'
            };

            db.ref('users/' + u.username).update(updates).then(() => {
                window.isConvertingPrayer = false;
                alert("انتهى وقت الصلاة (15 دقيقة) 🛑\nتم تحويلك الآن لنظام (البريك العام) تلقائياً.");
            });
        }

        /* ==========================================
        نظام مواقيت الصلاة والعد التنازلي
        ========================================== */

        let prayerTimesData = null;
        let prayerInterval = null;

        // دالة لجلب مواقيت الصلاة من API (القاهرة)
        async function fetchPrayerTimes() {
            try {
                const date = new Date();
                // إحداثيات القاهرة (يمكنك تغييرها) - طريقة الحساب 5 (الهيئة المصرية)
                const url = `https://api.aladhan.com/v1/timings/${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}?latitude=30.0444&longitude=31.2357&method=5`;

                const response = await fetch(url);
                const data = await response.json();

                if (data && data.data && data.data.timings) {
                    prayerTimesData = data.data.timings;
                    renderPrayerList();
                    startPrayerCountdown();
                }
            } catch (error) {
                console.error("فشل جلب مواقيت الصلاة:", error);
                document.getElementById('nextPrayerName').innerText = "خطأ في الاتصال";
            }
        }

        function renderPrayerList() {
            if (!prayerTimesData) return;

            // أسماء الصلوات التي نريد عرضها
            const pNames = {
                Fajr: "الفجر",
                Dhuhr: "الظهر",
                Asr: "العصر",
                Maghrib: "المغرب",
                Isha: "العشاء"
            };

            const list = document.getElementById('prayerList');
            list.innerHTML = "";

            for (const [key, arName] of Object.entries(pNames)) {
                const time24 = prayerTimesData[key];
                // تحويل لـ 12 ساعة
                const timeParts = time24.split(':');
                let hours = parseInt(timeParts[0]);
                const minutes = timeParts[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;

                list.innerHTML += `
                    <li class="prayer-item" id="prayer-row-${key}">
                        <span>${arName}</span>
                        <span>${hours}:${minutes} <small>${ampm}</small></span>
                    </li>
                `;
            }
        }

        function startPrayerCountdown() {
            if (prayerInterval) clearInterval(prayerInterval);

            prayerInterval = setInterval(() => {
                if (!prayerTimesData) return;

                const now = new Date();
                const pNames = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                const arNames = ['الفجر', 'الظهر', 'العصر', 'المغرب', 'العشاء'];

                let nextPrayerIndex = -1;
                let diffMs = 0;

                // البحث عن الصلاة القادمة
                for (let i = 0; i < pNames.length; i++) {
                    const timeStr = prayerTimesData[pNames[i]];
                    const [h, m] = timeStr.split(':');
                    const pDate = new Date();
                    pDate.setHours(h, m, 0, 0);

                    if (pDate > now) {
                        nextPrayerIndex = i;
                        diffMs = pDate - now;
                        break;
                    }
                }

                // لو خلصنا صلوات اليوم، يبقى القادمة هي الفجر بكرة
                if (nextPrayerIndex === -1) {
                    nextPrayerIndex = 0; // الفجر
                    const timeStr = prayerTimesData['Fajr'];
                    const [h, m] = timeStr.split(':');
                    const pDate = new Date();
                    pDate.setDate(pDate.getDate() + 1); // بكرة
                    pDate.setHours(h, m, 0, 0);
                    diffMs = pDate - now;
                }

                // تحديث الواجهة
                const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);

                document.getElementById('nextPrayerCount').innerText =
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                document.getElementById('nextPrayerName').innerText = `المتبقي على ${arNames[nextPrayerIndex]}`;

                // تلوين الصلاة القادمة
                document.querySelectorAll('.prayer-item').forEach(item => {
                    item.classList.remove('current-prayer', 'next-prayer-highlight');
                });
                const nextLi = document.getElementById(`prayer-row-${pNames[nextPrayerIndex]}`);
                nextLi.classList.add('next-prayer-highlight');
            }, 1000);
        }

        function togglePrayerWidget() {
            const widget = document.getElementById('prayerWidget');
            const btn = document.querySelector('.prayer-toggle-btn');
            widget.classList.toggle('active');
            btn.classList.toggle('active');
        }

        window.addEventListener('load', fetchPrayerTimes);

    // دالة لفتح الأرشيف وجلب البيانات
    function openSecretArchive() {
        // حماية إضافية: لو مش محمود اطرده
        if (currentUser.username !== 'mahmoud') {
            alert("⛔ غير مصرح لك بدخول المنطقة المحرمة!");
            return;
        }

        document.getElementById('archiveModal').classList.remove('hidden');
        const tbody = document.getElementById('archiveBody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">جاري تحميل السجلات... ⏳</td></tr>';

        // جلب آخر 100 عملية حذف
        db.ref('admin_logs').limitToLast(100).once('value', snapshot => {
            const data = snapshot.val();

            if (!data) {
                cachedArchiveData = [];
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">السجل نظيف ✅</td></tr>';
                updateArchiveCountBadge();
                return;
            }

            // التعديل هنا: استخدام Object.entries عشان نحتفظ بالمفتاح (key)
            cachedArchiveData = Object.entries(data).map(([key, val]) => {
                return { ...val, id: key }; // دمجنا المفتاح جوه البيانات
            }).sort((a, b) => b.timestamp - a.timestamp);

            // عرض البيانات
            filterArchiveTable();
        });
    }

    // دالة فلترة جدول الأرشيف
    function filterArchiveTable() {
        const tbody = document.getElementById('archiveBody');
        const searchTerm = document.getElementById('archiveSearchInput').value.toLowerCase();
        const dateFrom = document.getElementById('archiveDateFrom').value;
        const dateTo = document.getElementById('archiveDateTo').value;

        tbody.innerHTML = '';

        if (cachedArchiveData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">السجل نظيف ✅</td></tr>';
            updateArchiveCountBadge();
            return;
        }

        let filteredData = cachedArchiveData;

        // فلترة بالبحث
        if (searchTerm) {
            filteredData = filteredData.filter(log =>
                log.adminName.toLowerCase().includes(searchTerm) ||
                log.target.toLowerCase().includes(searchTerm) ||
                log.action.toLowerCase().includes(searchTerm) ||
                log.details.toLowerCase().includes(searchTerm)
            );
        }

        // فلترة بالتاريخ
        if (dateFrom || dateTo) {
            filteredData = filteredData.filter(log => {
                const logDate = log.dateStr.split(' ')[0]; // استخراج التاريخ فقط (DD/MM/YYYY)
                const logDateISO = logDate.split('/').reverse().join('-'); // تحويل لـ YYYY-MM-DD

                if (dateFrom && logDateISO < dateFrom) return false;
                if (dateTo && logDateISO > dateTo) return false;
                return true;
            });
        }

        // عرض النتائج
        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">لا توجد نتائج للبحث 🔍</td></tr>';
        } else {
            filteredData.forEach(log => {
                tbody.innerHTML += `
                    <tr style="background:rgba(255,255,255,0.02); border-bottom:1px solid rgba(255,215,0,0.1);">
                        <td style="color:gold; font-weight:bold;">${log.adminName}</td>
                        <td style="color:#ef4444;">${log.action}</td>
                        <td>${log.target}</td>
                        <td style="font-size:0.9rem; color:#aaa;">${log.details}</td>
                        <td style="direction:ltr;">${log.dateStr}</td>
                        <td style="text-align:center;">
                            <button onclick="deleteArchiveLog('${log.id}')" class="btn btn-danger btn-sm" title="حذف السجل نهائياً">🗑</button>
                        </td>
                    </tr>
                `;
            });
        }

        updateArchiveCountBadge(filteredData.length);
    }

    // دالة إعادة تعيين الفلاتر
    function resetArchiveFilters() {
        document.getElementById('archiveSearchInput').value = '';
        document.getElementById('archiveDateFrom').value = '';
        document.getElementById('archiveDateTo').value = '';
        filterArchiveTable();
    }

    // دالة تحديث عداد النتائج
    function updateArchiveCountBadge(count) {
        const badge = document.getElementById('archiveCountBadge');
        if (count === undefined) count = cachedArchiveData.length;
        badge.innerHTML = `عدد السجلات: ${count}`;
    }

    // دالة حذف سجل واحد من الأرشيف
    function deleteArchiveLog(logId) {
        if (!confirm("⚠️ هل أنت متأكد من حذف هذا السجل نهائياً؟\n\nلا يمكن التراجع عن هذا الإجراء.")) return;

        db.ref('admin_logs/' + logId).remove()
            .then(() => {
                alert("✅ تم حذف السجل بنجاح.");
                // إعادة تحميل البيانات
                openSecretArchive();
            })
            .catch((error) => {
                alert("حدث خطأ: " + error.message);
            });
    }

    // دالة مسح جميع سجلات الأرشيف
    function clearAllArchiveLogs() {
        if (!confirm("🚨 تحذير خطير!\n\nسيتم مسح جميع سجلات الأرشيف نهائياً.\n\nهذا الإجراء لا يمكن التراجع عنه ويؤثر على الرقابة الإدارية.\n\nهل تريد المتابعة؟")) return;

        if (!confirm("تأكيد نهائي: هل أنت متأكد تماماً؟")) return;

        db.ref('admin_logs').remove()
            .then(() => {
                alert("✅ تم مسح جميع سجلات الأرشيف.");
                // إعادة تحميل البيانات
                openSecretArchive();
            })
            .catch((error) => {
                alert("حدث خطأ: " + error.message);
            });
    }

    // تعديل دالة showAdmin عشان تظهر الزرار لمحمود بس
    // (مهم: ابحث عن دالة showAdmin الموجودة عندك وضف السطر ده جواها)
                                function showAdmin() {
                                    // إظهار وإخفاء الأقسام الرئيسية
                                    const loginSec = document.getElementById('loginSection');
                                    const adminSec = document.getElementById('adminSection');

                                    if (loginSec) loginSec.classList.add('hidden');
                                    if (adminSec) adminSec.classList.remove('hidden');

                                    const managerNameEl = document.getElementById('currentManagerDisplay');
                                    const realName = currentUser.realName || currentUser.username;

                                    if (managerNameEl) {
                                        if (currentUser.username === 'mahmoud') {
                                            managerNameEl.innerHTML = `
                                                <span class="boss-crown">👑</span>
                                                <span class="the-boss-name">${realName} (CEO)</span>
                                            `;
                                            // إظهار أزرار محمود لو موجودة
                                            const archBtn = document.getElementById('secretArchiveBtn');
                                            const resetBtn = document.getElementById('secretResetBtn');
                                            if (archBtn) archBtn.classList.remove('hidden');
                                            if (resetBtn) resetBtn.classList.remove('hidden');
                                        } else {
                                            let title = (currentUser.username === 'ahmed') ? "المشرف العام" : "المشرف";
                                            managerNameEl.innerText = `${title}: ${realName}`;

                                            // إخفاء أزرار محمود
                                            const archBtn = document.getElementById('secretArchiveBtn');
                                            const resetBtn = document.getElementById('secretResetBtn');
                                            if (archBtn) archBtn.classList.add('hidden');
                                            if (resetBtn) resetBtn.classList.add('hidden');
                                        }
                                    }

                                    switchAdminTab('monitor');
                                    startGlobalTimer();
                                }

                                function updateQueueSelect() {
                                    const sel = document.getElementById('queueUserSelect');
                                    if (!sel) return;

                                    // تصفير القائمة قبل وضع الأسماء
                                    let h = '<option value="">-- اختر الموظف لإضافته للدور --</option>';

                                    // تحويل الكائن إلى مصفوفة للفحص
                                    const usersArray = Object.values(allUsersData);

                                    console.log("عدد الموظفين الموجودين:", usersArray.length); // للتأكد من وجود بيانات

                                    usersArray.forEach(u => {
                                        // الشروط: أن يكون له اسم مستخدم + ليس مديراً + ليس موجوداً بالفعل في الطابور
                                        if (u.username && !MANAGERS.includes(u.username) && !currentQueue.includes(u.username)) {
                                            h += `<option value="${u.username}">${u.realName || u.username}</option>`;
                                        }
                                    });

                                    sel.innerHTML = h;
                                }

                                if (currentUser && currentUser.role === 'admin') {
                                    updateQueueSelect(); // تحديث قائمة الأسماء في الطابور
                                    renderQueueUI();     // رسم الطابور إذا كان هناك أسماء
                                }

                                function autoCreateAdmins() {
                                    const admins = {
                                        'mahmoud': { realName: 'محمود', password: '112233' },
                                        'abutamim': { realName: 'أبو تميم', password: '445566' },
                                        'ahmed': { realName: 'أحمد يحيى', password: '778899' }
                                    };

                                    Object.keys(admins).forEach(user => {
                                        db.ref('users/' + user).update({
                                            username: user,
                                            realName: admins[user].realName,
                                                password: admins[user].password,
                                            role: 'admin'
                                        });
                                    });
                                }

                                async function runSmartArchiving() {
        // التحقق من الصلاحية (للمدير العام فقط)
        if (!['mahmoud', 'ahmed'].includes(currentUser.username)) {
            return alert("⛔ هذه العملية حساسة ومتاحة للإدارة العليا فقط.");
        }

        if (!confirm("⚠️ تنبيه هام:\nسيتم نقل سجلات الحضور والشكاوى الأقدم من 60 يوماً إلى الأرشيف.\n\nهل تريد المتابعة لتسريع الموقع؟")) return;

        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:99999; font-size:1.5rem;";
        loadingDiv.innerHTML = "<div>⏳ جاري أرشفة البيانات القديمة...<br><small id='archProgress'>يرجى عدم إغلاق الصفحة</small></div>";
        document.body.appendChild(loadingDiv);

        try {
            const usersRef = db.ref('users');
            const archiveRef = db.ref('archive');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val();

            if (!users) throw new Error("لا توجد بيانات!");

            let sessionsCount = 0;
            let complaintsCount = 0;
            const updates = {}; // لتجميع كل التعديلات وإرسالها مرة واحدة (Atomic Update)
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 60); // تحديد تاريخ قبل 60 يوم

            for (const [userId, userData] of Object.entries(users)) {
                // 1. أرشفة سجلات الحضور (Sessions)
                if (userData.sessions) {
                    for (const [key, session] of Object.entries(userData.sessions)) {
                        const parts = session.date.split('/'); // Assuming DD/MM/YYYY
                        const sessionDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);

                        if (sessionDate < cutoffDate) {
                            // تحديد مسار الأرشيف: archive/sessions/YYYY/UserId/SessionKey
                            const year = parts[2];
                            const archivePath = `archive/sessions/${year}/${userId}/${key}`;
                            const userPath = `users/${userId}/sessions/${key}`;

                            updates[archivePath] = session; // نسخ للأرشيف
                            updates[userPath] = null;       // حذف من الملف النشط
                            sessionsCount++;
                        }
                    }
                }

                // 2. أرشفة الشكاوى (Complaints)
                if (userData.complaints) {
                    for (const [key, complaint] of Object.entries(userData.complaints)) {
                        const parts = complaint.date.split('/');
                        const compDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);

                        if (compDate < cutoffDate) {
                            const year = parts[2];
                            const archivePath = `archive/complaints/${year}/${userId}/${key}`;
                            const userPath = `users/${userId}/complaints/${key}`;

                            updates[archivePath] = complaint;
                            updates[userPath] = null;
                            complaintsCount++;
                        }
                    }
                }
            }

            if (Object.keys(updates).length > 0) {
                await db.ref().update(updates);
                alert(`✅ تمت العملية بنجاح!\n\n📦 تم أرشفة:\n- ${sessionsCount} سجل حضور\n- ${complaintsCount} شكوى قديمة\n\nالموقع الآن أخف وأسرع! 🚀`);
            } else {
                alert("✨ قاعدة البيانات نظيفة، لا توجد سجلات قديمة جداً للأرشفة.");
            }

        } catch (error) {
            console.error(error);
            alert("حدث خطأ أثناء الأرشفة: " + error.message);
        } finally {
            document.body.removeChild(loadingDiv);
            triggerGlobalRefresh();
        }
    }
    async function exportProfessionalExcel() {
        const startDateVal = document.getElementById('filterStartDate').value;
        const endDateVal = document.getElementById('filterEndDate').value;

        if (!startDateVal || !endDateVal) return alert("📅 حدد التاريخ الأول يا مدير!");

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('تقرير الأداء الشامل', {
            views: [{ rightToLeft: true }] // اتجاه من اليمين للشمال
        });

        // 1. حساب البيانات (نفس المنطق بتاعك)
        let rows = [];
        let totals = { days: 0, ox: 0, ot: 0, perm: 0, cash: 0, count: 0 };

        Object.values(allUsersData).forEach(u => {
            if (!u.username || MANAGERS.includes(u.username)) return;

            let uS = { name: u.realName || u.username, days: new Set(), ox: 0, prayer: 0, meet: 0, vip: 0, ot: 0, perm: 0, comp: 0, cash: 0 };

            let clockInTime = "--:--";
            let clockOutTime = "--:--";

            // جلب وقت الحضور والانصراف من تاريخ البداية المختار (أو أول يوم في الفلتر)
            if (u.attendance) {
                // نبحث عن حضور الموظف في تواريخ الفلتر (سنأخذ متوسط أو عرض أول يوم متاح)
                const attendanceDates = Object.keys(u.attendance);
                const targetDate = startDateVal.split('-').reverse().join('-'); // تحويل YYYY-MM-DD لـ DD-MM-YYYY
                
                // نأخذ بيانات الحضور لليوم المختار في التقرير
                const dayData = u.attendance[startDateVal] || u.attendance[Object.keys(u.attendance)[0]]; 
                if(dayData) {
                    clockInTime = dayData.clockIn || "--:--";
                    clockOutTime = dayData.clockOut || dayData.lastSeen || "--:--";
                }
            }

            // إضافة وقت الحضور والانصراف لصفوف الإكسيل
            rows.push([uS.name, uS.days.size, clockInTime, clockOutTime, Math.round(uS.ox/60), Math.round(uS.prayer/60), Math.round(uS.meet/60), Math.round(uS.vip/60), uS.ot, uS.perm, uS.comp, uS.cash]);

            if (u.sessions) {
                let daily = {};
                Object.values(u.sessions).forEach(s => {
                    const sD = s.date.split('/').reverse().join('-');
                    if (sD >= startDateVal && sD <= endDateVal) {
                        uS.days.add(s.date);
                        const dur = parseInt(s.duration) || 0;
                        if (s.type === 'بريك عام' || s.type === 'طوارئ') daily[s.date] = (daily[s.date] || 0) + dur;
                        else if (s.type === 'صلاة') uS.prayer += dur;
                        else if (s.type === 'ميتنج') uS.meet += dur;
                        else if (s.type === 'استراحة VIP') uS.vip += dur;
                    }
                });
                const allow = (u.allowance || 45) * 60;
                Object.values(daily).forEach(v => { if(v > allow) uS.ox += (v - allow); });
            }

            if (u.overtimeHistory) {
                Object.values(u.overtimeHistory).forEach(ot => {
                    const otD = ot.date.split('/').reverse().join('-');
                    if (otD >= startDateVal && otD <= endDateVal) uS.ot += parseFloat(ot.hours) || 0;
                });
            }

            if (u.permHistory) {
                Object.values(u.permHistory).forEach(p => {
                    const pD = p.date.split('/').reverse().join('-');
                    if (pD >= startDateVal && pD <= endDateVal) uS.perm += parseFloat(p.hours) || 0;
                });
            }

            if (u.complaints) {
                Object.values(u.complaints).forEach(c => {
                    const cD = c.date.split('/').reverse().join('-');
                    if (cD >= startDateVal && cD <= endDateVal) { uS.comp++; uS.cash += parseFloat(c.amount) || 0; }
                });
            }

            totals.days += uS.days.size;
            totals.ox += Math.round(uS.ox/60);
            totals.ot += uS.ot;
            totals.perm += uS.perm;
            totals.cash += uS.cash;
            totals.count++;

            rows.push([uS.name, uS.days.size, clockInTime, clockOutTime, Math.round(uS.ox/60), Math.round(uS.prayer/60), Math.round(uS.meet/60), Math.round(uS.vip/60), uS.ot, uS.perm, uS.comp, uS.cash]);
        });

        // --- تنسيق الصفحة ---

        // الصف الأول: العنوان الكبير
        worksheet.mergeCells('A1:L1');
        const titleCell = worksheet.getCell('A1');
        titleCell.value = 'نظام ELSHAMAA لإدارة الموارد البشرية - التقرير التحليلي';
        titleCell.font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0F172A' } };
        titleCell.alignment = { vertical: 'middle', horizontal: 'center' };

        // الصف الثاني: التواريخ (مثل الصورة)
        worksheet.mergeCells('A2:L2');
        const dateRangeCell = worksheet.getCell('A2');
        dateRangeCell.value = `الفترة من ${startDateVal} إلى ${endDateVal} | تاريخ الاستخراج: ${getServerDateString()}`;
        dateRangeCell.font = { bold: true };
        dateRangeCell.alignment = { horizontal: 'center' };
        dateRangeCell.border = { bottom: { style: 'double', color: { argb: 'FF000000' } } };

        worksheet.addRow([]); // صف فارغ للفصل

        // --- الجدول العلوي (اللون الأصفر - ملخص الإدارة) ---
        // دمج الخلايا للبدء من المنتصف قليلاً مثل الصورة
        const summaryHeader = ["إجمالي الأيام", "إجمالي الأكسدة (د)", "إجمالي الإضافي (س)", "إجمالي الخصم (ج.م)", "عدد الموظفين"];
        const summaryRow = worksheet.addRow(["", "", "", "", ...summaryHeader]);

        // تنسيق عناوين الملخص (الأصفر)
        for (let i = 5; i <= 10; i++) {
            const cell = summaryRow.getCell(i);
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFD700' } }; // اللون الذهبي/الأصفر
            cell.font = { bold: true };
            cell.alignment = { horizontal: 'center' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        }

        const summaryData = worksheet.addRow(["", "", "", "", totals.days, totals.ox, totals.ot, totals.cash, totals.count]);
        for (let i = 5; i <= 10; i++) {
            const cell = summaryData.getCell(i);
            cell.alignment = { horizontal: 'center' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        }

        worksheet.addRow([]); // صف فارغ

        // --- الجدول الرئيسي (اللون الأزرق - بيانات الموظفين) ---
        const mainHeader = ["اسم الموظف", "أيام الحضور", "وقت الحضور", "وقت الانصراف", "الأكسدة (د)", "الصلاة (د)", "الميتنج (د)", "VIP (د)", "إضافي (س)", "استأذان (س)", "المخالفات", "الخصم (ج.م)"];
        const headerRow = worksheet.addRow(mainHeader);

        headerRow.eachCell((cell) => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } }; // اللون الأزرق
            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true }; // نص أبيض عريض
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        // إضافة بيانات الموظفين
        rows.forEach((rowData, index) => {
            const row = worksheet.addRow(rowData);
            row.eachCell((cell) => {
                cell.alignment = { horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };

                // تلوين الصفوف بالتناوب (اختياري لسهولة القراءة)
                if (index % 2 !== 0) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8FAFC' } };
                }
            });

            // تنبيه بالأحمر لو الأكسدة عالية (أكثر من 60 دقيقة)
            if (rowData[2] > 60) {
                row.getCell(3).font = { color: { argb: 'FFFF0000' }, bold: true };
            }
        });

        // ضبط عرض الأعمدة تلقائياً
        worksheet.getColumn(1).width = 25; // اسم الموظف عريض
        for (let i = 2; i <= 10; i++) {
            worksheet.getColumn(i).width = 15;
        }

        // تصدير الملف
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ELSHAMAA_Report_${startDateVal}.xlsx`);
    }

    let currentSelectedDay = null;
    let tempWeeklyOrder = [];

    // أيام الأسبوع بالترتيب
    const daysAr = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس"];

    // 1. اختيار اليوم من لوحة المشرف
    function selectWeeklyDay(dayIndex) {
        currentSelectedDay = dayIndex;
        document.querySelectorAll('.day-btn').forEach(b => b.classList.replace('btn-primary', 'btn-dark'));
        document.getElementById('day-' + dayIndex).classList.replace('btn-dark', 'btn-primary');
        document.getElementById('selectedDayLabel').innerText = "تعديل ترتيب يوم: " + daysAr[dayIndex];
        
        // جلب البيانات المخزنة لهذا اليوم
        db.ref('settings/weeklySchedule/' + dayIndex).once('value', (snap) => {
            tempWeeklyOrder = snap.val() || [];
            renderWeeklyConfigOrder();
        });
        
        // تحديث قائمة الموظفين في السيلكت
        populateWeeklyUserSelect();
    }

    function populateWeeklyUserSelect() {
        const sel = document.getElementById('weeklyUserSelect');
        sel.innerHTML = '<option value="">-- اختر الموظف --</option>';
        Object.values(allUsersData).forEach(u => {
            if(u.username && !MANAGERS.includes(u.username)) {
                sel.innerHTML += `<option value="${u.username}">${u.realName || u.username}</option>`;
            }
        });
    }

    function addUserToWeeklyDay() {
        const un = document.getElementById('weeklyUserSelect').value;
        if(!un || currentSelectedDay === null) return;
        if(tempWeeklyOrder.includes(un)) return alert("الموظف مضاف بالفعل لهذا اليوم");
        tempWeeklyOrder.push(un);
        renderWeeklyConfigOrder();
    }

    function renderWeeklyConfigOrder() {
        const container = document.getElementById('weeklyDayOrderDisplay');
        container.innerHTML = '';
        tempWeeklyOrder.forEach((un, index) => {
            const u = allUsersData[un];
            container.innerHTML += `
                <div style="display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:8px 15px; border-radius:10px; align-items:center;">
                    <span>#${index+1} - ${u ? (u.realName || un) : un}</span>
                    <button onclick="removeUserFromWeekly(${index})" style="background:none; border:none; color:red; cursor:pointer;">✖</button>
                </div>
            `;
        });
    }

    function removeUserFromWeekly(index) {
        tempWeeklyOrder.splice(index, 1);
        renderWeeklyConfigOrder();
    }

    function saveWeeklySchedule() {
        if(currentSelectedDay === null) return;
        db.ref('settings/weeklySchedule/' + currentSelectedDay).set(tempWeeklyOrder).then(() => {
            alert("تم حفظ جدول يوم " + daysAr[currentSelectedDay] + " بنجاح ✅");
            // إذا كان اليوم المحفوظ هو "اليوم الحالي"، قم بتحديث طابور الصلاة فوراً
            checkAndApplyTodaySchedule();
        });
    }

    // 2. دالة عرض الجدول للموظف
    function renderEmployeeWeeklyView() {
        const container = document.getElementById('employeeWeeklyLog');
        if(!container) return;

        db.ref('settings/weeklySchedule').on('value', (snap) => {
            const schedule = snap.val() || {};
            container.innerHTML = '';

            const todayIndex = getCustomDayIndex(); // الحصول على رقم اليوم (0 سبت إلى 5 خميس)

            daysAr.forEach((dayName, index) => {
                const dayOrder = schedule[index] || [];
                const myPos = dayOrder.indexOf(currentUser.username);
                const isToday = (index === todayIndex);

                container.innerHTML += `
                    <div style="background:${isToday ? 'rgba(6, 182, 212, 0.2)' : 'rgba(255,255,255,0.03)'};
                                border:1px solid ${isToday ? 'var(--accent)' : 'var(--glass-border)'};
                                padding:10px; border-radius:15px; text-align:center;">
                        <div style="font-size:0.7rem; color:${isToday ? 'var(--accent)' : '#aaa'}">${dayName} ${isToday ? '(اليوم)' : ''}</div>
                        <div style="font-weight:bold; font-size:1.1rem; margin:5px 0;">
                            ${myPos !== -1 ? '#' + (myPos + 1) : '---'}
                        </div>
                        <div style="font-size:0.6rem; opacity:0.7">${myPos !== -1 ? 'دورك في الصلاة' : 'غير مدرج'}</div>
                    </div>
                `;
            });
        });
    }

    // دالة للحصول على اليوم الحالي بنظام (السبت=0)
    function getCustomDayIndex() {
        const d = new Date().getDay(); // 0=أحد, 1=اثنين ... 6=سبت
        const mapping = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5}; // تحويل ليناسب جدولنا
        return mapping[d] !== undefined ? mapping[d] : -1;
    }

    // 3. دالة تطبيق جدول اليوم تلقائياً على "طابور الصلاة"
    function checkAndApplyTodaySchedule() {
        const todayIndex = getCustomDayIndex();
        if(todayIndex === -1) return; // يوم جمعة مثلاً

        db.ref('settings/weeklySchedule/' + todayIndex).once('value', (snap) => {
            const todayOrder = snap.val();
            if(todayOrder && todayOrder.length > 0) {
                // تحديث طابور الصلاة الحالي (settings/prayerQueue) بجدول اليوم
                db.ref('settings/prayerQueue').set(todayOrder);
            }
        });
    }

    // استدعاء الدوال عند تحميل الصفحة
    if(currentUser) {
        if(currentUser.role === 'admin') {
            renderAdminWeeklyLog(); // عرض سجل الجدول الأسبوعي للمشرف
        } else {
            renderEmployeeWeeklyView();
        }
    }

    // دالة عرض سجل الجدول الأسبوعي للمشرف
    function renderAdminWeeklyLog() {
        const tbody = document.getElementById('adminWeeklyLogBody');
        if(!tbody) return;

        db.ref('settings/weeklySchedule').on('value', (snap) => {
            const schedule = snap.val() || {};
            tbody.innerHTML = '';

            daysAr.forEach((dayName, index) => {
                const dayOrder = schedule[index] || [];
                const orderText = dayOrder.length > 0
                    ? dayOrder.map((username, pos) => {
                        const u = allUsersData[username];
                        return `${pos + 1}. ${u ? (u.realName || username) : username}`;
                    }).join(' → ')
                    : 'لم يتم تحديد ترتيب بعد';

                tbody.innerHTML += `
                    <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 15px; font-weight: bold; color: var(--accent);">${dayName}</td>
                        <td style="padding: 15px; color: white; direction: rtl;">${orderText}</td>
                    </tr>
                `;
            });
        });
    }

    // استدعيها مرة واحدة فقط أو اتركها لضمان عدم ضياع الحسابات
                                autoCreateAdmins();

    // دالة لجلب الأسماء الحقيقية بدلاً من اليوزر نيم
    function getRealName(username) {
        const user = allUsersData[username];
        return user ? (user.realName || username) : username;
    }

function updateWeeklyLogDisplays() {
    const days = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس"];

    function getCustomDayIndex() {
        const d = new Date().getDay();
        const mapping = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5};
        return mapping[d] !== undefined ? mapping[d] : -1;
    }

    const todayIdx = getCustomDayIndex();

    db.ref('settings/weeklySchedule').on('value', (snap) => {
        const schedule = snap.val() || {};
        // استهداف الحاوية الجديدة داخل الـ Modal
        const modalLog = document.getElementById('weeklyModalContent');

        if (!modalLog) return;
        modalLog.innerHTML = '';

        days.forEach((dayName, idx) => {
            const members = schedule[idx] || [];
            const isToday = (idx === todayIdx);

            const namesList = members.map((un, i) => {
                const u = allUsersData[un];
                const name = u ? (u.realName || un) : un;
                const isMe = (currentUser && un === currentUser.username);

                return `<span style="
                    color: ${isMe ? '#ffd700' : '#fff'};
                    font-weight: ${isMe ? '900' : 'normal'};
                    background: ${isMe ? 'rgba(255, 215, 0, 0.1)' : 'transparent'};
                    padding: 4px 10px;
                    border-radius: 8px;
                    border: ${isMe ? '1px solid #ffd700' : 'none'};
                    display: inline-block;
                    margin: 2px;
                ">${i + 1}. ${name}</span>`;
            }).join(' <span style="color:#334155">|</span> ');

            modalLog.innerHTML += `
                <div style="
                    background: ${isToday ? 'linear-gradient(95deg, rgba(6, 182, 212, 0.15) 0%, rgba(15, 23, 42, 0.4) 100%)' : 'rgba(255,255,255,0.02)'};
                    border: 1px solid ${isToday ? 'var(--accent)' : 'rgba(255,255,255,0.05)'};
                    padding: 20px;
                    border-radius: 20px;
                    display: flex;
                    align-items: center;
                    gap: 25px;
                    ${isToday ? 'box-shadow: 0 0 20px rgba(6, 182, 212, 0.05);' : ''}
                ">
                    <div style="min-width: 90px; font-weight: 900; color: ${isToday ? 'var(--accent)' : '#64748b'}; font-size: 1.1rem; border-left: 2px solid ${isToday ? 'var(--accent)' : '#334155'}; padding-left: 15px;">
                        ${dayName}
                    </div>
                    <div style="font-size: 1rem; line-height: 1.8; color: #cbd5e1; flex: 1;">
                        ${namesList || '<span style="color:#444; font-style:italic;">لا يوجد ترتيب مسجل</span>'}
                    </div>
                </div>
            `;
        });
    });
}

    // تأكد من استدعاء الدالة عند فتح صفحة الأدمن أو الموظف
    if (currentUser) {
        updateWeeklyLogDisplays();
    }

    // معاينة الصورة عند الاختيار
    function previewPerformanceImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('perfPreviewImg').src = e.target.result;
                document.getElementById('perfPreviewContainer').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // مسح الصورة المختارة
    function clearPerfImg() {
        document.getElementById('performanceImgInput').value = "";
        document.getElementById('perfPreviewContainer').style.display = 'none';
    }

    // الوظيفة الرئيسية: الرفع لـ Cloudinary ثم النشر
    async function uploadAndSendPerformance() {
        const file = document.getElementById('performanceImgInput').files[0];
        const text = document.getElementById('broadcastInput').value.trim();
        const btn = document.getElementById('btnSendPerformance');
        const select = document.getElementById('broadcastTarget');
        let targets = Array.from(select.selectedOptions).map(o => o.value);

        if (!file && !text) return alert("اكتب وصفاً أو ارفع صورة أولاً ⚠️");

        // قفل الزرار
        btn.disabled = true;
        btn.innerHTML = "⏳ جاري الرفع للسحابة...";

        try {
            let imageUrl = "";
            if (file) {
                // استخدام دالة الرفع الموجودة أصلاً في الكود الخاص بك
                imageUrl = await uploadToCloudinary(file);
            }

            const data = {
                message: text || "⭐ تم تسجيل لقطة أداء مميزة!",
                image: imageUrl,
                timestamp: getServerTime(),
                sender: currentUser.realName || currentUser.username,
                target: targets.includes('all') ? 'all' : targets
            };

            // الإرسال لـ Firebase
            await db.ref('broadcasts').push(data);

            alert("تم النشر بنجاح لجميع الموظفين! 🏆");
            
            // تصفير الحقول
            document.getElementById('broadcastInput').value = "";
            clearPerfImg();

        } catch (e) {
            console.error(e);
            alert("فشل الرفع.. تأكد من اتصال الإنترنت ❌");
        } finally {
            btn.disabled = false;
            btn.innerHTML = "🚀 نشر في السجل وبث مباشر";
        }
    }

    // فتح معرض الأداء بتصميم جديد ودعم الحذف للمشرفين
    function openPerformanceGallery() {
        const modal = document.getElementById('performanceGalleryModal');
        const grid = document.getElementById('galleryGrid');
        
        modal.classList.remove('hidden');
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:50px;"><div class="btn-disabled">⏳ جاري تحميل اللحظات المميزة...</div></div>';

        const isAdmin = (currentUser.role === 'admin');

        db.ref('broadcasts').once('value', (snap) => {
            const data = snap.val();
            if (!data) {
                grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#aaa;">لا توجد صور في السجل حالياً 📂</p>';
                return;
            }

            grid.innerHTML = "";
            const keys = Object.keys(data).sort((a, b) => data[b].timestamp - data[a].timestamp);
            let hasImages = false;

            keys.forEach(key => {
                const b = data[key];
                if (b.image && b.image.includes('cloudinary')) {
                    hasImages = true;
                    
                    // زر الحذف يظهر فقط إذا كان المستخدم مشرف
                    const deleteBtn = isAdmin ? `
                        <button class="delete-gallery-btn" onclick="deleteFromGallery('${key}')" title="حذف هذه الصورة">
                            🗑️
                        </button>
                    ` : '';

                    grid.innerHTML += `
                        <div class="gallery-card">
                            ${deleteBtn}
                            <img src="${b.image}" class="gallery-img" onclick="showZoomImage('${b.image}')">
                            <div class="gallery-info">
                                <div style="color:var(--accent); font-weight:bold; font-size:0.9rem;">👤 ${b.sender || 'Admin'}</div>
                                <div style="color:#ccc; font-size:0.75rem; margin-top:4px;">📅 ${new Date(b.timestamp).toLocaleDateString('ar-EG')}</div>
                                <div style="color:white; font-size:0.8rem; margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.message || ''}</div>
                            </div>
                        </div>
                    `;
                }
            });

            if (!hasImages) {
                grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#aaa;">تم العثور على نصوص فقط.. لا توجد صور 🖼️</p>';
            }
        });
    }

    // دالة الحذف الخاصة بالمعرض
    function deleteFromGallery(key) {
        if (!confirm("⚠️ هل أنت متأكد من حذف هذه الصورة نهائياً من المعرض والبث؟")) return;

        // تسجيل العملية في الأرشيف للرقابة
        logDeletionAction("حذف صورة من معرض الأداء", "الكل", "قام المشرف بحذف لقطة أداء مميزة من المعرض العام");

        db.ref('broadcasts/' + key).remove()
            .then(() => {
                alert("تم الحذف بنجاح ✅");
                openPerformanceGallery(); // إعادة تحميل المعرض لتحديث الشكل
            })
            .catch(err => alert("خطأ في الحذف: " + err.message));
    }

    // 1. تحديث قائمة الموظفين للاختيار عند فتح تبويب المجموعات
    function updateMembersSelector() {
        const list = document.getElementById('membersSelectorList');
        list.innerHTML = '';
        Object.values(allUsersData).forEach(u => {
            if(u.username && !MANAGERS.includes(u.username)) {
                list.innerHTML += `
                    <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" name="groupMember" value="${u.username}"> 
                        👤 ${u.realName || u.username}
                    </label>`;
            }
        });
    }

    function createNewGroup() {
        const groupName = document.getElementById('groupNameInput').value.trim();
        const selectedMembers = Array.from(document.querySelectorAll('input[name="groupMember"]:checked')).map(el => el.value);

        if(!groupName) return alert("يرجى كتابة اسم المجموعة");
        if(selectedMembers.length === 0) return alert("يرجى اختيار أعضاء للمجموعة");

        const groupId = db.ref('groups').push().key;

        // 1. حفظ بيانات المجموعة في نود المجموعات
        const groupData = {
            name: groupName,
            members: selectedMembers
        };

        const updates = {};
        updates['groups/' + groupId] = groupData;

        // 2. تحديث كل موظف مختار وإضافة اسم المجموعة لملفه الشخصي
        selectedMembers.forEach(username => {
            updates['users/' + username + '/groupName'] = groupName;
        });

        db.ref().update(updates).then(() => {
            alert("تم إنشاء مجموعة (" + groupName + ") وربط الموظفين بها بنجاح ✅");
            document.getElementById('groupNameInput').value = "";
            // إعادة تحميل قائمة الاختيار
            updateMembersSelector();
        });
    }

    // 3. رسم جدول المجموعات وتحديث حالتها (متاحة أو في بريك)
    function renderGroupsTable() {
        db.ref('groups').on('value', (snap) => {
            const groups = snap.val() || {};
            allGroupsData = groups; // Update global groups data
            const tbody = document.getElementById('groupsManagementBody');
            tbody.innerHTML = '';

            Object.keys(groups).forEach(id => {
                const g = groups[id];

                // فحص حالة المجموعة: هل أي عضو فيها حالياً في البريك؟
                let groupInBreak = false;
                let membersDisplay = [];

                g.members.forEach(mUsername => {
                    const user = allUsersData[mUsername];
                    if(user) {
                        membersDisplay.push(user.realName || user.username);
                        if(user.isOnBreak) groupInBreak = true;
                    }
                });

                // الحالة الآن (Checkbox أخضر أو نص أحمر)
                const statusCell = groupInBreak
                    ? `<span style="color: #f43f5e; font-weight: bold;">🚫 المجموعة في بريك</span>`
                    : `<span style="color: #10b981;">✅ المجموعة متاحة <input type="checkbox" checked disabled></span>`;

                tbody.innerHTML += `
                    <tr>
                        <td style="color: #6366f1; font-weight: bold;">${g.name}</td>
                        <td>${membersDisplay.join(' - ')}</td>
                        <td>${statusCell}</td>
                        <td>
                            <button onclick="deleteGroup('${id}')" class="btn btn-danger btn-sm">حذف</button>
                        </td>
                    </tr>`;
            });
        });
    }

    // 4. حذف مجموعة
    function deleteGroup(id) {
        if(confirm("هل تريد حذف هذه المجموعة؟")) {
            db.ref('groups/' + id).remove();
        }
    }

    // دالة لتحديث قائمة المجموعات المنسدلة في شاشة إضافة الموظفين
    function updateAllGroupSelects() {
        db.ref('groups').on('value', (snap) => {
            const groups = snap.val() || {};
            const groupSelect = document.getElementById('newUserGroup'); // تأكد أن هذا هو ID القائمة

            if (!groupSelect) return;

            // الاحتفاظ بالقيمة المختارة حالياً قبل التحديث
            const currentVal = groupSelect.value;

            let h = '<option value="">-- اختر المجموعة --</option>';
            Object.values(groups).forEach(g => {
                // إضافة كل مجموعة موجودة في الجدول كخيار في القائمة
                h += `<option value="${g.name}">${g.name}</option>`;
            });

            groupSelect.innerHTML = h;

            // إعادة القيمة المختارة لو كانت موجودة
            if (currentVal) groupSelect.value = currentVal;
        });
    }

    // هذه الدالة تراقب نود المجموعات في Firebase وتحدث القائمة فوراً عند أي تغيير
    function syncGroupsToSelect() {
        db.ref('groups').on('value', (snap) => {
            const groups = snap.val() || {};
            const groupSelect = document.getElementById('newUserGroup');
            
            if (!groupSelect) return;

            // حفظ القيمة المختارة حالياً عشان متتمسحش أثناء التحديث
            const currentSelection = groupSelect.value;

            // تنظيف القائمة والبدء من جديد
            let optionsHTML = '<option value="">-- اختر المجموعة --</option>';
            
            Object.values(groups).forEach(g => {
                // هنا بنضيف اسم المجموعة اللي في الجدول للقائمة
                optionsHTML += `<option value="${g.name}">${g.name}</option>`;
            });

            groupSelect.innerHTML = optionsHTML;
            
            // إعادة اختيار المجموعة لو كانت محددة مسبقاً
            if (currentSelection) groupSelect.value = currentSelection;
        });
    }

    // استدعاء الدالة لتبدأ العمل فور فتح الصفحة
    syncGroupsToSelect();

    function exportMonthlyExcel() {
        const startDateVal = document.getElementById('filterStartDate').value;
        const endDateVal = document.getElementById('filterEndDate').value;

        if (!startDateVal || !endDateVal) {
            return alert("يرجى تحديد تاريخ البداية والنهاية لاستخراج التقرير 📅");
        }

        let reportData = [];

        Object.values(allUsersData).forEach(u => {
            if (!u.username || MANAGERS.includes(u.username)) return;

            let totalBreakTime = 0;
            let totalPrayerTime = 0;
            let totalMeetingTime = 0;
            let totalVIPTime = 0;
            let totalOvertimeHours = 0;
            let totalPermHours = 0; // متغيير الاستأذان الجديد
            let totalDeductions = 0;
            let totalOxidation = 0;
            
            let clockInTime = "--:--";
            let clockOutTime = "--:--";

            // جلب أول يوم وقت الحضور والانصراف
            if (u.attendance) {
                const attendanceDates = Object.keys(u.attendance);
                const firstDate = attendanceDates[0];
                if (firstDate) {
                    const dayData = u.attendance[firstDate];
                    clockInTime = dayData.clockIn || "--:--";
                    clockOutTime = dayData.clockOut || dayData.lastSeen || "--:--";
                }
            }

            // حساب السجلات (بريك، صلاة، ميتنج، VIP)
            if (u.sessions) {
                let dailyBreaks = {};
                Object.values(u.sessions).forEach(s => {
                    const parts = s.date.split('/');
                    const sessionDate = `${parts[2]}-${parts[1]}-${parts[0]}`;

                    if (sessionDate >= startDateVal && sessionDate <= endDateVal) {
                        const dur = parseInt(s.duration) || 0;
                        if (s.type === 'بريك عام' || s.type === 'طوارئ') {
                            totalBreakTime += dur;
                            dailyBreaks[s.date] = (dailyBreaks[s.date] || 0) + dur;
                        }
                        else if (s.type === 'صلاة') totalPrayerTime += dur;
                        else if (s.type === 'ميتنج') totalMeetingTime += dur;
                        else if (s.type === 'استراحة VIP') totalVIPTime += dur;
                    }
                });
                // حساب الأكسدة
                Object.values(dailyBreaks).forEach(dailyTotal => {
                    const allow = (u.allowance || 45) * 60;
                    if (dailyTotal > allow) totalOxidation += (dailyTotal - allow);
                });
            }

            // حساب الإضافي المعتمد
            if (u.overtimeHistory) {
                Object.values(u.overtimeHistory).forEach(ot => {
                    const otD = ot.date.split('/').reverse().join('-');
                    if (otD >= startDateVal && otD <= endDateVal) totalOvertimeHours += parseFloat(ot.hours) || 0;
                });
            }

            // حساب الاستأذان المعتمد (المطلوب)
            if (u.permHistory) {
                Object.values(u.permHistory).forEach(p => {
                    const pD = p.date.split('/').reverse().join('-');
                    if (pD >= startDateVal && pD <= endDateVal) totalPermHours += parseFloat(p.hours) || 0;
                });
            }

            // حساب الاستأذان المعتمد (المطلوب)
            if (u.permHistory) {
                Object.values(u.permHistory).forEach(p => {
                    const pD = p.date.split('/').reverse().join('-');
                    if (pD >= startDateVal && pD <= endDateVal) totalPermHours += parseFloat(p.hours) || 0;
                });
            }

            // حساب الخصومات
            if (u.complaints) {
                Object.values(u.complaints).forEach(c => {
                    const cD = c.date.split('/').reverse().join('-');
                    if (cD >= startDateVal && cD <= endDateVal) totalDeductions += parseFloat(c.amount) || 0;
                });
            }

            reportData.push({
                "اسم الموظف": u.realName || u.username,
                "وقت الحضور": clockInTime,
                "وقت الانصراف": clockOutTime,
                "الأكسدة (د)": Math.round(totalOxidation / 60),
                "الإضافي (س)": totalOvertimeHours,
                "الاستأذان (س)": totalPermHours, // إضافة العمود الجديد
                "الخصم (ج.م)": totalDeductions,
                "الصلاة (د)": Math.round(totalPrayerTime / 60),
                "الميتنج (د)": Math.round(totalMeetingTime / 60),
                "VIP (د)": Math.round(totalVIPTime / 60)
            });
        });

        const worksheet = XLSX.utils.json_to_sheet(reportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "تقرير شهري");
        XLSX.writeFile(workbook, `Report_${startDateVal}.xlsx`);
    }

    async function exportProfessionalExcel() {
        const startDateVal = document.getElementById('filterStartDate').value;
        const endDateVal = document.getElementById('filterEndDate').value;

        if (!startDateVal || !endDateVal) return alert("📅 حدد التاريخ أولاً يا مدير!");

        const workbook = new ExcelJS.Workbook();

        // 1. إنشاء ورقة الملخص
        const summarySheet = workbook.addWorksheet('ملخص الأداء العام', { views: [{ rightToLeft: true }] });

        // 2. إنشاء ورقة التفاصيل (التفنيدة)
        const detailsSheet = workbook.addWorksheet('سجل التفاصيل اليومي', { views: [{ rightToLeft: true }] });

        // 3. إنشاء ورقة تقرير الموظفين المفصل
        const employeeReportSheet = workbook.addWorksheet('تقرير الموظفين المفصل', { views: [{ rightToLeft: true }] });

        let summaryRows = [];
        let detailedLogs = [];
        let totals = { days: 0, ox: 0, ot: 0, perm: 0, cash: 0, count: 0 };

        Object.values(allUsersData).forEach(u => {
            if (!u.username || MANAGERS.includes(u.username)) return;

            let uS = { name: u.realName || u.username, days: new Set(), ox: 0, prayer: 0, meet: 0, vip: 0, ot: 0, perm: 0, comp: 0, cash: 0 };

            if (u.sessions) {
                let daily = {};
                Object.entries(u.sessions).forEach(([key, s]) => {
                    const sD = s.date.split('/').reverse().join('-');
                    if (sD >= startDateVal && sD <= endDateVal) {
                        uS.days.add(s.date);
                        const dur = parseInt(s.duration) || 0;
                        const durMin = Math.round(dur/60);

                        detailedLogs.push([
                            s.date,
                            uS.name,
                            s.type,
                            durMin + " دقيقة",
                            (s.startTime ? "بداية: " + s.startTime : "") + (s.endTime ? " | نهاية: " + s.endTime : "") + " | " + (s.reason || "بدون سبب")
                        ]);

                        if (s.type === 'بريك عام' || s.type === 'طوارئ') daily[s.date] = (daily[s.date] || 0) + dur;
                        else if (s.type === 'صلاة') uS.prayer += dur;
                        else if (s.type === 'ميتنج') uS.meet += dur;
                        else if (s.type === 'استراحة VIP') uS.vip += dur;
                    }
                });
                const allow = (u.allowance || 45) * 60;
                Object.values(daily).forEach(v => { if(v > allow) uS.ox += (v - allow); });
            }

            if (u.overtimeHistory) {
                Object.values(u.overtimeHistory).forEach(ot => {
                    const otD = ot.date.split('/').reverse().join('-');
                    if (otD >= startDateVal && otD <= endDateVal) {
                        uS.ot += parseFloat(ot.hours) || 0;
                        detailedLogs.push([ot.date, uS.name, "إضافي", ot.hours + " ساعة", "معتمد من: " + ot.approvedBy]);
                    }
                });
            }

            if (u.complaints) {
                Object.values(u.complaints).forEach(c => {
                    const cD = c.date.split('/').reverse().join('-');
                    if (cD >= startDateVal && cD <= endDateVal) {
                        uS.comp++; uS.cash += parseFloat(c.amount) || 0;
                        detailedLogs.push([c.date, uS.name, "مخالفة/خصم", c.amount + " ج.م", c.title + ": " + c.details]);
                    }
                });
            }

            totals.days += uS.days.size; totals.ox += Math.round(uS.ox/60); totals.ot += uS.ot; totals.perm += uS.perm; totals.cash += uS.cash; totals.count++;
            summaryRows.push([uS.name, uS.days.size, Math.round(uS.ox/60), Math.round(uS.prayer/60), Math.round(uS.meet/60), Math.round(uS.vip/60), uS.ot, uS.perm, uS.comp, uS.cash]);
        });

        // --- تنسيق ورقة الملخص ---
        summarySheet.mergeCells('A1:J1');
        summarySheet.getCell('A1').value = 'ELSHAMAA - تقرير الأداء التفصيلي 2026';
        summarySheet.getCell('A1').font = { size: 18, bold: true, color: { argb: 'FFFFFFFF' } };
        summarySheet.getCell('A1').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E293B' } };
        summarySheet.getCell('A1').alignment = { vertical: 'middle', horizontal: 'center' };

        const headerRow = summarySheet.getRow(7);
        const mainHeader = ["اسم الموظف", "أيام الحضور", "وقت الحضور", "وقت الانصراف", "الأكسدة (د)", "الصلاة (د)", "الميتنج (د)", "VIP (د)", "إضافي (س)", "استأذان (س)", "المخالفات", "الخصم (ج.م)"];

        headerRow.values = mainHeader;
        headerRow.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };
            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
            cell.alignment = { horizontal: 'center' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        summaryRows.forEach(rowData => {
            summarySheet.addRow(rowData).eachCell(cell => {
                cell.alignment = { horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            });
        });

        // إضافة الفلتر لورقة الملخص
        summarySheet.autoFilter = 'A7:L7';
        summarySheet.getColumn(1).width = 25;
        for(let i=2; i<=12; i++) summarySheet.getColumn(i).width = 14;

        // --- تنسيق ورقة التفاصيل (التفنيدة) مع الفلتر ---
        detailsSheet.mergeCells('A1:E1');
        detailsSheet.getCell('A1').value = 'تفاصيل الحركات اليومية (تفنيدة النشاط)';
        detailsSheet.getCell('A1').font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        detailsSheet.getCell('A1').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF059669' } };
        detailsSheet.getCell('A1').alignment = { vertical: 'middle', horizontal: 'center' };

        const dHeaderRow = detailsSheet.getRow(3);
        dHeaderRow.values = ["التاريخ", "الموظف", "نوع النشاط", "المدة/القيمة", "السبب/التفاصيل"];
        dHeaderRow.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF334155' } };
            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
            cell.alignment = { horizontal: 'center' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        // إضافة البيانات
        detailedLogs.sort((a,b) => b[0].localeCompare(a[0])).forEach((log, index) => {
            const row = detailsSheet.addRow(log);
            row.eachCell(cell => {
                cell.alignment = { horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            });
            // تلوين الصفوف (Zebra Style) لسهولة القراءة في التفاصيل
            if(index % 2 !== 0) {
                row.eachCell(cell => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } }; });
            }
        });

        // السحر هنا: إضافة خاصية الفلتر لجدول التفاصيل (الصف الثالث)
        detailsSheet.autoFilter = 'A3:E3';

        detailsSheet.getColumn(1).width = 15;
        detailsSheet.getColumn(2).width = 20;
        detailsSheet.getColumn(3).width = 15;
        detailsSheet.getColumn(4).width = 15;
        detailsSheet.getColumn(5).width = 45;

        // --- تنسيق ورقة تقرير الموظفين المفصل ---
        employeeReportSheet.mergeCells('A1:E1');
        employeeReportSheet.getCell('A1').value = 'تقرير الموظفين المفصل (مثل الواجهة)';
        employeeReportSheet.getCell('A1').font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        employeeReportSheet.getCell('A1').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF7C3AED' } };
        employeeReportSheet.getCell('A1').alignment = { vertical: 'middle', horizontal: 'center' };

        let currentRow = 3;

        Object.values(allUsersData).forEach(u => {
            if (!u.username || MANAGERS.includes(u.username)) return;

            // عنوان الموظف
            employeeReportSheet.mergeCells(`A${currentRow}:E${currentRow}`);
            employeeReportSheet.getCell(`A${currentRow}`).value = `الموظف: ${u.realName || u.username}`;
            employeeReportSheet.getCell(`A${currentRow}`).font = { size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
            employeeReportSheet.getCell(`A${currentRow}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF374151' } };
            employeeReportSheet.getCell(`A${currentRow}`).alignment = { horizontal: 'center' };
            currentRow++;

            if (u.sessions) {
                const grouped = {};
                Object.keys(u.sessions).forEach(k => {
                    const s = u.sessions[k], cD = s.date.split('/').reverse().join('-');
                    if (cD >= startDateVal && cD <= endDateVal) {
                        if(!grouped[s.date]) grouped[s.date] = { acts: [] };
                        const timeDisplay = s.startTime ? `[${s.startTime}${s.endTime ? ' - ' + s.endTime : ''}]` : "";
                        grouped[s.date].acts.push(`${timeDisplay} ${s.type}: ${Math.round(parseInt(s.duration)/60)}د (${s.reason||'--'})`);
                    }
                });

                Object.keys(grouped).sort((a,b)=>b.localeCompare(a)).forEach(d => {
                    employeeReportSheet.addRow([d, '', grouped[d].acts.join(' | '), '', '']);
                    currentRow++;
                });
            }

            // صف فارغ بين الموظفين
            currentRow++;
        });

        employeeReportSheet.getColumn(1).width = 15;
        employeeReportSheet.getColumn(2).width = 10;
        employeeReportSheet.getColumn(3).width = 60;
        employeeReportSheet.getColumn(4).width = 10;
        employeeReportSheet.getColumn(5).width = 10;

        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ELSHAMAA_Report_${startDateVal}.xlsx`);
    }

    async function exportProfessionalExcel() {
        const startDateVal = document.getElementById('filterStartDate').value;
        const endDateVal = document.getElementById('filterEndDate').value;

        if (!startDateVal || !endDateVal) return alert("📅 حدد التاريخ أولاً يا مدير!");

        const workbook = new ExcelJS.Workbook();

        // 1. إنشاء ورقة الملخص (Summary Sheet)
        const summarySheet = workbook.addWorksheet('ملخص الأداء العام', { views: [{ rightToLeft: true }] });

        // 2. إنشاء ورقة التفاصيل (Details Sheet)
        const detailsSheet = workbook.addWorksheet('سجل التفاصيل اليومي', { views: [{ rightToLeft: true }] });

        let summaryRows = [];
        let detailedLogs = [];
        let totals = { days: 0, ox: 0, ot: 0, perm: 0, cash: 0, count: 0 };

        // معالجة البيانات من قاعدة البيانات
        Object.values(allUsersData).forEach(u => {
            if (!u.username || MANAGERS.includes(u.username)) return;

            let uS = { name: u.realName || u.username, days: new Set(), ox: 0, prayer: 0, meet: 0, vip: 0, ot: 0, perm: 0, comp: 0, cash: 0 };

            // حساب سجلات النشاط (البريك، الصلاة، الميتنج)
            if (u.sessions) {
                let daily = {};
                Object.entries(u.sessions).forEach(([key, s]) => {
                    const sD = s.date.split('/').reverse().join('-'); // تحويل التاريخ للمقارنة
                    if (sD >= startDateVal && sD <= endDateVal) {
                        uS.days.add(s.date);
                        const dur = parseInt(s.duration) || 0;
                        const durMin = Math.round(dur/60);

                        // إضافة لتفنيدة التفاصيل
                        detailedLogs.push([s.date, uS.name, s.type, durMin + " دقيقة", s.reason || "بدون سبب"]);

                        if (s.type === 'بريك عام' || s.type === 'طوارئ') daily[s.date] = (daily[s.date] || 0) + dur;
                        else if (s.type === 'صلاة') uS.prayer += dur;
                        else if (s.type === 'ميتنج') uS.meet += dur;
                        else if (s.type === 'استراحة VIP') uS.vip += dur;
                    }
                });
                // حساب الأكسدة (الوقت الزائد عن المسموح)
                const allow = (u.allowance || 45) * 60;
                Object.values(daily).forEach(v => { if(v > allow) uS.ox += (v - allow); });
            }

            // حساب الإضافي (Overtime)
            if (u.overtimeHistory) {
                Object.values(u.overtimeHistory).forEach(ot => {
                    const otD = ot.date.split('/').reverse().join('-');
                    if (otD >= startDateVal && otD <= endDateVal) {
                        uS.ot += parseFloat(ot.hours) || 0;
                        detailedLogs.push([ot.date, uS.name, "إضافي", ot.hours + " ساعة", "معتمد من: " + ot.approvedBy]);
                    }
                });
            }

            // حساب المخالفات والخصومات
            if (u.complaints) {
                Object.values(u.complaints).forEach(c => {
                    const cD = c.date.split('/').reverse().join('-');
                    if (cD >= startDateVal && cD <= endDateVal) {
                        uS.comp++; uS.cash += parseFloat(c.amount) || 0;
                        detailedLogs.push([c.date, uS.name, "مخالفة/خصم", c.amount + " ج.م", c.title + ": " + c.details]);
                    }
                });
            }

            // تجميع الإجماليات العامة
            totals.days += uS.days.size; totals.ox += Math.round(uS.ox/60); totals.ot += uS.ot; totals.cash += uS.cash; totals.count++;

            // تجهيز صف الملخص للموظف
            summaryRows.push([uS.name, uS.days.size, Math.round(uS.ox/60), Math.round(uS.prayer/60), Math.round(uS.meet/60), Math.round(uS.vip/60), uS.ot, uS.perm, uS.comp, uS.cash]);
        });

        // --- تنسيق ورقة الملخص (Summary) ---
        summarySheet.mergeCells('A1:J1');
        const titleCell = summarySheet.getCell('A1');
        titleCell.value = 'نظام ELSHAMAA - تقرير الأداء التحليلي الشامل';
        titleCell.font = { size: 18, bold: true, color: { argb: 'FFFFFFFF' } };
        titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E293B' } };
        titleCell.alignment = { vertical: 'middle', horizontal: 'center' };

        // رأس الجدول للملخص
        const headerRow = summarySheet.getRow(7);
        const mainHeader = ["اسم الموظف", "أيام الحضور", "الأكسدة (د)", "الصلاة (د)", "الميتنج (د)", "VIP (د)", "إضافي (س)", "استأذان (س)", "المخالفات", "الخصم (ج.م)"];
        headerRow.values = mainHeader;
        headerRow.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };
            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
            cell.alignment = { horizontal: 'center' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        summaryRows.forEach(rowData => {
            summarySheet.addRow(rowData).eachCell(cell => {
                cell.alignment = { horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            });
        });

        // --- تنسيق ورقة التفاصيل (Detailed Logs) ---
        detailsSheet.getRow(1).values = ["التاريخ", "الموظف", "نوع النشاط", "المدة/القيمة", "السبب/التفاصيل"];
        detailsSheet.getRow(1).eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF059669' } };
            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
        });

        detailedLogs.forEach(log => {
            detailsSheet.addRow(log).eachCell(cell => {
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            });
        });

        // ضبط عرض الأعمدة
        summarySheet.getColumn(1).width = 25;
        detailsSheet.getColumn(5).width = 50;

        // تصدير الملف
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ELSHAMAA_Report_${startDateVal}_to_${endDateVal}.xlsx`);
    }
    </script>

    <script>
    // Prayer Queue Functions
    function populateQueueSelect() {
        const select = document.getElementById('queueUserSelect');
        select.innerHTML = '<option value="">-- اختر الموظف لإضافته للدور --</option>';
        Object.values(allUsersData).forEach(u => {
            if (!MANAGERS.includes(u.username)) {
                const option = document.createElement('option');
                option.value = u.username;
                option.textContent = u.realName || u.username;
                select.appendChild(option);
            }
        });
    }

    function addToQueue() {
        const select = document.getElementById('queueUserSelect');
        const username = select.value;
        if (!username) return alert('اختر موظف أولاً');
        db.ref('settings/prayerQueue').once('value', (snap) => {
            let queue = snap.val() || [];
            if (queue.includes(username)) return alert('الموظف موجود بالفعل في الدور');
            queue.push(username);
            db.ref('settings/prayerQueue').set(queue).then(() => {
                renderPrayerQueue();
                select.value = '';
            });
        });
    }

    function clearQueue() {
        if (!confirm('هل تريد تصفير الدور بالكامل؟')) return;
        db.ref('settings/prayerQueue').set([]).then(() => {
            renderPrayerQueue();
        });
    }

    function renderPrayerQueue() {
        const display = document.getElementById('queueDisplay');
        db.ref('settings/prayerQueue').once('value', (snap) => {
            const queue = snap.val() || [];
            display.innerHTML = '';
            queue.forEach((username, index) => {
                const u = allUsersData[username];
                if (u) {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: rgba(99, 102, 241, 0.2); border: 1px solid var(--primary); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; min-width: 80px;';
                    card.innerHTML = `
                        <img src="${u.profilePic || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary);">
                        <div style="font-size: 0.8rem; text-align: center; margin-top: 5px;">${u.realName || u.username}</div>
                        <div style="font-size: 0.7rem; color: var(--accent);">#${index + 1}</div>
                        <button onclick="removeFromQueue(${index})" style="background: var(--danger); border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 0.7rem; margin-top: 5px;">×</button>
                    `;
                    display.appendChild(card);
                }
            });
        });
    }

    function removeFromQueue(index) {
        db.ref('settings/prayerQueue').once('value', (snap) => {
            let queue = snap.val() || [];
            queue.splice(index, 1);
            db.ref('settings/prayerQueue').set(queue).then(() => {
                renderPrayerQueue();
            });
        });
    }

    // Listener for prayerQueue
    db.ref('settings/prayerQueue').on('value', () => {
        if (currentUser && currentUser.role === 'admin') renderPrayerQueue();
    });

    // الاستماع لتغييرات الطابور وتحديث المتغير العالمي
    db.ref('settings/prayerQueue').on('value', (snap) => {
        currentQueue = snap.val() || [];
        if (currentUser && currentUser.role !== 'admin') {
            updateUserUI(); // تحديث أزرار وحالة الموظف فوراً
        }
    });

    // 3. دالة بناء الجدول (الخوارزمية)
    function renderRotationTable() {
        const tbody = document.getElementById('rotationTableBody');
        if(!tbody) return;
        tbody.innerHTML = '';

        const n = selectedRotationMembers.length;
        if(n === 0) {
            tbody.innerHTML = '<tr><td colspan="4">لا يوجد موظفين مختارين.</td></tr>';
            return;
        }

        selectedRotationMembers.forEach((un, index) => {
            const u = allUsersData[un];
            if(!u) return;

            // حساب مكانه "الآن" في الدائرة
            // الموظف اللي ترتيبه الحالي = 0 هو اللي هيظهر رقم 1
            let currentPos = ((index - currentRotationOffset) % n + n) % n + 1;
            
            // حساب مكانه في "اللفة الجاية"
            let nextPos = ((index - (currentRotationOffset + 1)) % n + n) % n + 1;

            tbody.innerHTML += `
                <tr style="${currentPos === 1 ? 'background: rgba(16, 185, 129, 0.1); border-right: 4px solid #10b981;' : ''}">
                    <td style="font-weight:bold; color:white;">
                        ${currentPos === 1 ? '👑 ' : ''}${u.realName || un}
                    </td>
                    <td style="font-weight:bold; color:${currentPos === 1 ? '#10b981' : 'white'}">#${currentPos}</td>
                    <td style="color:#aaa;">#${nextPos}</td>
                    <td style="font-size:0.8rem; color:#666;">سيصبح #${nextPos} عند التدوير</td>
                </tr>`;
        });
    }

    // 4. دالة تحديث "طابور الصلاة الفعلي" بناء على الجدول الحالي
    function updateEmployeeQueueFromRotation() {
        if (rotationBaseList.length === 0) return;

        const n = rotationBaseList.length;
        // ترتيب الموظفين حسب أولوية الظهر (أو الوقت الحالي)
        let sortedQueue = [...rotationBaseList].sort((a, b) => {
            let idxA = rotationBaseList.indexOf(a);
            let idxB = rotationBaseList.indexOf(b);
            let posA = ((idxA - currentOffset) % n + n) % n;
            let posB = ((idxB - currentOffset) % n + n) % n;
            return posA - posB;
        });

        // تحديث طابور الصلاة الرسمي في Firebase
        // ملاحظة: دي بتخلي الزرار يفتح أوتوماتيك للي عليه الدور في الجدول
        db.ref('settings/prayerQueue').set(sortedQueue);
    }

    // 5. دالة التدوير (تتحرك خطوة لقدام)
    function rotateManually() {
        if(!confirm("هل تريد تدوير الأدوار للانتقال للصلاة التالية (أو لليوم التالي)؟")) return;
        currentOffset = (currentOffset + 1) % rotationBaseList.length;
        saveRotation();
        alert("تم تدوير الجدول.. الموظف اللي كان التاني بقى الأول! 🚀");
    }

    function saveRotation() {
        db.ref('settings/prayerRotation').set({
            list: rotationBaseList,
            offset: currentOffset
        });
    }

    function resetRotation() {
        if(!confirm("سيتم مسح القائمة الحالية وإعادة بنائها من موظفي اليوم.. هل أنت متأكد؟")) return;
        rotationBaseList = Object.values(allUsersData)
            .filter(u => u.username && !MANAGERS.includes(u.username))
            .map(u => u.username);
        currentOffset = 0;
        saveRotation();
    }
    </script>
    <!-- نافذة تأكيد إتمام الصلاة -->
    <div id="prayerCheckModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:30000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
        <div style="background:#1e293b; border:2px solid var(--primary); border-radius:25px; padding:30px; width:90%; max-width:400px; text-align:center; box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);">
            <div style="font-size: 4rem; margin-bottom: 10px;">🕌</div>
            <h3 id="prayerCheckTitle" style="color:white; margin-bottom:15px;">هل أتممت صلاة الظهر؟</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:25px;">تأكيدك يساعد في تنظيم الدور لزملائك المنتظرين.</p>

            <div style="display:flex; gap:15px;">
                <button onclick="confirmPrayerStatus(true)" class="btn btn-success" style="flex:1; padding:15px; font-size:1.1rem;">✅ نعم، الحمد لله</button>
                <button onclick="confirmPrayerStatus(false)" class="btn btn-danger" style="flex:1; padding:15px; font-size:1.1rem;">❌ لا، لسه</button>
            </div>
        </div>
    </div>

    <!-- نافذة عرض أرشيف الصلاة -->
    <div id="prayerHistoryModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:25000; padding:20px; overflow-y:auto; backdrop-filter: blur(8px);">
        <div style="max-width:700px; margin:40px auto; background:#1e293b; border:1px solid var(--primary); border-radius:25px; padding:30px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                <h3 style="color:var(--primary); margin:0;">📋 سجل ترتيب الصلوات السابقة</h3>
                <button onclick="document.getElementById('prayerHistoryModal').classList.add('hidden')" class="btn btn-dark">إغلاق ✖</button>
            </div>

            <div id="prayerHistoryContent" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- السجلات ستظهر هنا -->
            </div>
        </div>
    </div>

    <!-- نافذة السجل السحابي -->
    <div id="prayerCloudModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:25000; padding:20px; overflow-y:auto; backdrop-filter: blur(10px);">
        <div style="max-width:600px; margin:30px auto; background:#1e293b; border:2px solid var(--primary); border-radius:25px; padding:25px; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                <h3 style="color:var(--primary); margin:0;">☁️ سجل ترتيب الصلوات السحابي</h3>
                <button onclick="document.getElementById('prayerCloudModal').classList.add('hidden')" class="btn btn-dark">إغلاق ✖</button>
            </div>
            <div id="cloudHistoryContent">
                <!-- البيانات ستظهر هنا -->
            </div>
        </div>
    </div>

    <!-- نافذة معرض الأداء -->
    <div id="performanceGalleryModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:25000; padding:20px; overflow-y:auto; backdrop-filter: blur(10px);">
        <div style="max-width:800px; margin:30px auto; background:#1e293b; border:2px solid var(--accent); border-radius:25px; padding:25px; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                <h3 style="color:var(--accent); margin:0;">🏆 معرض سجل الأداء (الصور السابقة)</h3>
                <div id="galleryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                    <!-- الصور تظهر هنا -->
                </div>
                <button onclick="document.getElementById('performanceGalleryModal').classList.add('hidden')" class="btn btn-dark">إغلاق ✖</button>
            </div>
            <div id="performanceGalleryContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                <!-- الصور ستظهر هنا -->
            </div>
        </div>
    </div>

    <!-- نافذة ألبوم صور التميز والأداء المحدثة -->
    <div id="performanceGalleryModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(2, 6, 23, 0.95); z-index:99999; padding:20px; overflow-y:auto; backdrop-filter:blur(15px);">
        <div style="max-width:1200px; margin:20px auto; background:var(--bg-deep); border:1px solid var(--accent); border-radius:35px; padding:30px; box-shadow:0 0 50px rgba(6, 182, 212, 0.2);">

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span style="font-size:2rem;">🏆</span>
                    <h2 style="color:var(--accent); margin:0; font-size:1.5rem;">معرض لقطات التميز</h2>
                </div>
                <button onclick="document.getElementById('performanceGalleryModal').classList.add('hidden')" class="btn btn-danger" style="border-radius:15px;">إغلاق المعرض ×</button>
            </div>

            <div id="galleryGrid">
            <!-- الصور يتم توليدها هنا بواسطة الجافاسكريبت -->
            </div>
        </div>
    </div>

    <!-- نافذة جدول الصلاة الأسبوعي (Standalone Page) -->
    <div id="weeklyScheduleModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:25000; padding:20px; overflow-y:auto; backdrop-filter: blur(15px);">
        <div style="max-width:900px; margin:20px auto; background:#0f172a; border:1px solid var(--accent); border-radius:35px; padding:30px; box-shadow: 0 0 50px rgba(6, 182, 212, 0.2);">

            <!-- الهيدر الخاص بالنافذة -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span style="font-size:2rem; background:var(--accent); color:#000; padding:10px; border-radius:15px;">🗓️</span>
                    <div>
                        <h2 style="color:var(--accent); margin:0; font-size:1.6rem;">جدول الترتيب الأسبوعي</h2>
                        <small style="color:#64748b;">يتم تحديث الترتيب تلقائياً بناءً على إعدادات المشرف</small>
                    </div>
                </div>
                <button onclick="document.getElementById('weeklyScheduleModal').classList.add('hidden')" class="btn btn-danger" style="border-radius:15px; padding:10px 20px;">إغلاق ×</button>
            </div>

            <!-- الحاوية التي سيظهر فيها الجدول -->
            <div id="weeklyModalContent" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- سيتم ملء البيانات هنا بواسطة JS -->
            </div>
        </div>
    </div>

    </body>
    </html>
