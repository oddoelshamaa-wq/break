html
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙŠØ³ØªÙ… Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª (Online & Persistent)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2, h3 { color: #2c3e50; text-align: center; margin-bottom: 20px; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 0.9rem; margin: 5px; }
        .btn-primary { background-color: #3498db; }
        .btn-danger { background-color: #e74c3c; }
        .btn-success { background-color: #27ae60; }
        .btn-warning { background-color: #f39c12; }
        .btn-dark { background-color: #34495e; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; vertical-align: top; }
        th { background-color: #2c3e50; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .hidden { display: none; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; justify-content: center; }
        .timer-display { font-size: 3rem; font-weight: bold; color: #333; margin: 20px 0; text-align: center; }
        .details-list { text-align: right; list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        .details-list li { border-bottom: 1px solid #eee; padding: 4px 0; }
        .over-limit { color: #c0392b; font-weight: bold; background-color: #fadbd8; padding: 5px; border-radius: 4px; display: inline-block; }
        .under-limit { color: #27ae60; font-weight: bold; }
        
        /* Loading Overlay */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:999; font-size: 1.5rem; color: #333; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading">
    <div>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    <div style="font-size: 0.8rem; margin-top: 10px; color: #777;">Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
</div>

<div class="container hidden" id="mainContainer">

    <!-- ============ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ============ -->
    <div id="loginSection">
        <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Online)</h2>
        <div style="max-width: 400px; margin: auto; padding: 20px; border: 1px solid #eee; border-radius: 10px;">
            <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button id="btnLogin" class="btn btn-primary" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
            <p style="text-align: center; font-size: 0.8em; color: #777; margin-top: 10px;">Admin: <b>admin</b> | Pass: <b>123</b></p>
        </div>
    </div>

    <!-- ============ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† ============ -->
    <div id="adminSection" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0;">ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
            <button id="btnAdminLogout" class="btn btn-dark">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="nav-tabs">
            <button onclick="switchAdminTab('monitor')" class="btn btn-primary">ğŸ”´ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­ÙŠØ©</button>
            <button onclick="switchAdminTab('reports')" class="btn btn-warning">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</button>
            <button onclick="switchAdminTab('users')" class="btn btn-success">â• Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­ÙŠØ© -->
        <div id="tab-monitor">
            <div style="display:flex; justify-content:space-between; align-items:center; background:#ecf0f1; padding:15px; border-radius:8px;">
                <span style="font-weight: bold; color: #555;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Live)</span>
                <button id="btnEndDay" class="btn btn-danger">ğŸ’¾ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ… ÙˆØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            </div>
            <table id="monitorTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ</th>
                        <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ / Ø§Ù„ØªØ¬Ø§ÙˆØ²</th>
                        <th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</th>
                        <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="monitorBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <div id="tab-reports" class="hidden">
            <h3>ğŸ“… Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª</h3>
            <div style="max-width: 500px; margin: auto;">
                <select id="reportUserSelect">
                    <option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option>
                </select>
            </div>
            <table id="reportTable">
                <thead>
                    <tr>
                        <th width="15%">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th width="40%">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        <th width="15%">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th width="15%">Ø§Ù„Ù…Ø³Ù…ÙˆØ­</th>
                        <th width="15%">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                    </tr>
                </thead>
                <tbody id="reportBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="tab-users" class="hidden">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
            <div style="display: flex; gap: 10px; background: #eee; padding: 20px; border-radius: 8px;">
                <input type="text" id="newRealName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
                <input type="text" id="newUsername" placeholder="User">
                <input type="password" id="newPassword" placeholder="Pass">
                <input type="number" id="newAllowance" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø¯)" value="45">
                <button id="btnAddUser" class="btn btn-success" style="width: 150px;">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div style="margin-top:20px; color:red; font-size:0.9em;">* Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User) ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª.</div>
        </div>
    </div>

    <!-- ============ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙˆØ¸Ù ============ -->
    <div id="employeeSection" class="hidden">
        <h2 id="welcomeMsg"></h2>
        <div style="text-align: center; background: #fafafa; padding: 30px; border-radius: 15px; border: 1px solid #ddd; max-width: 600px; margin: 20px auto;">
            <p style="font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ: <b id="userAllowanceVal"></b> Ø¯Ù‚ÙŠÙ‚Ø©</p>
            <div class="timer-display" id="userTimer">00:00</div>
            <h3 id="userStatusMsg" style="min-height: 30px;"></h3>
            
            <div id="overtimeAlert" class="hidden" style="background:#fadbd8; color:#c0392b; padding:15px; border-radius:8px; margin:15px 0; border: 1px solid #e74c3c;">
                âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù€ <span id="overtimeValue" style="font-weight:bold; font-size:1.2em;"></span>
            </div>

            <div style="margin-top: 30px;">
                <input type="text" id="breakReason" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬..." style="font-size: 1.1em; padding: 12px;">
                <button id="btnToggleBreak" class="btn btn-success" style="width:100%; font-size:1.3em; padding:15px; margin-top: 10px;">Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ</button>
            </div>
        </div>
        <div style="text-align: center;">
            <button id="btnUserLogout" class="btn btn-dark" style="margin-top: 20px;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

</div>

<!-- Ø±Ø¨Ø· Firebase -->
<script type="module">
    // 1. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø§Øª Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, remove, get, child } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ)
    const firebaseConfig = {
        apiKey: "AIzaSyC2J8fVx7qAz_g33gUNQxXMEJHsWeFrjuk",
        authDomain: "break-3ccd9.firebaseapp.com",
        projectId: "break-3ccd9",
        storageBucket: "break-3ccd9.firebasestorage.app",
        messagingSenderId: "785237776836",
        appId: "1:785237776836:web:0a0062bf07359391fd6c91",
        measurementId: "G-ZWXTBPXK59",
        databaseURL: "https://break-3ccd9-default-rtdb.firebaseio.com/"
    };

    // 3. ØªØ´ØºÙŠÙ„ Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    let allUsersData = {};
    let currentUser = null;
    let timerInterval = null;
    let isDataLoaded = false;

    // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹ (Realtime Listener) ---
    const usersRef = ref(db, 'users');
    
    onValue(usersRef, (snapshot) => {
        const data = snapshot.val();
        allUsersData = data || {}; 
        
        // Ø¨Ù…Ø¬Ø±Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        if (!isDataLoaded) {
            isDataLoaded = true;
            checkSavedSession(); // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙŠÙØ±Ø´
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('mainContainer').classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©
        if(!document.getElementById('adminSection').classList.contains('hidden')) {
            renderMonitorTable();
            updateReportSelect();
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©
        if(currentUser && allUsersData[currentUser.username]) {
            currentUser = allUsersData[currentUser.username];
            updateUserUI();
        } else if (currentUser && !allUsersData[currentUser.username]) {
            // Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§ØªÙ…Ø³Ø­ ÙˆØ£Ù†Ø§ ÙØ§ØªØ­
            alert("ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");
            logout();
        }
    });

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Fix for Refresh) ---
    function checkSavedSession() {
        const savedSession = localStorage.getItem('break_system_session');
        if (savedSession) {
            if (savedSession === 'admin') {
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
                showSection('adminSection');
                switchAdminTab('monitor');
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(renderMonitorTable, 1000);
            } else {
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ÙˆØ¸Ù
                if (allUsersData[savedSession]) {
                    currentUser = allUsersData[savedSession];
                    showSection('employeeSection');
                    initUserDash();
                } else {
                    // Ù„Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸ Ø¨Ø³ Ø§ØªÙ…Ø³Ø­ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§
                    localStorage.removeItem('break_system_session');
                }
            }
        } else {
            // Ù…ÙÙŠØ´ Ø¬Ù„Ø³Ø©ØŒ Ø¥Ø¸Ù‡Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            showSection('loginSection');
        }
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    window.switchAdminTab = (tabName) => {
        document.getElementById('tab-monitor').classList.add('hidden');
        document.getElementById('tab-reports').classList.add('hidden');
        document.getElementById('tab-users').classList.add('hidden');
        document.getElementById('tab-' + tabName).classList.remove('hidden');
    }

    function formatTime(s) {
        const m = Math.floor(s / 60).toString().padStart(2,'0');
        const sec = (s % 60).toString().padStart(2,'0');
        return `${m}:${sec}`;
    }

    // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ ---
    document.getElementById('btnLogin').addEventListener('click', () => {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();

        if(u === 'admin' && p === '123') {
            // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©
            localStorage.setItem('break_system_session', 'admin');
            
            showSection('adminSection');
            switchAdminTab('monitor');
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(renderMonitorTable, 1000);
        } else {
            if(allUsersData[u] && allUsersData[u].password === p) {
                // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©
                localStorage.setItem('break_system_session', u);

                currentUser = allUsersData[u];
                showSection('employeeSection');
                initUserDash();
            } else {
                alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©');
            }
        }
    });

    function showSection(id) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById('employeeSection').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function logout() {
        // Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
        localStorage.removeItem('break_system_session');
        
        currentUser = null;
        if(timerInterval) clearInterval(timerInterval);
        document.getElementById('loginUser').value = '';
        document.getElementById('loginPass').value = '';
        showSection('loginSection');
    }
    document.getElementById('btnUserLogout').addEventListener('click', logout);
    document.getElementById('btnAdminLogout').addEventListener('click', logout);

    // --- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† ---
    document.getElementById('btnAddUser').addEventListener('click', () => {
        const name = document.getElementById('newRealName').value;
        const username = document.getElementById('newUsername').value.trim();
        const pass = document.getElementById('newPassword').value;
        const allow = parseInt(document.getElementById('newAllowance').value);

        if(!username || !pass) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        if(allUsersData[username]) return alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");

        set(ref(db, 'users/' + username), {
            username: username,
            realName: name,
            password: pass,
            allowance: allow,
            usedSeconds: 0,
            isOnBreak: false,
            lastReason: "-"
        }).then(() => {
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('newRealName').value = '';
            document.getElementById('newUsername').value = '';
        }).catch((err) => alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message));
    });

    // Live Monitor
    function renderMonitorTable() {
        if(document.getElementById('tab-monitor').classList.contains('hidden')) return;
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';

        if(Object.keys(allUsersData).length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†</td></tr>';
            return;
        }

        Object.values(allUsersData).forEach(u => {
            let total = u.usedSeconds || 0;
            if(u.isOnBreak && u.lastStartTime) {
                total += Math.floor((Date.now() - u.lastStartTime) / 1000);
            }

            const allowedSec = u.allowance * 60;
            const diff = allowedSec - total;

            let statusHtml = u.isOnBreak 
                ? `<span style="color:red; font-weight:bold;">â›” Ø®Ø§Ø±Ø¬ (${u.lastReason})</span>` 
                : `<span style="color:green;">âœ… ÙŠØ¹Ù…Ù„</span>`;
            
            let remainingHtml = diff >= 0 
                ? `<span class="under-limit">${formatTime(diff)}</span>` 
                : `<span class="over-limit">ØªØ¬Ø§ÙˆØ² ${formatTime(Math.abs(diff))}</span>`;

            let logsCount = u.dailyLogs ? Object.keys(u.dailyLogs).length : 0;
            if(u.isOnBreak) logsCount++;

            let controlBtn = u.isOnBreak 
                ? `<button class="btn btn-warning force-stop-btn" data-user="${u.username}" style="padding:4px 8px; font-size:12px">Ø¥Ù†Ù‡Ø§Ø¡</button>` 
                : '-';

            let row = `<tr>
                <td><b>${u.realName}</b></td>
                <td>${statusHtml}</td>
                <td>${formatTime(total)}</td>
                <td>${remainingHtml}</td>
                <td>${logsCount} Ù…Ø±Ø§Øª Ø®Ø±ÙˆØ¬</td>
                <td>${controlBtn}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        document.querySelectorAll('.force-stop-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                forceStop(e.target.getAttribute('data-user'));
            });
        });
    }

    window.forceStop = (targetUsername) => {
        if(!confirm("Ø¥Ù†Ù‡Ø§Ø¡ Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…ÙˆØ¸Ù Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹ØŸ")) return;
        const user = allUsersData[targetUsername];
        if(!user || !user.isOnBreak) return;

        const duration = Math.floor((Date.now() - user.lastStartTime) / 1000);
        const newUsed = (user.usedSeconds || 0) + duration;
        
        const logEntry = {
            reason: user.lastReason + " (Admin)",
            duration: duration,
            time: new Date().toLocaleTimeString('ar-EG')
        };

        const updates = {};
        updates['users/' + targetUsername + '/isOnBreak'] = false;
        updates['users/' + targetUsername + '/usedSeconds'] = newUsed;
        updates['users/' + targetUsername + '/lastStartTime'] = null;
        
        const newLogKey = new Date().getTime(); 
        updates['users/' + targetUsername + '/dailyLogs/' + newLogKey] = logEntry;

        update(ref(db), updates);
    };

    document.getElementById('btnEndDay').addEventListener('click', () => {
        if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹.")) return;
        
        const todayDate = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
        const updates = {};

        Object.values(allUsersData).forEach(u => {
            let currentUsed = u.usedSeconds || 0;
            let logs = u.dailyLogs || {};

            if(u.isOnBreak) {
                const duration = Math.floor((Date.now() - u.lastStartTime) / 1000);
                currentUsed += duration;
                logs['auto_close'] = {
                    reason: u.lastReason + " (Auto Close)",
                    duration: duration,
                    time: new Date().toLocaleTimeString('ar-EG')
                };
            }

            const historyEntry = {
                date: todayDate,
                totalUsed: currentUsed,
                allowance: u.allowance * 60,
                details: logs
            };

            const newHistoryKey = Date.now();
            updates['users/' + u.username + '/history/' + newHistoryKey] = historyEntry;

            updates['users/' + u.username + '/usedSeconds'] = 0;
            updates['users/' + u.username + '/isOnBreak'] = false;
            updates['users/' + u.username + '/lastStartTime'] = null;
            updates['users/' + u.username + '/lastReason'] = "-";
            updates['users/' + u.username + '/dailyLogs'] = null; 
        });

        update(ref(db), updates)
            .then(() => alert("ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­ âœ…"))
            .catch(err => alert("Ø®Ø·Ø£: " + err.message));
    });

    // Reports Logic
    function updateReportSelect() {
        const sel = document.getElementById('reportUserSelect');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option>';
        Object.values(allUsersData).forEach(u => {
            sel.innerHTML += `<option value="${u.username}">${u.realName}</option>`;
        });
        sel.value = currentVal;
    }

    document.getElementById('reportUserSelect').addEventListener('change', (e) => {
        const username = e.target.value;
        const tbody = document.getElementById('reportBody');
        tbody.innerHTML = '';
        if(!username) return;

        const user = allUsersData[username];
        if(!user.history) {
            tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</td></tr>';
            return;
        }

        const historyArr = Object.values(user.history).reverse();

        historyArr.forEach(record => {
            const diff = record.allowance - record.totalUsed;
            
            let detailsHtml = '<ul class="details-list">';
            if(record.details) {
                Object.values(record.details).forEach(log => {
                     detailsHtml += `<li><b>${log.reason}</b> <span style="font-size:0.8em">(${formatTime(log.duration)})</span> - ${log.time}</li>`;
                });
            } else {
                detailsHtml += '<li>Ù„Ø§ ØªÙØ§ØµÙŠÙ„</li>';
            }
            detailsHtml += '</ul>';

            let resultHtml = diff >= 0 
                ? `<span style="color:green; font-weight:bold;">ØªÙ…Ø§Ù…</span>` 
                : `<span style="color:red; font-weight:bold;">ØªØ¬Ø§ÙˆØ² ${formatTime(Math.abs(diff))}</span>`;

            let row = `<tr>
                <td><b>${record.date}</b></td>
                <td>${detailsHtml}</td>
                <td>${formatTime(record.totalUsed)}</td>
                <td>${formatTime(record.allowance)}</td>
                <td>${resultHtml}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    });

    // --- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù ---
    function initUserDash() {
        document.getElementById('welcomeMsg').innerText = currentUser.realName;
        document.getElementById('userAllowanceVal').innerText = currentUser.allowance;
        updateUserUI();
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateUserUI, 1000);
    }

    function updateUserUI() {
        let total = currentUser.usedSeconds || 0;
        if(currentUser.isOnBreak && currentUser.lastStartTime) {
            total += Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
        }

        document.getElementById('userTimer').innerText = formatTime(total);
        
        const allowed = currentUser.allowance * 60;
        const diff = allowed - total;
        const statusMsg = document.getElementById('userStatusMsg');
        const alertBox = document.getElementById('overtimeAlert');

        if(diff >= 0) {
            statusMsg.innerText = `Ù…ØªØ¨Ù‚ÙŠ Ù„Ùƒ: ${formatTime(diff)}`;
            statusMsg.style.color = "green";
            alertBox.classList.add('hidden');
        } else {
            statusMsg.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
            statusMsg.style.color = "red";
            alertBox.classList.remove('hidden');
            document.getElementById('overtimeValue').innerText = formatTime(Math.abs(diff));
        }

        const btn = document.getElementById('btnToggleBreak');
        const inp = document.getElementById('breakReason');

        if(currentUser.isOnBreak) {
            btn.innerText = "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ";
            btn.className = "btn btn-danger";
            inp.disabled = true;
            inp.value = currentUser.lastReason;
        } else {
            btn.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ";
            btn.className = "btn btn-success";
            inp.disabled = false;
            if(inp.value === currentUser.lastReason) inp.value = "";
        }
    }

    document.getElementById('btnToggleBreak').addEventListener('click', () => {
        const inp = document.getElementById('breakReason');
        const userRef = ref(db, 'users/' + currentUser.username);

        if(!currentUser.isOnBreak) {
            if(!inp.value.trim()) return alert("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¨Ø¨");
            update(userRef, {
                isOnBreak: true,
                lastStartTime: Date.now(), 
                lastReason: inp.value
            });
        } else {
            const duration = Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
            const newUsed = (currentUser.usedSeconds || 0) + duration;
            
            const logEntry = {
                reason: currentUser.lastReason,
                duration: duration,
                time: new Date().toLocaleTimeString('ar-EG')
            };
            const newLogKey = Date.now(); 

            const updates = {};
            updates['users/' + currentUser.username + '/isOnBreak'] = false;
            updates['users/' + currentUser.username + '/usedSeconds'] = newUsed;
            updates['users/' + currentUser.username + '/lastStartTime'] = null;
            updates['users/' + currentUser.username + '/dailyLogs/' + newLogKey] = logEntry;

            update(ref(db), updates);
        }
    });

</script>
</body>
</html>
