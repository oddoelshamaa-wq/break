<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ² -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #ff6b6b;
            --success-color: #1dd1a1;
            --meeting-color: #f39c12;
            --prayer-color: #3498db;
            --dark-text: #2d3436;
            --light-bg: #f7f9fc;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            color: var(--dark-text);
            transition: background 0.3s;
        }

        /* ÙˆÙ…ÙŠØ¶ Ø£Ø­Ù…Ø± Ù„Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø§ÙˆØ² */
        @keyframes flash-red {
            0% { background-color: #ffcccc; box-shadow: inset 0 0 0 0 red; }
            50% { background-color: #ff0000; box-shadow: inset 0 0 50px 20px red; }
            100% { background-color: #ffcccc; box-shadow: inset 0 0 0 0 red; }
        }

        .alarm-mode {
            background: none !important;
            animation: flash-red 0.8s infinite;
        }

        .container {
            max-width: 1200px; /* ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            margin: auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        h2, h3 { color: #2c3e50; text-align: center; font-weight: 700; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            color: white;
            transition: all 0.3s ease;
            margin: 3px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .btn-primary { background: linear-gradient(45deg, #4e54c8, #8f94fb); }
        .btn-danger { background: linear-gradient(45deg, #ee5253, #ff6b6b); }
        .btn-success { background: linear-gradient(45deg, #10ac84, #1dd1a1); }
        .btn-warning { background: linear-gradient(45deg, #f39c12, #f1c40f); color: #fff; } /* Ù…ÙŠØªÙ†Ø¬ */
        .btn-info { background: linear-gradient(45deg, #3498db, #2980b9); } /* ØµÙ„Ø§Ø© */
        .btn-dark { background: #2d3436; }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-family: 'Cairo', sans-serif;
        }
        input:focus { outline: none; border-color: var(--primary-color); }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            font-size: 0.95rem;
        }
        th { background: #2d3436; color: white; padding: 15px; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background-color: #f8f9fa; }

        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .hidden { display: none !important; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .bg-red { background-color: #ff7675; color: white; }
        .bg-green { background-color: #55efc4; color: #2d3436; }
        .bg-orange { background-color: #f39c12; color: white; } /* Ù…ÙŠØªÙ†Ø¬ */
        .bg-blue { background-color: #3498db; color: white; } /* ØµÙ„Ø§Ø© */
        
        .timer-display { font-size: 3.5rem; font-weight: 800; color: var(--primary-color); margin: 15px 0; }
        .timer-label { font-size: 1.2rem; color: #777; margin-bottom: 5px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù */
        .employee-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .control-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: #f8f9fa;
        }
        .control-card:hover { transform: translateY(-5px); }
        
        .card-general { border-color: var(--success-color); }
        .card-prayer { border-color: var(--prayer-color); }
        .card-meeting { border-color: var(--meeting-color); }

        .filter-box {
            background: #f1f2f6; padding: 20px; border-radius: 15px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; align-items: end; border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loading">
    <div class="loader"></div>
    <h3 style="color: var(--primary-color);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</h3>
</div>

<!-- Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª -->
<audio id="alarmSound" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<div class="container hidden" id="mainContainer">
    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginSection">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: var(--primary-color);">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h1>
            <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª ÙˆØ§Ù„Ù…ÙŠØªÙ†Ø¬</p>
        </div>
        <div style="max-width: 400px; margin: auto;">
            <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; margin-top: 10px;">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <div id="adminSection" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ğŸš€</h2>
            <button onclick="logout()" class="btn btn-dark">Ø®Ø±ÙˆØ¬ ğŸ”’</button>
        </div>

        <div class="nav-tabs">
            <button onclick="switchAdminTab('monitor')" class="btn btn-primary">ğŸ“¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
            <button onclick="switchAdminTab('reports')" class="btn btn-warning">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button onclick="switchAdminTab('users')" class="btn btn-success">âš™ï¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© -->
        <div id="tab-monitor">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¢Ù†</h3>
                <button onclick="endDay()" class="btn btn-danger">ğŸ›‘ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ…</button>
            </div>
            <table id="monitorTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                        <th>Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù… (Ù…ØªØ¨Ù‚ÙŠ)</th>
                        <th>ØµÙ„Ø§Ø© (Ù…Ø³ØªÙ‡Ù„Ùƒ)</th>
                        <th>Ù…ÙŠØªÙ†Ø¬ (Ù…Ø³ØªÙ‡Ù„Ùƒ)</th>
                        <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="monitorBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <div id="tab-reports" class="hidden">
            <h3>Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
            <div class="filter-box">
                <div><label>Ø§Ù„Ù…ÙˆØ¸Ù:</label><select id="reportUserSelect"><option value="">-- Ø§Ø®ØªØ± --</option></select></div>
                <div><label>Ù…Ù†:</label><input type="date" id="filterStartDate"></div>
                <div><label>Ø¥Ù„Ù‰:</label><input type="date" id="filterEndDate"></div>
                <div><button onclick="renderUserReport()" class="btn btn-primary" style="width: 100%;">Ø¨Ø­Ø« ğŸ”</button></div>
            </div>
            <div id="overtimeSummary" class="hidden" style="padding:15px; margin-bottom:15px; border-radius:10px; text-align:center; font-weight:bold;"></div>
            <table id="reportTable">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø±ÙŠÙƒ</th><th>ØµÙ„Ø§Ø©</th><th>Ù…ÙŠØªÙ†Ø¬</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒ</th></tr></thead>
                <tbody id="reportBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="tab-users" class="hidden">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px dashed #ccc; margin-bottom: 20px;">
                <h4 style="margin-top:0; color: var(--primary-color);" id="formTitle">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="newRealName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
                    <input type="text" id="newUsername" placeholder="User Name">
                    <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <input type="number" id="newAllowance" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… (Ø¯Ù‚ÙŠÙ‚Ø©)" value="45">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="saveUser()" id="saveUserBtn" class="btn btn-success" style="flex: 1;">Ø­ÙØ¸</button>
                    <button onclick="cancelEdit()" id="cancelEditBtn" class="btn btn-dark hidden">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
            <table id="usersManagementTable">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>User</th><th>Pass</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="usersManagementBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div id="employeeSection" class="hidden">
        <div style="text-align: right;"><button onclick="logout()" class="btn btn-dark btn-sm">Ø®Ø±ÙˆØ¬</button></div>
        <div style="text-align: center;">
            <h2 id="welcomeMsg"></h2>
            
            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ -->
            <div style="background: #f1f2f6; padding: 30px; border-radius: 30px; margin: 20px auto; max-width: 600px;">
                <div id="timerLabel" class="timer-label">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</div>
                <div class="timer-display" id="userTimer">00:00</div>
                <h3 id="userStatusMsg"></h3>
                <div id="overtimeAlert" class="hidden status-badge bg-red" style="font-size: 1.2rem; padding: 10px;">ØªØ¬Ø§ÙˆØ²Øª ÙˆÙ‚Øª Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…Ø³Ù…ÙˆØ­!</div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div id="controlsArea">
                <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¨Ø¨ Ù„Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… -->
                <div style="max-width: 400px; margin: auto;">
                    <input type="text" id="breakReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… (ÙØ·Ø§Ø±ØŒ Ø­Ù…Ø§Ù…ØŒ Ø¥Ù„Ø®)..." style="text-align: center;">
                </div>

                <div class="employee-controls">
                    <!-- ÙƒØ§Ø±Øª Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… -->
                    <div class="control-card card-general">
                        <h4>ğŸ” Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…</h4>
                        <p style="font-size:0.8rem; color:#666;">ÙŠØ®ØµÙ… Ù…Ù† Ø§Ù„Ù€ 45 Ø¯Ù‚ÙŠÙ‚Ø©</p>
                        <button onclick="startMyBreak('general')" class="btn btn-success" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>

                    <!-- ÙƒØ§Ø±Øª Ø§Ù„ØµÙ„Ø§Ø© -->
                    <div class="control-card card-prayer">
                        <h4>ğŸ•Œ ØµÙ„Ø§Ø©</h4>
                        <p style="font-size:0.8rem; color:#666;">Ø¹Ø¯Ø§Ø¯ Ù…Ù†ÙØµÙ„ (Ø­Ø±)</p>
                        <button onclick="startMyBreak('prayer')" class="btn btn-info" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>

                    <!-- ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙŠØªÙ†Ø¬ -->
                    <div class="control-card card-meeting">
                        <h4>ğŸ¤ Ù…ÙŠØªÙ†Ø¬</h4>
                        <p style="font-size:0.8rem; color:#666;">Ø¹Ø¯Ø§Ø¯ ØªØµØ§Ø¹Ø¯ÙŠ (Ù…Ù† 0)</p>
                        <button onclick="startMyBreak('meeting')" class="btn btn-warning" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>
                </div>
            </div>

            <!-- Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø£ÙŠ Ù†Ø´Ø§Ø·) -->
            <div id="stopArea" class="hidden" style="margin-top: 20px;">
                <button onclick="stopMyBreak()" class="btn btn-danger" style="padding: 15px 40px; font-size: 1.5rem; width: 100%; max-width: 300px;">ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ²
    const firebaseConfig = {
        apiKey: "AIzaSyC2J8fVx7qAz_g33gUNQxXMEJHsWeFrjuk",
        authDomain: "break-3ccd9.firebaseapp.com",
        projectId: "break-3ccd9",
        storageBucket: "break-3ccd9.firebasestorage.app",
        messagingSenderId: "785237776836",
        appId: "1:785237776836:web:0a0062bf07359391fd6c91",
        databaseURL: "https://break-3ccd9-default-rtdb.firebaseio.com/"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch (e) { console.error(e); }

    let allUsersData = {};
    let currentUser = null;
    let timerInterval = null;
    let isDataLoaded = false;
    let isEditing = false; 

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹
    db.ref('users').on('value', (snapshot) => {
        const data = snapshot.val();
        allUsersData = data || {};
        
        if (!isDataLoaded) {
            isDataLoaded = true;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('hidden');
            checkSavedSession();
        }

        if(!document.getElementById('adminSection').classList.contains('hidden')) {
            renderMonitorTable();
            renderUserManagementTable();
            updateReportSelect();
        }
        
        if(currentUser && allUsersData[currentUser.username]) {
            currentUser = allUsersData[currentUser.username];
            updateUserUI();
        }
    });

    // --- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
    function checkSavedSession() {
        const saved = localStorage.getItem('break_sys_v2');
        if(saved === 'admin') showAdmin();
        else if(saved && allUsersData[saved]) { currentUser = allUsersData[saved]; showEmployee(); }
        else showSection('loginSection');
    }

    function attemptLogin() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        
        if(u === 'admin' && p === '20002') { 
            localStorage.setItem('break_sys_v2', 'admin'); 
            showAdmin(); 
        } else if(allUsersData[u] && allUsersData[u].password === p) { 
            localStorage.setItem('break_sys_v2', u); 
            currentUser = allUsersData[u]; 
            showEmployee(); 
        } else {
            alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·Ø£');
        }
    }

    function showSection(id) {
        ['loginSection','adminSection','employeeSection'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function logout() { 
        localStorage.removeItem('break_sys_v2'); 
        currentUser=null; 
        clearInterval(timerInterval); 
        showSection('loginSection'); 
        stopAlarm();
    }

    function showAdmin() { showSection('adminSection'); switchAdminTab('monitor'); startTimer(); }
    function showEmployee() { showSection('employeeSection'); initUserDash(); }
    
    function switchAdminTab(tab) {
        ['tab-monitor','tab-reports','tab-users'].forEach(t => document.getElementById(t).classList.add('hidden'));
        document.getElementById('tab-'+tab).classList.remove('hidden');
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(!document.getElementById('adminSection').classList.contains('hidden')) renderMonitorTable();
            if(!document.getElementById('employeeSection').classList.contains('hidden')) updateUserUI();
        }, 1000);
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
    function renderUserManagementTable() {
        const tbody = document.getElementById('usersManagementBody');
        tbody.innerHTML = '';
        Object.values(allUsersData).forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td>${u.realName}</td>
                    <td>${u.username}</td>
                    <td>${u.password}</td>
                    <td>${u.allowance} Ø¯Ù‚ÙŠÙ‚Ø©</td>
                    <td>
                        <button onclick="prepareEdit('${u.username}')" class="btn btn-info btn-sm">âœï¸</button>
                        <button onclick="deleteUser('${u.username}')" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
        });
    }

    function saveUser() {
        const u = document.getElementById('newUsername').value.trim();
        const p = document.getElementById('newPassword').value;
        const n = document.getElementById('newRealName').value;
        const a = parseInt(document.getElementById('newAllowance').value);

        if(!u || !p || !n) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

        if(isEditing) {
            db.ref('users/' + u).update({ realName: n, password: p, allowance: a }).then(() => { alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); cancelEdit(); });
        } else {
            if(allUsersData[u]) return alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯!");
            db.ref('users/' + u).set({
                username: u, realName: n, password: p, allowance: a,
                usedSeconds: 0, prayerSeconds: 0, meetingSeconds: 0, isOnBreak: false
            }).then(() => { alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); cancelEdit(); });
        }
    }

    window.prepareEdit = (u) => {
        isEditing = true;
        const user = allUsersData[u];
        document.getElementById('newUsername').value = user.username;
        document.getElementById('newUsername').disabled = true;
        document.getElementById('newPassword').value = user.password;
        document.getElementById('newRealName').value = user.realName;
        document.getElementById('newAllowance').value = user.allowance;
        document.getElementById('saveUserBtn').innerText = "ØªØ¹Ø¯ÙŠÙ„";
        document.getElementById('cancelEditBtn').classList.remove('hidden');
    }

    window.cancelEdit = () => {
        isEditing = false;
        document.getElementById('newUsername').value = '';
        document.getElementById('newUsername').disabled = false;
        document.getElementById('newPassword').value = '';
        document.getElementById('newRealName').value = '';
        document.getElementById('newAllowance').value = '45';
        document.getElementById('saveUserBtn').innerText = "Ø­ÙØ¸";
        document.getElementById('cancelEditBtn').classList.add('hidden');
    }

    window.deleteUser = (u) => { if(confirm("Ø­Ø°ÙØŸ")) db.ref('users/'+u).remove(); }

    // --- Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (Admin) ---
    function renderMonitorTable() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        Object.values(allUsersData).forEach(u => {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let gen = u.usedSeconds || 0;
            let prayer = u.prayerSeconds || 0;
            let meet = u.meetingSeconds || 0;
            let currentDuration = 0;

            if (u.isOnBreak && u.lastStartTime) {
                currentDuration = Math.floor((Date.now() - u.lastStartTime) / 1000);
                if (u.breakType === 'general') gen += currentDuration;
                else if (u.breakType === 'prayer') prayer += currentDuration;
                else if (u.breakType === 'meeting') meet += currentDuration;
            }

            // Ø§Ù„Ø­Ø§Ù„Ø©
            let statusBadge = '<span class="status-badge bg-green">Ù…ØªØ§Ø­</span>';
            if (u.isOnBreak) {
                if (u.breakType === 'general') statusBadge = `<span class="status-badge bg-red">â›” Ø¨Ø±ÙŠÙƒ (${u.lastReason})</span>`;
                else if (u.breakType === 'prayer') statusBadge = `<span class="status-badge bg-blue">ğŸ•Œ ÙŠØµÙ„ÙŠ</span>`;
                else if (u.breakType === 'meeting') statusBadge = `<span class="status-badge bg-orange">ğŸ¤ Ù…ÙŠØªÙ†Ø¬</span>`;
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø¹Ø§Ù…
            const allowanceSec = u.allowance * 60;
            const remaining = allowanceSec - gen;
            const remDisplay = remaining >= 0 
                ? `<span style="color:var(--success-color)">${formatTime(remaining)}</span>` 
                : `<span style="color:red; font-weight:bold;">ØªØ¬Ø§ÙˆØ² ${formatTime(Math.abs(remaining))}</span>`;

            // Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù‚Ø³Ø±ÙŠ
            const actionBtn = u.isOnBreak 
                ? `<button onclick="forceStop('${u.username}')" class="btn btn-warning btn-sm">Ø¥Ù†Ù‡Ø§Ø¡</button>` 
                : '-';

            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold">${u.realName}</td>
                    <td>${statusBadge}</td>
                    <td>${remDisplay}</td>
                    <td style="color:var(--prayer-color)">${formatTime(prayer)}</td>
                    <td style="color:var(--meeting-color)">${formatTime(meet)}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        });
    }

    window.forceStop = (username) => {
        if(!confirm("Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ù…ÙˆØ¸ÙØŸ")) return;
        const u = allUsersData[username];
        const d = Math.floor((Date.now() - u.lastStartTime) / 1000);
        
        const updates = { isOnBreak: false, lastStartTime: null };
        if(u.breakType === 'general') updates.usedSeconds = (u.usedSeconds||0) + d;
        else if(u.breakType === 'prayer') updates.prayerSeconds = (u.prayerSeconds||0) + d;
        else if(u.breakType === 'meeting') updates.meetingSeconds = (u.meetingSeconds||0) + d;

        db.ref('users/'+username).update(updates);
        // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
        db.ref('users/'+username+'/dailyLogs/'+Date.now()).set({ 
            reason: (u.lastReason || u.breakType) + " (Admin Stop)", 
            duration: d, 
            type: u.breakType,
            time: new Date().toLocaleTimeString('ar-EG') 
        });
    }

    window.endDay = () => {
        if(!confirm("Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ… ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§ØªØŸ")) return;
        const today = new Date().toLocaleDateString('ar-EG');
        const updates = {};
        
        Object.values(allUsersData).forEach(u => {
            let gen = u.usedSeconds || 0;
            let pra = u.prayerSeconds || 0;
            let met = u.meetingSeconds || 0;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬Ø§Ø±ÙŠ Ù„Ùˆ Ù„Ø³Ø§ ÙØ§ØªØ­
            if(u.isOnBreak) {
                const d = Math.floor((Date.now() - u.lastStartTime) / 1000);
                if(u.breakType === 'general') gen += d;
                else if(u.breakType === 'prayer') pra += d;
                else if(u.breakType === 'meeting') met += d;
            }

            const k = Date.now();
            updates['users/'+u.username+'/history/'+k] = { 
                date: today, 
                totalGeneral: gen, 
                totalPrayer: pra, 
                totalMeeting: met, 
                allowance: u.allowance*60,
                details: u.dailyLogs || {} 
            };
            
            updates['users/'+u.username+'/usedSeconds'] = 0;
            updates['users/'+u.username+'/prayerSeconds'] = 0;
            updates['users/'+u.username+'/meetingSeconds'] = 0;
            updates['users/'+u.username+'/isOnBreak'] = false;
            updates['users/'+u.username+'/lastStartTime'] = null;
            updates['users/'+u.username+'/dailyLogs'] = null;
            updates['users/'+u.username+'/breakType'] = null;
            updates['users/'+u.username+'/lastReason'] = "";
        });
        db.ref().update(updates).then(() => alert("ØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…"));
    }

    // --- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ---
    window.updateReportSelect = () => {
        const sel = document.getElementById('reportUserSelect');
        if(sel.options.length <= 1) {
             Object.values(allUsersData).forEach(u => sel.innerHTML += `<option value="${u.username}">${u.realName}</option>`);
        }
    }

    window.renderUserReport = () => {
        const uName = document.getElementById('reportUserSelect').value;
        const sDate = document.getElementById('filterStartDate').value;
        const eDate = document.getElementById('filterEndDate').value;
        const tbody = document.getElementById('reportBody');
        const summary = document.getElementById('overtimeSummary');
        
        tbody.innerHTML = ''; summary.classList.add('hidden');
        if(!uName || !allUsersData[uName].history) return tbody.innerHTML='<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';

        const hist = allUsersData[uName].history;
        const startTs = sDate ? new Date(sDate).setHours(0,0,0,0) : 0;
        const endTs = eDate ? new Date(eDate).setHours(23,59,59,999) : 9999999999999;
        let totalOver = 0;

        Object.keys(hist).sort().reverse().forEach(k => {
            if(k >= startTs && k <= endTs) {
                const h = hist[k];
                const diff = h.allowance - h.totalGeneral;
                if(diff < 0) totalOver += Math.abs(diff);

                let dList = '<ul style="text-align:right; font-size:0.8rem; margin:0; padding-right:15px;">';
                if(h.details) Object.values(h.details).forEach(d => {
                    let icon = d.type === 'meeting' ? 'ğŸ¤' : (d.type === 'prayer' ? 'ğŸ•Œ' : 'â˜•');
                    dList += `<li>${icon} ${d.reason} <span style="color:#777">(${formatTime(d.duration)})</span></li>`;
                });
                dList += '</ul>';

                tbody.innerHTML += `
                    <tr>
                        <td>${h.date}</td>
                        <td>${dList}</td>
                        <td>${formatTime(h.totalGeneral)} / ${formatTime(h.allowance)}</td>
                        <td style="color:var(--prayer-color)">${formatTime(h.totalPrayer || 0)}</td>
                        <td style="color:var(--meeting-color)">${formatTime(h.totalMeeting || 0)}</td>
                        <td>${diff>=0 ? '<span class="status-badge bg-green">ØªÙ…Ø§Ù…</span>' : '<span class="status-badge bg-red">ØªØ¬Ø§ÙˆØ²</span>'}</td>
                    </tr>
                `;
            }
        });

        if(totalOver > 0) {
            summary.classList.remove('hidden');
            summary.innerHTML = `âš ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙˆÙ‚Øª (Overtime) ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©: ${formatTime(totalOver)}`;
            summary.style.background = "#ffeaa7"; summary.style.color = "#d35400";
        }
    }

    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ ---
    function initUserDash() {
        document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.realName}`;
        startTimer();
    }

    // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø¨Ø£Ù†ÙˆØ§Ø¹Ù‡
    window.startMyBreak = (type) => {
        if(currentUser.isOnBreak) return alert("Ø£Ù†Øª ÙÙŠ Ù†Ø´Ø§Ø· Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ù‡Ø§Ø¦Ù‡ Ø£ÙˆÙ„Ø§Ù‹.");
        
        let reason = "";
        if(type === 'general') {
            reason = document.getElementById('breakReason').value.trim();
            if(!reason) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ø±ÙŠÙƒ");
        } else if(type === 'prayer') {
            reason = "ØµÙ„Ø§Ø©";
        } else if(type === 'meeting') {
            reason = "Ù…ÙŠØªÙ†Ø¬";
        }

        db.ref('users/' + currentUser.username).update({
            isOnBreak: true,
            breakType: type,
            lastStartTime: Date.now(),
            lastReason: reason
        });
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ
    window.stopMyBreak = () => {
        if(!currentUser.isOnBreak) return;
        
        const type = currentUser.breakType;
        const duration = Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
        
        const updates = {
            isOnBreak: false,
            lastStartTime: null,
            breakType: null,
            lastReason: ""
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        if(type === 'general') updates.usedSeconds = (currentUser.usedSeconds || 0) + duration;
        else if(type === 'prayer') updates.prayerSeconds = (currentUser.prayerSeconds || 0) + duration;
        else if(type === 'meeting') updates.meetingSeconds = (currentUser.meetingSeconds || 0) + duration;

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
        const logEntry = {
            reason: currentUser.lastReason,
            duration: duration,
            type: type,
            time: new Date().toLocaleTimeString('ar-EG')
        };
        
        db.ref('users/' + currentUser.username).update(updates);
        db.ref('users/' + currentUser.username + '/dailyLogs/' + Date.now()).set(logEntry);
        
        // Ù…Ø³Ø­ Ø®Ø§Ù†Ø© Ø§Ù„Ø³Ø¨Ø¨
        document.getElementById('breakReason').value = "";
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ù…ÙˆØ¸Ù
    function updateUserUI() {
        const controls = document.getElementById('controlsArea');
        const stopBtn = document.getElementById('stopArea');
        const timerDisplay = document.getElementById('userTimer');
        const label = document.getElementById('timerLabel');
        const statusMsg = document.getElementById('userStatusMsg');
        const alertEl = document.getElementById('overtimeAlert');

        if(currentUser.isOnBreak) {
            // Ø­Ø§Ù„Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¨Ø±ÙŠÙƒ/ØµÙ„Ø§Ø©/Ù…ÙŠØªÙ†Ø¬
            controls.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            
            const elapsed = Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
            
            if(currentUser.breakType === 'meeting') {
                // Ù…ÙŠØªÙ†Ø¬: Ø¹Ø¯Ø§Ø¯ ØªØµØ§Ø¹Ø¯ÙŠ Ù…Ù† 0
                label.innerText = "ÙÙŠ Ù…ÙŠØªÙ†Ø¬ ğŸ¤ (Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠØ¹Ø¯)";
                timerDisplay.innerText = formatTime(elapsed);
                timerDisplay.style.color = "var(--meeting-color)";
                statusMsg.innerText = "";
                stopAlarm();
            } else if(currentUser.breakType === 'prayer') {
                // ØµÙ„Ø§Ø©: Ø¹Ø¯Ø§Ø¯ ØªØµØ§Ø¹Ø¯ÙŠ Ù…Ù† 0
                label.innerText = "ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© ğŸ•Œ";
                timerDisplay.innerText = formatTime(elapsed);
                timerDisplay.style.color = "var(--prayer-color)";
                statusMsg.innerText = "";
                stopAlarm();
            } else {
                // Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…: ÙŠØ®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
                const totalUsed = (currentUser.usedSeconds || 0) + elapsed;
                const remaining = (currentUser.allowance * 60) - totalUsed;
                
                label.innerText = `ÙÙŠ Ø¨Ø±ÙŠÙƒ: ${currentUser.lastReason}`;
                
                if(remaining >= 0) {
                    timerDisplay.innerText = formatTime(remaining);
                    timerDisplay.style.color = "var(--primary-color)";
                    statusMsg.innerText = "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯";
                    stopAlarm();
                } else {
                    timerDisplay.innerText = "-" + formatTime(Math.abs(remaining));
                    timerDisplay.style.color = "red";
                    statusMsg.innerText = "ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­!";
                    playAlarm();
                }
            }

        } else {
            // Ø­Ø§Ù„Ø©: Ø§Ù„Ù…ÙˆØ¸Ù Ù…ØªØ§Ø­ (Ù„ÙŠØ³ ÙÙŠ Ø¨Ø±ÙŠÙƒ)
            controls.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            alertEl.classList.add('hidden');
            stopAlarm();

            const remaining = (currentUser.allowance * 60) - (currentUser.usedSeconds || 0);
            label.innerText = "Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ";
            
            if(remaining >= 0) {
                timerDisplay.innerText = formatTime(remaining);
                timerDisplay.style.color = "var(--dark-text)";
                statusMsg.innerText = "";
            } else {
                timerDisplay.innerText = "00:00"; // Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
                statusMsg.innerText = `Ù„Ø¯ÙŠÙƒ ØªØ¬Ø§ÙˆØ² Ø³Ø§Ø¨Ù‚: ${formatTime(Math.abs(remaining))}`;
                statusMsg.style.color = "red";
            }
        }
    }

    function playAlarm() {
        document.body.classList.add('alarm-mode');
        document.getElementById('overtimeAlert').classList.remove('hidden');
        const audio = document.getElementById('alarmSound');
        if(audio.paused) audio.play().catch(e=>console.log(e));
    }
    
    function stopAlarm() {
        document.body.classList.remove('alarm-mode');
        document.getElementById('overtimeAlert').classList.add('hidden');
        const audio = document.getElementById('alarmSound');
        audio.pause(); audio.currentTime=0;
    }

    function formatTime(s) {
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        return `${m}:${sec}`;
    }
</script>
</body>
</html>
