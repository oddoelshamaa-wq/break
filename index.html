<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª - Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ² -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #ff6b6b;
            --success-color: #1dd1a1;
            --meeting-color: #f39c12;
            --prayer-color: #3498db;
            --emergency-color: #c0392b;
            --dark-text: #2d3436;
            --light-bg: #f7f9fc;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            color: var(--dark-text);
            transition: background 0.3s;
        }

        /* ÙˆÙ…ÙŠØ¶ Ø£Ø­Ù…Ø± Ù„Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… Ø£Ùˆ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ */
        @keyframes flash-red {
            0% { background-color: #ffcccc; box-shadow: inset 0 0 0 0 red; }
            50% { background-color: #ff0000; box-shadow: inset 0 0 50px 20px red; }
            100% { background-color: #ffcccc; box-shadow: inset 0 0 0 0 red; }
        }

        .alarm-mode {
            background: none !important;
            animation: flash-red 0.8s infinite;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        h2, h3 { color: #2c3e50; text-align: center; font-weight: 700; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            color: white;
            transition: all 0.3s ease;
            margin: 3px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .btn-primary { background: linear-gradient(45deg, #4e54c8, #8f94fb); }
        .btn-danger { background: linear-gradient(45deg, #ee5253, #ff6b6b); }
        .btn-success { background: linear-gradient(45deg, #10ac84, #1dd1a1); }
        .btn-warning { background: linear-gradient(45deg, #f39c12, #f1c40f); color: #fff; }
        .btn-info { background: linear-gradient(45deg, #3498db, #2980b9); }
        .btn-dark { background: #2d3436; }
        .btn-purple { background: linear-gradient(45deg, #8e44ad, #9b59b6); } 
        .btn-emergency { background: linear-gradient(45deg, #c0392b, #e74c3c); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } 100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } }

        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-family: 'Cairo', sans-serif;
        }
        input:focus { outline: none; border-color: var(--primary-color); }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            font-size: 0.95rem;
        }
        th { background: #2d3436; color: white; padding: 15px; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background-color: #f8f9fa; }

        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; flex-wrap: wrap;}
        .hidden { display: none !important; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .bg-red { background-color: #ff7675; color: white; }
        .bg-green { background-color: #55efc4; color: #2d3436; }
        .bg-orange { background-color: #f39c12; color: white; }
        .bg-blue { background-color: #3498db; color: white; }
        .bg-purple { background-color: #9b59b6; color: white; }
        .bg-dark-red { background-color: #c0392b; color: white; }
        
        .timer-display { font-size: 3.5rem; font-weight: 800; color: var(--primary-color); margin: 15px 0; }
        .timer-label { font-size: 1.2rem; color: #777; margin-bottom: 5px; }

        .employee-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .control-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: #f8f9fa;
        }
        .control-card:hover { transform: translateY(-5px); }
        
        .card-general { border-color: var(--success-color); }
        .card-prayer { border-color: var(--prayer-color); }
        .card-meeting { border-color: var(--meeting-color); }
        .card-emergency { border-color: var(--emergency-color); background: #fff0f0; }

        .filter-box {
            background: #f1f2f6; padding: 20px; border-radius: 15px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; align-items: end; border: 1px solid #ddd;
        }

        .online-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .dot-green { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .dot-grey { background-color: #95a5a6; }

        .settings-box {
            background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;
        }

        .manager-info {
            background: #2d3436; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;
        }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loading">
    <div class="loader"></div>
    <h3 style="color: var(--primary-color);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</h3>
</div>

<!-- Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª -->
<audio id="alarmSound" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<div class="container hidden" id="mainContainer">
    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginSection">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: var(--primary-color);">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h1>
            <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª ÙˆØ§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… (Ø§Ù„Ù…Ø·ÙˆØ±)</p>
        </div>
        <div style="max-width: 400px; margin: auto;">
            <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (manager1, manager2...)">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; margin-top: 10px;">Ø¯Ø®ÙˆÙ„</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#777; text-align:center;">
                Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†: manager1, manager2, manager3<br>
                ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¬Ù…ÙŠØ¹: 123
            </p>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† -->
    <div id="adminSection" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <div>
                <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸš€</h2>
                <span id="currentManagerDisplay" class="manager-info"></span>
            </div>
            <button onclick="logout()" class="btn btn-dark">Ø®Ø±ÙˆØ¬ ğŸ”’</button>
        </div>

        <div class="nav-tabs">
            <button onclick="switchAdminTab('monitor')" class="btn btn-primary">ğŸ“¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
            <button onclick="switchAdminTab('requests')" class="btn btn-emergency">ğŸš¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©</button>
            <button onclick="switchAdminTab('overtime')" class="btn btn-purple">ğŸ•’ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</button>
            <button onclick="switchAdminTab('reports')" class="btn btn-warning">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</button>
            <button onclick="switchAdminTab('users')" class="btn btn-success">âš™ï¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© -->
        <div id="tab-monitor">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¢Ù†</h3>
                <button onclick="endDay()" class="btn btn-danger">ğŸ›‘ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ…</button>
            </div>
            <div id="activeBreakCount" style="text-align:center; margin:10px 0; font-weight:bold; color:var(--primary-color);"></div>
            <table id="monitorTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù… (Ù…ØªØ¨Ù‚ÙŠ)</th>
                        <th>ØµÙ„Ø§Ø©</th>
                        <th>Ù…ÙŠØªÙ†Ø¬</th>
                        <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="monitorBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© -->
        <div id="tab-requests" class="hidden">
            <h3>ğŸš¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
            <table id="emergencyRequestsTable">
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="emergencyRequestsBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="tab-overtime" class="hidden">
            <h3>âš™ï¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</h3>
            <div class="settings-box">
                <label style="font-weight:bold;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù…:</label>
                <div style="display:flex; max-width:300px; margin:10px auto; gap:10px;">
                    <input type="number" id="maxBreaksInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: 2" style="margin:0;">
                    <button onclick="saveSettings()" class="btn btn-success">Ø­ÙØ¸</button>
                </div>
            </div>
            <table id="overtimeRequestsTable">
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th><th>ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="overtimeRequestsBody"></tbody>
            </table>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <div id="tab-reports" class="hidden">
            <h3>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„</h3>
            <div class="filter-box">
                <div><label>Ø§Ù„Ù…ÙˆØ¸Ù:</label><select id="reportUserSelect"><option value="">-- Ø§Ø®ØªØ± --</option></select></div>
                <div><label>Ù…Ù†:</label><input type="date" id="filterStartDate"></div>
                <div><label>Ø¥Ù„Ù‰:</label><input type="date" id="filterEndDate"></div>
                <div><button onclick="renderUserReport()" class="btn btn-primary" style="width: 100%;">Ø¨Ø­Ø« ğŸ”</button></div>
            </div>
            
            <div style="margin-top:20px;">
                <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… (Ù…Ù† ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡)</h4>
                <table id="overtimeReportTable">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th><th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚ (Ø§Ù„Ù…Ø¯ÙŠØ±)</th></tr></thead>
                    <tbody id="overtimeReportBody"></tbody>
                </table>
            </div>

            <div style="margin-top:20px;">
                <h4>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h4>
                <table id="reportTable">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø±ÙŠÙƒ</th><th>ØµÙ„Ø§Ø©</th><th>Ù…ÙŠØªÙ†Ø¬</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</th></tr></thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="tab-users" class="hidden">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px dashed #ccc; margin-bottom: 20px;">
                <h4 style="margin-top:0; color: var(--primary-color);">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="newRealName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
                    <input type="text" id="newUsername" placeholder="User Name">
                    <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <input type="number" id="newAllowance" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… (Ø¯Ù‚ÙŠÙ‚Ø©)" value="45">
                </div>
                <button onclick="saveUser()" class="btn btn-success" style="width:100%; margin-top:10px;">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            </div>
            <table id="usersManagementTable">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>User</th><th>Pass</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="usersManagementBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div id="employeeSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <h4 id="welcomeMsg" style="margin:0;"></h4>
             <button onclick="logout()" class="btn btn-dark btn-sm">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div style="text-align: center;">
            <div style="background: #f1f2f6; padding: 20px; border-radius: 30px; margin: 20px auto; max-width: 600px;">
                <div id="timerLabel" class="timer-label">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</div>
                <div class="timer-display" id="userTimer">00:00</div>
                <h3 id="userStatusMsg"></h3>
                <div id="overtimeAlert" class="hidden status-badge bg-red" style="font-size: 1.2rem; padding: 10px;">ØªØ¬Ø§ÙˆØ²Øª ÙˆÙ‚Øª Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…Ø³Ù…ÙˆØ­!</div>
            </div>

            <div id="controlsArea">
                <div style="max-width: 400px; margin: auto; margin-bottom: 15px;">
                    <input type="text" id="breakReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ø±ÙŠÙƒ..." style="text-align: center;">
                </div>

                <div class="employee-controls">
                    <div class="control-card card-general">
                        <h4>ğŸ” Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…</h4>
                        <button onclick="startMyBreak('general')" class="btn btn-success" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>
                    <div class="control-card card-prayer">
                        <h4>ğŸ•Œ ØµÙ„Ø§Ø©</h4>
                        <button onclick="startMyBreak('prayer')" class="btn btn-info" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>
                    <div class="control-card card-meeting">
                        <h4>ğŸ¤ Ù…ÙŠØªÙ†Ø¬</h4>
                        <button onclick="startMyBreak('meeting')" class="btn btn-warning" style="width:100%">Ø¨Ø¯Ø¡</button>
                    </div>
                    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                    <div class="control-card card-emergency">
                        <h4>ğŸš¨ Ø®Ø±ÙˆØ¬ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ</h4>
                        <p style="font-size:0.75rem; color:#c0392b;">ÙŠØªØ·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</p>
                        <div id="emergencyStatusArea">
                            <button onclick="requestEmergency()" id="btnReqEmergency" class="btn btn-dark btn-sm" style="width:100%">Ø·Ù„Ø¨ Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; border-top: 2px dashed #ddd; padding-top: 20px;">
                    <h4 style="color: #8e44ad;">ğŸ’¼ Ø·Ù„Ø¨ Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠ (Overtime)</h4>
                    <div id="overtimeRequestForm">
                        <div style="display:flex; max-width:400px; margin:auto; gap:10px;">
                            <input type="number" id="otHours" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª" style="margin:0;">
                            <button onclick="requestOvertime()" class="btn btn-purple">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                        </div>
                    </div>
                    <div id="overtimeStatus" style="margin-top:10px; font-weight:bold;"></div>
                </div>
            </div>

            <div id="stopArea" class="hidden" style="margin-top: 20px;">
                <button onclick="stopMyBreak()" class="btn btn-danger" style="padding: 15px 40px; font-size: 1.5rem; width: 100%; max-width: 300px;">ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ²
    const firebaseConfig = {
        apiKey: "AIzaSyC2J8fVx7qAz_g33gUNQxXMEJHsWeFrjuk",
        authDomain: "break-3ccd9.firebaseapp.com",
        projectId: "break-3ccd9",
        storageBucket: "break-3ccd9.firebasestorage.app",
        messagingSenderId: "785237776836",
        appId: "1:785237776836:web:0a0062bf07359391fd6c91",
        databaseURL: "https://break-3ccd9-default-rtdb.firebaseio.com/"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch (e) { console.error(e); }

    let allUsersData = {};
    let globalSettings = { maxGeneralBreaks: 100 };
    let currentUser = null; // ÙŠØ­Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±
    let timerInterval = null;
    let isDataLoaded = false;
    
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù… (Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ù… Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ† Ø¨ØµÙØ© Ù…Ø¯ÙŠØ±)
    // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø³Ù†Ø®Ø²Ù†Ù‡Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const MANAGERS = ['manager1', 'manager2', 'manager3'];

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙˆÙ†ÙˆØ§ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
    function initManagers() {
        MANAGERS.forEach(m => {
            db.ref('users/' + m).once('value', snap => {
                if (!snap.exists()) {
                    db.ref('users/' + m).set({
                        username: m,
                        realName: "Ø§Ù„Ù…Ø¯ÙŠØ± " + m.replace('manager',''),
                        password: "123",
                        role: "admin",
                        state: "offline"
                    });
                } else {
                    // ØªØ£ÙƒØ¯ Ø£Ù† Ù„Ø¯ÙŠÙ‡Ù… ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†
                    if(snap.val().role !== 'admin') db.ref('users/' + m).update({ role: 'admin' });
                }
            });
        });
    }

    db.ref('settings').on('value', snap => {
        if(snap.val()) {
            globalSettings = snap.val();
            document.getElementById('maxBreaksInput').value = globalSettings.maxGeneralBreaks || '';
        }
    });

    db.ref('users').on('value', (snapshot) => {
        const data = snapshot.val();
        allUsersData = data || {};
        
        if (!isDataLoaded) {
            isDataLoaded = true;
            initManagers(); // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('hidden');
            checkSavedSession();
        }

        if(!document.getElementById('adminSection').classList.contains('hidden')) {
            renderMonitorTable();
            renderUserManagementTable();
            renderOvertimeRequests();
            renderEmergencyRequests();
            updateReportSelect();
        }
        
        if(currentUser && allUsersData[currentUser.username]) {
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù…ÙˆØ¸Ù)
            const updated = allUsersData[currentUser.username];
            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆÙ„
            updated.role = currentUser.role; 
            currentUser = updated;
            
            if(currentUser.role !== 'admin') updateUserUI();
        }
    });

    // --- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
    function checkSavedSession() {
        const savedUser = localStorage.getItem('break_sys_user');
        const savedRole = localStorage.getItem('break_sys_role');
        
        if(savedUser && allUsersData[savedUser]) {
            currentUser = allUsersData[savedUser];
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸ ÙƒØ£Ø¯Ù…Ù†
            if (currentUser.role === 'admin' || MANAGERS.includes(savedUser)) {
                currentUser.role = 'admin'; // ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                showAdmin();
            } else {
                setupPresence(savedUser);
                showEmployee();
            }
        } else {
            showSection('loginSection');
        }
    }

    function attemptLogin() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        
        if(allUsersData[u] && allUsersData[u].password === p) {
            currentUser = allUsersData[u];
            
            if(currentUser.role === 'admin') {
                localStorage.setItem('break_sys_user', u);
                localStorage.setItem('break_sys_role', 'admin');
                showAdmin();
            } else {
                localStorage.setItem('break_sys_user', u);
                localStorage.setItem('break_sys_role', 'employee');
                setupPresence(u);
                showEmployee();
            }
        } else {
            alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·Ø£');
        }
    }

    function setupPresence(username) {
        const connectedRef = db.ref(".info/connected");
        const userStatusRef = db.ref("users/" + username + "/state");
        connectedRef.on("value", (snap) => {
            if (snap.val() === false) return;
            userStatusRef.onDisconnect().set("offline").then(() => userStatusRef.set("online"));
        });
    }

    function showSection(id) {
        ['loginSection','adminSection','employeeSection'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function logout() { 
        if(currentUser && currentUser.role !== 'admin') {
            db.ref("users/" + currentUser.username + "/state").set("offline");
        }
        localStorage.removeItem('break_sys_user'); 
        localStorage.removeItem('break_sys_role');
        currentUser=null; 
        clearInterval(timerInterval); 
        showSection('loginSection'); 
        stopAlarm();
    }

    function showAdmin() { 
        showSection('adminSection'); 
        document.getElementById('currentManagerDisplay').innerText = `ğŸ‘¤ ${currentUser.realName}`;
        switchAdminTab('monitor'); 
        startTimer(); 
    }
    function showEmployee() { showSection('employeeSection'); initUserDash(); }
    
    function switchAdminTab(tab) {
        ['tab-monitor','tab-reports','tab-users', 'tab-overtime', 'tab-requests'].forEach(t => document.getElementById(t).classList.add('hidden'));
        document.getElementById('tab-'+tab).classList.remove('hidden');
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(!document.getElementById('adminSection').classList.contains('hidden')) renderMonitorTable();
            if(!document.getElementById('employeeSection').classList.contains('hidden')) updateUserUI();
        }, 1000);
    }

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ (Admin) ---
    function renderEmergencyRequests() {
        const tbody = document.getElementById('emergencyRequestsBody');
        tbody.innerHTML = '';
        let count = 0;

        Object.values(allUsersData).forEach(u => {
            if(u.emergencyRequest && u.emergencyRequest.status === 'pending') {
                count++;
                tbody.innerHTML += `
                    <tr>
                        <td>${u.realName}</td>
                        <td style="color:red; font-weight:bold;">${u.emergencyRequest.reason}</td>
                        <td>${new Date(u.emergencyRequest.timestamp).toLocaleTimeString('ar-EG')}</td>
                        <td>
                            <button onclick="handleEmergency('${u.username}', true)" class="btn btn-success btn-sm">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                            <button onclick="handleEmergency('${u.username}', false)" class="btn btn-danger btn-sm">Ø±ÙØ¶</button>
                        </td>
                    </tr>
                `;
            }
        });
        if(count === 0) tbody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
    }

    window.handleEmergency = (username, approved) => {
        if(!currentUser || currentUser.role !== 'admin') return alert("ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø¯ÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø©");
        
        const updates = {};
        updates[`users/${username}/emergencyRequest/status`] = approved ? 'approved' : 'rejected';
        updates[`users/${username}/emergencyRequest/approvedBy`] = currentUser.realName; // ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±
        
        db.ref().update(updates).then(() => alert(approved ? "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨" : "ØªÙ… Ø§Ù„Ø±ÙØ¶"));
    }

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… (Admin) ---
    function renderOvertimeRequests() {
        const tbody = document.getElementById('overtimeRequestsBody');
        tbody.innerHTML = '';
        
        Object.values(allUsersData).forEach(u => {
            if(u.overtimeRequest && u.overtimeRequest.status === 'pending') {
                tbody.innerHTML += `
                    <tr>
                        <td>${u.realName}</td>
                        <td style="font-weight:bold; color:#8e44ad;">${u.overtimeRequest.hours} Ø³Ø§Ø¹Ø§Øª</td>
                        <td>${new Date(u.overtimeRequest.timestamp).toLocaleTimeString('ar-EG')}</td>
                        <td>
                            <button onclick="handleOvertime('${u.username}', true)" class="btn btn-success btn-sm">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                            <button onclick="handleOvertime('${u.username}', false)" class="btn btn-danger btn-sm">Ø±ÙØ¶</button>
                        </td>
                    </tr>
                `;
            }
        });
        if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
    }

    window.handleOvertime = (username, approved) => {
        const req = allUsersData[username].overtimeRequest;
        if(!req) return;
        
        const updates = {};
        updates[`users/${username}/overtimeRequest/status`] = approved ? 'approved' : 'rejected';
        updates[`users/${username}/overtimeRequest/handledBy`] = currentUser.realName;

        if(approved) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ù„Ù„Ø±ØµÙŠØ¯
            const currentBalance = allUsersData[username].approvedOvertimeBalance || 0;
            updates[`users/${username}/approvedOvertimeBalance`] = currentBalance + parseFloat(req.hours);
            
            // (Ø¬Ø¯ÙŠØ¯) ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
            const historyKey = Date.now();
            updates[`users/${username}/overtimeHistory/${historyKey}`] = {
                date: new Date().toLocaleDateString('ar-EG'),
                hours: parseFloat(req.hours),
                approvedBy: currentUser.realName // ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø°ÙŠ ÙˆØ§ÙÙ‚
            };
        }
        
        db.ref().update(updates);
    };

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
    function renderUserManagementTable() {
        const tbody = document.getElementById('usersManagementBody');
        tbody.innerHTML = '';
        Object.values(allUsersData).forEach(u => {
            if(u.role === 'admin') return; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ù‡Ù†Ø§
            tbody.innerHTML += `
                <tr>
                    <td>${u.realName}</td>
                    <td>${u.username}</td>
                    <td>${u.password}</td>
                    <td>${u.allowance} Ø¯Ù‚ÙŠÙ‚Ø©</td>
                    <td><button onclick="deleteUser('${u.username}')" class="btn btn-danger btn-sm">Ø­Ø°Ù</button></td>
                </tr>`;
        });
    }

    function saveUser() {
        const u = document.getElementById('newUsername').value.trim();
        const p = document.getElementById('newPassword').value;
        const n = document.getElementById('newRealName').value;
        const a = parseInt(document.getElementById('newAllowance').value);

        if(!u || !p || !n) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        if(allUsersData[u]) return alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯!");
        
        db.ref('users/' + u).set({
            username: u, realName: n, password: p, allowance: a,
            role: 'employee', state: 'offline'
        }).then(() => alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©"));
    }

    window.deleteUser = (u) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ")) db.ref('users/'+u).remove(); }
    window.saveSettings = () => {
        const max = document.getElementById('maxBreaksInput').value;
        db.ref('settings').update({ maxGeneralBreaks: parseInt(max) }).then(()=>alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"));
    }

    // --- Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ---
    function renderMonitorTable() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        let activeGeneralBreaks = 0;

        Object.values(allUsersData).forEach(u => {
            if(u.role === 'admin') return; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©

            let gen = u.usedSeconds || 0;
            let currentDuration = 0;

            if (u.isOnBreak && u.lastStartTime) {
                currentDuration = Math.floor((Date.now() - u.lastStartTime) / 1000);
                if (u.breakType === 'general' || u.breakType === 'emergency') {
                    gen += currentDuration;
                    if(u.breakType === 'general') activeGeneralBreaks++;
                }
            }

            const isOnline = u.state === 'online';
            const onlineIndicator = `<span class="online-dot ${isOnline ? 'dot-green' : 'dot-grey'}"></span>`;

            let statusBadge = '<span class="status-badge bg-green">Ù…ØªØ§Ø­</span>';
            if (u.isOnBreak) {
                if (u.breakType === 'general') statusBadge = `<span class="status-badge bg-red">â›” Ø¨Ø±ÙŠÙƒ (${u.lastReason})</span>`;
                else if (u.breakType === 'prayer') statusBadge = `<span class="status-badge bg-blue">ğŸ•Œ ÙŠØµÙ„ÙŠ</span>`;
                else if (u.breakType === 'meeting') statusBadge = `<span class="status-badge bg-orange">ğŸ¤ Ù…ÙŠØªÙ†Ø¬</span>`;
                else if (u.breakType === 'emergency') statusBadge = `<span class="status-badge bg-dark-red">ğŸš¨ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ</span>`;
            }

            const allowanceSec = u.allowance * 60;
            const remaining = allowanceSec - gen;
            const remDisplay = remaining >= 0 ? formatTime(remaining) : `<span style="color:red">${formatTime(Math.abs(remaining))}</span>`;

            const actionBtn = u.isOnBreak ? `<button onclick="forceStop('${u.username}')" class="btn btn-warning btn-sm">Ø¥Ù†Ù‡Ø§Ø¡</button>` : '-';

            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold">${u.realName} ${onlineIndicator}</td>
                    <td>${statusBadge}</td>
                    <td>${remDisplay}</td>
                    <td>${formatTime(u.prayerSeconds || 0)}</td>
                    <td>${formatTime(u.meetingSeconds || 0)}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        });

        const limit = globalSettings.maxGeneralBreaks || 100;
        document.getElementById('activeBreakCount').innerHTML = 
            `ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù…: <span style="font-size:1.2em; ${activeGeneralBreaks >= limit ? 'color:red' : 'color:green'}">${activeGeneralBreaks} / ${limit}</span>`;
    }

    window.forceStop = (username) => {
        if(!confirm("Ø¥Ù†Ù‡Ø§Ø¡ Ù„Ù„Ù…ÙˆØ¸ÙØŸ")) return;
        const u = allUsersData[username];
        const d = Math.floor((Date.now() - u.lastStartTime) / 1000);
        
        const updates = { isOnBreak: false, lastStartTime: null };
        if(u.breakType === 'general' || u.breakType === 'emergency') updates.usedSeconds = (u.usedSeconds||0) + d;
        else if(u.breakType === 'prayer') updates.prayerSeconds = (u.prayerSeconds||0) + d;
        else if(u.breakType === 'meeting') updates.meetingSeconds = (u.meetingSeconds||0) + d;

        db.ref('users/'+username).update(updates);
    }

    window.endDay = () => {
        if(!confirm("Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) return;
        const today = new Date().toLocaleDateString('ar-EG');
        const updates = {};
        
        Object.values(allUsersData).forEach(u => {
            if(u.role === 'admin') return;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØªØ§Ù„
            let gen = u.usedSeconds || 0;
            let pra = u.prayerSeconds || 0;
            let met = u.meetingSeconds || 0;
            if(u.isOnBreak) {
                const d = Math.floor((Date.now() - u.lastStartTime) / 1000);
                if(u.breakType === 'general' || u.breakType === 'emergency') gen += d;
                else if(u.breakType === 'prayer') pra += d;
                else if(u.breakType === 'meeting') met += d;
            }

            const k = Date.now();
            updates['users/'+u.username+'/history/'+k] = { 
                date: today, 
                totalGeneral: gen, 
                totalPrayer: pra, 
                totalMeeting: met, 
                approvedOvertime: u.approvedOvertimeBalance || 0
            };
            
            // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            updates['users/'+u.username+'/usedSeconds'] = 0;
            updates['users/'+u.username+'/prayerSeconds'] = 0;
            updates['users/'+u.username+'/meetingSeconds'] = 0;
            updates['users/'+u.username+'/isOnBreak'] = false;
            updates['users/'+u.username+'/lastStartTime'] = null;
            updates['users/'+u.username+'/breakType'] = null;
            updates['users/'+u.username+'/emergencyRequest'] = null;
            updates['users/'+u.username+'/overtimeRequest'] = null;
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†ØµÙØ± approvedOvertimeBalance Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø±ØµÙŠØ¯ Ø§Ù„Ø´Ù‡Ø±ØŒ 
            // Ù„ÙƒÙ† Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ù‡ Ø­Ø³Ø§Ø¨ ÙŠÙˆÙ…ÙŠØŒ ÙØ³Ù†ØµÙØ±Ù‡
            updates['users/'+u.username+'/approvedOvertimeBalance'] = 0;
        });
        db.ref().update(updates).then(() => alert("ØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„ âœ…"));
    }

    // --- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ ---
    window.updateReportSelect = () => {
        const sel = document.getElementById('reportUserSelect');
        if(sel.options.length <= 1) {
             Object.values(allUsersData).forEach(u => {
                 if(u.role !== 'admin') sel.innerHTML += `<option value="${u.username}">${u.realName}</option>`;
             });
        }
    }

    window.renderUserReport = () => {
        const uName = document.getElementById('reportUserSelect').value;
        const tbody = document.getElementById('reportBody');
        const otBody = document.getElementById('overtimeReportBody');
        
        tbody.innerHTML = ''; otBody.innerHTML = '';
        
        if(!uName) return;
        const user = allUsersData[uName];

        // 1. ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ… Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
        if(user.overtimeHistory) {
            let otCount = 0;
            let totalOtHours = 0;
            Object.values(user.overtimeHistory).forEach(ot => {
                otCount++;
                totalOtHours += ot.hours;
                otBody.innerHTML += `
                    <tr>
                        <td>${ot.date}</td>
                        <td style="color:#8e44ad; font-weight:bold;">${ot.hours} Ø³Ø§Ø¹Ø©</td>
                        <td>âœ… ${ot.approvedBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    </tr>
                `;
            });
            if(otCount > 0) {
                otBody.innerHTML += `<tr style="background:#f0f0f0; font-weight:bold;"><td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${otCount} Ù…Ø±Ø§Øª | Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${totalOtHours}</td></tr>`;
            }
        } else {
            otBody.innerHTML = '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</td></tr>';
        }

        // 2. Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        if(user.history) {
            Object.values(user.history).forEach(h => {
                tbody.innerHTML += `
                    <tr>
                        <td>${h.date}</td>
                        <td>${formatTime(h.totalGeneral)}</td>
                        <td>${formatTime(h.totalPrayer)}</td>
                        <td>${formatTime(h.totalMeeting)}</td>
                        <td>${h.approvedOvertime} Ø³</td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
        }
    }

    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù ---
    function initUserDash() {
        document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.realName}`;
        startTimer();
    }

    // Ø·Ù„Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ
    window.requestEmergency = () => {
        const reason = document.getElementById('breakReason').value.trim();
        if(!reason) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø³Ø¨Ø¨ Ø£Ø¹Ù„Ø§Ù‡ â˜ï¸");

        db.ref(`users/${currentUser.username}/emergencyRequest`).set({
            reason: reason,
            status: 'pending',
            timestamp: Date.now()
        }).then(() => alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ğŸš¨\nØ§Ù†ØªØ¸Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±."));
    }

    window.requestOvertime = () => {
        const h = document.getElementById('otHours').value;
        if(!h || h <= 0) return alert("Ø£Ø¯Ø®Ù„ Ø³Ø§Ø¹Ø§Øª");
        
        db.ref(`users/${currentUser.username}/overtimeRequest`).set({
            hours: h,
            status: 'pending',
            timestamp: Date.now()
        }).then(() => alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨"));
    }

    window.startMyBreak = (type) => {
        if(currentUser.isOnBreak) return alert("Ø£Ù†Øª ÙÙŠ Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙØ¹Ù„");

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ
        if(type === 'emergency') {
            // Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ:
            const req = currentUser.emergencyRequest;
            if(!req || req.status !== 'approved') return alert("ÙŠØ¬Ø¨ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹!");
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… (Ø§Ù„Ø¹Ø¯Ø¯)
        if(type === 'general') {
            const limit = globalSettings.maxGeneralBreaks || 100;
            const currentCount = Object.values(allUsersData).filter(u => u.isOnBreak && u.breakType === 'general').length;
            if(currentCount >= limit) return alert(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${limit}) Ù…ÙƒØªÙ…Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø£Ùˆ Ø·Ù„Ø¨ Ø®Ø±ÙˆØ¬ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ.`);
        }

        let reason = document.getElementById('breakReason').value.trim();
        if(type === 'prayer') reason = "ØµÙ„Ø§Ø©";
        if(type === 'meeting') reason = "Ù…ÙŠØªÙ†Ø¬";
        if(type === 'emergency') reason = currentUser.emergencyRequest.reason + " (Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ)";
        
        if((type === 'general' || type === 'emergency') && !reason) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨");

        db.ref('users/' + currentUser.username).update({
            isOnBreak: true,
            breakType: type,
            lastStartTime: Date.now(),
            lastReason: reason
        });
    }

    window.stopMyBreak = () => {
        if(!currentUser.isOnBreak) return;
        const type = currentUser.breakType;
        const duration = Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
        
        const updates = { isOnBreak: false, lastStartTime: null, breakType: null, lastReason: "" };
        
        if(type === 'general' || type === 'emergency') updates.usedSeconds = (currentUser.usedSeconds || 0) + duration;
        else if(type === 'prayer') updates.prayerSeconds = (currentUser.prayerSeconds || 0) + duration;
        else if(type === 'meeting') updates.meetingSeconds = (currentUser.meetingSeconds || 0) + duration;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠØŒ Ø§Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨ Ù„ÙŠØ¹ÙˆØ¯ Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
        if(type === 'emergency') updates.emergencyRequest = null;

        db.ref('users/' + currentUser.username).update(updates);
        document.getElementById('breakReason').value = "";
    }

    function updateUserUI() {
        const timerDisplay = document.getElementById('userTimer');
        const label = document.getElementById('timerLabel');
        const statusMsg = document.getElementById('userStatusMsg');
        const btnReqEmergency = document.getElementById('btnReqEmergency');
        const emStatusArea = document.getElementById('emergencyStatusArea');
        const otStatus = document.getElementById('overtimeStatus');

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ
        if(currentUser.emergencyRequest) {
            const st = currentUser.emergencyRequest.status;
            if(st === 'pending') {
                emStatusArea.innerHTML = `<span class="status-badge bg-orange">â³ Ø§Ù„Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>`;
            } else if(st === 'approved') {
                emStatusArea.innerHTML = `<button onclick="startMyBreak('emergency')" class="btn btn-emergency btn-sm" style="width:100%">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†!</button>
                                          <p style="font-size:0.7rem; color:green;">ÙˆØ§ÙÙ‚: ${currentUser.emergencyRequest.approvedBy}</p>`;
            } else if(st === 'rejected') {
                emStatusArea.innerHTML = `<span class="status-badge bg-red">âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</span> 
                                          <button onclick="clearEmergencyReq()" style="font-size:0.7rem; border:none; background:none; text-decoration:underline; cursor:pointer">Ù…Ø­Ùˆ</button>`;
            }
        } else {
            emStatusArea.innerHTML = `<button onclick="requestEmergency()" class="btn btn-dark btn-sm" style="width:100%">Ø·Ù„Ø¨ Ø®Ø±ÙˆØ¬</button>`;
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…
        if(currentUser.overtimeRequest) {
            const st = currentUser.overtimeRequest.status;
            if(st === 'pending') otStatus.innerHTML = `<span style="color:orange">â³ Ø·Ù„Ø¨Ùƒ (${currentUser.overtimeRequest.hours}Ø³) Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>`;
            else if(st === 'approved') otStatus.innerHTML = `<span style="color:green">âœ… ÙˆØ§ÙÙ‚ ${currentUser.overtimeRequest.handledBy} Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ</span>`;
            else if(st === 'rejected') otStatus.innerHTML = `<span style="color:red">âŒ ØªÙ… Ø§Ù„Ø±ÙØ¶</span>`;
        } else {
            otStatus.innerHTML = '';
        }

        // Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª
        if(currentUser.isOnBreak) {
            document.getElementById('controlsArea').classList.add('hidden');
            document.getElementById('stopArea').classList.remove('hidden');
            
            const elapsed = Math.floor((Date.now() - currentUser.lastStartTime) / 1000);
            
            if(currentUser.breakType === 'meeting' || currentUser.breakType === 'prayer') {
                label.innerText = currentUser.lastReason;
                timerDisplay.innerText = formatTime(elapsed);
                timerDisplay.style.color = currentUser.breakType === 'meeting' ? "var(--meeting-color)" : "var(--prayer-color)";
                statusMsg.innerText = "";
                stopAlarm();
            } else {
                // Ø¹Ø§Ù… Ø£Ùˆ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ
                const totalUsed = (currentUser.usedSeconds || 0) + elapsed;
                const remaining = (currentUser.allowance * 60) - totalUsed;
                label.innerText = `ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬: ${currentUser.lastReason}`;
                
                if(remaining >= 0) {
                    timerDisplay.innerText = formatTime(remaining);
                    timerDisplay.style.color = "var(--primary-color)";
                    statusMsg.innerText = "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯";
                    stopAlarm();
                } else {
                    timerDisplay.innerText = "-" + formatTime(Math.abs(remaining));
                    timerDisplay.style.color = "red";
                    statusMsg.innerText = "ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­!";
                    playAlarm();
                }
            }
        } else {
            document.getElementById('controlsArea').classList.remove('hidden');
            document.getElementById('stopArea').classList.add('hidden');
            stopAlarm();
            document.getElementById('overtimeAlert').classList.add('hidden');

            const remaining = (currentUser.allowance * 60) - (currentUser.usedSeconds || 0);
            label.innerText = "Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ";
            if(remaining >= 0) {
                timerDisplay.innerText = formatTime(remaining);
                timerDisplay.style.color = "#2d3436";
                statusMsg.innerText = "";
            } else {
                timerDisplay.innerText = "00:00";
                statusMsg.innerText = `Ù„Ø¯ÙŠÙƒ ØªØ¬Ø§ÙˆØ² Ø³Ø§Ø¨Ù‚: ${formatTime(Math.abs(remaining))}`;
                statusMsg.style.color = "red";
            }
        }
    }

    window.clearEmergencyReq = () => { db.ref('users/'+currentUser.username+'/emergencyRequest').remove(); }

    function playAlarm() {
        document.body.classList.add('alarm-mode');
        document.getElementById('overtimeAlert').classList.remove('hidden');
        const audio = document.getElementById('alarmSound');
        if(audio.paused) audio.play().catch(e=>{});
    }
    
    function stopAlarm() {
        document.body.classList.remove('alarm-mode');
        const audio = document.getElementById('alarmSound');
        audio.pause(); audio.currentTime=0;
    }

    function formatTime(s) {
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        return `${m}:${sec}`;
    }
</script>
</body>
</html>
